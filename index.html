<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SERVELECT ‚Ä¢ Pontaj & Concedii</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" href="favicon.png" />
  <meta name="theme-color" content="#516A75"/>

  <!-- Preload audio compat (po»õi »ôi elimina dacƒÉ vrei) -->
  <link rel="preload" href="./audio/stage1.mp3" as="fetch" type="audio/mpeg" crossorigin>
  <link rel="preload" href="./audio/stage2.mp3" as="fetch" type="audio/mpeg" crossorigin>
  <link rel="preload" href="./audio/stage3.mp3" as="fetch" type="audio/mpeg" crossorigin>
  <link rel="preload" href="./audio/chime.mp3"  as="fetch" type="audio/mpeg" crossorigin>

  <style>
    :root{
      --brand:#516B74;
      --brand-weak:rgba(81,106,117,0.88);
      --accent:#95CA4B;
      --text:#0f172a;
      --muted:#5b6b73;
      --bg:#f4f7f9;
      --card:#ffffff;
      --ring:#cfe0e7;
      --danger:#ef4444;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%; width:100%}
    body{
      margin:0;
      font-family: Montserrat, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        linear-gradient(180deg, rgba(149, 202, 75, 0.91) 0%, rgba(81, 106, 117, 0.88) 66%),
        url('background.jpg');
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      min-height:100vh;
    }
    .shell{max-width:1100px;margin:0 auto;padding:24px;}
    .nav{
      display:flex;align-items:center;justify-content:space-between;
      gap:16px;padding:14px 16px;border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.80));
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 30px rgba(81,106,117,.18);
      border:1px solid rgba(81,106,117,.18);
    }
    .brand{display:flex;align-items:center;gap:12px;text-decoration:none;color:inherit}
    .brand img{ width:38px;height:38px;object-fit:contain;aspect-ratio:1/1;border-radius:10px;box-shadow:0 3px 10px rgba(81,106,117,.25) }
    .brand h1{font-size:18px;letter-spacing:.2px;margin:0;line-height:1.1}
    .brand h1 span{display:block;font-weight:700}
    .brand small{display:block;font-size:12px;color:var(--muted);margin-top:2px}
    .hero{ margin-top:20px; display:grid;grid-template-columns:1.1fr .9fr;gap:24px;align-items:stretch; }
    @media (max-width:900px){ .hero{grid-template-columns:1fr} }
    .card{ background:var(--card); border:1px solid rgba(14,165,233,.12); border-radius:18px; box-shadow: 0 20px 60px rgba(2,132,199,.08); }
    .panel{padding:20px 20px 14px 20px}
    .panel header{ display:flex;align-items:center;gap:10px;margin:6px 0 14px; }
    .panel header .dot{ width:10px;height:10px;border-radius:50%;background:var(--accent); box-shadow:0 0 0 4px rgba(149,202,75,0.18); }
    .panel header h2{margin:0;font-size:18px}
    .sub{color:var(--muted);font-size:14px;margin:0 0 14px}
    label{display:block;font-size:12px;color:var(--muted);margin:4px 0 6px}
    .grid{display:grid;gap:14px}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:900px){ .grid.cols-3,.grid.cols-2{grid-template-columns:1fr} }
    select, input[type="text"], input[type="email"], input[type="date"]{
      width:100%;padding:12px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;
      font-size:15px;outline:none;transition: box-shadow .15s, border-color .15s;
    }
    select:focus, input:focus{ border-color: var(--brand); box-shadow:0 0 0 4px var(--ring); }
    .btnbar{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .btn{ --bg:#e2e8f0; --fg:#0f172a; appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;
      cursor:pointer;transition: transform .06s ease, box-shadow .2s ease, background .2s; box-shadow:0 6px 16px rgba(15,23,42,.08);
      color:var(--fg);background:var(--bg); }
    .btn:active{transform: translateY(1px)}
    .btn.primary{ --bg: var(--accent); --fg:#fff }
    .btn.pause{ --bg:#f59e0b; --fg:#111827 }
    .btn.unpause{ --bg: var(--brand); --fg:#fff }
    .btn.finish{ --bg: var(--accent); --fg:#fff }
    .btn.extra{ --bg:#64748b; --fg:#fff }
    .btn:disabled{opacity:.6;cursor:not-allowed;}
    .leave{ border:1px dashed #cbd5e1;border-radius:14px;padding:12px;background:#f8fafc; }
    .kicker{font-size:12px;color:var(--muted);margin-bottom:6px}
    .status{font-size:13px;color:var(--muted);margin-top:10px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;white-space:pre-wrap}
    .chip{ display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(81,106,117,.10);color:#2f3e45;font-weight:600;font-size:12px }
    .rail{padding:18px}
    .summary{ display:grid;gap:12px }
    .summary .item{ display:flex;align-items:center;gap:10px;padding:12px;border-radius:14px;background:#f8fafc;border:1px solid #e2e8f0; }
    .footer{ margin-top:18px;font-size:12px;color:var(--muted);text-align:center }
    .ok{color:#15803d} .err{color:#ef4444} .warn{color:#a16207}

    .toast{
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 24px; z-index: 9999; min-width: 280px; max-width: 92vw;
      background: #0f172a; color: #fff; border-radius: 14px; padding: 14px 16px;
      box-shadow: 0 20px 50px rgba(2,6,23,.35); display:none; font-size:14px
    }
    .toast.ok{ background:#166534 }
    .toast.warn{ background:#a16207 }
    .toast.err{ background:#991b1b }
    .toast .small{opacity:.85;font-size:12px;margin-top:4px}

    body.action-lock .btnbar { pointer-events: none; }
    body.action-lock .btnbar .btn { opacity:.6; cursor:not-allowed; }

    /* ===== SPLASH ===== */
    html.splash-open, body.splash-open{ overflow:hidden; }
    .splash{
      position:fixed; inset:0; z-index:2000;
      display:grid; place-items:center;
      background: radial-gradient(1200px 800px at 50% 20%, #e8f2e0, #d9e6df);
      opacity:1; transform:scale(1); transition: opacity .6s ease, transform .6s ease;
    }
    .splash.hide{ opacity:0; transform:scale(1.01); pointer-events:none }

    .s-wrap{ width:min(1100px, 92vw); text-align:center; user-select:none }
    .brand-line{
      display:flex; align-items:center; justify-content:center; gap: clamp(10px, 2vw, 22px);
      line-height:1; flex-wrap:wrap;
    }
    .brand-word{ font-weight:800; letter-spacing:.5px; font-size: clamp(44px, 9vw, 96px); }
    .serv{ color:var(--brand) }
    .lect{ color:var(--accent) }

    .battery{ height: clamp(110px, 20vw, 190px); width:auto; display:block;
              filter: drop-shadow(0 8px 24px rgba(0,0,0,.08)); }
    .bat-outline{ stroke:var(--brand); stroke-width:10; fill:none; stroke-linejoin:round }
    .bat-cap{ fill:var(--brand) }
    .bar{ opacity:.18; fill:transparent; stroke:var(--brand); stroke-width:2; transition: opacity .2s ease }
    .bar.on{ opacity:1; fill:currentColor; stroke:transparent }
    .bar.stage-red{ color:#ef4444 }
    .bar.stage-yellow{ color:#f59e0b }
    .bar.stage-green{ color:var(--accent) }
    .glow{ filter: drop-shadow(0 0 0 rgba(149,202,75,0)); transition: filter .5s ease }
    .glow.active{
      filter: drop-shadow(0 0 14px rgba(149,202,75,.75)) drop-shadow(0 0 28px rgba(149,202,75,.45));
    }
    .tag{ margin-top: clamp(10px, 2.2vw, 18px); font-weight:700; font-size: clamp(18px, 3.6vw, 34px); line-height:1.15; }
    .tag .money{ color:var(--accent) }
    .tag .save{ color:var(--brand) }

    @media (prefers-reduced-motion: reduce){
      .glow, .bar, .splash{ transition:none }
    }

    /* ===== Overlay ‚ÄúPorne»ôte sunetul‚Äù (doar dacƒÉ e nevoie) ===== */
    .audio-unlock{
      position:fixed; inset:0; z-index:2200; display:none; place-items:center;
      background:rgba(0,0,0,.35); -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px);
      text-align:center; font-family: Montserrat, ui-sans-serif, system-ui;
    }
    .audio-unlock.show{ display:grid }
    .audio-unlock button{
      appearance:none; border:0; border-radius:14px; padding:14px 18px; cursor:pointer;
      background:#95CA4B; color:#fff; font-weight:800; font-size:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.2);
    }
    .audio-unlock small{display:block; color:#fff; opacity:.9; margin-top:10px; font-weight:600}
  </style>
</head>
<body>
  <!-- ===== SPLASH OVERLAY ===== -->
  <div id="splash" class="splash" role="dialog" aria-label="Ecran de √Ænt√¢mpinare">
    <div class="s-wrap">
      <div class="brand-line">
        <div class="brand-word serv">SERV</div>

        <!-- Bateria (vertical) ca litera ‚ÄûE‚Äù stilizatƒÉ -->
        <svg class="battery glow" id="battery" viewBox="0 0 150 240" role="img" aria-label="Baterie">
          <rect x="20" y="40" width="110" height="180" rx="14" class="bat-outline"/>
          <rect x="57" y="10" width="36" height="20" rx="6" class="bat-cap"/>
          <rect id="bar1" class="bar" x="32" y="174" width="86" height="32" rx="8"/>
          <rect id="bar2" class="bar" x="32" y="130" width="86" height="32" rx="8"/>
          <rect id="bar3" class="bar" x="32" y="86"  width="86" height="32" rx="8"/>
        </svg>

        <div class="brand-word lect">LECT</div>
      </div>

      <div class="tag">
        <span class="money">Energy is money!</span>
        &nbsp;<span class="save">We save both.</span>
      </div>
    </div>
  </div>
  <!-- ===== END SPLASH ===== -->

  <!-- Overlay ‚ÄúPorne»ôte sunetul‚Äù (apare doar dacƒÉ e necesar) -->
  <div id="audioUnlock" class="audio-unlock" aria-live="polite" aria-label="Porne»ôte sunetul">
    <div>
      <button id="unlockBtn">üîä Porne»ôte sunetul</button>
      <small>Doar prima datƒÉ pe acest site (autoplay blocat de browser)</small>
    </div>
  </div>

  <div class="shell">
    <nav class="nav card">
      <a class="brand" href="#" aria-label="Spre √Ænceput">
        <img src="favicon.png" alt="SiglƒÉ SERVELECT" />
        <div>
          <h1><span>SERVELECT</span><small>Pontaj & Management Concedii</small></h1>
        </div>
      </a>
      <div class="chip" id="cfg">Se √ÆncarcƒÉ configura»õia‚Ä¶</div>
    </nav>

    <section class="hero">
      <div class="card panel">
        <header>
          <span class="dot" aria-hidden="true"></span>
          <h2>√énregistrare activitate</h2>
        </header>
        <p class="sub">
          Alege <b>Departament</b> ‚Üí <b>Angajat</b>, apoi <b>Tip de activitate</b>,
          completeazƒÉ <b>Client</b> <i>(op»õional pentru Comercial)</i> »ôi (op»õional) o <b>NotƒÉ</b>.
          Apoi folose»ôte butoanele de mai jos.
        </p>

        <div class="grid cols-3">
          <div>
            <label for="deptSelect">Departament</label>
            <select id="deptSelect"><option value="" selected disabled>Alege departamentul...</option></select>
          </div>

          <div>
            <label for="employeeSelect">Angajat</label>
            <select id="employeeSelect"><option>Se √ÆncarcƒÉ...</option></select>
            <div class="status" id="empStatus"></div>
          </div>

          <div>
            <label for="activitySelect">Tip de activitate</label>
            <select id="activitySelect">
              <option value="" selected disabled>Alege tip...</option>
              <option>atelier</option>
              <option>birou-lucrare</option>
              <option>deplasare</option>
              <option>ofertare</option>
              <option>concediu de odihna</option>
              <option>concediu medical</option>
              <option>zi libera legala</option>
              <option>birou-administrativ</option>
              <option>home office</option>
              <option>invoire</option>
              <option>pe drum</option>
              <option>concediu pentru ore suplimentare</option>
              <option>birou + deplasare</option>
            </select>
          </div>

          <div>
            <label for="locationInput">Client</label>
            <input id="locationInput" type="text" placeholder="ex: »òantier B ‚Äì PoartƒÉ 2" />
          </div>
        </div>

        <div class="grid" style="margin-top:12px">
          <div>
            <label for="notes">NotƒÉ (op»õional)</label>
            <input id="notes" type="text" placeholder="ex: Proiect X, client Y" />
          </div>
        </div>

        <!-- Leave panel -->
        <div id="leavePanel" class="leave" style="display:none;margin-top:16px">
          <div class="kicker"><b>Cerere concediu</b> ‚Äî adaugƒÉ <b>zile individuale</b> de concediu, apoi completeazƒÉ emailul personal »ôi (op»õional) o notƒÉ. Se trimite automat la HR.</div>

          <div class="grid cols-3" id="leaveDaysBlock">
            <div>
              <label for="leaveDay">Zi concediu</label>
              <input type="date" id="leaveDay" />
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="btnAddDay" class="btn extra" type="button" style="width:100%">AdaugƒÉ zi</button>
            </div>
            <div>
              <label>Zile selectate</label>
              <div id="leaveDaysList" class="status" style="min-height:44px"></div>
            </div>
          </div>
          <div class="grid cols-3">
            <div>
              <label for="leaveStart">Data start</label>
              <input type="date" id="leaveStart" />
            </div>
            <div>
              <label for="leaveEnd">Data sf√¢r»ôit</label>
              <input type="date" id="leaveEnd" />
            </div>
            <div>
              <label for="leaveEmail">Email personal</label>
              <input type="email" id="leaveEmail" placeholder="ex: prenume.nume@..." />
            </div>
          </div>
          <div class="grid" style="margin-top:10px">
            <div>
              <label for="leaveNotes">NotƒÉ cƒÉtre HR (op»õional)</label>
              <input type="text" id="leaveNotes" placeholder="ex: motiv / detalii" />
            </div>
          </div>
          <div class="btnbar">
            <button id="btnLeave" class="btn primary" type="button">Trimite cererea de concediu</button>
            <span class="status" id="leaveStatus"></span>
          </div>
        </div>

        <!-- Main action buttons -->
        <div class="btnbar" style="margin-top:16px">
          <button class="btn primary" id="btnStart">Start</button>
          <button class="btn pause"   id="btnPause">Pause</button>
          <button class="btn unpause" id="btnUnpause">Unpause</button>
          <button class="btn finish"  id="btnFinish">Finish</button>
        </div>

        <!-- EXTRA time buttons (ascunse pentru Comercial) -->
        <div class="btnbar" id="extraBar" style="margin-top:8px">
          <button class="btn extra" id="btnExtraStart" title="Porne»ôte orele extra (separate de suplimentare)">Extra Start</button>
          <button class="btn extra" id="btnExtraFinish" title="√éncheie orele extra">Extra Finish</button>
        </div>

        <div id="status" class="status" role="status" aria-live="polite"></div>

        <div id="last" class="status mono" style="display:none"></div>
      </div>

      <aside class="card rail">
        <header style="display:flex;align-items:center;gap:10px;margin:4px 0 10px">
          <span class="dot" aria-hidden="true"></span>
          <h2 style="margin:0;font-size:18px">Scurt ghid</h2>
        </header>
        <div class="summary">
          <div class="item"><b>Start</b> porne»ôte pontajul</div>
          <div class="item"><b>Pause</b> / <b>Unpause</b> marcheazƒÉ pauzele.</div>
          <div class="item"><b>Finish</b> √Æncheie ziua de lucru.</div>
          <div class="item"><b>Extra Start/Finish</b> ‚Äî ore extra separate de suplimentare.</div>
          <div class="item"><b>Concedii</b> ‚Äî alege tipul »ôi trimite cererea.</div>
        </div>
        <div class="footer">¬© <span id="year"></span> SERVELECT. Toate drepturile rezervate.</div>
      </aside>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <iframe name="hidden_iframe" style="display:none;"></iframe>
  <iframe name="hidden_iframe_leave" style="display:none;"></iframe>

  <!-- Leave Google Form -->
  <form id="leaveForm" method="POST" target="hidden_iframe_leave">
    <input type="hidden" id="lv_name" />
    <input type="hidden" id="lv_type" />
    <input type="hidden" id="lv_email" />
    <input type="hidden" id="lv_start" />
    <input type="hidden" id="lv_end" />
    <input type="hidden" id="lv_notes" />
    <input type="hidden" id="lv_ts" />
  </form>

  <!-- Main Google Form payload -->
  <form id="gform" method="POST" target="hidden_iframe">
    <input type="hidden" id="f_action" />
    <input type="hidden" id="f_timestamp" />
    <input type="hidden" id="f_name" />
    <input type="hidden" id="f_activity" />
    <input type="hidden" id="f_location" />
    <input type="hidden" id="f_lat" />
    <input type="hidden" id="f_lon" />
    <input type="hidden" id="f_acc" />
    <input type="hidden" id="f_device" />
    <input type="hidden" id="f_notes" />
    <input type="hidden" id="f_maps" />
    <input type="hidden" id="f_department" />
    <input type="hidden" id="f_nonce" />
  </form>

  <!-- Fallback inline employees list -->
  <script type="text/plain" id="employees-inline">
Ion Popescu
Maria Ionescu
Vlad Georgescu
Ana Radu
  </script>

  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

 <!-- ================== SPLASH: AUDIO CROSS-DESKTOP (autoplay detect + unlock) ================== -->
<script>
(() => {
  // Timings (ms)
  const STAGE1=0, STAGE2=600, STAGE3=1200, CHIME=1500, HIDE=1900;

  // UI refs
  const splash  = document.getElementById('splash');
  const battery = document.getElementById('battery');
  const bars    = [document.getElementById('bar1'), document.getElementById('bar2'), document.getElementById('bar3')];

  // Unlock overlay (o arƒÉtƒÉm doar dacƒÉ e nevoie)
  let unlock = document.getElementById('audioUnlock');
  if (!unlock){
    const div = document.createElement('div');
    div.id = 'audioUnlock';
    div.className = 'audio-unlock';
    div.innerHTML = `<div>
      <button id="unlockBtn">üîä Porne»ôte sunetul</button>
      <small>Browserul a blocat autoplay cu sunet. Un singur click »ôi e gata.</small>
    </div>`;
    document.body.appendChild(div);
    unlock = div;
  }
  const unlockBtn = () => document.getElementById('unlockBtn');

  // ========== UI helpers ==========
  function resetBars(){ bars.forEach(b => b.className = 'bar'); battery.classList.remove('active'); }
  function stageUI(n){
    resetBars();
    if (n>=1){ bars[0].classList.add('on','stage-red'); }
    if (n>=2){ bars[0].classList.remove('stage-red'); bars[0].classList.add('stage-yellow'); bars[1].classList.add('on','stage-yellow'); }
    if (n>=3){ bars.forEach(b=>{ b.classList.remove('stage-red','stage-yellow'); b.classList.add('on','stage-green'); }); battery.classList.add('active'); }
  }
  function openSplash(){
    document.documentElement.classList.add('splash-open');
    document.body.classList.add('splash-open');
    splash.classList.remove('hide');
  }
  function closeSplash(){
    splash.classList.add('hide');
    setTimeout(()=>{ document.documentElement.classList.remove('splash-open'); document.body.classList.remove('splash-open'); }, 460);
  }

  // ========== Audio setup ==========
  const a1 = new Audio('./audio/stage1.mp3');
  const a2 = new Audio('./audio/stage2.mp3');
  const a3 = new Audio('./audio/stage3.mp3');
  const ch = new Audio('./audio/chime.mp3');
  [a1,a2,a3,ch].forEach(a => { a.preload='auto'; a.loop=false; a.playsInline=true; a.load(); });

  function playUnmuted(a){
    try{
      a.currentTime = 0;
      a.muted = false; // important: testƒÉm AUTOPLAY CU SUNET
      return a.play(); // dacƒÉ e blocat, promisiunea rejecteazƒÉ cu NotAllowedError
    }catch(e){
      return Promise.reject(e);
    }
  }
  function stopAll(){ [a1,a2,a3,ch].forEach(a=>{ try{ a.pause(); a.currentTime = 0; }catch{} }); }

  // Timeline sincron UI + AUDIO
  function runTimelineWithHtmlAudio(){
    resetBars();
    setTimeout(()=>{ stageUI(1); playUnmuted(a1).catch(()=>{}); }, STAGE1);
    setTimeout(()=>{ stageUI(2); playUnmuted(a2).catch(()=>{}); }, STAGE2);
    setTimeout(()=>{ stageUI(3); playUnmuted(a3).catch(()=>{}); }, STAGE3);
    setTimeout(()=>{ playUnmuted(ch).catch(()=>{}); }, CHIME);
    setTimeout(closeSplash, HIDE);
  }

  // Fallback super-rapid (WebAudio synth) ‚Äì dupƒÉ gest e garantat
  const Synth = (() => {
    let ctx;
    function ensure(){ return ctx || (ctx = new (window.AudioContext||window.webkitAudioContext)()); }
    function blip(f=600, dur=0.14, type='sine', gain=0.95, at=0){
      const c = ensure(), t0 = c.currentTime + at/1000;
      const o = c.createOscillator(); o.type = type; o.frequency.value = f;
      const g = c.createGain(); g.gain.setValueAtTime(0, t0);
      g.gain.linearRampToValueAtTime(gain, t0 + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
      o.connect(g); g.connect(c.destination); o.start(t0); o.stop(t0 + dur);
    }
    async function run(){
      ensure();
      resetBars();
      setTimeout(()=>stageUI(1), STAGE1);
      setTimeout(()=>stageUI(2), STAGE2);
      setTimeout(()=>stageUI(3), STAGE3);
      // sunete
      blip(420,.17,'sine',0.95, STAGE1);
      blip(620,.16,'sine',0.95, STAGE2);
      blip(760,.18,'sine',0.95, STAGE2+90);
      blip(780,.14,'triangle',.9, STAGE3);
      blip(900,.14,'triangle',.9, STAGE3+70);
      blip(1020,.16,'triangle',.9, STAGE3+140);
      blip(880,.22,'triangle',.95, CHIME);
      blip(1109,.24,'triangle',.95, CHIME+70);
      blip(1319,.28,'triangle',.95, CHIME+140);
      setTimeout(closeSplash, HIDE);
    }
    async function resume(){ try{ if (ctx && ctx.state==='suspended') await ctx.resume(); }catch{} }
    return { run, resume };
  })();

  // ===== Start logic =====
  openSplash();
  resetBars();

  (async () => {
    // √éncercƒÉm autoplay CU SUNET pe desktop:
    try{
      // testƒÉm rapid cu primul sunet; dacƒÉ e permis, rulƒÉm tot timeline-ul
      await playUnmuted(a1);
      stopAll(); // nu vrem sƒÉ √Æl auzim de douƒÉ ori; rulƒÉm timeline-ul curat
      runTimelineWithHtmlAudio();
    } catch {
      // blocat => cerem un singur click (overlay)
      unlock.classList.add('show');
      const btn = unlockBtn();
      if (btn){
        btn.addEventListener('click', async () => {
          unlock.classList.remove('show');
          stopAll();
          // dupƒÉ gest: √Æncerc HTMLAudio normal (unmuted). DacƒÉ tot nu, folosesc synth.
          try{
            await playUnmuted(a1);
            stopAll();
            runTimelineWithHtmlAudio();
          }catch{
            await Synth.resume();
            await Synth.run();
          }
        }, { once:true });
      }
    }
  })();
})();
</script>
<!-- ================== END SPLASH ================== -->


  <script>
  /** ================== Helpers & Config ================== */
  function setText(el, msg, cls){ el.className = (el.className.split(' ')[0] || 'status') + (cls?(' '+cls):''); el.textContent = msg; }
  function _norm(s){ return String(s==null?'':s).trim(); }
  function _normAction(a){
    let s = _norm(a).toLowerCase().replace(/[-\s]+/g,'_');
    if (s === 'resume') s='unpause';
    if (s === 'stop') s='finish';
    if (s === 'extra start') s='extra_start';
    if (s === 'extra finish') s='extra_finish';
    return s;
  }
  function showToast(msg, type){
    const t = document.getElementById('toast');
    t.className = 'toast' + (type ? ' ' + type : '');
    t.innerHTML = msg;
    t.style.display = 'block';
    clearTimeout(showToast._h);
    showToast._h = setTimeout(()=>{ t.style.display='none'; }, 7000);
  }

  /** Trimite cererea de concediu la WebApp (fƒÉrƒÉ preflight CORS) */
  async function sendLeave(payload) {
    const r = await fetch(CFG.leaveEndpoint, {
      method: 'POST',
      headers: {'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify(payload)
    });
    const txt = await r.text();
    let data;
    try { data = JSON.parse(txt); }
    catch { throw new Error('RƒÉspuns invalid: ' + txt.slice(0,200)); }
    if (!r.ok || !data.ok) throw new Error((data && data.error) || ('HTTP '+r.status));
    return data;
  }

  /* >>> ANTI-SPAM/LOCK utils */
  const CLICK_COOLDOWN_MS = 1200;
  const GUARD_MIN_LOCK_MS = 600;
  let busy = false;
  let lastActionAt = 0;
  function setUILock(on){ document.body.classList.toggle('action-lock', !!on); }
  function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }
  function geolocateOnce(){
    return new Promise((resolve, reject) => {
      if (!('geolocation' in navigator)) return reject(new Error('Geoloca»õie indisponibilƒÉ pe acest dispozitiv.'));
      navigator.geolocation.getCurrentPosition(
        pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude, acc: Math.round(pos.coords.accuracy || 0) }),
        err => reject(new Error('Eroare loca»õie: ' + err.message)),
        { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
      );
    });
  }
  function randomNonce(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }

  (function(){
    const statusEl = document.getElementById('status');
    const cfgEl = document.getElementById('cfg');
    const notesEl = document.getElementById('notes');
    const locInput = document.getElementById('locationInput');
    const deptSel = document.getElementById('deptSelect');
    const empSel = document.getElementById('employeeSelect');
    const actSel = document.getElementById('activitySelect');
    const empStatus = document.getElementById('empStatus');
    const form = document.getElementById('gform');

    const leavePanel = document.getElementById('leavePanel');
    const leaveStart = document.getElementById('leaveStart');
    const leaveEnd = document.getElementById('leaveEnd');
    const leaveEmail = document.getElementById('leaveEmail');
    const leaveNotes = document.getElementById('leaveNotes');
    const leaveStatus = document.getElementById('leaveStatus');
    const leaveDay = document.getElementById('leaveDay');
    const leaveDaysList = document.getElementById('leaveDaysList');
    const btnAddDay = document.getElementById('btnAddDay');
    const extraBar = document.getElementById('extraBar');
    let LEAVE_DAYS = [];

    function setStatus(m, c){ setText(statusEl, m, c); }
    function setCfg(m, c){ setText(cfgEl, m, c); }
    function setEmp(m, c){ setText(empStatus, m, c); }
    function setLeaveStatus(m, c){ setText(leaveStatus, m, c); }

    let CFG = null;
    let STATE = blankState();
    const LS_KEY = 'pontaj/state/v1';

    function blankState(){
      return {
        name: '',
        normal: { running:false, paused:false },
        extra:  { running:false },
        lastNormalStart: null,
        lastNormalFinish: null,
        lastExtraStart: null,
        lastExtraFinish: null
      };
    }
    function loadLS(){ try { return JSON.parse(localStorage.getItem(LS_KEY) || 'null'); } catch{return null;} }
    function saveLS(){ try { localStorage.setItem(LS_KEY, JSON.stringify(STATE)); } catch{} }

    function bindCFGToForm() {
      form.action = CFG.formAction;
      const names = CFG.fields;
      const idMap = {
        'f_action':   names.action,
        'f_timestamp':names.timestamp,
        'f_name':     names.name,
        'f_activity': names.activityType,
        'f_location': names.location,
        'f_lat':      names.latitude,
        'f_lon':      names.longitude,
        'f_acc':      names.accuracy,
        'f_device':   names.device,
        'f_notes':    names.notes,
        'f_maps':     names.mapsLink,
        'f_department': names.department || ''
      };
      Object.entries(idMap).forEach(([id,name]) => {
        const el = document.getElementById(id);
        if (name) el.setAttribute('name', name);
      });
    }

    function bindLeaveForm() {
      if (!CFG.leaveFormAction || !CFG.leaveFields) return false;
      const m = CFG.leaveFields;
      const map = {
        'lv_name':  m.name,
        'lv_type':  m.activityType,
        'lv_email': m.personalEmail,
        'lv_start': m.startDate,
        'lv_end':   m.endDate,
        'lv_notes': m.notes,
        'lv_ts':    m.timestamp
      };
      Object.entries(map).forEach(([id, name]) => {
        const el = document.getElementById(id);
        if (el && name) el.setAttribute('name', name);
      });
      document.getElementById('leaveForm').action = CFG.leaveFormAction;
      return true;
    }

    function parseEmployeesCSV(text){
      if (text && text.charCodeAt && text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
      text = (text || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
      if (!text) return [];
      if (!/,|;/.test(text)) {
        return text.split('\n').map(s => s.trim()).filter(Boolean);
      }
      const comma = (text.match(/,/g) || []).length;
      const semiCount = (text.match(/;/g) || []).length;
      const delim = semiCount > comma ? ';' : ',';
      const rows = text.split('\n')
        .map(line => line.split(delim).map(c => c.trim().replace(/^"|"$/g,'')))
        .filter(r => r.length && r.join('').length);
      const header = rows[0].map(h => (h||'').toLowerCase());
      let startIdx = 0, nameCol = 0;
      if (header.some(h => /angajat|nume|employee|name/.test(h))) {
        nameCol = Math.max(0, header.findIndex(h => /angajat|nume|employee|name/.test(h)));
        startIdx = 1;
      }
      const list = [];
      for (let i=startIdx;i<rows.length;i++){
        const v = (rows[i][nameCol] || '').trim();
        if (v) list.push(v);
      }
      return list;
    }
    function getInlineEmployees(){
      const el = document.getElementById('employees-inline');
      if (!el) return [];
      return el.textContent.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    }

    function parseDepartmentsCSV(text){
      if (text && text.charCodeAt && text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
      text = (text || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
      if (!text) return { byDept:new Map(), byName:new Map(), deptList:[] };

      const lines = text.split('\n').filter(Boolean);
      const sep = (text.indexOf(';') > -1 && (text.indexOf(';') < text.indexOf(','))) ? ';' : ',';

      let start = 0, depCol = 0, nameCol = 1;
      const hdr = lines[0].split(sep).map(s=>s.trim().replace(/^"|"$/g,'').toLowerCase());
      if (hdr.some(h => /depart|dept/.test(h)) || hdr.some(h => /angajat|nume|employee|name/.test(h))) {
        const d = hdr.findIndex(h => /depart|dept/.test(h));
        const n = hdr.findIndex(h => /angajat|nume|employee|name/.test(h));
        if (d >= 0) depCol = d;
        if (n >= 0) nameCol = n;
        start = 1;
      }

      const byDept = new Map();
      const byName = new Map();

      for (let i=start;i<lines.length;i++){
        const cells = lines[i].split(sep).map(s=>s.trim().replace(/^"|"$/g,''));
        const dep = (cells[depCol]||'').trim();
        const nm  = (cells[nameCol]||'').trim();
        if (!dep || !nm) continue;
        if (!byDept.has(dep)) byDept.set(dep, []);
        byDept.get(dep).push(nm);
        byName.set(nm, dep);
      }

      const deptList = Array.from(byDept.keys()).sort((a,b)=>a.localeCompare(b,'ro'));
      for (const d of byDept.keys()) byDept.get(d).sort((a,b)=>a.localeCompare(b,'ro'));
      return { byDept, byName, deptList };
    }

    let DEPTMAP = { byDept:new Map(), byName:new Map(), deptList:[] };

    function fillDepartments(deptList){
      deptSel.innerHTML = '';
      const ph = document.createElement('option');
      ph.value=''; ph.textContent='Alege departamentul...'; ph.disabled = true; ph.selected = true;
      deptSel.appendChild(ph);
      deptList.forEach(d => { const o=document.createElement('option'); o.value=d; o.textContent=d; deptSel.appendChild(o); });
    }

    function fillEmployeesFromDept(dept){
      const sel = empSel;
      sel.innerHTML = '';
      const ph = document.createElement('option');
      ph.value=''; ph.textContent= dept ? 'Alege angajat‚Ä¶' : 'Alege departamentul mai √Ænt√¢i‚Ä¶';
      ph.disabled = true; ph.selected = true;
      sel.appendChild(ph);
      if (!dept) return;
      const list = (DEPTMAP.byDept.get(dept) || []);
      list.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
    }

    async function loadDepartments(){
      try{
        if (CFG.departmentsCsv){
          const url = CFG.departmentsCsv + (CFG.departmentsCsv.includes('?') ? '&' : '?') + 'v=' + Date.now();
          const r = await fetch(url, {cache:'no-store'});
          if (r.ok){
            const txt = await r.text();
            const map = parseDepartmentsCSV(txt);
            if (map.deptList.length){
              DEPTMAP = map;
              fillDepartments(map.deptList);
              setEmp('Departamente √ÆncƒÉrcate din departmentsCsv.', 'ok');
              return;
            }
          }
        }
      }catch(e){}

      // Fallback
      let fallbackEmployees = [];
      try {
        if (CFG.employeesCsv){
          const url = CFG.employeesCsv + (CFG.employeesCsv.includes('?') ? '&' : '?') + 'v=' + Date.now();
          const r = await fetch(url, {cache:'no-store'});
          if (r.ok) fallbackEmployees = parseEmployeesCSV(await r.text());
        }
      } catch(e){}
      if (!fallbackEmployees.length && Array.isArray(CFG.employees)) fallbackEmployees = CFG.employees.slice();
      if (!fallbackEmployees.length) fallbackEmployees = getInlineEmployees();

      const byDept = new Map([['productie', fallbackEmployees]]);
      const byName = new Map(fallbackEmployees.map(nm => [nm, 'productie']));
      const deptList = ['productie'];
      DEPTMAP = { byDept, byName, deptList };
      fillDepartments(deptList);
      setEmp('Nu existƒÉ departmentsCsv ‚Äî folosesc ‚Äûproductie‚Äù.', 'warn');
    }

    /** ===== STATE (UI + server) ===== */
    const btnStart = document.getElementById('btnStart');
    const btnPause = document.getElementById('btnPause');
    const btnUnpause = document.getElementById('btnUnpause');
    const btnFinish = document.getElementById('btnFinish');
    const btnExtraStart = document.getElementById('btnExtraStart');
    const btnExtraFinish = document.getElementById('btnExtraFinish');

    function reflectState(){
      const running = STATE.normal.running;
      the_paused  = STATE.normal.paused; // minor typo fixed below
    }
  })();
  </script>

  <script>
  // Reintroduc reflectState corect (am separat pentru claritate, fƒÉrƒÉ sƒÉ stric ordinea ta):
  (function(){
    const btnStart = document.getElementById('btnStart');
    const btnPause = document.getElementById('btnPause');
    const btnUnpause = document.getElementById('btnUnpause');
    const btnFinish = document.getElementById('btnFinish');
    const btnExtraStart = document.getElementById('btnExtraStart');
    const btnExtraFinish = document.getElementById('btnExtraFinish');

    let STATE = (function(){ try{return JSON.parse(localStorage.getItem('pontaj/state/v1')||'null')}catch{return null} })() || {
      name:'', normal:{running:false,paused:false}, extra:{running:false}
    };

    function reflectState(){
      const running = STATE.normal.running;
      const paused  = STATE.normal.paused;
      const extraR  = STATE.extra.running;

      const hasSel = !!document.getElementById('employeeSelect').value;
      btnStart.disabled       = !hasSel || running || extraR;
      btnPause.disabled       = !hasSel || !running || paused;
      btnUnpause.disabled     = !hasSel || !running || !paused;
      btnFinish.disabled      = !hasSel || !running;

      btnExtraStart.disabled  = !hasSel || running || extraR;
      btnExtraFinish.disabled = !hasSel || !extraR;
    }

    window.addEventListener('storage', reflectState);
    reflectState();
  })();
  </script>

  <script>
  (function(){
    // Mut restul init-ului tƒÉu aici, neschimbat, cu un mic bugfix lv_ts.
    const statusEl = document.getElementById('status');
    const cfgEl = document.getElementById('cfg');
    const notesEl = document.getElementById('notes');
    const locInput = document.getElementById('locationInput');
    const deptSel = document.getElementById('deptSelect');
    const empSel = document.getElementById('employeeSelect');
    const actSel = document.getElementById('activitySelect');
    const empStatus = document.getElementById('empStatus');
    const form = document.getElementById('gform');
    const extraBar = document.getElementById('extraBar');

    let CFG=null;

    function setText(el, msg, cls){ el.className = (el.className.split(' ')[0] || 'status') + (cls?(' '+cls):''); el.textContent = msg; }

    function isComercialDept(){
      const v = (deptSel.value || '').toLowerCase();
      return v === 'comercial' || v === 'coemercial';
    }

    function disableTimeButtons(disabled) {
      [document.getElementById('btnStart'),document.getElementById('btnPause'),
       document.getElementById('btnUnpause'),document.getElementById('btnFinish'),
       document.getElementById('btnExtraStart'),document.getElementById('btnExtraFinish')].forEach(el=>{
        if (el) el.disabled = !!disabled;
      });
    }
    function disableAllButtons(disabled){
      disableTimeButtons(disabled);
      const lbtn = document.getElementById('btnLeave');
      if (lbtn) lbtn.disabled = !!disabled;
    }

    async function fetchState(name){
      const base = (CFG.stateEndpoint && CFG.stateEndpoint.trim()) || (CFG.guardEndpoint && (CFG.guardEndpoint.trim() + '?fn=state'));
      if (!base) return null;
      const url = base.includes('?fn=state') ? (base + '&name=' + encodeURIComponent(name))
                                             : (base + (base.includes('?')?'&':'?') + 'name=' + encodeURIComponent(name));
      const r = await fetch(url, { cache:'no-store' });
      const txt = await r.text();
      try { return JSON.parse(txt).state || null; } catch { return null; }
    }

    async function fetchStats(name){
      const rawBase = (CFG.guardEndpoint && CFG.guardEndpoint.trim()) || (CFG.stateEndpoint && CFG.stateEndpoint.trim());
      if (!rawBase) return null;
      const base = rawBase.replace(/\?.*$/,'');
      const url = base + '?fn=stats&name=' + encodeURIComponent(name);
      try{
        const r = await fetch(url, { cache:'no-store' });
        const txt = await r.text();
        try { const data = JSON.parse(txt); return data && data.ok ? data.stats : null; }
        catch { return null; }
      }catch{ return null; }
    }

    async function guardRemote(name, action){
      const base = (CFG.guardEndpoint && CFG.guardEndpoint.trim()) || (CFG.stateEndpoint && CFG.stateEndpoint.trim());
      if (!base) return {ok:true};
      const url = base + (base.includes('?') ? '&' : '?') + 'fn=guard';
      try{
        const r = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type':'text/plain;charset=utf-8'},
          body: JSON.stringify({ name, action: (String(action).toLowerCase().replace(/[-\s]+/g,'_')) })
        });
        const txt = await r.text();
        let data; try { data = JSON.parse(txt); } catch { return {ok:true}; }
        return data;
      }catch{
        return {ok:true};
      }
    }

    function showToast(msg, type){
      const t = document.getElementById('toast');
      t.className = 'toast' + (type ? ' ' + type : '');
      t.innerHTML = msg;
      t.style.display = 'block';
      clearTimeout(showToast._h);
      showToast._h = setTimeout(()=>{ t.style.display='none'; }, 7000);
    }

    const CLICK_COOLDOWN_MS = 1200;
    const GUARD_MIN_LOCK_MS = 600;
    let busy = false;
    let lastActionAt = 0;
    function setUILock(on){ document.body.classList.toggle('action-lock', !!on); }
    function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }
    function geolocateOnce(){
      return new Promise((resolve, reject) => {
        if (!('geolocation' in navigator)) return reject(new Error('Geoloca»õie indisponibilƒÉ pe acest dispozitiv.'));
        navigator.geolocation.getCurrentPosition(
          pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude, acc: Math.round(pos.coords.accuracy || 0) }),
          err => reject(new Error('Eroare loca»õie: ' + err.message)),
          { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
        );
      });
    }
    function randomNonce(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }

    function setFormPayload(action, ts, gps){
      document.getElementById('f_action').value    = String(action).toLowerCase().replace(/[-\s]+/g,'_');
      document.getElementById('f_timestamp').value = ts;
      document.getElementById('f_name').value      = document.getElementById('employeeSelect').value;
      document.getElementById('f_activity').value  = document.getElementById('activitySelect').value;
      document.getElementById('f_location').value  = (document.getElementById('locationInput').value||'').trim();
      document.getElementById('f_lat').value       = gps.lat;
      document.getElementById('f_lon').value       = gps.lon;
      document.getElementById('f_acc').value       = gps.acc;
      document.getElementById('f_device').value    = navigator.userAgent;
      document.getElementById('f_notes').value     = (document.getElementById('notes').value || '');
      document.getElementById('f_maps').value      = `https://maps.google.com/?q=${gps.lat},${gps.lon}`;
      const nm = document.getElementById('employeeSelect').value;
      document.getElementById('f_department').value = (document.getElementById('deptSelect').value || '' );
      document.getElementById('f_nonce').value      = randomNonce();
    }

    async function submitAction(action) {
      const now = Date.now();
      if (busy) return;
      if (now - lastActionAt < CLICK_COOLDOWN_MS) return;

      if (!deptSel.value){ setText(statusEl,'Alege departamentul.','err'); return; }
      if (!empSel.value){ setText(statusEl,'SelecteazƒÉ angajat.','err'); return; }
      if (!actSel.value){ setText(statusEl,'Alege tip de activitate.','err'); return; }

      const actNorm = String(action).toLowerCase().replace(/[-\s]+/g,'_');
      const isCom = isComercialDept();

      if (isCom && (actNorm==='extra_start' || actNorm==='extra_finish')){
        setText(statusEl,'Departamentul Comercial nu poate folosi ore EXTRA.','warn'); return;
      }
      if (!isCom && !locInput.value.trim()){
        setText(statusEl,'Scrie clientul/loca»õia.','err'); locInput.focus(); return;
      }
      if (['concediu de odihna','concediu medical','concediu pentru ore suplimentare'].includes((actSel.value||'').toLowerCase())){
        setText(statusEl,'Pentru concediu folose»ôte ‚ÄûTrimite cererea de concediu‚Äù.','warn'); return;
      }

      busy = true; setUILock(true); disableAllButtons(true);
      const lockStart = Date.now();
      setText(statusEl,'Verific starea‚Ä¶','');

      try{
        const g = await guardRemote(empSel.value.trim(), action);
        if (!g.ok){ setText(statusEl, g.msg || 'Ac»õiune blocatƒÉ de regulile de pontaj.','warn'); return; }

        setText(statusEl,'Se ob»õine loca»õia GPS‚Ä¶','');
        const gps = await geolocateOnce();

        const ts = new Date().toISOString();
        setFormPayload(action, ts, gps);
        document.getElementById('gform').submit();

        setText(statusEl,`Trimis ‚úì (${actNorm.toUpperCase()}).`,'ok');

        await sleep(1200);
        try{
          const stats = await fetchStats(empSel.value.trim());
          if (stats){
            if (actNorm==='finish'){
              showToast(`<b>${empSel.value}</b><div class="small">Azi ‚Äî Ore: <b>${stats.totalHours}</b> h ‚Ä¢ Suplimentar: <b>${stats.overtime}</b> h</div>`, 'ok');
            } else if (actNorm==='extra_finish'){
              showToast(`<b>${empSel.value}</b><div class="small">Azi ‚Äî Extra: <b>${stats.extra}</b> h</div>`, 'ok');
            }
          }
        }catch{}
      }catch(err){
        setText(statusEl, String(err && err.message ? err.message : err), 'err');
      }finally{
        const elapsed = Date.now() - lockStart;
        if (elapsed < GUARD_MIN_LOCK_MS) await sleep(GUARD_MIN_LOCK_MS - elapsed);
        lastActionAt = Date.now();
        await sleep(CLICK_COOLDOWN_MS);
        busy = false; setUILock(false); disableAllButtons(false);
      }
    }

    function wireButtons(){
      document.getElementById('btnStart').addEventListener('click', ()=>submitAction('start'));
      document.getElementById('btnPause').addEventListener('click', ()=>submitAction('pause'));
      document.getElementById('btnUnpause').addEventListener('click', ()=>submitAction('unpause'));
      document.getElementById('btnFinish').addEventListener('click', ()=>submitAction('finish'));
      document.getElementById('btnExtraStart').addEventListener('click', ()=>submitAction('extra_start'));
      document.getElementById('btnExtraFinish').addEventListener('click', ()=>submitAction('extra_finish'));
    }

    (async function init(){
      try {
        const r = await fetch('config.json?v=' + Date.now(), {cache:'no-store'});
        if (!r.ok) throw new Error('HTTP ' + r.status);
        CFG = await r.json();
        if (!CFG.formAction || !CFG.fields) throw new Error('Config incomplet');
        setText(cfgEl,'Config √ÆncƒÉrcat','ok');
        window.CFG = CFG;
      } catch (e) {
        setText(cfgEl,'Eroare config: ' + (e.message||e),'err');
        disableAllButtons(true); return;
      }

      // mapare c√¢mpuri
      (function bindCFGToForm(){
        const names = CFG.fields;
        const idMap = {
          'f_action':   names.action,
          'f_timestamp':names.timestamp,
          'f_name':     names.name,
          'f_activity': names.activityType,
          'f_location': names.location,
          'f_lat':      names.latitude,
          'f_lon':      names.longitude,
          'f_acc':      names.accuracy,
          'f_device':   names.device,
          'f_notes':    names.notes,
          'f_maps':     names.mapsLink,
          'f_department': names.department || ''
        };
        Object.entries(idMap).forEach(([id,name]) => {
          const el = document.getElementById(id);
          if (name) el.setAttribute('name', name);
        });
        // leave form
        if (CFG.leaveFormAction && CFG.leaveFields) {
          const m = CFG.leaveFields;
          const map = {
            'lv_name':  m.name,
            'lv_type':  m.activityType,
            'lv_email': m.personalEmail,
            'lv_start': m.startDate,
            'lv_end':   m.endDate,
            'lv_notes': m.notes,
            'lv_ts':    m.timestamp
          };
          Object.entries(map).forEach(([id, name]) => {
            const el = document.getElementById(id);
            if (el && name) el.setAttribute('name', name);
          });
          document.getElementById('leaveForm').action = CFG.leaveFormAction;
        }
      })();

      // load departamente + angaja»õi
      async function parseDepartmentsCSV(text){
        if (text && text.charCodeAt && text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
        text = (text || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
        if (!text) return { byDept:new Map(), byName:new Map(), deptList:[] };

        const lines = text.split('\n').filter(Boolean);
        const sep = (text.indexOf(';') > -1 && (text.indexOf(';') < text.indexOf(','))) ? ';' : ',';

        let start = 0, depCol = 0, nameCol = 1;
        const hdr = lines[0].split(sep).map(s=>s.trim().replace(/^"|"$/g,'').toLowerCase());
        if (hdr.some(h => /depart|dept/.test(h)) || hdr.some(h => /angajat|nume|employee|name/.test(h))) {
          const d = hdr.findIndex(h => /depart|dept/.test(h));
          const n = hdr.findIndex(h => /angajat|nume|employee|name/.test(h));
          if (d >= 0) depCol = d;
          if (n >= 0) nameCol = n;
          start = 1;
        }

        const byDept = new Map();
        const byName = new Map();

        for (let i=start;i<lines.length;i++){
          const cells = lines[i].split(sep).map(s=>s.trim().replace(/^"|"$/g,''));
          const dep = (cells[depCol]||'').trim();
          const nm  = (cells[nameCol]||'').trim();
          if (!dep || !nm) continue;
          if (!byDept.has(dep)) byDept.set(dep, []);
          byDept.get(dep).push(nm);
          byName.set(nm, dep);
        }

        const deptList = Array.from(byDept.keys()).sort((a,b)=>a.localeCompare(b,'ro'));
        for (const d of byDept.keys()) byDept.get(d).sort((a,b)=>a.localeCompare(b,'ro'));
        return { byDept, byName, deptList };
      }

      async function loadDepartments(){
        try{
          if (CFG.departmentsCsv){
            const url = CFG.departmentsCsv + (CFG.departmentsCsv.includes('?') ? '&' : '?') + 'v=' + Date.now();
            const r = await fetch(url, {cache:'no-store'});
            if (r.ok){
              const txt = await r.text();
              const map = await parseDepartmentsCSV(txt);
              if (map.deptList.length){
                DEPTMAP = map;
                fillDepartments(map.deptList);
                setText(empStatus,'Departamente √ÆncƒÉrcate din departmentsCsv.','ok');
                return;
              }
            }
          }
        }catch(e){}

        let fallbackEmployees = [];
        try {
          if (CFG.employeesCsv){
            const url = CFG.employeesCsv + (CFG.employeesCsv.includes('?') ? '&' : '?') + 'v=' + Date.now();
            const r = await fetch(url, {cache:'no-store'});
            if (r.ok) fallbackEmployees = parseEmployeesCSV(await r.text());
          }
        } catch(e){}
        if (!fallbackEmployees.length && Array.isArray(CFG.employees)) fallbackEmployees = CFG.employees.slice();
        if (!fallbackEmployees.length) fallbackEmployees = document.getElementById('employees-inline').textContent.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

        const byDept = new Map([['productie', fallbackEmployees]]);
        const byName = new Map(fallbackEmployees.map(nm => [nm, 'productie']));
        const deptList = ['productie'];
        DEPTMAP = { byDept, byName, deptList };
        fillDepartments(deptList);
        setText(empStatus,'Nu existƒÉ departmentsCsv ‚Äî folosesc ‚Äûproductie‚Äù.','warn');
      }

      function fillDepartments(deptList){
        const sel = document.getElementById('deptSelect');
        sel.innerHTML = '';
        const ph = document.createElement('option');
        ph.value=''; ph.textContent='Alege departamentul...'; ph.disabled = true; ph.selected = true;
        sel.appendChild(ph);
        deptList.forEach(d => { const o=document.createElement('option'); o.value=d; o.textContent=d; sel.appendChild(o); });
      }
      function fillEmployeesFromDept(dept){
        const sel = document.getElementById('employeeSelect');
        sel.innerHTML = '';
        const ph = document.createElement('option');
        ph.value=''; ph.textContent= dept ? 'Alege angajat‚Ä¶' : 'Alege departamentul mai √Ænt√¢i‚Ä¶';
        ph.disabled = true; ph.selected = true;
        sel.appendChild(ph);
        if (!dept) return;
        const list = (DEPTMAP.byDept.get(dept) || []);
        list.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
      }

      await loadDepartments();
      fillEmployeesFromDept('');

      // evenimente UI
      document.getElementById('deptSelect').addEventListener('change', () => {
        fillEmployeesFromDept(document.getElementById('deptSelect').value);
        if (extraBar) extraBar.style.display = isComercialDept() ? 'none' : '';
      });

      const LEAVE_TYPES = new Set(['concediu de odihna','concediu medical','concediu pentru ore suplimentare']);
      document.getElementById('activitySelect').addEventListener('change', () => {
        const isLeave = LEAVE_TYPES.has((document.getElementById('activitySelect').value||'').toLowerCase());
        document.getElementById('leavePanel').style.display = isLeave ? '' : 'none';
        disableTimeButtons(isLeave);
      });

      // Butoane
      function submitActionProxy(type){
        return ()=>submitAction(type);
      }
      document.getElementById('btnStart').addEventListener('click', submitActionProxy('start'));
      document.getElementById('btnPause').addEventListener('click', submitActionProxy('pause'));
      document.getElementById('btnUnpause').addEventListener('click', submitActionProxy('unpause'));
      document.getElementById('btnFinish').addEventListener('click', submitActionProxy('finish'));
      document.getElementById('btnExtraStart').addEventListener('click', submitActionProxy('extra_start'));
      document.getElementById('btnExtraFinish').addEventListener('click', submitActionProxy('extra_finish'));

      // Leave submit
      document.getElementById('btnLeave').addEventListener('click', async () => {
        const deptSel = document.getElementById('deptSelect');
        const empSel  = document.getElementById('employeeSelect');
        const actSel  = document.getElementById('activitySelect');
        const leaveStart = document.getElementById('leaveStart');
        const leaveEnd   = document.getElementById('leaveEnd');
        const leaveEmail = document.getElementById('leaveEmail');
        const leaveNotes = document.getElementById('leaveNotes');
        const leaveStatus = document.getElementById('leaveStatus');

        function setLeaveStatus(m, c){ setText(leaveStatus, m, c); }

        setLeaveStatus('', '');
        if (!deptSel.value) { setLeaveStatus('Alege departamentul.', 'err'); return; }
        if (!empSel.value)  { setLeaveStatus('SelecteazƒÉ angajat.', 'err'); return; }
        const tip = (actSel.value || '').toLowerCase();
        if (!LEAVE_TYPES.has(tip)) { setLeaveStatus('Alege un tip de concediu.', 'err'); return; }
        const sd = leaveStart.value;
        const ed = leaveEnd.value;
        if (!sd || !ed) { setLeaveStatus('CompleteazƒÉ intervalul (start‚Äìsf√¢r»ôit).', 'err'); return; }
        if (ed < sd) { setLeaveStatus('Data de sf√¢r»ôit nu poate fi √Ænainte de start.', 'err'); return; }
        const email = (leaveEmail.value || '').trim();
        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { setLeaveStatus('Email personal invalid.', 'err'); return; }

        setLeaveStatus('Se trimite cererea‚Ä¶', '');

        let formSubmitted = false;
        if (CFG.leaveFormAction && CFG.leaveFields) {
          try {
            document.getElementById('lv_name').value  = empSel.value;
            document.getElementById('lv_type').value  = tip;
            document.getElementById('lv_email').value = email;
            document.getElementById('lv_start').value = sd;
            document.getElementById('lv_end').value   = ed;
            document.getElementById('lv_notes').value = (leaveNotes.value || '');
            document.getElementById('lv_ts').value    = new Date().toISOString();
            document.getElementById('leaveForm').submit();
            formSubmitted = true;
          } catch (e) { console.warn('Leave Form submit failed', e); }
        }

        let endpointOk = false, endpointMsg = '';
        if (CFG.leaveEndpoint) {
          try {
            document.getElementById('lv_ts').value = new Date().toISOString();
            const payload = {
              name: empSel.value,
              activityType: tip,
              startDate: sd,
              endDate: ed,
              personalEmail: email,
              notes: (leaveNotes.value || '')
            };
            const res = await sendLeave(payload);
            endpointOk = true;
            endpointMsg = res && res.zile ? (' (√ÆnregistratƒÉ ' + res.zile + ' zile)') : '';
          } catch (err) { console.warn('Leave endpoint error:', err); }
        }

        if (formSubmitted || endpointOk) {
          setLeaveStatus('Cerere trimisƒÉ' + endpointMsg + '. HR a fost notificat.', 'ok');
        } else {
          setLeaveStatus('Eroare: nu s-a putut trimite cererea (Form/Endpoint).', 'err');
        }
      });

    })();
  })();
  </script>
</body>
</html>
