/***************************************
 * PONTAJ — Code.gs (complet, cu EXTRA și normalizare acțiuni)
 * - Start / Pause / Unpause / Finish
 * - Extra Start / Extra Finish (ore extra, separat)
 * - Coloane: Durata (ore), Suplimentar (h), Extra (h), Indicator
 * - Foi statistici: Ore zilnice, Total lunar, Ore suplimentare, Ore extra
 * - PDF rapoarte: zilnic & săptămânal (EXTRA separat în zilnic)
 * - WebApp:
 *     GET  ?fn=state&name=...   -> starea curentă (running/paused/extra)
 *     POST ?fn=guard {name,action} -> validare acțiune (gard)
 *     POST (fără fn sau fn=leave)  -> cerere concediu (HR)
 ***************************************/

/*********************** UTILITARE GENERALE ************************/

function _norm(s){ return String(s == null ? '' : s).trim(); }
function _deaccent(s){ s=String(s==null?'':s); try{return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');}catch(e){return s;} }

function _getHeaders(sh){
  if (!sh) throw new Error('Sheet missing');
  var lastCol = sh.getLastColumn();
  if (!lastCol) return [];
  return sh.getRange(1,1,1,lastCol).getValues()[0].map(function(x){ return String(x); });
}
function _findCol(headers, keys){
  if (!headers || !headers.length) return 0;
  var keysN = keys.map(function(k){ return _deaccent(String(k).toLowerCase()); });
  for (var i = 0; i < headers.length; i++) {
    var h = _deaccent(String(headers[i]).toLowerCase());
    for (var k = 0; k < keysN.length; k++) {
      if (h.indexOf(keysN[k]) >= 0) return i + 1;
    }
  }
  return 0;
}

function _toDate(v){
  if (Object.prototype.toString.call(v) === '[object Date]') return isNaN(v) ? null : v;
  if (typeof v === 'string'){
    var s = v.replace(' ', 'T');
    var d = new Date(s);
    if (!isNaN(d)) return d;
  }
  return null;
}
function _num(v){
  if (v === null || v === undefined) return 0;
  if (typeof v === 'number') return isNaN(v) ? 0 : v;
  if (typeof v === 'string'){
    var s = v.trim().replace(',', '.'); var n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }
  return 0;
}
function _asHours(v){
  if (v === null || v === undefined) return 0;
  if (typeof v === 'number') return v;
  if (Object.prototype.toString.call(v) === '[object Date]'){
    var msInDay = 24 * 3600 * 1000;
    var ms = v.getTime() % msInDay;
    return Math.round((ms / 36e5) * 100) / 100;
  }
  if (typeof v === 'string'){
    var s = v.trim();
    if (/^\d{1,2}:\d{1,2}(:\d{1,2})?$/.test(s)){
      var parts = s.split(':'), h = _num(parts[0]), m = _num(parts[1]), sec = parts[2] ? _num(parts[2]) : 0;
      return Math.round((h + m/60 + sec/3600) * 100) / 100;
    }
    s = s.replace(',', '.'); var n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }
  return 0;
}
function _round2(n){ return Math.round(n * 100) / 100; }

function _isActivity(v){
  var a = _norm(v).toLowerCase();
  var set = {
    'atelier':1,'deplasare':1,'pe drum':1,'birou + deplasare':1,
    'birou-lucrare':1,'ofertare':1,'concediu de odihna':1,
    'concediu medical':1,'zi libera legala':1,'birou-administrativ':1,
    'home office':1,'invoire':1,'concediu pentru ore suplimentare':1
  };
  return !!set[a];
}
function _stdHoursForActivity(act){
  var a = _norm(act).toLowerCase();
  if (a === 'atelier' || a === 'deplasare' || a === 'pe drum' || a === 'birou + deplasare') return 8.5;
  return 8.0;
}
function _getResponsesSheet_(ss){
  var sheets = ss.getSheets();
  for (var i=0;i<sheets.length;i++){
    var nm = String(sheets[i].getName());
    var nmn = _deaccent(nm.toLowerCase());
    if (/responses/.test(nmn) || /raspuns/.test(nmn)) return sheets[i];
  }
  return ss.getSheets()[0];
}

/** Normalizare ACȚIUNI (spații/cratime → underscore + sinonime) */
function _normAction(a){
  var s = _norm(a).toLowerCase().replace(/[-\s]+/g,'_');
  if (s === 'resume') s = 'unpause';
  if (s === 'stop')   s = 'finish';
  if (s === 'extra start')  s = 'extra_start';
  if (s === 'extra finish') s = 'extra_finish';
  return s;
}

/*********************** INDICATOR (bulină) ************************/

function _removeIndicatorCF_(sh, cInd){
  var rules = sh.getConditionalFormatRules(), keep=[];
  for (var i=0;i<rules.length;i++){
    var r = rules[i], rgs = r.getRanges(), hit=false;
    if (rgs && rgs.length){
      for (var j=0;j<rgs.length;j++){
        var rg = rgs[j];
        if (rg && rg.getColumn() <= cInd && (rg.getColumn()+rg.getNumColumns()-1) >= cInd){ hit=true; break; }
      }
    }
    if (!hit) keep.push(r);
  }
  if (keep.length !== rules.length) sh.setConditionalFormatRules(keep);
}

function paintOneIndicatorRow_(sh, row, cDur, cInd, cAct, cLoc){
  if (!cDur || !cInd || row < 2) return;
  var valDur = sh.getRange(row, cDur).getValue();
  var dur = _asHours(valDur);

  var act = cAct ? _norm(sh.getRange(row, cAct).getDisplayValue()) : '';
  if (!act && cLoc){
    var maybe = _norm(sh.getRange(row, cLoc).getDisplayValue());
    if (_isActivity(maybe)) act = maybe;
  }
  var std = _stdHoursForActivity(act);

  var headers = _getHeaders(sh);
  var cOT = _findCol(headers, ['suplimentar (h)','overtime','suplimentar']);
  if (cOT){
    var ot = Math.max(0, _round2(dur - std));
    sh.getRange(row, cOT).setNumberFormat('0.00').setValue(ot);
  }
  sh.getRange(row, cInd).setValue('');

  var bg = null;
  if (dur > 0){
    if (dur < std) bg = '#F87171';
    else if (Math.abs(dur - std) < 1e-9) bg = '#4ADE80';
    else bg = '#C084FC';
  }
  sh.getRange(row, cInd, 1, 1).setBackground(bg || null);
}

function repaintAllIndicators_(){
  var ss = SpreadsheetApp.getActive();
  var sh = _getResponsesSheet_(ss);
  var headers = _getHeaders(sh);
  var cDur = _findCol(headers, ['durata (ore)','duration(h)','durata']);
  var cInd = _findCol(headers, ['indicator','bulina','indicator bulina']);
  var cAct = _findCol(headers, ['tip de activitate','activity type','tip activitate','activitate']);
  var cLoc = _findCol(headers, ['locație','locatie','location']);
  if (!cDur || !cInd) return;
  _removeIndicatorCF_(sh, cInd);
  var last = Math.max(2, sh.getLastRow());
  for (var r=2; r<=last; r++){
    paintOneIndicatorRow_(sh, r, cDur, cInd, cAct, cLoc);
  }
}

/*********************** PAUSE HELPER ************************/

function _sumPausedMsForInterval_(data, iNm, iAc, iTs, name, tStart, tFinish){
  var evts = [];
  for (var i=0;i<data.length;i++){
    var n = _norm(data[i][iNm]); if (n !== name) continue;
    var a = _normAction(data[i][iAc]);
    if (a !== 'pause' && a !== 'unpause') continue;
    var t = _toDate(data[i][iTs]); if (!t) continue;
    if (t <= tStart || t > tFinish) continue;
    evts.push({t:t, a:a});
  }
  evts.sort(function(x,y){ return x.t - y.t; });

  var pausedMs = 0, openPauseAt = null;
  for (var j=0;j<evts.length;j++){
    var e = evts[j];
    if (e.a === 'pause'){
      if (openPauseAt === null){ openPauseAt = e.t; }
    } else if (e.a === 'unpause'){
      if (openPauseAt !== null){
        pausedMs += (e.t.getTime() - openPauseAt.getTime());
        openPauseAt = null;
      }
    }
  }
  if (openPauseAt !== null){
    pausedMs += (tFinish.getTime() - openPauseAt.getTime());
  }
  return Math.max(0, pausedMs);
}

/*********************** HANDLERS FORM/EDIT ************************/

function onFormSubmit(e){
  var sh = e.range.getSheet();
  var headers = _getHeaders(sh);

  var cTs = headers.indexOf('Timestamp') + 1; 
  if (!cTs) cTs = _findCol(headers, ['timestamp','data','ora']);
  var cAc = _findCol(headers, ['action','actiune','acțiune']);
  var cNm = _findCol(headers, ['name','nume','angajat']);
  var cActType = _findCol(headers, ['tip de activitate','activity type','tip activitate','activitate']);
  var cLoc = _findCol(headers, ['locație','locatie','location']);
  if(!cTs || !cAc || !cNm) return;

  var row = e.range.getRow();
  var action = _normAction(sh.getRange(row, cAc).getDisplayValue());
  // interes doar pentru acțiuni de timp
  if(['finish','start','pause','unpause','extra_start','extra_finish'].indexOf(action) === -1) return;

  // asigură coloanele necesare
  var cDur = _findCol(headers, ['durata (ore)','duration(h)','durata']);
  if(!cDur){
    sh.insertColumnAfter(headers.length);
    cDur = headers.length + 1;
    sh.getRange(1, cDur).setValue('Durata (ore)');
    sh.getRange(2, cDur, Math.max(1, sh.getMaxRows()-1), 1).setNumberFormat('0.00');
    headers = _getHeaders(sh);
  }
  var cInd = _findCol(headers, ['indicator','bulina','indicator bulina']);
  if(!cInd){
    sh.insertColumnAfter(sh.getLastColumn());
    cInd = sh.getLastColumn();
    sh.getRange(1, cInd).setValue('Indicator');
    headers = _getHeaders(sh);
  }
  var cOT = _findCol(headers, ['suplimentar (h)','overtime','suplimentar']);
  if(!cOT){
    sh.insertColumnAfter(sh.getLastColumn());
    cOT = sh.getLastColumn();
    sh.getRange(1, cOT).setValue('Suplimentar (h)');
    sh.getRange(2, cOT, Math.max(1, sh.getMaxRows()-1), 1).setNumberFormat('0.00');
    headers = _getHeaders(sh);
  }
  var cEX = _findCol(headers, ['extra (h)','extra']);
  if(!cEX){
    sh.insertColumnAfter(sh.getLastColumn());
    cEX = sh.getLastColumn();
    sh.getRange(1, cEX).setValue('Extra (h)');
    sh.getRange(2, cEX, Math.max(1, sh.getMaxRows()-1), 1).setNumberFormat('0.00');
    headers = _getHeaders(sh);
  }

  var name = _norm(sh.getRange(row, cNm).getDisplayValue());
  var cTsIdx = cTs-1, cAcIdx = cAc-1, cNmIdx = cNm-1;
  var tsFinish = _toDate(sh.getRange(row, cTs).getValue());

  if(action === 'finish' || action === 'extra_finish'){
    if(tsFinish){
      var data = sh.getRange(2, 1, Math.max(0, sh.getLastRow()-1), sh.getLastColumn()).getValues();

      var lookFor = (action === 'finish') ? 'start' : 'extra_start';
      var startTime = null;
      // caută ultimul START/EXTRA_START fără FINISH ulterior
      for(var i=data.length-1;i>=0;i--){
        var n = _norm(data[i][cNmIdx]);
        var a = _normAction(data[i][cAcIdx]);
        var t = _toDate(data[i][cTsIdx]);
        if(n===name && a===lookFor && t && t<=tsFinish){ startTime=t; break; }
        if(n===name && (a==='finish' || a==='extra_finish') && t && t<=tsFinish) break;
      }

      if(startTime){
        if (action === 'finish'){
          var pausedMs = _sumPausedMsForInterval_(data, cNmIdx, cAcIdx, cTsIdx, name, startTime, tsFinish);
          var gross = tsFinish.getTime() - startTime.getTime();
          var net = Math.max(0, gross - pausedMs);
          var hours = _round2(net/36e5);
          sh.getRange(row, cDur).setNumberFormat('0.00').setValue(hours);
          sh.getRange(row, cInd).setValue('');
        } else {
          var grossE = tsFinish.getTime() - startTime.getTime();
          var hE = _round2(grossE/36e5);
          sh.getRange(row, cEX).setNumberFormat('0.00').setValue(hE);
        }
      } else {
        if (action === 'finish'){ sh.getRange(row, cDur).setValue(''); }
        if (action === 'extra_finish'){ sh.getRange(row, cEX).setValue(''); }
        sh.getRange(row, cInd).setValue('');
      }
    }
  } else {
    // start/pause/unpause/extra_start -> doar resetăm indicatorul
    sh.getRange(row, cInd).setValue('');
  }

  _removeIndicatorCF_(sh, cInd);
  var cAct = _findCol(headers, ['tip de activitate','activity type','tip activitate','activitate']);
  paintOneIndicatorRow_(sh, row, cDur, cInd, cAct, cLoc);

  try { buildDailySummary(); } catch (err) { Logger.log(err); }
  try { buildMonthlyTotals(); } catch (err) { Logger.log(err); }
  try { buildOvertimeSheet(); } catch (err) { Logger.log(err); }
  try { buildExtraSheet(); } catch (err) { Logger.log(err); }
}

function onEdit(e){
  if (!e || !e.range) return;
  var sh = e.range.getSheet();
  var row = e.range.getRow(), col = e.range.getColumn();
  if (row < 2) return;

  var headers = _getHeaders(sh);
  var cDur = _findCol(headers, ['durata (ore)','duration(h)','durata']);
  var cAct = _findCol(headers, ['tip de activitate','activity type','tip activitate','activitate']);
  var cLoc = _findCol(headers, ['locație','locatie','location']);
  var cInd = _findCol(headers, ['indicator','bulina','indicator bulina']);
  if (!cDur || !cInd) return;

  if (col !== cDur && col !== cAct && col !== cLoc) return;

  var rawDur = sh.getRange(row, cDur).getValue();
  var dur = _asHours(rawDur);
  sh.getRange(row, cDur).setNumberFormat('0.00').setValue(dur);
  sh.getRange(row, cInd).setValue('');

  _removeIndicatorCF_(sh, cInd);
  paintOneIndicatorRow_(sh, row, cDur, cInd, cAct, cLoc);
}

/*********************** CONFIG RAPOARTE & DRIVE ************************/

const REPORTS_PARENT_ID = "16FqKRS76NbU8TQhj9Ype3-orcSSHWn_Y"; // schimbă dacă vrei alt folder

function _getReportsRoot_() {
  if (REPORTS_PARENT_ID && REPORTS_PARENT_ID.trim()) {
    try { return DriveApp.getFolderById(REPORTS_PARENT_ID.trim()); }
    catch (e) { Logger.log("Folder ID invalid sau inaccesibil: " + e); }
  }
  return DriveApp.getRootFolder();
}
function _ensureFolder_(parent, name){
  var it = parent.getFoldersByName(name);
  return it.hasNext() ? it.next() : parent.createFolder(name);
}
function _moveFileToFolder_(file, destFolder){
  try { file.moveTo(destFolder); }
  catch (err) {
    try { destFolder.addFile(file); DriveApp.getRootFolder().removeFile(file); }
    catch(e2){ Logger.log('Nu am putut muta fișierul: ' + (e2 && e2.message ? e2.message : e2)); }
  }
}

/*********************** SHEET BUILDERS ************************/

function _ensureSheet_(ss, name, headers) {
  var sh = ss.getSheetByName(name) || ss.insertSheet(name);
  sh.clearContents();
  if (headers && headers.length) {
    sh.getRange(1, 1, 1, headers.length).setValues([headers]);
    sh.getRange(1, 1, 1, headers.length).setFontWeight('bold');
  }
  return sh;
}

/** Ore zilnice: Nume | Data | Ore | Suplimentar (h) | Extra (h) */
function buildDailySummary(){
  var ss = SpreadsheetApp.getActive();
  var formSh = _getResponsesSheet_(ss);
  var headers = _getHeaders(formSh);

  var cTs  = headers.indexOf('Timestamp') + 1; if(!cTs)  cTs  = _findCol(headers,['timestamp','data','ora']);
  var cNm  = _findCol(headers,['name','nume','angajat']);
  var cDur = _findCol(headers,['durata (ore)','duration(h)','durata']);
  var cOT  = _findCol(headers,['suplimentar (h)','overtime','suplimentar']);
  var cEX  = _findCol(headers,['extra (h)','extra']);
  if(!cTs || !cNm || !cDur){
    Logger.log('buildDailySummary: coloane lipsă');
    _ensureSheet_(ss,'Ore zilnice',['Nume','Data','Ore','Suplimentar (h)','Extra (h)']).autoResizeColumns(1,5);
    PropertiesService.getScriptProperties().setProperty('daily_details_json', JSON.stringify({}));
    return;
  }

  var last = Math.max(2, formSh.getLastRow());
  if (last < 2) {
    _ensureSheet_(ss, 'Ore zilnice', ['Nume','Data','Ore','Suplimentar (h)','Extra (h)']).autoResizeColumns(1,5);
    PropertiesService.getScriptProperties().setProperty('daily_details_json', JSON.stringify({}));
    return;
  }

  var vals = formSh.getRange(2,1,last-1, formSh.getLastColumn()).getValues();
  var map = {}; // key = "Nume|yyyy-mm-dd" -> {h, ot, ex}
  var tz = Session.getScriptTimeZone();

  for (var i=0;i<vals.length;i++){
    var ts = _toDate(vals[i][cTs-1]); if(!ts) continue;
    var name = _norm(vals[i][cNm-1]); if(!name) continue;
    var h = _asHours(vals[i][cDur-1]);
    var ot = cOT ? _num(vals[i][cOT-1]) : Math.max(0, h - 8);
    var ex = cEX ? _num(vals[i][cEX-1]) : 0;

    if(!(h>0) && !(ex>0)) continue;

    var d = new Date(ts); d.setHours(0,0,0,0);
    var dayStr = Utilities.formatDate(d, tz, 'yyyy-MM-dd');
    var key = name + '|' + dayStr;
    if (!map[key]) map[key] = {h:0, ot:0, ex:0};
    if (h>0){ map[key].h  += h; map[key].ot += (cOT ? ot : Math.max(0,h-8)); }
    if (ex>0){ map[key].ex += ex; }
  }

  var out = [['Nume','Data','Ore','Suplimentar (h)','Extra (h)']];
  Object.keys(map).sort().forEach(function(k){
    var p = k.split('|'), v = map[k];
    out.push([p[0], p[1], _round2(v.h), _round2(v.ot), _round2(v.ex)]);
  });

  var sh = _ensureSheet_(ss, 'Ore zilnice', out[0]);
  if (out.length > 1) {
    sh.getRange(2,1,out.length-1, out[0].length).setValues(out.slice(1));
    sh.getRange(2,3, out.length-1, 3).setNumberFormat('0.00');
  }
  sh.autoResizeColumns(1,5);

  PropertiesService.getScriptProperties().setProperty('daily_details_json', JSON.stringify(map));
}

/** Total lunar (include Extra separat) */
function buildMonthlyTotals(){
  var ss = SpreadsheetApp.getActive();
  var daily = ss.getSheetByName('Ore zilnice');
  var t = _ensureSheet_(ss, 'Total lunar', ['Nume','Luna','Total ore','Suplimentar (h)','Extra (h)']);

  if (!daily || daily.getLastRow() < 2) { t.autoResizeColumns(1,5); return; }

  var vals = daily.getRange(2,1,daily.getLastRow()-1, 5).getValues(); // Nume, Data, Ore, OT, EX
  var map = {}; // key = "Nume|YYYY-MM" -> {h, ot, ex}

  for (var i=0;i<vals.length;i++){
    var n  = _norm(vals[i][0]);
    var ds = vals[i][1];
    var h  = _num(vals[i][2]);
    var ot = _num(vals[i][3]);
    var ex = _num(vals[i][4]);
    if(!n || !ds) continue;
    var d = new Date(ds); if(isNaN(d)) continue;
    var ym = d.getFullYear()+'-'+('0'+(d.getMonth()+1)).slice(-2);
    var key = n+'|'+ym;
    if(!map[key]) map[key] = {h:0, ot:0, ex:0};
    map[key].h += h; map[key].ot += ot; map[key].ex += ex;
  }

  var out = [['Nume','Luna','Total ore','Suplimentar (h)','Extra (h)']];
  Object.keys(map).sort().forEach(function(k){
    var p=k.split('|'); var v=map[k];
    out.push([p[0], p[1], _round2(v.h), _round2(v.ot), _round2(v.ex)]);
  });

  if (out.length > 1) {
    t.getRange(2,1,out.length-1, out[0].length).setValues(out.slice(1));
    t.getRange(2,3, out.length-1, 3).setNumberFormat('0.00');
  }
  t.autoResizeColumns(1,5);
}

/** Ore suplimentare (OT > 0) */
function buildOvertimeSheet(){
  var ss = SpreadsheetApp.getActive();
  var daily = ss.getSheetByName('Ore zilnice');
  var sh = _ensureSheet_(ss, 'Ore suplimentare', ['Nume','Data','Suplimentar (h)']);

  if (!daily || daily.getLastRow() < 2) { sh.autoResizeColumns(1,3); return; }

  var vals = daily.getRange(2,1,daily.getLastRow()-1, 5).getValues(); // Nume, Data, Ore, OT, EX
  var out = [['Nume','Data','Suplimentar (h)']];
  for (var i=0;i<vals.length;i++){
    var n  = _norm(vals[i][0]);
    var ds = vals[i][1];
    var ot = _num(vals[i][3]);
    if (ot > 0) out.push([n, ds, _round2(ot)]);
  }

  if (out.length > 1) {
    sh.getRange(2,1,out.length-1, 3).setValues(out.slice(1));
    sh.getRange(2,3, out.length-1, 1).setNumberFormat('0.00');
  }
  sh.autoResizeColumns(1,3);
}

/** Ore extra (doar extra) */
function buildExtraSheet(){
  var ss = SpreadsheetApp.getActive();
  var daily = ss.getSheetByName('Ore zilnice');
  var sh = _ensureSheet_(ss, 'Ore extra', ['Nume','Data','Extra (h)']);

  if (!daily || daily.getLastRow() < 2) { sh.autoResizeColumns(1,3); return; }

  var vals = daily.getRange(2,1,daily.getLastRow()-1, 5).getValues(); // Nume, Data, Ore, OT, EX
  var out = [['Nume','Data','Extra (h)']];
  for (var i=0;i<vals.length;i++){
    var n  = _norm(vals[i][0]);
    var ds = vals[i][1];
    var ex = _num(vals[i][4]);
    if (ex > 0) out.push([n, ds, _round2(ex)]);
  }

  if (out.length > 1) {
    sh.getRange(2,1,out.length-1, 3).setValues(out.slice(1));
    sh.getRange(2,3, out.length-1, 1).setNumberFormat('0.00');
  }
  sh.autoResizeColumns(1,3);
}

/** Rebuild complet */
function rebuildAllReports(){
  buildDailySummary();
  buildMonthlyTotals();
  buildOvertimeSheet();
  buildExtraSheet();
}

/*********************** PDF RAPOARTE ************************/

function dailyReports(){
  var ss = SpreadsheetApp.getActive();
  var formSh = _getResponsesSheet_(ss);
  var headers = _getHeaders(formSh);

  var cTs=_findCol(headers,['timestamp','data','ora']); if(!cTs) cTs = headers.indexOf('Timestamp')+1;
  var cNm=_findCol(headers,['name','nume']);
  var cDur=_findCol(headers,['durata (ore)','duration(h)','durata']);
  var cOT =_findCol(headers,['suplimentar (h)','overtime','suplimentar']);
  var cEX=_findCol(headers,['extra (h)','extra']);
  var cAct=_findCol(headers,['tip de activitate','activity type','tip activitate','activitate']);
  var cLoc=_findCol(headers,['locație','locatie','location']);
  if(!cTs||!cNm||!cDur) return;

  var tz = Session.getScriptTimeZone();
  var now = new Date();
  var start = new Date(now); start.setDate(now.getDate()-1); start.setHours(0,0,0,0);
  var end   = new Date(start); end.setHours(23,59,59,999);
  var dayStr = Utilities.formatDate(start, tz, 'yyyy-MM-dd');

  var lastRow=Math.max(2, formSh.getLastRow());
  var vals=formSh.getRange(2,1,lastRow-1, formSh.getLastColumn()).getValues();

  var byEmp = {};
  for (var i=0;i<vals.length;i++){
    var ts=_toDate(vals[i][cTs-1]); if(!ts) continue;
    if (ts < start || ts > end) continue;
    var n=_norm(vals[i][cNm-1]); if(!n) continue;

    var h=_asHours(vals[i][cDur-1]); var ot=cOT? _num(vals[i][cOT-1]) : Math.max(0,h-8);
    var ex=cEX? _num(vals[i][cEX-1]) : 0;
    var act=cAct? _norm(vals[i][cAct-1]) : '';
    var loc=cLoc? _norm(vals[i][cLoc-1]) : '';

    if (!byEmp[n]) byEmp[n] = { totalH:0, totalOT:0, totalEX:0, rows:[], extra:[] };
    if (h>0){
      byEmp[n].totalH += h;
      byEmp[n].totalOT += ot;
      byEmp[n].rows.push({ time: Utilities.formatDate(ts, tz, 'HH:mm'), act: act, loc: loc, h: _round2(h), ot: _round2(ot) });
    }
    if (ex>0){
      byEmp[n].totalEX += ex;
      byEmp[n].extra.push({ time: Utilities.formatDate(ts, tz, 'HH:mm'), act: act, loc: loc, h: _round2(ex) });
    }
  }

  var root = _getReportsRoot_();
  var f1 = _ensureFolder_(root, 'Pontaj - Rapoarte Zilnice');
  var year = Utilities.formatDate(start, tz, 'yyyy');
  var month = Utilities.formatDate(start, tz, 'yyyy-MM');
  var f2 = _ensureFolder_(f1, year);
  var f3 = _ensureFolder_(f2, month);
  var f4 = _ensureFolder_(f3, dayStr);

  var empNames = Object.keys(byEmp);
  for (var e=0; e<empNames.length; e++){
    var name = empNames[e];
    var info = byEmp[name];

    var doc = DocumentApp.create('Raport Zilnic - ' + name + ' - ' + dayStr);
    var b = doc.getBody();
    b.appendParagraph('Raport Zilnic Pontaj').setHeading(DocumentApp.ParagraphHeading.HEADING1);
    b.appendParagraph('Angajat: ' + name).setHeading(DocumentApp.ParagraphHeading.HEADING2);
    b.appendParagraph('Data: ' + dayStr);
    b.appendParagraph(' ');

    if (info.rows.length){
      var table = b.appendTable([['Ora', 'Tip activitate', 'Locație', 'Ore', 'Suplimentar (h)']]);
      table.getRow(0).editAsText().setBold(true);
      info.rows.sort(function(a,b){ return a.time.localeCompare(b.time); });
      info.rows.forEach(function(rw){
        var tr = table.appendTableRow();
        tr.appendTableCell(String(rw.time));
        tr.appendTableCell(String(rw.act || ''));
        tr.appendTableCell(String(rw.loc || ''));
        tr.appendTableCell(String(rw.h));
        tr.appendTableCell(String(rw.ot));
      });
      b.appendParagraph('Total ore: ' + _round2(info.totalH) + ' h').setBold(true);
      b.appendParagraph('Suplimentar total: ' + _round2(info.totalOT) + ' h').setBold(true);
      b.appendParagraph(' ');
    }

    if (info.extra.length){
      b.appendParagraph('Ore EXTRA').setHeading(DocumentApp.ParagraphHeading.HEADING2);
      var tableE = b.appendTable([['Ora', 'Tip activitate', 'Locație', 'Extra (h)']]);
      tableE.getRow(0).editAsText().setBold(true);
      info.extra.sort(function(a,b){ return a.time.localeCompare(b.time); });
      info.extra.forEach(function(rw){
        var tr = tableE.appendTableRow();
        tr.appendTableCell(String(rw.time));
        tr.appendTableCell(String(rw.act || ''));
        tr.appendTableCell(String(rw.loc || ''));
        tr.appendTableCell(String(rw.h));
      });
      b.appendParagraph('Total EXTRA: ' + _round2(info.totalEX) + ' h').setBold(true);
    }

    doc.saveAndClose(); Utilities.sleep(500);
    var file = DriveApp.getFileById(doc.getId());
    _moveFileToFolder_(file, f4);
    var pdf = file.getAs('application/pdf');
    var pdfName = 'Raport_Zilnic_' + name + '_' + dayStr + '.pdf';
    f4.createFile(pdf).setName(pdfName);
  }
}

function weeklyReports(){
  var ss=SpreadsheetApp.getActive();
  var formSh=_getResponsesSheet_(ss);
  var headers=_getHeaders(formSh);
  var cTs=_findCol(headers,['timestamp','data','ora']); if(!cTs) cTs=headers.indexOf('Timestamp')+1;
  var cNm=_findCol(headers,['name','nume']);
  var cDur=_findCol(headers,['durata (ore)','duration(h)','durata']);
  var cOT=_findCol(headers,['suplimentar (h)','overtime','suplimentar']);
  var cEX=_findCol(headers,['extra (h)','extra']);
  if(!cTs||!cNm||!cDur) return;

  // săptămâna anterioară completă (Luni-Duminică)
  var now=new Date(); var day=now.getDay();
  var todayIs = (day+6)%7; // 0 = Luni
  var start=new Date(now); start.setDate(now.getDate()-todayIs-7); start.setHours(0,0,0,0);
  var end=new Date(start); end.setDate(start.getDate()+6); end.setHours(23,59,59,999);

  var vals=formSh.getRange(2,1, Math.max(0,formSh.getLastRow()-1), formSh.getLastColumn()).getValues();
  var perEmp={}, dayNames=['Luni','Marti','Miercuri','Joi','Vineri','Sambata','Duminica'];
  for(var i=0;i<vals.length;i++){
    var ts=_toDate(vals[i][cTs-1]); var n=_norm(vals[i][cNm-1]);
    var h=_asHours(vals[i][cDur-1]); var ot=cOT? _num(vals[i][cOT-1]) : Math.max(0,h-8);
    var ex=cEX? _num(vals[i][cEX-1]) : 0;
    if(!ts||!n) continue; if(ts<start||ts>end) continue;
    var dn=dayNames[(ts.getDay()+6)%7];
    if(!perEmp[n]) perEmp[n]={days:{}, total:0, totalOT:0, totalEX:0};
    if (h>0){
      if(!perEmp[n].days[dn]) perEmp[n].days[dn]={h:0,ot:0,ex:0};
      perEmp[n].days[dn].h+=h; perEmp[n].days[dn].ot+=ot; perEmp[n].total+=h; perEmp[n].totalOT+=ot;
    }
    if (ex>0){
      if(!perEmp[n].days[dn]) perEmp[n].days[dn]={h:0,ot:0,ex:0};
      perEmp[n].days[dn].ex+=ex; perEmp[n].totalEX+=ex;
    }
  }

  var tz = Session.getScriptTimeZone();
  var root=_getReportsRoot_();
  var fYear=_ensureFolder_(root, Utilities.formatDate(start, tz,'yyyy'));
  var fWeek=_ensureFolder_(fYear, Utilities.formatDate(start, tz,'YYYY-ww'));

  Object.keys(perEmp).forEach(function(name){
    var info=perEmp[name];
    var doc=DocumentApp.create('Raport '+name+' '+Utilities.formatDate(start, tz,'yyyy-MM-dd'));
    var b=doc.getBody();
    b.appendParagraph('Raport săptămânal pontaj').setHeading(DocumentApp.ParagraphHeading.HEADING1);
    b.appendParagraph('Angajat: '+name).setHeading(DocumentApp.ParagraphHeading.HEADING2);
    b.appendParagraph('Interval: '+Utilities.formatDate(start, tz,'yyyy-MM-dd')+' — '+Utilities.formatDate(end, tz,'yyyy-MM-dd'));
    b.appendParagraph(' ');
    var table=b.appendTable([['Zi','Ore','Suplimentar (h)','Extra (h)']]); table.getRow(0).editAsText().setBold(true);
    for (var d=0; d<dayNames.length; d++){
      var dn = dayNames[d], row = (info.days[dn]||{h:0,ot:0,ex:0});
      var tr = table.appendTableRow();
      tr.appendTableCell(dn);
      tr.appendTableCell(String(_round2(row.h)));
      tr.appendTableCell(String(_round2(row.ot)));
      tr.appendTableCell(String(_round2(row.ex)));
    }
    b.appendParagraph('Total: '+_round2(info.total)+' h').setBold(true);
    b.appendParagraph('Suplimentar total: '+_round2(info.totalOT) + ' h').setBold(true);
    b.appendParagraph('Total EXTRA: '+_round2(info.totalEX) + ' h').setBold(true);
    doc.saveAndClose(); Utilities.sleep(500);

    var file=DriveApp.getFileById(doc.getId());
    _moveFileToFolder_(file, fWeek);
    var blob=file.getAs('application/pdf'); 
    var pdfName='Raport_'+name+'_'+Utilities.formatDate(start, tz,'yyyy-MM-dd')+'.pdf'; 
    fWeek.createFile(blob).setName(pdfName);
  });
}

/*********************** CONCEDII — WEB APP ************************/

var HR_TO = 'office@servelect.ro'; // destinatar notificări HR
var LEAVE_TYPES = {
  'concediu de odihna': true,
  'concediu medical': true,
  'concediu pentru ore suplimentare': true
};

function ensureConcediiSheet_() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sh = ss.getSheetByName('Concedii');
  if (!sh) sh = ss.insertSheet('Concedii');
  if (sh.getLastRow() === 0) {
    sh.appendRow(['Data cererii','Nume','Tip concediu','Start','Sfârșit','Zile','Email personal','Notă','Status email']);
    sh.getRange('A2:A').setNumberFormat('yyyy-MM-dd HH:mm');
    sh.getRange('D2:E').setNumberFormat('yyyy-MM-dd');
    sh.getRange('F2:F').setNumberFormat('0');
  }
  return sh;
}

function safeSendEmail(opts) {
  var BLOCKED_RECIPIENTS = [/@googlegroups\.com$/i];
  var toList = String(opts.to || '')
    .split(',')
    .map(function(s){ return s.trim(); })
    .filter(function(addr){
      return addr && !BLOCKED_RECIPIENTS.some(function(rx){ return rx.test(addr); });
    });
  if (!toList.length) { Logger.log('safeSendEmail: destinatar blocat/gol: ' + JSON.stringify(opts)); return; }
  opts.to = toList.join(', ');
  MailApp.sendEmail(opts);
}

function jsonResp_(obj){
  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}

/*********************** WEBAPP: STATE & GUARD & LEAVE ************************/

// ——— Determină starea curentă din răspunsuri (cross-device)
function _computeStateForName_(name){
  var ss = SpreadsheetApp.getActive();
  var sh = _getResponsesSheet_(ss);
  var headers = _getHeaders(sh);
  if (!headers.length || sh.getLastRow() < 2) {
    return {
      ok:true, state:{
        name:name||'',
        normal:{running:false, paused:false},
        extra:{running:false},
        lastNormalStart:null,lastNormalFinish:null,
        lastExtraStart:null,lastExtraFinish:null
      }
    };
  }
  var cTs  = headers.indexOf('Timestamp')+1 || _findCol(headers,['timestamp','data','ora']);
  var cNm  = _findCol(headers,['name','nume']);
  var cAc  = _findCol(headers,['action','actiune','acțiune']);
  if (!cTs||!cNm||!cAc) {
    return { ok:true, state:{ name:name||'', normal:{running:false,paused:false}, extra:{running:false} } };
  }

  var vals = sh.getRange(2,1,sh.getLastRow()-1, sh.getLastColumn()).getValues();
  // doar ale lui "name", sortate crescător după timp
  var rows = [];
  for (var i=0;i<vals.length;i++){
    var n=_norm(vals[i][cNm-1]);
    if (name && n!==name) continue;
    var a=_normAction(vals[i][cAc-1]);
    var t=_toDate(vals[i][cTs-1]);
    if (!t) continue;
    rows.push({t:t,a:a});
  }
  rows.sort(function(x,y){ return x.t - y.t; });

  var state = {
    name:name||'',
    normal:{running:false, paused:false},
    extra:{running:false},
    lastNormalStart:null,lastNormalFinish:null,
    lastExtraStart:null,lastExtraFinish:null
  };

  var pauseOpen=false;
  for (var r=0;r<rows.length;r++){
    var a = rows[r].a, t = rows[r].t.toISOString();
    if (a==='start'){ state.normal.running=true; state.normal.paused=false; state.lastNormalStart=t; }
    else if (a==='pause' && state.normal.running){ state.normal.paused=true; pauseOpen=true; }
    else if (a==='unpause' && state.normal.running){ state.normal.paused=false; pauseOpen=false; }
    else if (a==='finish'){ state.normal.running=false; state.normal.paused=false; state.lastNormalFinish=t; pauseOpen=false; }
    else if (a==='extra_start'){ state.extra.running=true; state.lastExtraStart=t; }
    else if (a==='extra_finish'){ state.extra.running=false; state.lastExtraFinish=t; }
  }
  return { ok:true, state:state };
}

// ——— Validează o acțiune pe baza stării actuale
function _guardAction_(state, action){
  action = _normAction(action);

  var running = state.normal.running;
  var paused  = state.normal.paused;
  var extraR  = state.extra.running;

  switch(action){
    case 'start':
      if (running)  return {ok:false,msg:'Ai deja START activ.'};
      if (extraR)   return {ok:false,msg:'Finalizează „EXTRA” înainte de START.'};
      return {ok:true};
    case 'pause':
      if (!running) return {ok:false,msg:'Nu poți PAUSE fără START.'};
      if (paused)   return {ok:false,msg:'Ești deja în PAUSE.'};
      return {ok:true};
    case 'unpause':
      if (!running) return {ok:false,msg:'Nu poți UNPAUSE fără START.'};
      if (!paused)  return {ok:false,msg:'Nu ești în PAUSE.'};
      return {ok:true};
    case 'finish':
      if (!running) return {ok:false,msg:'Nu poți FINISH fără START.'};
      return {ok:true};
    case 'extra_start':
      if (running)  return {ok:false,msg:'Închide norma (FINISH) înainte de EXTRA START.'};
      if (extraR)   return {ok:false,msg:'EXTRA este deja pornit.'};
      return {ok:true};
    case 'extra_finish':
      if (!extraR)  return {ok:false,msg:'Nu poți EXTRA FINISH fără EXTRA START.'};
      return {ok:true};
    default:
      return {ok:false,msg:'Acțiune necunoscută: '+action};
  }
}

// ——— doGet: state endpoint
function doGet(e){
  var fn = (e && e.parameter && e.parameter.fn) ? String(e.parameter.fn) : '';
  if (fn === 'state'){
    var name = (e && e.parameter && e.parameter.name) ? String(e.parameter.name) : '';
    if (!name) return jsonResp_({ok:false, error:'Lipsește param name'});
    return jsonResp_(_computeStateForName_(name));
  }
  // fallback
  return ContentService.createTextOutput('Servelect Web App activ').setMimeType(ContentService.MimeType.TEXT);
}

// ——— doPost: guard sau leave
function doPost(e) {
  try {
    var fn = (e && e.parameter && e.parameter.fn) ? String(e.parameter.fn) : 'leave';
    var payload = (e && e.postData && e.postData.contents) ? e.postData.contents : '{}';
    var data = {};
    try { data = JSON.parse(payload); } catch(_) { data={}; }

    if (fn === 'guard'){
      var nameG = _norm(data.name||'');
      var action = _normAction(data.action);
      if (!nameG) return jsonResp_({ok:false, msg:'Lipsește name'});
      if (!action) return jsonResp_({ok:false, msg:'Lipsește action'});
      var st = _computeStateForName_(nameG);
      if (!st.ok) return jsonResp_({ok:false, msg:'Nu pot obține starea.'});
      var g = _guardAction_(st.state, action);
      return jsonResp_(g);
    }

    // === leave (implicit) ===
    var name = String(data.name || '').trim();
    var activityType = String(data.activityType || '').trim().toLowerCase();
    var startDateStr = String(data.startDate || '').trim();
    var endDateStr   = String(data.endDate || '').trim();
    var personalEmail = String(data.personalEmail || '').trim();
    var notes = String(data.notes || '').trim();

    if (!name) return jsonResp_({ok:false, error:'Lipsește numele'});
    if (!LEAVE_TYPES[activityType]) return jsonResp_({ok:false, error:'Tip concediu nevalid'});
    if (!startDateStr || !endDateStr) return jsonResp_({ok:false, error:'Lipsesc datele de început/sfârșit'});
    if (!personalEmail || !/.+@.+\..+/.test(personalEmail)) return jsonResp_({ok:false, error:'Email personal invalid'});

    var startDate = new Date(startDateStr);
    var endDate   = new Date(endDateStr);
    if (isNaN(startDate) || isNaN(endDate)) return jsonResp_({ok:false, error:'Date invalide'});
    if (endDate < startDate) return jsonResp_({ok:false, error:'Sfârșitul < început'});

    var zile = Math.floor((endDate - startDate)/(1000*60*60*24)) + 1;

    var sh = ensureConcediiSheet_();
    sh.appendRow([ new Date(), name, activityType, startDate, endDate, zile, personalEmail, notes, 'În așteptare' ]);
    var row = sh.getLastRow();

    var subject = 'Cerere concediu - ' + name + ' (' + zile + ' zile)';
    var body =
      'A fost trimisă o nouă cerere de concediu:\n\n' +
      'Angajat: ' + name + '\n' +
      'Tip concediu: ' + activityType + '\n' +
      'Interval: ' + startDate.toDateString() + ' - ' + endDate.toDateString() + ' (' + zile + ' zile)\n' +
      'Email personal: ' + personalEmail + '\n' +
      'Notă: ' + (notes || '(niciuna)') + '\n\n' +
      '---\nAcest mesaj a fost generat automat.';

    try {
      safeSendEmail({ to: HR_TO, subject: subject, body: body, replyTo: personalEmail, name: name + ' (Servelect Pontaj)' });
      safeSendEmail({ to: personalEmail, subject: '[Copie] ' + subject, body: body, name: 'Servelect Pontaj' });
      sh.getRange(row, 9).setValue('Trimis ✓');
    } catch (sendErr) {
      sh.getRange(row, 9).setValue('Eroare: ' + String(sendErr));
    }
    return jsonResp_({ ok:true, zile:zile, sentTo: HR_TO });

  } catch (err) {
    return jsonResp_({ ok:false, error: String(err) });
  }
}

/*********************** DIAGNOSTIC ************************/

function showExecutionContext() {
  var user = Session.getActiveUser().getEmail();
  var tz = Session.getScriptTimeZone();
  var root = _getReportsRoot_();
  Logger.log('Execută ca: ' + user);
  Logger.log('Time zone: ' + tz);
  Logger.log('Folder rădăcină rapoarte: ' + root.getName() + ' | URL: ' + root.getUrl());
}
function smokeDrive() {
  var root = _getReportsRoot_();
  var testFolder = _ensureFolder_(root, 'TEST_Pontaj');
  var f = testFolder.createFile('hello.txt', 'ok ' + new Date());
  Logger.log('Am scris: ' + f.getName() + ' | URL: ' + f.getUrl());
}
function forceDailyNow() { dailyReports(); Logger.log('dailyReports() rulat.'); }
function forceWeeklyNow(){ weeklyReports(); Logger.log('weeklyReports() rulat.'); }
function diagPontaj(){
  var ss = SpreadsheetApp.getActive();
  var sh = _getResponsesSheet_(ss);
  var headers = _getHeaders(sh);
  Logger.log('Sheet răspunsuri: ' + sh.getName());
  Logger.log('Antete: ' + JSON.stringify(headers));
  function col(keys){ return _findCol(headers, keys); }
  var cTs  = headers.indexOf('Timestamp')+1 || col(['timestamp','data','ora']);
  var cNm  = col(['name','nume','angajat']);
  var cAc  = col(['action','actiune','acțiune']);
  var cDur = col(['durata (ore)','duration(h)','durata']);
  Logger.log('cTs=' + cTs + ', cNm=' + cNm + ', cAc=' + cAc + ', cDur=' + cDur);
  Logger.log('Rows răspunsuri (fără header): ' + Math.max(0, sh.getLastRow()-1));
  rebuildAllReports();
  var dz = ss.getSheetByName('Ore zilnice');
  var ot = ss.getSheetByName('Ore suplimentare');
  var ex = ss.getSheetByName('Ore extra');
  var ml = ss.getSheetByName('Total lunar');
  Logger.log('Ore zilnice rows: ' + (dz ? dz.getLastRow() : 0));
  Logger.log('Ore suplimentare rows: ' + (ot ? ot.getLastRow() : 0));
  Logger.log('Ore extra rows: ' + (ex ? ex.getLastRow() : 0));
  Logger.log('Total lunar rows: ' + (ml ? ml.getLastRow() : 0));
}

function ensureFormSubmitTrigger(){
  // creează trigger „On form submit” pentru spreadsheetul curent, dacă nu există
  var ssId = SpreadsheetApp.getActive().getId();
  var has = ScriptApp.getProjectTriggers().some(function(t){
    return t.getTriggerSourceId() === ssId && t.getEventType() === ScriptApp.EventType.ON_FORM_SUBMIT;
  });
  if (!has){
    ScriptApp.newTrigger('onFormSubmit')
      .forSpreadsheet(ssId)
      .onFormSubmit()
      .create();
  }
  Logger.log('Trigger onFormSubmit: ' + (has ? 'DEJA EXISTĂ' : 'CREAT'));
}

/*********************** TRIGGERE (OPȚIONAL) ************************/
function createTimeTriggers(){
  ScriptApp.newTrigger('rebuildAllReports').timeBased().everyDays(1).atHour(0).nearMinute(30).create();
  ScriptApp.newTrigger('dailyReports').timeBased().everyDays(1).atHour(1).nearMinute(0).create();
  ScriptApp.newTrigger('weeklyReports').timeBased().onWeekDay(ScriptApp.WeekDay.MONDAY).atHour(7).create();
}
// ===== EOF =====
