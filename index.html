<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>test pontaj servelect</title>
  <link rel="icon" href="assets/favicon.png" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; background:#f8fafc; }
    .card { max-width: 900px; margin: 0 auto; padding: 18px; border-radius: 14px; background:#fff; box-shadow: 0 6px 24px rgba(0,0,0,.08); }
    h1 { font-size: 1.25rem; margin: 0 0 12px; }
    button { padding: 14px 16px; margin: 8px 8px 8px 0; border: 0; border-radius: 10px; font-size: 16px; cursor:pointer; }
    button.primary { background: #2563eb; color: white; }
    button.finish  { background: #16a34a; color: white; }
    button.pause   { background: #f59e0b; color: #111827; }
    button.unpause { background: #0ea5e9; color: white; }
    .row { margin: 10px 0; }
    input[type="text"], input[type="email"], input[type="date"], select { width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 15px; background: white; }
    .small { font-size: 0.9rem; color: #6b7280; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; }
    .ok { color: #16a34a; } .err { color: #dc2626; } .warn { color: #b45309; }
    .flex { display:flex; gap:16px; flex-wrap:wrap; }
    .col { flex:1 1 260px; min-width:260px; }
    .panel { border:1px dashed #cbd5e1; border-radius:12px; padding:12px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>TEST PONTAJ SERVELECT</h1>
    <p class="small">Alege <b>Angajat</b>, <b>Tip de activitate</b>, scrie <b>Locația</b>, apoi apasă <b>Start</b>, <b>Pause</b>, <b>Unpause</b> sau <b>Finish</b>.</p>

    <div id="cfg" class="small"></div>

    <div class="flex">
      <div class="col">
        <label class="small">Angajat</label>
        <select id="employeeSelect"><option>Se încarcă...</option></select>
        <div class="small" id="empStatus"></div>
      </div>

      <div class="col">
        <label class="small">Tip de activitate</label>
        <select id="activitySelect">
          <option value="" selected disabled>Alege tip...</option>
          <option>atelier</option>
          <option>birou-lucrare</option>
          <option>deplasare</option>
          <option>ofertare</option>
          <option>concediu de odihna</option>
          <option>concediu medical</option>
          <option>zi libera legala</option>
          <option>birou-administrativ</option>
          <option>home office</option>
          <option>invoire</option>
          <option>pe drum</option>
          <option>concediu pentru ore suplimentare</option>
          <option>birou + deplasare</option>
        </select>
        <div class="small"></div>
      </div>

      <div class="col">
        <label class="small">Locație (scrie locatia)</label>
        <input id="locationInput" type="text" placeholder="ex: Șantier B – Poartă 2" />
      </div>
    </div>

    <div class="row">
      <label class="small">Notă (opțional)</label>
      <input id="notes" type="text" placeholder="ex: Proiect X, client Y" />
    </div>

    <!-- === Panou concediu === -->
    <div id="leavePanel" class="row panel" style="display:none;">
      <div class="small" style="margin-bottom:8px;"><b>Cerere concediu</b> — completează intervalul de zile, emailul personal și o notă. Se trimite automat la office@servelect.ro.</div>
      <div class="flex">
        <div class="col">
          <label class="small">Data start</label>
          <input type="date" id="leaveStart" />
        </div>
        <div class="col">
          <label class="small">Data sfârșit</label>
          <input type="date" id="leaveEnd" />
        </div>
        <div class="col">
          <label class="small">Email personal</label>
          <input type="email" id="leaveEmail" placeholder="ex: prenume.nume@..." />
        </div>
      </div>
      <div class="row">
        <label class="small">Notă către HR (opțional)</label>
        <input type="text" id="leaveNotes" placeholder="ex: motiv / detalii" />
      </div>
      <div class="row">
        <button id="btnLeave" class="primary" type="button">Trimite cererea de concediu</button>
        <span class="small" id="leaveStatus"></span>
      </div>
    </div>
    <!-- === sfârșit panou concediu === -->

    <div class="row">
      <button class="primary" id="btnStart">Start</button>
      <button class="pause" id="btnPause">Pause</button>
      <button class="unpause" id="btnUnpause">Unpause</button>
      <button class="finish" id="btnFinish">Finish</button>
    </div>

    <div id="status" class="small"></div>
    <div id="last" class="small mono"></div>
  </div>

  <iframe name="hidden_iframe" style="display:none;"></iframe>

  <form id="gform" method="POST" target="hidden_iframe">
    <input type="hidden" id="f_action" />
    <input type="hidden" id="f_timestamp" />
    <input type="hidden" id="f_name" />
    <input type="hidden" id="f_activity" />
    <input type="hidden" id="f_location" />
    <input type="hidden" id="f_lat" />
    <input type="hidden" id="f_lon" />
    <input type="hidden" id="f_acc" />
    <input type="hidden" id="f_device" />
    <input type="hidden" id="f_notes" />
    <input type="hidden" id="f_maps" />
  </form>

  <form id="leaveFormFallback" method="POST" target="hidden_iframe" style="display:none;">
    <input type="hidden" name="name" />
    <input type="hidden" name="activityType" />
    <input type="hidden" name="startDate" />
    <input type="hidden" name="endDate" />
    <input type="hidden" name="personalEmail" />
    <input type="hidden" name="notes" />
  </form>

<script>
(async function() {
  const leaveTypes = new Set([
    'concediu de odihna',
    'concediu medical',
    'concediu pentru ore suplimentare'
  ]);

  const statusEl = document.getElementById('status');
  const cfgEl = document.getElementById('cfg');
  const lastEl = document.getElementById('last');
  const notesEl = document.getElementById('notes');
  const locInput = document.getElementById('locationInput');
  const empSel = document.getElementById('employeeSelect');
  const actSel = document.getElementById('activitySelect');
  const empStatus = document.getElementById('empStatus');
  const form = document.getElementById('gform');
  const leaveFormFallback = document.getElementById('leaveFormFallback');

  const leavePanel = document.getElementById('leavePanel');
  const leaveStart = document.getElementById('leaveStart');
  const leaveEnd = document.getElementById('leaveEnd');
  const leaveEmail = document.getElementById('leaveEmail');
  const leaveNotes = document.getElementById('leaveNotes');
  const leaveStatus = document.getElementById('leaveStatus');

  function setStatus(msg, cls) { statusEl.className = 'small ' + (cls||''); statusEl.textContent = msg; }
  function setCfg(msg, cls) { cfgEl.className = 'small ' + (cls||''); cfgEl.textContent = msg; }
  function setEmp(msg, cls) { empStatus.className = 'small ' + (cls||''); empStatus.textContent = msg; }
  function setLeaveStatus(msg, cls) { leaveStatus.className = 'small ' + (cls||''); leaveStatus.textContent = msg; }

  let CFG = null;
  try {
    const r = await fetch('config.json', {cache:'no-store'});
    if (!r.ok) throw new Error('HTTP ' + r.status);
    CFG = await r.json();
    if (!CFG.formAction || !CFG.fields) throw new Error('Config incomplet');
    setCfg('Config încărcat.', 'ok');
  } catch (e) {
    setCfg('Eroare config: ' + (e.message||e), 'err');
    disableAllButtons(true);
    return;
  }

  form.action = CFG.formAction;
  const names = CFG.fields;
  const idMap = {
    'f_action':   names.action,
    'f_timestamp':names.timestamp,
    'f_name':     names.name,
    'f_activity': names.activityType,
    'f_location': names.location,
    'f_lat':      names.latitude,
    'f_lon':      names.longitude,
    'f_acc':      names.accuracy,
    'f_device':   names.device,
    'f_notes':    names.notes,
    'f_maps':     names.mapsLink
  };
  Object.entries(idMap).forEach(([id,name]) => {
    const el = document.getElementById(id);
    if (name) el.setAttribute('name', name);
  });

  async function loadEmployees() {
    if (CFG.employeesCsv) {
      try {
        const r = await fetch(CFG.employeesCsv, {cache:'no-store'});
        if (!r.ok) throw new Error('CSV ' + r.status);
        const txt = await r.text();
        const rows = txt.trim().split(/\\r?\\n/).map(r=>r.split(','));
        const header = rows[0].map(h=>h.replace(/^\"|\"$/g,''));
        const idx = header.findIndex(h=>/angajat|nume/i.test(h));
        const list = rows.slice(1).map(row => {
          const clean = row.map(c => c.replace(/^\"|\"$/g,''));
          return clean[idx >= 0 ? idx : 0];
        }).filter(Boolean);
        fillEmployees(list);
        setEmp('Angajați încărcați din CSV.', 'ok');
        return;
      } catch (e) {
        setEmp('CSV angajați indisponibil, încerc config.json…', 'warn');
      }
    }
    fillEmployees(Array.isArray(CFG.employees) ? CFG.employees : []);
    setEmp('Angajați încărcați din config.json.', 'ok');
  }
  function fillEmployees(list){
    empSel.innerHTML = '';
    const ph = document.createElement('option');
    ph.value=''; ph.textContent='Alege angajat…'; ph.disabled = true; ph.selected = true;
    empSel.appendChild(ph);
    list.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; empSel.appendChild(o); });
  }
  await loadEmployees();

  actSel.addEventListener('change', () => {
    const isLeave = new Set(['concediu de odihna','concediu medical','concediu pentru ore suplimentare']).has((actSel.value||'').toLowerCase());
    leavePanel.style.display = isLeave ? '' : 'none';
    disableTimeButtons(isLeave);
  });

  function disableTimeButtons(disabled) {
    ['btnStart','btnPause','btnUnpause','btnFinish'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.disabled = !!disabled;
    });
  }
  function disableAllButtons(disabled){
    disableTimeButtons(disabled);
    const lbtn = document.getElementById('btnLeave');
    if (lbtn) lbtn.disabled = !!disabled;
  }

  // ====== Cerere concediu – application/x-www-form-urlencoded (fără CORS preflight) + fallback form ======
  document.getElementById('btnLeave').addEventListener('click', async () => {
    setLeaveStatus('', '');
    if (!empSel.value) { setLeaveStatus('Selectează angajat.', 'err'); return; }
    const tip = (actSel.value || '').toLowerCase();
    if (!new Set(['concediu de odihna','concediu medical','concediu pentru ore suplimentare']).has(tip)) { setLeaveStatus('Alege un tip de concediu.', 'err'); return; }

    const sd = leaveStart.value;
    const ed = leaveEnd.value;
    if (!sd || !ed) { setLeaveStatus('Completează intervalul (start și sfârșit).', 'err'); return; }
    if (ed < sd) { setLeaveStatus('Data de sfârșit nu poate fi înainte de start.', 'err'); return; }

    const email = (leaveEmail.value || '').trim();
    if (!email || !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) { setLeaveStatus('Email personal invalid.', 'err'); return; }

    if (!CFG.leaveEndpoint) { setLeaveStatus('Lipsește leaveEndpoint în config.json.', 'err'); return; }

    try {
      setLeaveStatus('Se trimite cererea…', '');
      const body = new URLSearchParams({
        name: empSel.value,
        activityType: tip,
        startDate: sd,
        endDate: ed,
        personalEmail: email,
        notes: (leaveNotes.value || '')
      });
      const res = await fetch(CFG.leaveEndpoint, { method: 'POST', body });
      let ok = false, zile = null;
      try {
        const txt = await res.text();
        const maybe = JSON.parse(txt);
        ok = !!maybe.ok;
        zile = maybe.zile;
      } catch(_){ ok = res.ok; }
      if (!ok) throw new Error('Răspuns invalid din server.');
      setLeaveStatus(`Cerere înregistrată. Email trimis către office@servelect.ro.`, 'ok');
      return;
    } catch (err) {
      try {
        leaveFormFallback.action = CFG.leaveEndpoint;
        leaveFormFallback.elements.namedItem('name').value = empSel.value;
        leaveFormFallback.elements.namedItem('activityType').value = tip;
        leaveFormFallback.elements.namedItem('startDate').value = sd;
        leaveFormFallback.elements.namedItem('endDate').value = ed;
        leaveFormFallback.elements.namedItem('personalEmail').value = email;
        leaveFormFallback.elements.namedItem('notes').value = (leaveNotes.value || '');
        leaveFormFallback.submit();
        setLeaveStatus('Cererea a fost trimisă (fallback). Verifică foaia „concedii”.', 'ok');
      } catch (e2) {
        setLeaveStatus('Eroare trimitere (fallback): ' + (e2.message||e2), 'err');
      }
    }
  });

  // ====== Pontaj clasic ======
  let busy = false;
  function submitAction(action) {
    if (busy) return;
    if (!empSel.value) { setStatus('Selectează angajat.', 'err'); return; }
    if (!actSel.value) { setStatus('Alege tip de activitate.', 'err'); return; }
    if (!locInput.value.trim()) { setStatus('Scrie o locație.', 'err'); locInput.focus(); return; }
    if (!('geolocation' in navigator)) { setStatus('Geolocație indisponibilă pe acest dispozitiv.', 'err'); return; }

    if (new Set(['concediu de odihna','concediu medical','concediu pentru ore suplimentare']).has((actSel.value||'').toLowerCase())) {
      setStatus('Pentru concediu folosește „Trimite cererea de concediu”.', 'warn');
      return;
    }

    busy = true; disableAllButtons(true);
    setStatus('Se obține locația GPS…');

    navigator.geolocation.getCurrentPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const acc = Math.round(pos.coords.accuracy || 0);
        const ts = new Date().toISOString();
        const maps = `https://maps.google.com/?q=${lat},${lon}`;

        document.getElementById('f_action').value = action;
        document.getElementById('f_timestamp').value = ts;
        document.getElementById('f_name').value = empSel.value;
        document.getElementById('f_activity').value = actSel.value;
        document.getElementById('f_location').value = locInput.value.trim();
        document.getElementById('f_lat').value = lat;
        document.getElementById('f_lon').value = lon;
        document.getElementById('f_acc').value = acc;
        document.getElementById('f_device').value = navigator.userAgent;
        document.getElementById('f_notes').value = (notesEl.value || '');
        document.getElementById('f_maps').value = maps;

        form.submit();
        setStatus(`Trimis ✓ (${action.toUpperCase()}). Verifică Google Sheet.`, 'ok');
        lastEl.textContent = JSON.stringify({
          action, timestamp: ts, angajat: empSel.value, activitate: actSel.value,
          locatie: locInput.value.trim(), latitude: lat, longitude: lon, accuracy: acc
        }, null, 2);

        setTimeout(()=>{ busy=false; disableAllButtons(false); }, 800);
      },
      err => {
        setStatus('Eroare locație: ' + err.message, 'err');
        busy=false; disableAllButtons(false);
      },
      { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
    );
  }

  document.getElementById('btnStart').addEventListener('click', ()=>submitAction('start'));
  document.getElementById('btnPause').addEventListener('click', ()=>submitAction('pause'));
  document.getElementById('btnUnpause').addEventListener('click', ()=>submitAction('unpause'));
  document.getElementById('btnFinish').addEventListener('click', ()=>submitAction('finish'));
})();
</script>
</body>
</html>
