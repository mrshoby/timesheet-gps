<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard</title>
  <style>
    :root{
      --bg:#f6f5ff;
      --card:#ffffff;
      --text:#16162b;
      --muted:#6e6e8e;
      --line:#ecebff;
      --shadow:0 10px 24px rgba(30, 20, 90, .06);
      --shadow2:0 6px 14px rgba(30, 20, 90, .05);
      --r:16px;
      --purple:#6c5ce7;
      --purple2:#8e44ad;
      --green:#2ecc71;
      --red:#ff5c5c;
      --blue:#4aa3ff;
      --gray:#9aa3b2;
      --orange:#f5a623;
      --cyan:#00c2ff;
      --pink:#ff4fd8;
    }
    html,body{height:100%;}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    /* Container */
    .wrap{
      padding: 18px 18px 26px;
      max-width: 1320px;
      margin: 0 auto;
    }

    /* Topbar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }
    .title{
      display:flex;
      align-items:baseline;
      gap:10px;
    }
    .title h1{
      margin:0;
      font-weight:700;
      font-size:18px;
      letter-spacing:.2px;
    }
    .title .sub{
      color:var(--muted);
      font-size:12px;
      font-weight:600;
    }
    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 8px 12px;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow: var(--shadow2);
    }
    .pill input{
      border:none;
      outline:none;
      font:inherit;
      width: 190px;
      background:transparent;
      color:var(--text);
    }
    .btn{
      border:none;
      background:var(--card);
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 9px 12px;
      cursor:pointer;
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      color:var(--text);
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background:var(--purple);
      box-shadow: 0 0 0 4px rgba(108,92,231,.15);
    }

    /* KPI grid */
    .kpi-grid{
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 12px;
      margin: 10px 0 16px;
    }
    @media (max-width: 1200px){
      .kpi-grid{ grid-template-columns: repeat(4, minmax(0,1fr)); }
    }
    @media (max-width: 860px){
      .kpi-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .pill input{ width: 140px; }
    }

    .kpi-card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow2);
      padding: 12px 14px 14px;
      position:relative;
      overflow:hidden;
      user-select:none;
    }
    .kpi-card::before{
      content:"";
      position:absolute;
      left:0; right:0; top:0;
      height:4px;
      background: var(--purple);
      opacity:.95;
    }
    .kpi-card[data-accent="gray"]::before{ background:#c7cbe3;}
    .kpi-card[data-accent="blue"]::before{ background:var(--blue);}
    .kpi-card[data-accent="red"]::before{ background:var(--red);}
    .kpi-card[data-accent="green"]::before{ background:var(--green);}
    .kpi-card[data-accent="purple"]::before{ background:var(--purple);}
    .kpi-card[data-accent="cyan"]::before{ background:var(--cyan);}
    .kpi-card[data-accent="orange"]::before{ background:var(--orange);}
    .kpi-card[data-accent="pink"]::before{ background:var(--pink);}

    .kpi-label{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.2px;
      margin-bottom: 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      min-height: 18px;
    }
    .kpi-label .chev{
      opacity:.65;
      font-weight:900;
      transform: translateY(-1px);
    }
    .kpi-value{
      font-size:22px;
      font-weight:800;
      letter-spacing:.2px;
      display:flex;
      align-items:baseline;
      gap:8px;
    }
    .kpi-small{
      margin-top: 8px;
      color:var(--muted);
      font-weight:600;
      font-size:12px;
    }

    /* Drag visuals */
    .kpi-card.dragging{
      opacity:.55;
      border-style:dashed;
    }

    /* Section */
    .section{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 14px 14px 8px;
      overflow:hidden;
    }
    .section-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 6px 6px 12px;
    }
    .section-head h2{
      margin:0;
      font-size:15px;
      font-weight:800;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .badge{
      font-size:11px;
      font-weight:800;
      color: var(--purple);
      background: rgba(108,92,231,.10);
      border: 1px solid rgba(108,92,231,.22);
      padding: 3px 8px;
      border-radius: 999px;
    }

    /* Table */
    .table-wrap{
      overflow:auto;
      border-top:1px solid var(--line);
    }
    table{
      border-collapse:separate;
      border-spacing:0;
      width: 100%;
      min-width: 1080px;
      font-size:13px;
    }
    thead th{
      position: sticky;
      top:0;
      z-index:5;
      background: #fff;
      border-bottom:1px solid var(--line);
      color: #2a2a45;
      font-size:11px;
      letter-spacing:.35px;
      text-transform:uppercase;
      font-weight:900;
      padding: 12px 10px;
    }
    tbody td{
      border-bottom:1px solid #f1f1ff;
      padding: 12px 10px;
      color: #1e1e36;
      vertical-align: middle;
    }
    tbody tr:hover td{ background: #fafaff; }
    th:first-child, td:first-child{
      position: sticky;
      left:0;
      z-index:4;
      background: #fff;
      border-right:1px solid var(--line);
    }
    tr:hover td:first-child{ background:#fafaff; }

    .emp{
      display:flex; align-items:center; gap:10px;
      min-width: 220px;
    }
    .idx{
      width:22px; text-align:center; color: var(--muted); font-weight:800;
    }
    .avatar{
      width:34px;height:34px;border-radius:50%;
      background: linear-gradient(135deg, rgba(108,92,231,.20), rgba(142,68,173,.18));
      display:grid; place-items:center;
      font-weight:900; color: var(--purple);
      border: 1px solid rgba(108,92,231,.20);
      flex:0 0 auto;
    }
    .emp-meta{display:flex; flex-direction:column; line-height:1.15;}
    .emp-name{ font-weight:900; }
    .emp-dept{ font-size:11px; color: var(--muted); font-weight:700; margin-top:2px; }

    .progress{
      height:10px;
      background:#eff0ff;
      border-radius:999px;
      overflow:hidden;
      border: 1px solid rgba(108,92,231,.12);
      min-width: 240px;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(46,204,113,.95), rgba(46,204,113,.55));
      border-radius:999px;
      transition: width .25s ease;
    }
    .muted{ color: var(--muted); font-weight:700; }
    .num{ font-weight:900; }
    .neg{ color: var(--red); font-weight:900; }
    .pos{ color: var(--green); font-weight:900; }

    .footnote{
      padding: 10px 6px 2px;
      color: var(--muted);
      font-weight:700;
      font-size:12px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .legend{
      display:flex; gap:14px; align-items:center; flex-wrap:wrap;
    }
    .leg{
      display:flex; align-items:center; gap:6px;
      font-weight:800;
    }
    .sw{
      width:10px; height:10px; border-radius:50%;
      background: var(--gray);
      box-shadow: 0 0 0 4px rgba(154,163,178,.18);
    }
    .sw.prog{ background: var(--purple); box-shadow:0 0 0 4px rgba(108,92,231,.16);}
    .sw.sub{ background: var(--red); box-shadow:0 0 0 4px rgba(255,92,92,.14);}
    .sw.ok{ background: var(--green); box-shadow:0 0 0 4px rgba(46,204,113,.14);}
    .sw.over{ background: var(--orange); box-shadow:0 0 0 4px rgba(245,166,35,.16);}
    .sw.off{ background: #cbd3e1; box-shadow:0 0 0 4px rgba(203,211,225,.18);}
    .sw.pause{ background: var(--pink); box-shadow:0 0 0 4px rgba(255,79,216,.14);}

    /* Skeleton / loading */
    .loading{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: 20px;
      padding: 18px;
      box-shadow: var(--shadow);
      margin-top: 10px;
      display:flex;
      align-items:center;
      gap:10px;
      color: var(--muted);
      font-weight:800;
    }
    .spinner{
      width:18px;height:18px;border-radius:50%;
      border: 3px solid rgba(108,92,231,.18);
      border-top-color: rgba(108,92,231,.85);
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to { transform: rotate(360deg); } }

  
    /* ===== Mini User Panel PRO (mov) ===== */
    .emp{display:flex; align-items:center; gap:10px;}
    .empBtn{margin-left:auto; width:34px; height:34px; border-radius:12px; border:1px solid rgba(108,92,231,.22);
      background: rgba(108,92,231,.10); color: var(--purple); cursor:pointer; display:grid; place-items:center;
      font-size:16px; font-weight:900; box-shadow: var(--shadow2);}
    .empBtn:hover{transform: translateY(-1px); background: rgba(108,92,231,.14);}
    .empBtn:active{transform: translateY(0px);}

    .upOverlay{position:fixed; inset:0; background: rgba(10, 8, 28, .55); display:none; align-items:center; justify-content:center; padding:18px; z-index: 9999;}
    .upOverlay.show{display:flex;}
    .upModal{
      width: 920px; max-width: 96vw;
      max-height: calc(100vh - 36px);
      overflow:auto;
      background: radial-gradient(1200px 700px at 20% 0%, rgba(155,127,255,.22) 0%, rgba(155,127,255,0) 45%),
                  radial-gradient(1000px 600px at 90% 10%, rgba(0,210,255,.10) 0%, rgba(0,210,255,0) 55%),
                  linear-gradient(180deg, #2b2357 0%, #231a49 100%);
      color: rgba(255,255,255,.92);
      border-radius: 26px;
      box-shadow: 0 22px 60px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.08);
      overflow:hidden;
      position:relative;
    }
    .upTop{
      display:flex; gap:16px; align-items:center;
      padding: 18px 18px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .upAvatar{
      width:54px;height:54px;border-radius:50%;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.10);
      display:grid;place-items:center;font-weight:900;
      overflow:hidden;
    }
    .upAvatar img{width:100%;height:100%;object-fit:cover;display:block;}
    .upWho{flex:1; min-width: 0;}
    .upName{display:flex; align-items:center; gap:10px; font-weight:950; font-size:22px; letter-spacing:.2px;}
    .upPill{padding:6px 10px; border-radius: 999px; background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.10);
      font-size:12px; font-weight:900; color: rgba(255,255,255,.85);}
    .upMeta{display:flex; gap:10px; flex-wrap:wrap; margin-top: 6px; font-size:12px; color: rgba(255,255,255,.65); font-weight:800;}
    .upMeta .m{display:flex; align-items:center; gap:6px;}
    .upActions{display:flex; gap:10px; align-items:center;}
    .upIcon{
      width:42px;height:42px;border-radius:14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      display:grid;place-items:center;
      cursor:pointer;
    }
    .upIcon:hover{background: rgba(255,255,255,.10);}
    .upClose{font-size:22px; line-height:0; font-weight:900;}

    .upBody{display:grid; grid-template-columns: 1.1fr .9fr; gap:16px; padding: 16px 18px 18px;}
    @media (max-width: 900px){
      .upBody{grid-template-columns: 1fr;}
    }
    .upCard{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding: 14px;
    }
    .upCard h3{
      margin:0 0 10px 0;
      font-size:14px;
      font-weight:950;
      color: rgba(255,255,255,.90);
      display:flex; align-items:center; justify-content:space-between;
    }
    .upCard h3 .hint{font-size:12px; font-weight:900; color: rgba(255,255,255,.55);}
    .upRow2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .upField label{display:block; font-size:12px; font-weight:900; color: rgba(255,255,255,.55); margin-bottom:6px;}
    .upField input, .upField select, .upField textarea{
      width:100%;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.10);
      color: rgba(255,255,255,.92);
      border-radius: 14px;
      padding: 10px 12px;
      font: inherit;
      outline: none;
    }
    .upField textarea{min-height: 44px; resize: vertical;}
    .upTabs{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .upChip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      font-weight:950;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .upChip.on{background: rgba(46, 204, 113, .18); border-color: rgba(46,204,113,.22);}
    .upChip.concediu.on{background: rgba(46, 204, 113, .18); border-color: rgba(46,204,113,.22);}
    .upChip.delegatie.on{background: rgba(241, 196, 15, .18); border-color: rgba(241,196,15,.22);}
    .upChip.telepasirea.on{background: rgba(52, 152, 219, .18); border-color: rgba(52,152,219,.22);}
    .upChip.invoire.on{background: rgba(155, 89, 182, .20); border-color: rgba(155,89,182,.25);}

    .evList{display:flex; flex-direction:column; gap:10px;}
    .evItem{
      display:grid;
      grid-template-columns: 26px 180px 1fr 44px;
      gap:10px;
      align-items:center;
      padding: 10px;
      border-radius: 16px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.08);
    }
    @media (max-width: 900px){
      .evItem{grid-template-columns: 26px 1fr 1fr 44px;}
    }
    .dot{width:12px;height:12px;border-radius:999px;}
    .dot.START{background:#48c9b0}
    .dot.PAUSE{background:#f1c40f}
    .dot.UNPAUSE{background:#f39c12}
    .dot.FINISH{background:#e74c3c}
    .dot.EXTRA_START{background:#a569bd}
    .dot.EXTRA_FINISH{background:#8e44ad}

    .evItem select, .evItem input{
      width:100%;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.10);
      color: rgba(255,255,255,.92);
      border-radius: 14px;
      padding: 10px 12px;
      font: inherit;
      outline:none;
    }
    .evDel{
      width:44px;height:44px;border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.9);
      display:grid;place-items:center;
      cursor:pointer;
      font-weight:950;
    }
    .evDel:hover{background: rgba(255,255,255,.10);}
    .upAdd{
      width:100%;
      border:1px dashed rgba(255,255,255,.18);
      background: transparent;
      color: rgba(255,255,255,.88);
      border-radius: 16px;
      padding: 12px 14px;
      cursor:pointer;
      font-weight:950;
    }
    .upAdd:hover{background: rgba(255,255,255,.06);}

    .barWrap{margin-top:12px;}
    .bar{
      height: 12px;
      border-radius: 999px;
      overflow:hidden;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      display:flex;
    }
    .seg{height:100%;}
    .seg.work{background: rgba(46, 204, 113, .65);}
    .seg.pause{background: rgba(241, 196, 15, .70);}
    .seg.extra{background: rgba(155, 89, 182, .65);}
    .barMeta{display:flex; justify-content:space-between; margin-top:8px; font-size:12px; font-weight:900; color: rgba(255,255,255,.70);}
    .statGrid{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .stat{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 10px 12px;
    }
    .stat .k{font-size:12px; font-weight:900; color: rgba(255,255,255,.55);}
    .stat .v{margin-top:6px; font-size:16px; font-weight:950;}
    .togRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px;}
    .toggle{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.08);
      font-weight:950;
      cursor:pointer;
      user-select:none;
    }
    .switch{
      width:40px;height:22px;border-radius: 999px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.12);
      position:relative;
    }
    .knob{
      width:18px;height:18px;border-radius: 999px;
      background: rgba(255,255,255,.92);
      position:absolute; top:1px; left:1px;
      transition: all .18s ease;
    }
    .toggle.on .switch{background: rgba(46, 204, 113, .55); border-color: rgba(46,204,113,.2);}
    .toggle.on .knob{left:21px;}

    .upFooter{
      display:flex; gap:12px; align-items:center; justify-content:flex-end;
      padding: 14px 18px 18px;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.06);
    }
    .btn{
      height: 46px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      padding: 0 16px;
      display:inline-flex; align-items:center; gap:10px;
      cursor:pointer;
      font-weight:950;
    }
    .btn:hover{background: rgba(255,255,255,.10);}
    .btn.primary{background: rgba(46, 204, 113, .85); border-color: rgba(46,204,113,.1); color:#0d2a1a;}
    .btn.primary:hover{filter:brightness(1.03);}
    .btn.danger{background: rgba(231, 76, 60, .18); border-color: rgba(231,76,60,.20);}
    .btn:disabled{opacity:.55; cursor:not-allowed;}

    .upErr{margin-top:10px; font-weight:900; color:#ffd1d1; display:none;}

  
    /* ===== Mini User Panel PRO fixes ===== */

    /* Ensure dashboard global .btn can't break modal buttons */
    .upModal .btn{
      position: relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 46px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      padding: 0 16px;
      gap:10px;
      cursor:pointer;
      font-weight:950;
      user-select:none;
      white-space:nowrap;
      min-width: 0;
    }
    .upModal .btn:hover{background: rgba(255,255,255,.10);}
    .upModal .btn.primary{background: rgba(46, 204, 113, .85); border-color: rgba(46,204,113,.1); color:#0d2a1a;}
    .upModal .btn.primary:hover{filter:brightness(1.03);}
    .upModal .btn.danger{background: rgba(231, 76, 60, .18); border-color: rgba(231,76,60,.20);}
    .upModal .btn:disabled{opacity:.55; cursor:not-allowed;}

    .upOverlay{ position: fixed !important; inset: 0 !important; width: 100vw !important; height: 100vh !important; z-index: 2147483647 !important; }
    .upOverlay.show{ display:flex !important; }
    .upModal, .upModal *, .upModal *::before, .upModal *::after{ box-sizing: border-box; }
    .upWho{min-width:0;}
    .upMeta{gap:10px; flex-wrap:wrap; align-items:center;}
    .upMeta .m{display:flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.07); border:1px solid rgba(255,255,255,.10);}
    .upMeta .mi{font-size:11px; font-weight:950; color: rgba(255,255,255,.65);}
    .upMeta .mv{font-size:11px; font-weight:950; color: rgba(255,255,255,.92); max-width: 260px; overflow:hidden; text-overflow: ellipsis; white-space:nowrap;}
    .upActions{flex-shrink:0;}

    .upNav{display:flex; gap:8px;}
    .upNav .btn{flex:1; justify-content:center;}

    .evItem{grid-template-columns: 18px minmax(140px, 1fr) 150px 44px;}
    .evItem select, .evItem input{min-width:0;}
    .evDel{flex-shrink:0;}

    /* Ruler + markers under timeline */
    .ruler{ position: relative; height: 64px; margin-top: 12px; border-radius: 16px;
      background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); overflow:hidden; }
    .rLine{ position:absolute; left:14px; right:14px; top: 22px; height:2px; border-radius:999px; background: rgba(255,255,255,.10); }
    .rMarks{ position:absolute; inset: 0; }
    .mark{ position:absolute; top: 8px; transform: translateX(-50%); width: 92px; text-align:center; pointer-events:none; }
    .mark .tick{ width:2px; height: 22px; margin: 0 auto; border-radius:999px; background: rgba(255,255,255,.70); }
    .mark .t{ margin-top: 6px; font-size: 11px; font-weight: 950; color: rgba(255,255,255,.92); }
    .mark .a{ margin-top: 3px; font-size: 10px; font-weight: 900; color: rgba(255,255,255,.72); }
    .mark .tag{ display:inline-flex; align-items:center; gap:6px; padding: 5px 8px; border-radius: 999px;
      background: rgba(0,0,0,.14); border: 1px solid rgba(255,255,255,.10); }
    .mark .dot2{ width:8px; height:8px; border-radius:999px; }
    .dot2.START{ background:#48c9b0; }
    .dot2.PAUSE{ background:#f1c40f; }
    .dot2.UNPAUSE{ background:#f39c12; }
    .dot2.FINISH{ background:#e74c3c; }
    .dot2.EXTRA_START{ background:#a569bd; }
    .dot2.EXTRA_FINISH{ background:#8e44ad; }

    .rList{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px; }
    .rChip{ display:inline-flex; align-items:center; gap:8px; padding: 8px 10px; border-radius: 14px;
      background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08); font-weight:950; }
    .rChip .tt{ font-size: 11px; color: rgba(255,255,255,.90); }
    .rChip .aa{ font-size: 11px; color: rgba(255,255,255,.70); }

  
    /* ===== Overlay lock + full-cover fix (prevents white area) ===== */
    html.up-lock, html.up-lock body{ overflow:hidden !important; height:100% !important; }
    .upOverlay{
      overflow:auto;
      position: fixed !important;
      top:0 !important; left:0 !important; right:0 !important; bottom:0 !important;
      width: 100vw !important; height: 100vh !important;
      margin:0 !important;
      transform: none !important;
      z-index: 2147483647 !important;
    }

    /* ===== Timeline (linii colorate + etichete) ===== */
    .tlWrap{margin-top:12px;}
    .tlTicks{
      display:flex; justify-content:space-between; align-items:center;
      font-size:12px; font-weight:950;
      color: rgba(255,255,255,.80);
      padding: 0 2px 8px;
    }
    .tlTrack{
      position:relative;
      height: 48px;
      border-radius: 16px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .tlBase{
      position:absolute; left:10px; right:10px; top:50%;
      height:2px; transform: translateY(-50%);
      background: rgba(255,255,255,.12);
    }
    .tlSeg{
      position:absolute; top:50%; height:6px;
      transform: translateY(-50%);
      border-radius: 999px;
      opacity:.95;
    }
    .tlSeg.work{ background: rgba(46, 204, 113, .85); }
    .tlSeg.pause{ background: rgba(241, 196, 15, .90); }
    .tlSeg.extra{ background: rgba(155, 89, 182, .85); }

    .tlMark{
      position:absolute; top:50%;
      width: 10px; height: 10px;
      transform: translate(-50%, -50%);
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.90);
      background: rgba(0,0,0,.35);
      box-shadow: 0 6px 14px rgba(0,0,0,.25);
    }
    .tlMark.START{ background: rgba(46,204,113,.95); }
    .tlMark.UNPAUSE{ background: rgba(46,204,113,.95); }
    .tlMark.PAUSE{ background: rgba(241,196,15,.98); }
    .tlMark.FINISH{ background: rgba(231,76,60,.95); }
    .tlMark.EXTRA_START{ background: rgba(155,89,182,.95); }
    .tlMark.EXTRA_FINISH{ background: rgba(155,89,182,.95); }

    .tlLegend{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:10px;
    }
    .tlChip2{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-weight:950; font-size:12px;
      color: rgba(255,255,255,.90);
    }
    .tlDot{width:10px;height:10px;border-radius:999px;}
    .tlDot.work{ background: rgba(46, 204, 113, .95); }
    .tlDot.pause{ background: rgba(241,196,15,.98); }
    .tlDot.finish{ background: rgba(231,76,60,.95); }
    .tlDot.extra{ background: rgba(155,89,182,.95); }
    .tlTime{opacity:.85;}
    .tlAct{opacity:.95;}

  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>Dashboard</h1>
        <div class="sub" id="lastUpdated">‚Äî</div>
      </div>

      <div class="actions">
        <div class="pill" title="CautƒÉ angajat √Æn rezumat">
          <span class="dot" aria-hidden="true"></span>
          <input id="searchEmployee" placeholder="CautƒÉ angajat" />
        </div>
        <button class="btn" id="btnRefresh" type="button">
          ‚Üª Refresh
        </button>
        <button class="btn" id="btnCalendar" type="button" title="Calendar prezen»õƒÉ">
          üìÖ Calendar
        </button>
        <button class="btn" id="btnAdminPanel" type="button" title="Admin Panel">
          üë§ Admin Panel
        </button>
      </div>
    </div>

    <div class="kpi-grid" id="kpiGrid" aria-label="KPI Cards">
      <!-- Cards are injected by JS (order persisted) -->
    </div>

    <div id="loading" class="loading">
      <div class="spinner" aria-hidden="true"></div>
      Se √ÆncarcƒÉ datele din adminEvents...
    </div>

    <div id="content" style="display:none;">
      <div class="section">
        <div class="section-head">
          <h2>
            <span style="display:inline-block;transform:translateY(-1px)">üóìÔ∏è</span>
            <span id="todayTitle">AstƒÉzi ‚Äî Rezumat</span>
            <span class="badge" id="employeeCountBadge">0 angaja»õi</span>
          </h2>
          <div class="pill" style="box-shadow:none;border-radius:12px;">
            <span style="color:var(--muted);font-weight:900;">üîé</span>
            <input id="tableSearch" placeholder="CautƒÉ angajat" style="width:180px;" />
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="min-width:260px;">Angajat</th>
                <th>Manager</th>
                <th style="min-width:280px;">Activitate</th>
                <th>Raport lunar p√¢nƒÉ la ziua curentƒÉ</th>
                <th>Balan»õƒÉ bancƒÉ de ore</th>
                <th>Zile concediu disponibile total</th>
                <th>Zile concediu disponibile la zi</th>
                <th>SolicitƒÉri de √Ænregistrat</th>
              </tr>
            </thead>
            <tbody id="summaryBody"></tbody>
          </table>
        </div>

        <div class="footnote">
          <span>Condi»õia de prezen»õƒÉ nu con»õine timp activ (pontaje ne√Æncheiate)</span>
          <div class="legend" aria-label="LegendƒÉ">
            <span class="leg"><span class="sw prog"></span>√én progres</span>
            <span class="leg"><span class="sw sub"></span>Sub normƒÉ</span>
            <span class="leg"><span class="sw ok"></span>Complet</span>
            <span class="leg"><span class="sw over"></span>Peste normƒÉ</span>
            <span class="leg"><span class="sw off"></span>Inactiv/absent</span>
            <span class="leg"><span class="sw pause"></span>√én pauzƒÉ</span>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ======= Config + Fetch =======
  let CFG = null;
  let ALL_EVENTS = [];
  let ROWS_CACHE = [];
  const TZ = 'Europe/Bucharest';
  const LS_ORDER_KEY = 'pv_admin_dashboard_card_order_v1';

  const CARD_DEFS = [
    // Look like Papervee
    {id:'workToday', label:'Timp total lucrat astƒÉzi', accent:'gray', format:'time'},
    {id:'pauseToday', label:'Timp total √Æn pauzƒÉ astƒÉzi', accent:'blue', format:'time'},
    {id:'activeNow', label:'Angaja»õi cu timp activ', accent:'purple'},
    {id:'underNorm', label:'Angaja»õi sub normƒÉ', accent:'red'},
    {id:'complete', label:'Angaja»õi cu timp complet', accent:'green', chev:true},
    {id:'overNorm', label:'Angaja»õi peste normƒÉ', accent:'orange'},
    {id:'inactive', label:'Angaja»õi inactivi', accent:'gray', chev:true},
    {id:'leave', label:'Angaja»õi √Æn concediu', accent:'blue'},
    {id:'event', label:'Angaja»õi √Æn eveniment', accent:'purple'},
    {id:'pausedNow', label:'Angaja»õi √Æn pauzƒÉ', accent:'pink'},

    // Your existing KPI cards
    {id:'eventsInRange', label:'Pontaje √Æn filtrul curent', accent:'gray'},
    {id:'employeesInRange', label:'Angaja»õi implica»õi', accent:'purple'},
    {id:'cntSTART', label:'START', accent:'green'},
    {id:'cntFINISH', label:'FINISH', accent:'green'},
    {id:'cntPAUSE', label:'PAUZƒÇ', accent:'pink'},
    {id:'cntUNPAUSE', label:'UNPAUSE', accent:'pink'},
    {id:'cntEXTRA_START', label:'EXTRA START', accent:'cyan'},
    {id:'cntEXTRA_FINISH', label:'EXTRA FINISH', accent:'cyan'},
  ];

  function qs(sel, root=document){ return root.querySelector(sel); }
  function qsa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }

  async function loadConfig(){
    const r = await fetch('config.json?v=' + Date.now(), {cache:'no-store'});
    if (!r.ok) throw new Error('Nu pot citi config.json (HTTP ' + r.status + ').');
    return r.json();
  }

  
  function _keyQS(){
    try{
      const cfg = window.CFG || {};
      const k = (cfg && cfg.adminKey) ? String(cfg.adminKey) : '';
      const ls = (localStorage.getItem('ADMIN_KEY') || localStorage.getItem('pontaj_adminKey') || '');
      const key = (k || ls || '').trim();
      return key ? ('&key=' + encodeURIComponent(key)) : '';
    }catch(_){ return ''; }
  }

function adminEndpointBase(cfg){
    const raw = cfg.adminEventsEndpoint || cfg.webappUrl || cfg.scriptUrl || '';
    return String(raw || '').replace(/\?.*$/, '').trim();
  }

  async function fetchAdminEvents(){
    const base = adminEndpointBase(CFG);
    if (!base) throw new Error('Lipse»ôte adminEventsEndpoint/webappUrl √Æn config.json');
    const url = base + '?fn=adminEvents&v=' + Date.now();
    const r = await fetch(url, {cache:'no-store'});
    const txt = await r.text();
    let data;
    try{ data = JSON.parse(txt); }catch(e){ throw new Error('RƒÉspuns invalid (JSON) de la adminEventsEndpoint.'); }
    if (!data || !data.ok || !Array.isArray(data.events)){
      throw new Error('adminEventsEndpoint nu a √Æntors un obiect ok cu events[].');
    }
    return data;
  }

  // ======= Time helpers =======
  function pad2(n){ return String(n).padStart(2,'0'); }
  function fmtDateRO(d){
    const dd = pad2(d.getDate());
    const mm = pad2(d.getMonth()+1);
    const yy = d.getFullYear();
    return `${dd}.${mm}.${yy}`;
  }
  function fmtTimeHHMM(mins){
    mins = Math.max(0, Math.round(mins));
    const h = Math.floor(mins/60);
    const m = mins%60;
    return `${pad2(h)}:${pad2(m)}`;
  }
  function toDate(v){
    const d = (v instanceof Date) ? v : new Date(v);
    return isNaN(d.getTime()) ? null : d;
  }
  function ymdLocal(d){
    // Use local timezone; good enough for Bucharest on client
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  function sameYMD(a,b){ return ymdLocal(a) === ymdLocal(b); }

  // ======= Domain logic (per employee day) =======
  const ACTIONS = {
    START: ['START','INCEPE','√éNCEPE','START_WORK','WORK_START'],
    PAUSE: ['PAUSE','PAUZA','PAUZƒÇ','PAUSE_START','BREAK_START'],
    UNPAUSE: ['UNPAUSE','REIA','REIA_MUNCA','REIA MUNCA','BREAK_END','PAUSE_END'],
    FINISH: ['FINISH','FINALIZEAZA','FINALIZEAZƒÇ','STOP','STOP_WORK','WORK_END'],
    EXTRA_START: ['EXTRA_START','EXTRA INCEPE','EXTRA √éNCEPE','EXTRA_START_WORK'],
    EXTRA_FINISH: ['EXTRA_FINISH','EXTRA STOP','EXTRA FINAL','EXTRA_END'],
    VOID: ['VOID','IGNORE','DELETED']
  };
  function normalizeAction(raw){
    const up = String(raw||'').trim().toUpperCase();
    const m = (key) => ACTIONS[key].some(v => up === v);
    if (m('START')) return 'START';
    if (m('PAUSE')) return 'PAUSE';
    if (m('UNPAUSE')) return 'UNPAUSE';
    if (m('FINISH')) return 'FINISH';
    if (m('EXTRA_START')) return 'EXTRA_START';
    if (m('EXTRA_FINISH')) return 'EXTRA_FINISH';
    if (m('VOID')) return 'VOID';
    return up || 'UNKNOWN';
  }

  function calcDayForEmployee(eventsSorted){
    // eventsSorted: [{ts, action}] only for a single employee and day, sorted by ts
    let workMin = 0;
    let pauseMin = 0;
    let started = false;
    let finished = false;
    let inPause = false;

    let segStart = null;
    let pauseStart = null;

    for (const ev of eventsSorted){
      const a = normalizeAction(ev.action);
      const t = toDate(ev.ts);
      if (!t) continue;
      if (a === 'VOID') continue;

      if (a === 'START' || a === 'UNPAUSE'){
        if (!started){
          started = true;
        }
        if (inPause){
          // end pause
          if (pauseStart){
            pauseMin += (t - pauseStart)/60000;
          }
          inPause = false;
          pauseStart = null;
        }
        if (!finished){
          if (!segStart) segStart = t;
        }
      }

      if (a === 'PAUSE'){
        if (started && !finished){
          if (segStart){
            workMin += (t - segStart)/60000;
            segStart = null;
          }
          if (!inPause){
            inPause = true;
            pauseStart = t;
          }
        }
      }

      if (a === 'FINISH'){
        if (started && !finished){
          if (inPause){
            // close pause at finish (optional)
            if (pauseStart){
              pauseMin += (t - pauseStart)/60000;
            }
            inPause = false;
            pauseStart = null;
          }
          if (segStart){
            workMin += (t - segStart)/60000;
            segStart = null;
          }
          finished = true;
        }
      }
    }

    // If open segment (in progress), do NOT auto-close (matches ‚Äúpontaj ne√Æncheiat‚Äù note)
    // We still can mark active/paused states:
    const activeNow = started && !finished && !inPause;
    const pausedNow = started && !finished && inPause;

    return {workMin, pauseMin, started, finished, activeNow, pausedNow};
  }

  function buildIndices(events){
    // Normalize minimal shape
    const out = events.map(ev => ({
      ts: ev.ts || ev.timestamp || ev.date || ev.time,
      name: ev.name || ev.employee || ev.user || '',
      email: ev.email || '',
      dept: ev.dept || ev.department || '',
      action: ev.action || ev.type || '',
      manager: ev.manager || '',
      activity: ev.activity || '',
      location: ev.location || ''
    })).filter(e => e.ts && (e.name || e.email));

    // parse dates
    out.forEach(e => { e._d = toDate(e.ts); e._ymd = e._d ? ymdLocal(e._d) : null; e._a = normalizeAction(e.action); });

    return out.filter(e => e._d && e._ymd);
  }

  function uniqEmployees(events){
    const map = new Map();
    for (const e of events){
      const key = (e.email || e.name).toLowerCase();
      if (!map.has(key)){
        map.set(key, {key, name:e.name || e.email, email:e.email||'', dept:e.dept||'', manager:e.manager||''});
      }
    }
    return Array.from(map.values()).sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  }

  function groupByEmployeeDay(events, dayYMD){
    const m = new Map(); // key -> events
    for (const e of events){
      if (e._ymd !== dayYMD) continue;
      const key = (e.email || e.name).toLowerCase();
      if (!m.has(key)) m.set(key, []);
      m.get(key).push(e);
    }
    // sort
    for (const [k, arr] of m){
      arr.sort((a,b)=> a._d - b._d);
    }
    return m;
  }

  function calcMonthTotals(events, year, month){
    // returns Map(empKey -> workMinMonth)
    const m = new Map();
    const ym = `${year}-${pad2(month+1)}`;
    // group per employee per day in month
    const byEmpDay = new Map();
    for (const e of events){
      if (!e._ymd || !e._ymd.startsWith(ym)) continue;
      const key = (e.email || e.name).toLowerCase();
      const dkey = key + '|' + e._ymd;
      if (!byEmpDay.has(dkey)) byEmpDay.set(dkey, []);
      byEmpDay.get(dkey).push(e);
    }
    for (const [dkey, arr] of byEmpDay){
      arr.sort((a,b)=> a._d - b._d);
      const empKey = dkey.split('|')[0];
      const dayCalc = calcDayForEmployee(arr);
      m.set(empKey, (m.get(empKey)||0) + dayCalc.workMin);
    }
    return m;
  }

  function expectedMinutesSoFar(year, month, normMin){
    // Workdays from 1st to today (inclusive) excluding weekends
    const now = new Date();
    const endDay = (now.getFullYear()===year && now.getMonth()===month) ? now.getDate() : new Date(year, month+1, 0).getDate();
    let workdays = 0;
    for (let d=1; d<=endDay; d++){
      const dt = new Date(year, month, d);
      const wd = dt.getDay(); // 0 Sun 6 Sat
      if (wd === 0 || wd === 6) continue;
      workdays++;
    }
    return workdays * normMin;
  }

  // ======= KPI Cards =======
  function cardTemplate(def){
    const el = document.createElement('div');
    el.className = 'kpi-card';
    el.dataset.cardId = def.id;
    el.dataset.accent = def.accent || 'purple';
    el.draggable = true;

    el.innerHTML = `
      <div class="kpi-label">
        <span>${escapeHtml(def.label)}</span>
        <span class="chev">${def.chev ? '‚ñæ' : ''}</span>
      </div>
      <div class="kpi-value" id="val_${escapeAttr(def.id)}">‚Äî</div>
      <div class="kpi-small" id="sub_${escapeAttr(def.id)}"></div>
    `;
    return el;
  }

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function escapeAttr(s){ return String(s||'').replace(/[^a-zA-Z0-9_\-]/g,'_'); }

  function buildKpiGrid(){
    const grid = qs('#kpiGrid');
    grid.innerHTML = '';

    const desiredOrder = loadCardOrder();
    const defsById = new Map(CARD_DEFS.map(d => [d.id, d]));
    const ordered = [];
    desiredOrder.forEach(id => { if (defsById.has(id)) ordered.push(defsById.get(id)); });
    // add missing
    CARD_DEFS.forEach(d => { if (!ordered.some(x=>x.id===d.id)) ordered.push(d); });

    ordered.forEach(def => grid.appendChild(cardTemplate(def)));
    makeCardsDraggable(grid);
  }

  function loadCardOrder(){
    try{
      const raw = localStorage.getItem(LS_ORDER_KEY);
      const arr = raw ? JSON.parse(raw) : null;
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }

  function saveCardOrder(){
    const grid = qs('#kpiGrid');
    const ids = qsa('.kpi-card', grid).map(x => x.dataset.cardId);
    try{ localStorage.setItem(LS_ORDER_KEY, JSON.stringify(ids)); }catch{}
  }

  function setCardValue(id, value, sub=''){
    const val = qs('#val_' + escapeAttr(id));
    const subEl = qs('#sub_' + escapeAttr(id));
    if (val) val.textContent = value;
    if (subEl) subEl.textContent = sub;
  }

  function makeCardsDraggable(container){
    let dragging = null;

    container.addEventListener('dragstart', (e) => {
      const card = e.target.closest('.kpi-card');
      if (!card) return;
      dragging = card;
      card.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      try{ e.dataTransfer.setData('text/plain', card.dataset.cardId); }catch{}
    });

    container.addEventListener('dragend', () => {
      if (dragging){
        dragging.classList.remove('dragging');
        dragging = null;
        saveCardOrder();
      }
    });

    container.addEventListener('dragover', (e) => {
      if (!dragging) return;
      e.preventDefault();
      const after = getDragAfterElement(container, e.clientX, e.clientY);
      if (after == null){
        container.appendChild(dragging);
      } else {
        container.insertBefore(dragging, after);
      }
    });

    function getDragAfterElement(container, x, y){
      const draggableElements = [...container.querySelectorAll('.kpi-card:not(.dragging)')];
      let closest = { offset: Number.NEGATIVE_INFINITY, element: null };
      for (const el of draggableElements){
        const box = el.getBoundingClientRect();
        const offset = (y - (box.top + box.height / 2));
        if (offset < 0 && offset > closest.offset){
          closest = { offset, element: el };
        }
      }
      return closest.element;
    }
  }

  // ======= Summary table =======
  function renderSummaryTable(rows){
    const body = qs('#summaryBody');
    body.innerHTML = '';

    const search = (qs('#tableSearch').value || '').trim().toLowerCase();

    const filtered = rows.filter(r => (r.name||'').toLowerCase().includes(search));
    qs('#employeeCountBadge').textContent = `${filtered.length} angaja»õi`;

    let idx=0;
    for (const r of filtered){
      idx++;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div class="emp">
            <div class="idx">${idx}</div>
            <div class="avatar">${escapeHtml(r.initials)}</div>
            <div class="emp-meta">
              <div class="emp-name">${escapeHtml(r.name)}</div>
              <div class="emp-dept">${escapeHtml(r.dept || '‚Äî')}</div>
            </div>
          <button class="empBtn" type="button" data-open-userpanel="1" data-emp="${escapeHtml(r.name)}" data-dept="${escapeHtml(r.dept || '')}" title="User panel / editare intervale" aria-label="User panel">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path fill="currentColor" d="M12 12c2.76 0 5-2.24 5-5S14.76 2 12 2 7 4.24 7 7s2.24 5 5 5Zm0 2c-3.33 0-10 1.67-10 5v3h20v-3c0-3.33-6.67-5-10-5Z"/>
            </svg>
          </button>
          </div>
        </td>
        <td class="muted">${escapeHtml(r.manager || '‚Äî')}</td>
        <td>
          <div style="display:flex;align-items:center;gap:10px;">
            <div class="progress" title="Lucrat azi / normƒÉ">
              <div class="bar" style="width:${Math.max(0, Math.min(100, r.workPct))}%;"></div>
            </div>
            <div class="num">${escapeHtml(r.workLabel)}</div>
          </div>
        </td>
        <td class="${r.monthDeltaClass}">${escapeHtml(r.monthDeltaLabel)}</td>
        <td class="${r.bankClass}">${escapeHtml(r.bankLabel)}</td>
        <td class="muted">${escapeHtml(r.leaveTotal)}</td>
        <td class="muted">${escapeHtml(r.leaveToDay)}</td>
        <td class="muted">${escapeHtml(r.requests)}</td>
      `;
      body.appendChild(tr);
    }
  }

  // ======= Compute everything =======
  function computeDashboard(){
    const now = new Date();
    const todayYMD = ymdLocal(now);
    qs('#todayTitle').textContent = `AstƒÉzi, ${fmtDateRO(now)} ‚Äî Rezumat`;
    qs('#lastUpdated').textContent = 'Actualizat: ' + now.toLocaleTimeString('ro-RO', {hour:'2-digit', minute:'2-digit'});

    const employees = uniqEmployees(ALL_EVENTS);
    const byEmpToday = groupByEmployeeDay(ALL_EVENTS, todayYMD);

    const normMin = 8 * 60; // simplu: 8h

    let totalWorkMin = 0;
    let totalPauseMin = 0;

    let activeNow = 0;
    let pausedNow = 0;

    let underNorm = 0;
    let complete = 0;
    let overNorm = 0;

    let employeesWithEventsToday = 0;

    // Counts actions in current filter (today)
    const actionCounts = {
      START:0, FINISH:0, PAUSE:0, UNPAUSE:0, EXTRA_START:0, EXTRA_FINISH:0
    };

    for (const e of ALL_EVENTS){
      if (e._ymd === todayYMD && e._a && e._a !== 'VOID'){
        if (actionCounts[e._a] != null) actionCounts[e._a]++;
      }
    }

    const dayCalcs = new Map(); // empKey -> calc
    for (const emp of employees){
      const arr = byEmpToday.get(emp.key) || [];
      if (arr.length) employeesWithEventsToday++;

      const calc = calcDayForEmployee(arr);
      dayCalcs.set(emp.key, calc);

      totalWorkMin += calc.workMin;
      totalPauseMin += calc.pauseMin;

      if (calc.activeNow) activeNow++;
      if (calc.pausedNow) pausedNow++;

      // classification using worked minutes only (ignore open segment)
      if (calc.workMin <= 0 && !arr.length){
        // inactive
      } else if (calc.workMin < normMin){
        underNorm++;
      } else {
        // complet vs peste normƒÉ (toleran»õƒÉ 15 minute)
        const tol = 15; // minute
        if (calc.workMin <= normMin + tol) complete++;
        else overNorm++;
      }
    }

    const population = employees.length;
    const inactive = Math.max(0, population - employeesWithEventsToday);

    // these are optional without leave/event data
    const leave = 0;
    const event = 0;

    // KPI cards values
    setCardValue('workToday', fmtTimeHHMM(totalWorkMin));
    setCardValue('pauseToday', fmtTimeHHMM(totalPauseMin));
    setCardValue('activeNow', String(activeNow));
    setCardValue('pausedNow', String(pausedNow));
    setCardValue('underNorm', String(underNorm));
    setCardValue('complete', String(complete));
    setCardValue('overNorm', String(overNorm));
    setCardValue('inactive', String(inactive));
    setCardValue('leave', String(leave));
    setCardValue('event', String(event));

    setCardValue('eventsInRange', String(ALL_EVENTS.filter(e => e._ymd === todayYMD && e._a !== 'VOID').length));
    setCardValue('employeesInRange', String(employeesWithEventsToday));
    setCardValue('cntSTART', String(actionCounts.START));
    setCardValue('cntFINISH', String(actionCounts.FINISH));
    setCardValue('cntPAUSE', String(actionCounts.PAUSE));
    setCardValue('cntUNPAUSE', String(actionCounts.UNPAUSE));
    setCardValue('cntEXTRA_START', String(actionCounts.EXTRA_START));
    setCardValue('cntEXTRA_FINISH', String(actionCounts.EXTRA_FINISH));

    // summary rows
    const monthTotals = calcMonthTotals(ALL_EVENTS, now.getFullYear(), now.getMonth());
    const expected = expectedMinutesSoFar(now.getFullYear(), now.getMonth(), normMin);

    const rows = employees.map(emp => {
      const c = dayCalcs.get(emp.key) || {workMin:0};
      const initials = (emp.name || '').split(/\s+/).filter(Boolean).slice(0,2).map(s=>s[0].toUpperCase()).join('') || '‚Ä¢';
      const workPct = (normMin > 0) ? (c.workMin / normMin * 100) : 0;

      const workedMonth = monthTotals.get(emp.key) || 0;
      const delta = workedMonth - expected;
      const deltaLabel = (delta>=0?'+':'-') + fmtTimeHHMM(Math.abs(delta));
      const deltaClass = delta>=0 ? 'pos' : 'neg';

      // bank = same as delta for now
      const bankLabel = deltaLabel;
      const bankClass = deltaClass;

      return {
        name: emp.name || emp.email,
        dept: emp.dept,
        manager: (emp.isAdmin ? 'Admin' : (emp.manager || emp.managerEmail || '‚Äî')),
        initials,
        workPct,
        workLabel: fmtTimeHHMM(c.workMin),
        monthDeltaLabel: deltaLabel,
        monthDeltaClass: deltaClass,
        bankLabel,
        bankClass,
        leaveTotal: '‚Äî',
        leaveToDay: '‚Äî',
        requests: '0'
      };
    });

    // sort by name
    rows.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    ROWS_CACHE = rows;
    renderSummaryTable(ROWS_CACHE);
  }

    // ======= Shell navigation helper =======
  function shellNavigate(id, url){
    try{
      if (window.parent && window.parent !== window){
        window.parent.postMessage({ type:'PONTAJ_NAV', id }, '*');
        return;
      }
    }catch(_){}
    window.location.href = url;
  }

  // ======= Init =======
  async function init(){
    buildKpiGrid();
    await _loadAdminAuth();
    await _loadManagersMap();

    qs('#btnRefresh').addEventListener('click', () => { refresh(); });

    qs('#btnCalendar').addEventListener('click', () => { shellNavigate('calendar', 'admin-calendar-prezenta.html'); });
    qs('#btnAdminPanel').addEventListener('click', () => { shellNavigate('adminpanel', 'admin-panel.html'); });

    const searchTop = qs('#searchEmployee');
    const searchTbl = qs('#tableSearch');
    // keep in sync
    const sync = (v) => {
      searchTop.value = v;
      searchTbl.value = v;
      renderSummaryTable(_LAST_ROWS_CACHE);
    };

    function hookSearch(){
      searchTop.addEventListener('input', () => {
        searchTbl.value = searchTop.value;
        renderSummaryTable(ROWS_CACHE);
      });
      searchTbl.addEventListener('input', () => {
        searchTop.value = searchTbl.value;
        renderSummaryTable(ROWS_CACHE);
      });
    }

    hookSearch();


    // ===== Mini User Panel PRO (mov) =====
    const ADMINS = { list: [], byEmail: new Map(), byName: new Map() };
    const MANAGERS = { map: new Map() }; // empNameLower -> {email,name}

    const UP = {
      name:'', dept:'', email:'', chat:'', date:'', note:'',
      tags:new Set(),
      tz:'Europe/Bucharest',
      telegramOn:true,
      remindOn:true,
      afterMin:5,
      events:[],
      busy:false
    };

    function _upInit(){
      const parts = String(UP.name||'').trim().split(/\s+/).filter(Boolean);
      const a = parts[0] ? parts[0][0] : '?';
      const b = parts.length>1 ? parts[parts.length-1][0] : '';
      return (a+b).toUpperCase();
    }

    function _b64ws(str){
      const b64 = btoa(unescape(encodeURIComponent(str)));
      return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    }

    function _jsonp(url){
      return new Promise((resolve, reject)=>{
        const cbName = '__cb_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');
        const sep = url.includes('?') ? '&' : '?';
        const full = url + sep + 'callback=' + encodeURIComponent(cbName) + '&_=' + Date.now();
        let done = false;

        const timeout = setTimeout(()=>{
          if (done) return;
          done = true;
          cleanup();
          reject(new Error('Timeout JSONP'));
        }, 15000);

        function cleanup(){
          try{ delete window[cbName]; }catch(_){}
          try{ s.remove(); }catch(_){}
          clearTimeout(timeout);
        }

        window[cbName] = (data)=>{
          if (done) return;
          done = true;
          cleanup();
          resolve(data);
        };

        s.onerror = ()=>{
          if (done) return;
          done = true;
          cleanup();
          reject(new Error('Eroare JSONP'));
        };

        s.src = full;
        document.body.appendChild(s);
      });
    }

    function _webappBase(){
      const cfg = window.CFG || CFG || {};
      const raw = cfg.adminEventsEndpoint || cfg.webappUrl || cfg.scriptUrl || '';
      return String(raw || '').replace(/\?.*$/, '').trim();
    }

    async function _loadAdminAuth(){
      try{
        const cfg = window.CFG || CFG || {};
        const url = String(cfg.adminAuthUrl || '').trim();
        if (!url) return;
        const r = await fetch(url + (url.includes('?')?'&':'?') + 'v=' + Date.now(), {cache:'no-store'});
        if (!r.ok) throw new Error('admin-auth.json HTTP ' + r.status);
        const data = await r.json();

        // Accept multiple shapes: array or {admins:[...]} or {list:[...]}
        const arr = Array.isArray(data) ? data : (data.admins || data.list || data.users || []);
        ADMINS.list = arr
          .map(a => ({
            name: String(a.name || a.n || a.user || a.username || '').trim(),
            email: String(a.email || a.e || a.mail || '').trim()
          }))
          .filter(a => a.name || a.email);

        ADMINS.byEmail = new Map(ADMINS.list.filter(a=>a.email).map(a=>[a.email.toLowerCase(), a]));
        ADMINS.byName = new Map(ADMINS.list.filter(a=>a.name).map(a=>[a.name.toLowerCase(), a]));
      }catch(err){
        console.warn('Nu pot √ÆncƒÉrca admin-auth.json:', err);
      }
    }

    async function _loadManagersMap(){
      // optional server-side map via JSONP
      try{
        const base = _webappBase();
        if (!base) return;
        const url = base + '?fn=adminManagersMap' + _keyQS();
        const data = await _jsonp(url);
        if (!data || !data.ok || !data.map) return;
        const mp = data.map || {};
        MANAGERS.map = new Map(Object.keys(mp).map(k => [String(k).toLowerCase(), mp[k]]));
      }catch(err){
        // fallback local storage
        try{
          const s = localStorage.getItem('pontaj/managers/v1');
          if (s){
            const o = JSON.parse(s);
            MANAGERS.map = new Map(Object.keys(o).map(k => [k.toLowerCase(), o[k]]));
          }
        }catch(_){}
      }
    }

    function _isAdminName(name){
      const n = String(name||'').trim().toLowerCase();
      if (!n) return false;
      return ADMINS.byName.has(n);
    }

    function _getManagerFor(name){
      const k = String(name||'').trim().toLowerCase();
      return MANAGERS.map.get(k) || null;
    }

    async function _setManagerFor(empName, managerEmail){
      const empKey = String(empName||'').trim().toLowerCase();
      if (!empKey) return {ok:false, error:'Nume invalid'};
      const mgr = managerEmail ? String(managerEmail).trim() : '';
      // server-side if available
      try{
        const base = _webappBase();
        if (base){
          const url = base + '?fn=adminSetManager&name=' + encodeURIComponent(empName) + '&managerEmail=' + encodeURIComponent(mgr) + _keyQS();
          const data = await _jsonp(url);
          if (data && data.ok){
            // refresh map from response if provided
            if (data.map){
              const mp = data.map;
              MANAGERS.map = new Map(Object.keys(mp).map(k => [String(k).toLowerCase(), mp[k]]));
            }else{
              if (mgr) MANAGERS.map.set(empKey, {email:mgr});
              else MANAGERS.map.delete(empKey);
            }
            // local cache
            const o = {};
            for (const [k,v] of MANAGERS.map.entries()) o[k]=v;
            localStorage.setItem('pontaj/managers/v1', JSON.stringify(o));
            return {ok:true};
          }
        }
      }catch(err){
        console.warn('adminSetManager fallback:', err);
      }

      // local fallback
      if (mgr) MANAGERS.map.set(empKey, {email:mgr});
      else MANAGERS.map.delete(empKey);
      const o = {};
      for (const [k,v] of MANAGERS.map.entries()) o[k]=v;
      localStorage.setItem('pontaj/managers/v1', JSON.stringify(o));
      return {ok:true, local:true};
    }


    function _upShowErr(msg){
      const el = qs('#upErr');
      el.textContent = msg || '';
      el.style.display = msg ? '' : 'none';
    }

    function _upSetBusy(b){
      UP.busy = !!b;
      qs('#upApprove').disabled = UP.busy;
      qs('#upAddEv').disabled = UP.busy;
      qs('#upDate').disabled = UP.busy;
      qs('#upPrevDay').disabled = UP.busy;
      qs('#upNextDay').disabled = UP.busy;
    }

    function _toMin(hhmm){
      const m = String(hhmm||'').match(/^(\d{1,2}):(\d{2})/);
      if(!m) return null;
      return parseInt(m[1],10)*60 + parseInt(m[2],10);
    }
    function _fmt(mins){
      mins = Math.max(0, Math.round(mins));
      const h = Math.floor(mins/60), m = mins%60;
      return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
    }

    function _allowedAction(a){
      a = String(a||'').toUpperCase().trim();
      const allowed = ['START','PAUSE','UNPAUSE','FINISH','EXTRA_START','EXTRA_FINISH'];
      return allowed.includes(a) ? a : 'START';
    }

    function _calc(){
      let start=null, finish=null;
      let extraStart=null, extraFinish=null;
      let openPause=null;
      let pauseMin=0;

      const evs = UP.events.slice().sort((A,B)=> (_toMin(A.time)||0)-(_toMin(B.time)||0));
      for (const ev of evs){
        const t = _toMin(ev.time);
        if (t==null) continue;
        if (ev.action==='START') start = (start==null? t : Math.min(start,t));
        if (ev.action==='FINISH') finish = (finish==null? t : Math.max(finish,t));
        if (ev.action==='EXTRA_START') extraStart = (extraStart==null? t : Math.min(extraStart,t));
        if (ev.action==='EXTRA_FINISH') extraFinish = (extraFinish==null? t : Math.max(extraFinish,t));

        if (ev.action==='PAUSE') openPause = t;
        if (ev.action==='UNPAUSE' && openPause!=null){
          if (t>openPause) pauseMin += (t-openPause);
          openPause = null;
        }
      }

      let span = (start!=null && finish!=null && finish>start) ? (finish-start) : 0;
      // Fallback: if actions are mislabeled but we have times, infer a basic span from min..max
      if (span===0){
        const ts = evs.map(e=>_toMin(e.time)).filter(v=>v!=null);
        if (ts.length>=2){
          const mn = Math.min.apply(null, ts);
          const mx = Math.max.apply(null, ts);
          if (mx>mn){
            start = (start==null)? mn : start;
            finish = (finish==null)? mx : finish;
            if (finish<=start){ start = mn; finish = mx; }
            span = finish-start;
          }
        }
      }
      const workMin = Math.max(0, span - pauseMin);

      const extraSpan = (extraStart!=null && extraFinish!=null && extraFinish>extraStart) ? (extraFinish-extraStart) : 0;

      return {workMin, pauseMin, extraMin: extraSpan, start, finish, extraStart, extraFinish};
    }

    function _renderStats(){
      const c = _calc();
      qs('#stWork').textContent = _fmt(c.workMin);
      qs('#stPause').textContent = _fmt(c.pauseMin);
      qs('#stExtra').textContent = _fmt(c.extraMin);

      const balance = c.workMin - (8*60);
      const sign = balance>=0 ? '+' : '-';
      qs('#stBalance').textContent = sign + _fmt(Math.abs(balance));

      qs('#upHeaderSummary').textContent = `pauzƒÉ ${_fmt(c.pauseMin)} ‚Ä¢ extra ${_fmt(c.extraMin)}`;

      const total = Math.max(1, c.workMin + c.pauseMin + c.extraMin);
      qs('#segWork').style.width = ((c.workMin/total)*100).toFixed(1)+'%';
      qs('#segPause').style.width = ((c.pauseMin/total)*100).toFixed(1)+'%';
      qs('#segExtra').style.width = ((c.extraMin/total)*100).toFixed(1)+'%';
      qs('#upEvCount').textContent = String(UP.events.length);
    }


    function _eventColorClass(a){
      a = _allowedAction(a);
      if (a==='PAUSE') return 'pause';
      if (a==='FINISH') return 'finish';
      if (a==='EXTRA_START' || a==='EXTRA_FINISH') return 'extra';
      return 'work';
    }

    function _renderTimeline(){
      const track = qs('#upTimeline');
      const legend = qs('#upTimelineLegend');
      if (!track || !legend) return;

      // clear previous (keep base line)
      track.innerHTML = '<div class="tlBase"></div>';
      legend.innerHTML = '';

      const evs = UP.events
        .map(ev => ({ action:_allowedAction(ev.action), time:String(ev.time||'').slice(0,5), m:_toMin(ev.time) }))
        .filter(ev => ev.m!=null)
        .sort((a,b)=> a.m-b.m);

      if (!evs.length){
        qs('#tlL').textContent = '‚Äî';
        qs('#tlM').textContent = '‚Äî';
        qs('#tlR').textContent = '‚Äî';
        return;
      }

      // axis: min..max with padding, minimum span 120 min
      let minM = evs[0].m;
      let maxM = evs[evs.length-1].m;
      let pad = 30;
      minM = Math.max(0, minM - pad);
      maxM = Math.min(1440, maxM + pad);
      if (maxM - minM < 120){
        const mid = (minM + maxM)/2;
        minM = Math.max(0, Math.floor(mid - 60));
        maxM = Math.min(1440, Math.ceil(mid + 60));
      }
      const span = Math.max(1, maxM - minM);

      const leftLabel = _fmt(minM);
      const rightLabel = _fmt(maxM);
      const midLabel = _fmt(Math.round((minM+maxM)/2));
      qs('#tlL').textContent = leftLabel;
      qs('#tlM').textContent = midLabel;
      qs('#tlR').textContent = rightLabel;

      // build intervals (state machine)
      const intervals = [];
      let state = 'off'; // off/work/pause/extra
      let prev = minM;

      function pushInterval(a,b,s){
        if (b<=a) return;
        intervals.push({a,b,s});
      }

      function applyAction(a){
        if (a==='START' || a==='UNPAUSE') state = 'work';
        else if (a==='PAUSE') state = 'pause';
        else if (a==='FINISH') state = 'off';
        else if (a==='EXTRA_START') state = 'extra';
        else if (a==='EXTRA_FINISH') state = 'work';
      }

      for (const ev of evs){
        pushInterval(prev, ev.m, state);
        applyAction(ev.action);
        prev = ev.m;
      }
      pushInterval(prev, maxM, state);

      // render segments (skip off)
      for (const it of intervals){
        if (it.s === 'off') continue;
        const seg = document.createElement('div');
        seg.className = 'tlSeg ' + (it.s==='work'?'work':it.s==='pause'?'pause':'extra');
        const left = ((it.a - minM)/span)*100;
        const width = ((it.b - it.a)/span)*100;
        seg.style.left = `calc(${left}% + 10px)`;
        seg.style.width = `calc(${width}% - 0px)`;
        seg.style.right = 'auto';
        track.appendChild(seg);
      }

      // render markers
      for (const ev of evs){
        const mk = document.createElement('div');
        mk.className = 'tlMark ' + ev.action;
        const left = ((ev.m - minM)/span)*100;
        mk.style.left = `calc(${left}% + 10px)`;
        mk.title = `${ev.time} ‚Ä¢ ${ev.action}`;
        track.appendChild(mk);

        const chip = document.createElement('div');
        const cc = _eventColorClass(ev.action);
        chip.className = 'tlChip2';
        chip.innerHTML = `<span class="tlDot ${cc}"></span><span class="tlTime">${escapeHtml(ev.time)}</span><span class="tlAct">${escapeHtml(ev.action)}</span>`;
        legend.appendChild(chip);
      }
    }



    function _renderEvents(){
      // sort events by time so they don't appear over each other / out of order
      UP.events.sort((a,b)=>{
        const A=_toMin(a.time)||0, B=_toMin(b.time)||0;
        if (A!==B) return A-B;
        return String(a.action||'').localeCompare(String(b.action||''));
      });
      const wrap = qs('#upEvents');
      wrap.innerHTML = '';
      UP.events.forEach((ev, i)=>{
        const row = document.createElement('div');
        row.className = 'evItem';
        row.innerHTML = `
          <div class="dot ${_allowedAction(ev.action)}"></div>
          <select data-k="action" data-i="${i}">
            <option value="START">START</option>
            <option value="PAUSE">PAUSE</option>
            <option value="UNPAUSE">UNPAUSE</option>
            <option value="FINISH">FINISH</option>
            <option value="EXTRA_START">EXTRA_START</option>
            <option value="EXTRA_FINISH">EXTRA_FINISH</option>
          </select>
          <input type="time" step="60" value="${escapeHtml(ev.time||'')}" data-k="time" data-i="${i}">
          <button class="evDel" type="button" data-k="del" data-i="${i}" title="»òterge">üóë</button>
        `;
        wrap.appendChild(row);
        row.querySelector('select').value = _allowedAction(ev.action);
      });
      _renderStats();
      _renderTimeline();
    }

    function _toggleEl(el, on){ el.classList.toggle('on', !!on); }

    async function _loadDay(){
      _upShowErr('');
      _upSetBusy(true);

      try{
        const base = _webappBase();
        if (!base) throw new Error('Lipse»ôte webappUrl/adminEventsEndpoint √Æn config.json');

        const url = base + '?fn=fixDayGet&name=' + encodeURIComponent(UP.name) + '&date=' + encodeURIComponent(UP.date);
        const data = await _jsonp(url);
        if (!data || !data.ok) throw new Error((data && data.error) ? data.error : 'RƒÉspuns invalid');

        const prof = data.profile || data.meta || {};
        UP.email = data.email || prof.email || UP.email || '‚Äî';
        UP.chat = data.telegramChatId || prof.telegramChatId || UP.chat || '‚Äî';
        UP.dept = data.dept || prof.dept || UP.dept || '‚Äî';

        UP.note = String(data.note || prof.note || '');
        qs('#upNote').value = UP.note;

        const evs = Array.isArray(data.events) ? data.events : [];
        UP.events = evs.map(ev => ({
          time: String(ev.localTime || ev.time || '').slice(0,5),
          action: _allowedAction(ev.action || ev.rawAction || ev.Action || 'START')
        })).filter(ev => ev.time);

        qs('#upAvatar').textContent = _upInit();
        qs('#upEmpEmail').textContent = UP.email || '‚Äî';
        qs('#upEmpChat').textContent = (UP.chat && String(UP.chat).trim()) ? String(UP.chat).trim() : '‚Äî';
        qs('#upEmpDept').textContent = UP.dept || '‚Äî';

        _renderEvents();
        _renderTimeline();
      }catch(err){
        console.error(err);
        _upShowErr('Eroare: ' + (err && err.message ? err.message : err));
      }finally{
        _upSetBusy(false);
      }
    }

    async function _saveDay(){
      _upShowErr('');
      _upSetBusy(true);

      try{
        const base = _webappBase();
        if (!base) throw new Error('Lipse»ôte webappUrl/adminEventsEndpoint √Æn config.json');

        let admin = 'admin';
        try{
          const s = localStorage.getItem('pontaj/admin/v1');
          if (s){
            const o = JSON.parse(s);
            admin = o.email || o.user || o.name || 'admin';
          }
        }catch(_){}

        const payload = {
          admin,
          name: UP.name,
          date: UP.date,
          reason: 'Admin mini panel',
          note: UP.note,
          tags: Array.from(UP.tags),
          events: UP.events.map(ev => ({ time: ev.time, action: ev.action }))
        };

        const b64 = _b64ws(JSON.stringify(payload));
        const url = base + '?fn=fixDayApply&payload=' + encodeURIComponent(b64);
        const res = await _jsonp(url);
        if (!res || !res.ok) throw new Error((res && res.error) ? res.error : 'Salvare e»ôuatƒÉ');

        if (typeof window.__adminDashboardRefresh === 'function'){
          await window.__adminDashboardRefresh();
        }
        _closePanel();
      }catch(err){
        console.error(err);
        _upShowErr('Eroare salvare: ' + (err && err.message ? err.message : err));
      }finally{
        _upSetBusy(false);
      }
    }

    function _openPanel(name, dept){
      UP.name = String(name||'').trim();
      UP.dept = String(dept||'').trim();
      UP.date = ymdLocal(new Date());
      UP.tags = new Set();
      UP.note = '';
      UP.events = [];
      UP.email = '‚Äî';
      UP.chat = '‚Äî';

      qs('#upEmpName').textContent = UP.name || '‚Äî';
      qs('#upEmpDept').textContent = UP.dept || '‚Äî';
      qs('#upEmpEmail').textContent = '‚Äî';
      qs('#upEmpChat').textContent = '‚Äî';
      qs('#upDate').value = UP.date;
      qs('#upNote').value = '';

      _toggleEl(qs('#tgTelegram'), UP.telegramOn);
      _toggleEl(qs('#tgRemind'), UP.remindOn);
      qs('#upAfter').value = String(UP.afterMin || 5);
      qs('#upTz').value = UP.tz || 'Europe/Bucharest';

      document.querySelectorAll('.upChip').forEach(c=> c.classList.remove('on'));
      _fillManagerSelect();

      document.documentElement.classList.add('up-lock');
      const ov = qs('#upOverlay');
      ov.classList.add('show');
      ov.setAttribute('aria-hidden','false');

      _loadDay();
    }

    function _closePanel(){
      const ov = qs('#upOverlay');
      ov.classList.remove('show');
      document.documentElement.classList.remove('up-lock');
      ov.setAttribute('aria-hidden','true');
      _upShowErr('');
    }


    function _fillManagerSelect(){
      const sel = qs('#upManagerSelect');
      if (!sel) return;
      sel.innerHTML = '';
      // If employee is admin, hide manager controls
      const isAdm = _isAdminName(UP.name);
      qs('#mgrWrap').style.display = isAdm ? 'none' : '';
      qs('#upAssignManager').style.display = isAdm ? 'none' : '';
      qs('#upClearManager').style.display = isAdm ? 'none' : '';
      if (isAdm) return;

      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '‚Äî SelecteazƒÉ manager ‚Äî';
      sel.appendChild(opt0);

      for (const a of ADMINS.list){
        const o = document.createElement('option');
        o.value = a.email || a.name;
        o.textContent = a.name ? (a.name + (a.email ? ' ‚Ä¢ ' + a.email : '')) : (a.email || 'admin');
        sel.appendChild(o);
      }

      const cur = _getManagerFor(UP.name);
      if (cur && cur.email) sel.value = cur.email;
      else sel.value = '';
    }



    function _wirePanel(){
      document.addEventListener('click', (e)=>{
        const btn = e.target.closest('[data-open-userpanel="1"]');
        if (!btn) return;
        e.preventDefault();
        const name = btn.getAttribute('data-emp') || '';
        const dept = btn.getAttribute('data-dept') || '';
        if (!name) return;
        _openPanel(name, dept);
      });

      qs('#upClose').addEventListener('click', _closePanel);
      qs('#upCancel').addEventListener('click', _closePanel);

      qs('#upApprove').addEventListener('click', async ()=>{
        UP.note = String(qs('#upNote').value || '');
        await _saveDay();
      });

      qs('#upAddEv').addEventListener('click', ()=>{
        UP.events.push({ time: '09:00', action: 'START' });
        _renderEvents();
      });

      qs('#upEvents').addEventListener('change', (e)=>{
        const i = parseInt(e.target.getAttribute('data-i')||'-1',10);
        const k = e.target.getAttribute('data-k');
        if (i<0 || i>=UP.events.length) return;
        if (k=='time') UP.events[i].time = String(e.target.value||'').slice(0,5);
        if (k=='action') UP.events[i].action = _allowedAction(e.target.value);
        _renderEvents();
      });

      qs('#upEvents').addEventListener('click', (e)=>{
        const del = e.target.closest('[data-k="del"]');
        if (!del) return;
        const i = parseInt(del.getAttribute('data-i')||'-1',10);
        if (i<0 || i>=UP.events.length) return;
        UP.events.splice(i,1);
        _renderEvents();
      });

      qs('#upDate').addEventListener('change', ()=>{
        UP.date = String(qs('#upDate').value || '').trim();
        if (UP.date) _loadDay();
      });

      qs('#upPrevDay').addEventListener('click', ()=>{
        const d = new Date(UP.date+'T00:00:00');
        d.setDate(d.getDate()-1);
        UP.date = ymdLocal(d);
        qs('#upDate').value = UP.date;
        _loadDay();
      });
      qs('#upNextDay').addEventListener('click', ()=>{
        const d = new Date(UP.date+'T00:00:00');
        d.setDate(d.getDate()+1);
        UP.date = ymdLocal(d);
        qs('#upDate').value = UP.date;
        _loadDay();
      });

      document.querySelectorAll('.upChip').forEach(ch=>{
        ch.addEventListener('click', ()=>{
          const tag = ch.getAttribute('data-tag');
          const on = !ch.classList.contains('on');
          ch.classList.toggle('on', on);
          if (on) UP.tags.add(tag); else UP.tags.delete(tag);
        });
      });

      qs('#tgTelegram').addEventListener('click', ()=>{
        UP.telegramOn = !UP.telegramOn;
        _toggleEl(qs('#tgTelegram'), UP.telegramOn);
      });
      qs('#tgRemind').addEventListener('click', ()=>{
        UP.remindOn = !UP.remindOn;
        _toggleEl(qs('#tgRemind'), UP.remindOn);
      });

      qs('#upAfter').addEventListener('change', ()=>{ UP.afterMin = parseInt(qs('#upAfter').value,10) || 5; });
      qs('#upTz').addEventListener('change', ()=>{ UP.tz = String(qs('#upTz').value||'Europe/Bucharest'); });

      qs('#upOpenFull').addEventListener('click', ()=>{
        const url = 'admin-user-panel.html?name=' + encodeURIComponent(UP.name) + '&date=' + encodeURIComponent(UP.date);
        window.open(url, '_blank');
      });
      qs('#upOpenFixDay').addEventListener('click', ()=>{
        const url = 'fix-day.html?name=' + encodeURIComponent(UP.name) + '&date=' + encodeURIComponent(UP.date);
        window.open(url, '_blank');
      });

      qs('#upDeleteDay').addEventListener('click', ()=>{
        if (!confirm('»òtergi toate evenimentele din ziua selectatƒÉ?')) return;
        UP.events = [];
        _renderEvents();
      });

      qs('#upNotify').addEventListener('click', ()=>{
        alert('NotificƒÉ angajat: implementez endpoint-ul dacƒÉ vrei (ex: fn=adminNotify). Acum e doar UI.');
      });


      qs('#upAssignManager').addEventListener('click', async ()=>{
        const sel = qs('#upManagerSelect');
        const v = sel ? String(sel.value||'').trim() : '';
        if (!v){ alert('Alege un manager din listƒÉ.'); return; }
        const res = await _setManagerFor(UP.name, v);
        if (!res.ok){ alert('Eroare: ' + (res.error||'')); return; }
        // refresh rows so manager appears in tabel
        computeDashboard();
        alert('Manager atribuit.');
      });
      qs('#upClearManager').addEventListener('click', async ()=>{
        const res = await _setManagerFor(UP.name, '');
        if (!res.ok){ alert('Eroare: ' + (res.error||'')); return; }
        _fillManagerSelect();
        computeDashboard();
        alert('Manager »ôters.');
      });

      qs('#upAudit').addEventListener('click', ()=>{
        window.open('fix-day.html?audit=1&name=' + encodeURIComponent(UP.name) + '&date=' + encodeURIComponent(UP.date), '_blank');
      });

      qs('#upOverlay').addEventListener('click', (e)=>{
        if (e.target && e.target.id === 'upOverlay') _closePanel();
      });
      document.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape' && qs('#upOverlay').classList.contains('show')) _closePanel();
      });
    }


    _wirePanel();

    async function refresh(){
      qs('#loading').style.display = '';
      qs('#content').style.display = 'none';

      try{
        CFG = await loadConfig();
        window.CFG = CFG;

        const data = await fetchAdminEvents();
        ALL_EVENTS = buildIndices(data.events);
        window.__pontajAdminEvents = ALL_EVENTS;

        computeDashboard();
      }catch(err){
        console.error(err);
        alert('Eroare dashboard: ' + (err && err.message ? err.message : err));
      }finally{
        qs('#loading').style.display = 'none';
        qs('#content').style.display = '';
      }
    }

    await refresh();
  }

  window.addEventListener('DOMContentLoaded', init);
})();
</script>

  <!-- ===== Mini User Panel PRO (mov) ===== -->
  <div class="upOverlay" id="upOverlay" aria-hidden="true">
    <div class="upModal" role="dialog" aria-modal="true" aria-label="User Panel">
      <div class="upTop">
        <div class="upAvatar" id="upAvatar">??</div>
        <div class="upWho">
          <div class="upName">
            <span id="upEmpName">‚Äî</span>
            <span class="upPill" id="upEmpDept">‚Äî</span>
          </div>
          <div class="upMeta">
            <span class="m"><span class="mi">Email</span><span id="upEmpEmail" class="mv">‚Äî</span></span>
            <span class="m"><span class="mi">Telegram</span><span id="upEmpChat" class="mv">‚Äî</span></span>
            <span class="m"><span class="mi">Status</span><span id="upEmpStatus" class="mv">‚Äî</span></span>
          </div>
        </div>
        <div class="upActions">
          <button class="upIcon" id="upBell" title="NotificƒÉri">üîî</button>
          <button class="upIcon" id="upHelp" title="Ajutor">‚ùî</button>
          <button class="upIcon upClose" id="upClose" title="√énchide">√ó</button>
        </div>
      </div>

      <div class="upBody">
        <!-- LEFT -->
        <div class="upCard">
          <h3>Zi selectatƒÉ <span class="hint" id="upHeaderSummary">‚Äî</span></h3>
          <div class="upRow2">
            <div class="upField">
              <label>Data</label>
              <input type="date" id="upDate">
            </div>
            <div class="upField">
              <label>Navigare</label>
              <div class="upNav">
                  <button class="btn" id="upPrevDay" type="button">‚Äπ</button>
                  <button class="btn" id="upNextDay" type="button">‚Ä∫</button>
                </div>
            </div>
          </div>

          <div style="height:12px"></div>

          <h3>Evenimente <span class="hint"><span id="upEvCount">0</span> evenimente</span></h3>
          <div class="evList" id="upEvents"></div>
          <button class="upAdd" id="upAddEv" type="button">+ AdaugƒÉ eveniment</button>

          <div style="height:12px"></div>

          <h3>Comentarii</h3>
          <div class="upField">
            <textarea id="upNote" placeholder="AdaugƒÉ o notƒÉ..."></textarea>
          </div>

          <div style="height:10px"></div>

          <div class="upTabs">
            <div class="upChip concediu" data-tag="CONCEDIU">üå¥ Concediu</div>
            <div class="upChip delegatie" data-tag="DELEGATIE">‚úàÔ∏è Delegatie</div>
            <div class="upChip telepasirea" data-tag="TELEPASIRE">‚ö° TelepƒÉ»ôirea</div>
            <div class="upChip invoire" data-tag="INVOIRE">üîî Invoire</div>
          </div>

          
          <div class="tlWrap">
            <div class="tlTicks">
              <span id="tlL">‚Äî</span>
              <span id="tlM">‚Äî</span>
              <span id="tlR">‚Äî</span>
            </div>
            <div class="tlTrack" id="upTimeline" aria-label="Timeline activitate">
              <div class="tlBase"></div>
            </div>
            <div class="tlLegend" id="upTimelineLegend" aria-label="Legenda evenimente"></div>
          </div>


          <div class="ruler">
            <div class="rLine"></div>
            <div class="rMarks" id="upMarks"></div>
          </div>
          <div class="rList" id="upActionList"></div>

          <div class="upErr" id="upErr"></div>
        </div>

        <!-- RIGHT -->
        <div class="upCard">
          <h3>Activitate zilnicƒÉ</h3>
          <div class="statGrid">
            <div class="stat"><div class="k">Activ</div><div class="v" id="stWork">‚Äî</div></div>
            <div class="stat"><div class="k">PauzƒÉ</div><div class="v" id="stPause">‚Äî</div></div>
            <div class="stat"><div class="k">Suplimentar</div><div class="v" id="stExtra">‚Äî</div></div>
            <div class="stat"><div class="k">Balans zi</div><div class="v" id="stBalance">‚Äî</div></div>
          </div>

          <div style="height:12px"></div>

          <h3>SetƒÉri</h3>
          <div class="upField">
            <label>Timezone</label>
            <select id="upTz">
              <option value="Europe/Bucharest">Bucure»ôti (RO)</option>
              <option value="UTC">UTC</option>
            </select>
          </div>

          <div class="togRow">
            <div class="toggle" id="tgTelegram"><div class="switch"><div class="knob"></div></div> NotificƒÉri Telegram</div>
            <div class="toggle" id="tgRemind"><div class="switch"><div class="knob"></div></div> RemindƒÉri</div>
          </div>

          <div style="height:10px"></div>

          <div class="upRow2">
            <div class="upField">
              <label>Afi»ôeazƒÉ dupƒÉ</label>
              <select id="upAfter">
                <option value="1">1 min</option>
                <option value="5" selected>5 min</option>
                <option value="10">10 min</option>
                <option value="15">15 min</option>
              </select>
            </div>
            <div class="upField">
              <label>Ac»õiuni</label>
              <div class="upRow2" style="grid-template-columns:1fr 1fr; gap:8px">
                <button class="btn" id="upOpenFixDay" type="button">FixDay</button>
                <button class="btn" id="upOpenFull" type="button">Panel complet</button>
              </div>
            </div>
          </div>

          <div style="height:12px"></div>

          <h3>Admin</h3>
          <div class="upField" id="mgrWrap" style="margin-top:10px;">
            <label>Manager alocat</label>
            <select id="upManagerSelect"></select>
          </div>
          <div style="height:10px"></div>
          <div class="upRow2" style="grid-template-columns:1fr 1fr; gap:10px">
            <button class="btn" id="upAssignManager" type="button">Atribuie</button>
            <button class="btn" id="upClearManager" type="button">»òterge manager</button>
          </div>
          <div style="height:12px"></div>

          <div class="upRow2" style="grid-template-columns:1fr 1fr; gap:10px">
            <button class="btn danger" id="upDeleteDay" type="button">»òterge zi</button>
            <button class="btn" id="upNotify" type="button">NotificƒÉ angajat</button>
          </div>
          <div style="height:10px"></div>
          <button class="btn" id="upAudit" type="button">FixDay: Audit zi</button>
        </div>
      </div>

      <div class="upFooter">
        <button class="btn" id="upCancel" type="button">AnuleazƒÉ</button>
        <button class="btn primary" id="upApprove" type="button">‚úì SalveazƒÉ modificƒÉrile</button>
      </div>
    </div>
  </div>

</body>
</html>
