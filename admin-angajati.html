<!DOCTYPE html>

<html lang="ro">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>SERVELECT ‚Ä¢ Admin Pontaj</title>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&amp;display=swap" rel="stylesheet"/>
<link href="favicon.png" rel="icon"/>
<meta content="#516A75" name="theme-color"/>
<link href="admin-core.css" rel="stylesheet"/><link href="admin-embed.css" rel="stylesheet"/><style>
  /* ===== Angaja»õi (design like 3.webp) ===== */
  .aaHead{padding:22px 18px 14px}
  .aaHeadTop{display:flex;align-items:flex-end;gap:14px;flex-wrap:wrap;justify-content:space-between}
  .aaTitle{margin:0 0 6px;font-size:20px;font-weight:800;letter-spacing:.2px}
  .aaSub{color:rgba(80, 90, 120, .85);font-weight:600;font-size:12px}
  .aaControls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .aaSearch{display:flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid rgba(70,80,120,.18);border-radius:12px;background:#fff;min-width:230px}
  .aaSearchIcon{opacity:.55}
  .aaSearch input{border:0;outline:0;background:transparent;font:inherit;width:100%}
  .aaSelect{padding:10px 12px;border-radius:12px;border:1px solid rgba(70,80,120,.18);background:#fff;font:inherit}
  .aaDates{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:12px;border:1px solid rgba(70,80,120,.18);background:#fff}
  .aaDate{border:0;outline:0;font:inherit;background:transparent}
  .aaDash{opacity:.35;font-weight:800}
  .aaWarn{margin-top:10px;padding:10px 12px;border-radius:12px;font-weight:700;font-size:12px;background:rgba(255,77,77,.10);color:#b1252c;border:1px solid rgba(255,77,77,.25)}
  .aaWarn.ok{background:rgba(89,209,125,.14);color:#1d7a3a;border-color:rgba(89,209,125,.30)}
  .aaWarn.bad{background:rgba(255,77,77,.10);color:#b1252c;border-color:rgba(255,77,77,.25)}

  .aaCard{margin:0 18px 22px;border-radius:18px;background:#fff;border:1px solid rgba(70,80,120,.14);overflow:hidden}
  .aaRow{display:grid;grid-template-columns: 1.25fr .75fr .55fr;gap:12px;align-items:center;padding:14px 16px}
  .aaRowHead{background:rgba(240,242,255,.55);border-bottom:1px solid rgba(70,80,120,.14);font-weight:900;color:#2f3450}
  .aaColActions{text-align:right}
  .aaSort{background:transparent;border:0;font:inherit;font-weight:900;color:inherit;cursor:pointer;display:flex;align-items:center;gap:8px}
  .aaSortIcon{opacity:.55;font-weight:900}
  #list .aaRowBody{border-bottom:1px solid rgba(70,80,120,.12)}
  #list .aaRowBody:last-child{border-bottom:0}
  .aaEmp{display:flex;align-items:center;gap:12px;min-width:0}
  .aaAvatar{width:38px;height:38px;border-radius:999px;background:#f0f2ff;border:2px solid #fff;box-shadow:0 8px 18px rgba(20,18,40,.10);display:flex;align-items:center;justify-content:center;font-weight:900;color:#38405c}
  .aaAvatarImg{width:38px;height:38px;border-radius:999px;border:2px solid #fff;box-shadow:0 8px 18px rgba(20,18,40,.10);object-fit:cover}
  .aaEmpMeta{min-width:0}
  .aaEmpName{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .aaEmpSub{font-size:12px;color:rgba(80,90,120,.78);font-weight:700;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .aaBadge{margin-left:auto;font-size:11px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid rgba(70,80,120,.14);background:#fff}
  .aaBadge.ok{color:#1d7a3a;background:rgba(89,209,125,.12);border-color:rgba(89,209,125,.35)}
  .aaBadge.bad{color:#b1252c;background:rgba(255,77,77,.10);border-color:rgba(255,77,77,.30)}
  .aaPeriod{font-weight:900;color:#2f3450}

  .aaColActions{display:flex;gap:10px;justify-content:flex-end;align-items:center}
  .aaBtnApprove{
    display:inline-flex;align-items:center;gap:10px;
    padding:12px 16px;border-radius:12px;border:1px solid rgba(89,209,125,.55);
    background:linear-gradient(180deg, rgba(89,209,125,.92), rgba(89,209,125,.80));
    color:#fff;font-weight:900;cursor:pointer;
    box-shadow:0 10px 20px rgba(27,150,90,.18);
  }
  .aaCheck{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:999px;background:rgba(255,255,255,.20);font-weight:1000}
  .aaBtnReject,.aaBtnGear{
    width:44px;height:44px;border-radius:12px;border:1px solid rgba(70,80,120,.18);
    background:#f7f8ff;color:#2f3450;font-weight:900;cursor:pointer;
  }
  .aaBtnReject:hover,.aaBtnGear:hover{filter:brightness(0.98)}
  .aaBtnApprove:hover{filter:brightness(0.99)}
  .aaRowBody:hover{background:rgba(240,242,255,.22)}

  .aaEmpty{padding:26px 16px;text-align:center;color:rgba(80,90,120,.75);font-weight:800}
  .aaLoading{display:flex;align-items:center;gap:12px;justify-content:center;padding:22px 16px;color:rgba(80,90,120,.75);font-weight:800}
  .aaSpinner{width:18px;height:18px;border-radius:999px;border:3px solid rgba(80,90,120,.18);border-top-color:rgba(80,90,120,.55);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  .aaMenu{
    position:fixed;z-index:9999;
    width:240px;padding:8px;border-radius:14px;
    background:#fff;border:1px solid rgba(70,80,120,.16);
    box-shadow:0 16px 40px rgba(20,18,40,.18);
  }
  .aaMenuItem{
    width:100%;text-align:left;
    border:0;background:transparent;
    padding:10px 10px;border-radius:12px;
    font-weight:900;cursor:pointer;
  }
  .aaMenuItem:hover{background:rgba(240,242,255,.6)}

  .aaModalWrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(20,18,40,.25);z-index:10000;padding:18px}
  .aaModal{width:min(560px, 100%);background:#fff;border-radius:18px;border:1px solid rgba(70,80,120,.16);box-shadow:0 18px 46px rgba(20,18,40,.20);overflow:hidden}
  .aaModalHead{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:rgba(240,242,255,.6);border-bottom:1px solid rgba(70,80,120,.14)}
  .aaModalTitle{font-weight:1000}
  .aaIconBtn{width:36px;height:36px;border-radius:12px;border:1px solid rgba(70,80,120,.18);background:#fff;font-weight:1000;cursor:pointer}
  .aaModalBody{padding:16px}
  .aaField{margin-bottom:12px}
  .aaField label{display:block;font-weight:900;margin:0 0 6px}
  .aaInput{width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(70,80,120,.18);font:inherit;outline:none}
  .aaRead{padding:12px 12px;border-radius:12px;border:1px dashed rgba(70,80,120,.22);background:#fbfcff;font-weight:900}
  .aaHelp{margin-top:6px;color:rgba(80,90,120,.78);font-weight:700;font-size:12px;line-height:1.35}
  .aaModalFoot{display:flex;gap:10px;align-items:center;padding:14px 16px;border-top:1px solid rgba(70,80,120,.14);background:rgba(240,242,255,.35)}

  @media (max-width: 860px){
    .aaRow{grid-template-columns: 1fr;gap:10px}
    .aaColActions{justify-content:flex-start}
    .aaControls{width:100%}
    .aaSearch{flex:1;min-width:200px}
  }
</style>
</head>
<body class="admin-embed view-employees" data-page-title="Index angaja»õi ‚Ä¢ Admin">
<div class="shell">
<nav class="nav card">
<a aria-label="Spre pontaj" class="brand" href="index.html">
<img alt="SiglƒÉ SERVELECT" src="favicon.png"/>
<div>
<h1><span>SERVELECT</span><small>Pontaj &amp; Management Concedii</small></h1>
</div>
</a>
<div class="nav-actions">
<!-- √énapoi la pontaj -->
<a class="btn" href="index.html" id="backToTimesheetLink">
      ‚Üê √énapoi la pontaj
    </a>
<!-- Badge de context -->
<div class="chip">Admin dashboard</div>
<!-- Meniu hamburger (user + Deconectare) -->
<div class="nav-menu-wrapper">
<button aria-expanded="false" aria-label="Meniu admin" class="hamburger-btn" id="adminHamburgerBtn" type="button">
<span class="hamburger-box">
<span class="hamburger-inner"></span>
</span>
</button>
<div class="nav-menu" id="adminHamburgerMenu">
<div class="nav-menu-section">
<div class="nav-menu-user-label">Utilizator logat</div>
<div class="chip" id="adminLabel">Admin</div>
</div>
<div class="nav-menu-section nav-menu-actions">
<button class="nav-menu-item nav-menu-item-danger" id="logoutBtn" type="button">
<span>Deconectare</span>
</button>
</div>
</div>
</div>
<!-- Self-service: lƒÉsat √Æn DOM pentru script, dar ascuns prin CSS -->
<a class="btn" href="self.html" id="selfServiceLink" rel="noopener" target="_blank">
      üßæ Self-service ‚Äì raportul meu
    </a>
</div>
</nav>
<main class="admin-layout">
  <section class="admin-main">
    <header class="aaHead">
      <div class="aaHeadTop">
        <div>
          <h1 class="aaTitle">Angaja»õi</h1>
          <div class="aaSub" id="subLine">√éncƒÉrcare‚Ä¶</div>
        </div>

        <div class="aaControls">
          <div class="aaSearch">
            <span class="aaSearchIcon">üîé</span>
            <input id="q" placeholder="CautƒÉ angajat" autocomplete="off"/>
          </div>

          <select id="scope" class="aaSelect" title="Filtru angaja»õi">
            <option value="mine">Angaja»õii mei</option>
            <option value="all">To»õi angaja»õii</option>
          </select>

          <div class="aaDates">
            <input id="from" type="date" class="aaDate" title="De la"/>
            <span class="aaDash">‚Äî</span>
            <input id="to" type="date" class="aaDate" title="P√¢nƒÉ la"/>
          </div>

          <button class="btn primary" id="refreshBtn" type="button">Re√ÆncarcƒÉ</button>
        </div>
      </div>

      <div class="aaWarn" id="warnBox" style="display:none"></div>
    </header>

    <section class="aaCard">
      <div class="aaRow aaRowHead">
        <div class="aaColEmp">
          <button class="aaSort" data-sort="name" type="button">
            ANGAJAT <span class="aaSortIcon">‚Üë‚Üì</span>
          </button>
        </div>
        <div class="aaColPeriod">
          <button class="aaSort" data-sort="period" type="button">
            PERIOADA <span class="aaSortIcon">‚Üë‚Üì</span>
          </button>
        </div>
        <div class="aaColActions">AC»öIUNI</div>
      </div>

      <div id="list"></div>

      <div class="aaEmpty" id="empty" style="display:none">
        Nu existƒÉ angaja»õi pentru filtrul curent.
      </div>

      <div class="aaLoading" id="loading">
        <div class="aaSpinner"></div>
        <div>Se √ÆncarcƒÉ‚Ä¶</div>
      </div>
    </section>
  </section>
</main>

<div class="aaMenu" id="menu" style="display:none">
  <button class="aaMenuItem" id="mSetPin" type="button">üîë SeteazƒÉ PIN</button>
  <button class="aaMenuItem" id="mClearPin" type="button">üßΩ »òterge PIN</button>
  <button class="aaMenuItem" id="mToggleActive" type="button">‚úÖ/‚õî ActiveazƒÉ / DezactiveazƒÉ</button>
</div>

<div class="aaModalWrap" id="pinModal" style="display:none">
  <div class="aaModal">
    <div class="aaModalHead">
      <div class="aaModalTitle">SeteazƒÉ PIN</div>
      <button class="aaIconBtn" id="pinClose" type="button">‚úï</button>
    </div>
    <div class="aaModalBody">
      <div class="aaField">
        <label>Angajat</label>
        <div class="aaRead" id="pinEmpName">‚Äî</div>
      </div>
      <div class="aaField">
        <label>PIN (4‚Äì10 cifre)</label>
        <input id="pinInput" class="aaInput" inputmode="numeric" autocomplete="off" placeholder="ex: 1234"/>
        <div class="aaHelp">PIN-ul se salveazƒÉ permanent √Æn <b>EmployeeAuth</b> (hash). Angajatul √Æl folose»ôte √Æn <b>index.html</b>.</div>
      </div>
      <div class="aaField">
        <label>ConfirmƒÉ PIN</label>
        <input id="pinInput2" class="aaInput" inputmode="numeric" autocomplete="off" placeholder="repetƒÉ PIN-ul"/>
      </div>
    </div>
    <div class="aaModalFoot">
      <button class="btn" id="pinGen" type="button">GenereazƒÉ</button>
      <div style="flex:1"></div>
      <button class="btn" id="pinCancel" type="button">Renun»õƒÉ</button>
      <button class="btn primary" id="pinSave" type="button">SalveazƒÉ</button>
    </div>
  </div>
</div>

<div class="aaModalWrap" id="keyModal" style="display:none">
  <div class="aaModal">
    <div class="aaModalHead">
      <div class="aaModalTitle">Cheie admin</div>
    </div>
    <div class="aaModalBody">
      <div class="aaHelp">Nu am gƒÉsit <b>ADMIN_KEY</b> √Æn browser. Introdu cheia ca sƒÉ pot citi/scrie √Æn sheet-uri.</div>
      <input id="keyInput" class="aaInput" autocomplete="off" placeholder="ex: Servelect_2026!_AdminKey"/>
      <div class="aaHelp">Se salveazƒÉ √Æn localStorage: <code>pontaj_adminKey</code>.</div>
    </div>
    <div class="aaModalFoot">
      <div style="flex:1"></div>
      <button class="btn primary" id="keySave" type="button">SalveazƒÉ</button>
    </div>
  </div>
</div>

<script>
(function(){try{const t=document.body.getAttribute('data-page-title')||'Admin ‚Äî Angaja»õi';document.title=t;}catch(e){}})();
</script>

<script>
(() => {
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const esc = (s)=>String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  const pad2 = (n)=>String(n).padStart(2,"0");
  const fmtDate = (d)=>`${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`;
  const fmtPeriod = (from, to)=>`${fmtDate(from)} ‚Äì ${fmtDate(to)}`;
  const initials = (name)=>{
    const parts = String(name||"").trim().split(/\s+/).filter(Boolean);
    const a = parts[0]?.[0]||"";
    const b = parts[1]?.[0]||"";
    return (a+b).toUpperCase() || "‚Ä¢";
  };

  function toast(msg, ok=true){
    const box = $("#warnBox");
    box.style.display = "";
    box.className = "aaWarn" + (ok ? " ok" : " bad");
    box.textContent = msg;
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>{ box.style.display="none"; }, 3200);
  }
  function showWarn(msg){
    const box = $("#warnBox");
    box.style.display = "";
    box.className = "aaWarn bad";
    box.textContent = msg;
  }

  const CFG = {};
  async function loadConfig(){
    const tries = ["config.json","./config.json","../config.json","/config.json"];
    for (const p of tries){
      try{
        const r = await fetch(p+"?v="+Date.now(), {cache:"no-store"});
        if (!r.ok) continue;
        const j = await r.json();
        Object.assign(CFG, j);
        return;
      }catch(e){}
    }
    throw new Error("Nu pot √ÆncƒÉrca config.json (verificƒÉ path-ul / GitHub Pages).");
  }

  function getAdminName(){
    const keys = ["pontaj/admin/v1","pontaj_admin_session","pontaj_admin","admin_session"];
    for (const k of keys){
      try{
        const raw = localStorage.getItem(k);
        if (!raw) continue;
        const obj = JSON.parse(raw);
        return obj.label || obj.name || obj.user || obj.username || "";
      }catch(e){}
    }
    return "";
  }
  function getAdminKey(){
    return localStorage.getItem("pontaj_adminKey")
      || localStorage.getItem("pontaj/adminKey")
      || localStorage.getItem("ADMIN_KEY")
      || "";
  }
  function ensureAdminKey(){
    const key = getAdminKey();
    if (key) return Promise.resolve(key);
    $("#keyModal").style.display = "flex";
    return new Promise((resolve)=>{
      $("#keySave").onclick = ()=>{
        const v = String($("#keyInput").value||"").trim();
        if (!v) return;
        localStorage.setItem("pontaj_adminKey", v);
        $("#keyModal").style.display = "none";
        resolve(v);
      };
    });
  }

  function jsonp(endpoint, params){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(16).slice(2);
      const qs = new URLSearchParams(Object.assign({}, params, { callback: cb }));
      const url = endpoint + (endpoint.includes("?") ? "&" : "?") + qs.toString();
      const s = document.createElement("script");
      let done = false;

      window[cb] = (data)=>{
        done = true;
        cleanup();
        resolve(data);
      };
      function cleanup(){
        try{ delete window[cb]; }catch(e){ window[cb] = undefined; }
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }
      s.onerror = ()=>{
        if (done) return;
        cleanup();
        reject(new Error("JSONP error"));
      };
      s.src = url;
      document.head.appendChild(s);
    });
  }

  const STATE = {
    employees: [],
    filtered: [],
    managersMap: {},
    sort: "name",
    sortDir: 1,
    adminName: "",
    adminKey: "",
    from: null,
    to: null,
  };

  async function apiManagersMap(){
    try{
      const r = await jsonp(CFG.adminEventsEndpoint, { fn:"adminManagersMap", key: STATE.adminKey });
      if (r && r.ok) return r.map || {};
    }catch(e){}
    return {};
  }
  async function apiEmployees(){
    const r = await jsonp(CFG.adminEventsEndpoint, { fn:"adminEmployees", key: STATE.adminKey });
    if (!r || !r.ok) throw new Error(r?.message || "adminEmployees failed");
    const list = r.employees || r.list || [];
    return list.map(x=>({
      employeeKey: x.employeeKey || x.key || x.usernameHash || "",
      name: x.name || x.employeeName || x.label || "",
      dept: x.dept || x.department || "",
      active: (x.active === false || String(x.active).toLowerCase()==="false") ? false : true,
      avatarUrl: (x.avatarUrl || x.avatarURL || x.AvatarURL || x.avatar || "") || ""
    })).filter(x=>x.name);
  }

  async function apiSetPin(emp, pin){
    const r = await jsonp(CFG.adminEventsEndpoint, {
      fn:"adminEmployeeSetPin",
      key: STATE.adminKey,
      employeeKey: emp.employeeKey,
      employeeName: emp.name,
      pin: pin
    });
    if (!r || !r.ok) throw new Error(r?.message || "Set PIN failed");
    return r;
  }
  async function apiClearPin(emp){
    const r = await jsonp(CFG.adminEventsEndpoint, {
      fn:"adminEmployeeClearPin",
      key: STATE.adminKey,
      employeeKey: emp.employeeKey,
      employeeName: emp.name
    });
    if (!r || !r.ok) throw new Error(r?.message || "Clear PIN failed");
    return r;
  }
  async function apiSetActive(emp, active){
    const r = await jsonp(CFG.adminEventsEndpoint, {
      fn:"adminEmployeeSetActive",
      key: STATE.adminKey,
      employeeKey: emp.employeeKey,
      employeeName: emp.name,
      active: active ? "1" : "0"
    });
    if (!r || !r.ok) throw new Error(r?.message || "Set active failed");
    return r;
  }

  function apply(){
    const q = String($("#q").value||"").trim().toLowerCase();
    const scope = $("#scope").value;
    let arr = STATE.employees.slice();

    if (scope === "mine" && STATE.adminName){
      const map = STATE.managersMap || {};
      arr = arr.filter(e=>{
        const m = map[e.employeeKey];
        const mgr = (m && (m.managerName || m.managerEmail)) ? String(m.managerName || m.managerEmail) : "";
        return mgr && mgr.toLowerCase() === STATE.adminName.toLowerCase();
      });
    }

    if (q){
      arr = arr.filter(e=> e.name.toLowerCase().includes(q) || String(e.dept||"").toLowerCase().includes(q));
    }

    const periodText = fmtPeriod(STATE.from, STATE.to);
    arr = arr.map(e=>({ ...e, periodText }));

    const key = STATE.sort;
    const dir = STATE.sortDir;
    arr.sort((a,b)=> (key==="name" ? a.name.localeCompare(b.name, "ro") : a.periodText.localeCompare(b.periodText)) * dir);

    STATE.filtered = arr;
    render();
  }

  function render(){
    const list = $("#list");
    const empty = $("#empty");
    const loading = $("#loading");
    loading.style.display = "none";

    if (!STATE.filtered.length){
      list.innerHTML = "";
      empty.style.display = "";
      $("#subLine").textContent = "0 angaja»õi.";
      return;
    }
    empty.style.display = "none";

    $("#subLine").textContent = `${STATE.filtered.length} angaja»õi ‚Ä¢ ${fmtPeriod(STATE.from, STATE.to)}${STATE.adminName ? " ‚Ä¢ " + STATE.adminName : ""}`;

    list.innerHTML = STATE.filtered.map(emp=>{
      const avatarUrl = (emp.avatarUrl && String(emp.avatarUrl).trim())
        ? String(emp.avatarUrl).trim()
        : ((CFG.employeeAvatars && CFG.employeeAvatars[emp.name]) ? String(CFG.employeeAvatars[emp.name]) : "");
      const avatarHtml = avatarUrl
        ? `<img class="aaAvatarImg" src="${esc(avatarUrl)}" alt="">`
        : `<div class="aaAvatar">${esc(initials(emp.name))}</div>`;
      const badge = emp.active ? `<span class="aaBadge ok">Activ</span>` : `<span class="aaBadge bad">Inactiv</span>`;
      return `<div class="aaRow aaRowBody" data-key="${esc(emp.employeeKey)}">
        <div class="aaColEmp">
          <div class="aaEmp">
            ${avatarHtml}
            <div class="aaEmpMeta">
              <div class="aaEmpName">${esc(emp.name)}</div>
              <div class="aaEmpSub">${esc(emp.dept||"")}</div>
            </div>
            ${badge}
          </div>
        </div>
        <div class="aaColPeriod">
          <div class="aaPeriod">${esc(emp.periodText)}</div>
        </div>
        <div class="aaColActions">
          <button class="aaBtnApprove" data-act="approve" type="button">
            <span class="aaCheck">‚úì</span> AprobƒÉ
          </button>
          <button class="aaBtnReject" data-act="reject" type="button" title="Respinge">‚úï</button>
          <button class="aaBtnGear" data-act="gear" type="button" title="SetƒÉri">‚öô</button>
        </div>
      </div>`;
    }).join("");

    $$(".aaRowBody", list).forEach(row=>{
      const key = row.getAttribute("data-key");
      const emp = STATE.filtered.find(x=>x.employeeKey===key);
      row.querySelector("[data-act='approve']").onclick = ()=>toast("AprobƒÉri: TODO (spune-mi ce aprobi aici).", true);
      row.querySelector("[data-act='reject']").onclick  = ()=>toast("Respingeri: TODO.", false);
      row.querySelector("[data-act='gear']").onclick    = (ev)=>openMenu(ev.currentTarget, emp);
    });
  }

  let MENU_EMP = null;
  function openMenu(btn, emp){
    MENU_EMP = emp;
    const m = $("#menu");
    const r = btn.getBoundingClientRect();
    m.style.display = "block";
    m.style.left = Math.min(window.innerWidth - 260, r.right - 240) + "px";
    m.style.top  = (r.bottom + 8) + "px";
  }
  function closeMenu(){
    $("#menu").style.display = "none";
    MENU_EMP = null;
  }

  function openPinModal(emp){
    $("#pinEmpName").textContent = emp.name;
    $("#pinInput").value = "";
    $("#pinInput2").value = "";
    $("#pinModal").style.display = "flex";
    $("#pinInput").focus();
  }
  function closePinModal(){ $("#pinModal").style.display = "none"; }
  function randPin(){ return String(Math.floor(1000 + Math.random()*9000)); }

  function bind(){
    $("#refreshBtn").addEventListener("click", ()=>refresh());
    $("#q").addEventListener("input", ()=>apply());
    $("#scope").addEventListener("change", ()=>apply());
    $$(".aaSort").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const key = btn.getAttribute("data-sort");
        if (STATE.sort === key) STATE.sortDir *= -1;
        else { STATE.sort = key; STATE.sortDir = 1; }
        apply();
      });
    });

    $("#mSetPin").onclick = ()=>{ if (!MENU_EMP) return; const e = MENU_EMP; closeMenu(); openPinModal(e); };
    $("#mClearPin").onclick = async ()=>{
      if (!MENU_EMP) return;
      const emp = MENU_EMP; closeMenu();
      if (!confirm("»òtergi PIN-ul pentru " + emp.name + "?")) return;
      try{ await apiClearPin(emp); toast("PIN »ôters pentru " + emp.name, true); }catch(e){ showWarn(e.message || String(e)); }
    };
    $("#mToggleActive").onclick = async ()=>{
      if (!MENU_EMP) return;
      const emp = MENU_EMP; closeMenu();
      const next = !emp.active;
      try{
        await apiSetActive(emp, next);
        emp.active = next;
        toast((next ? "Activat: " : "Dezactivat: ") + emp.name, true);
        apply();
      }catch(e){ showWarn(e.message || String(e)); }
    };

    document.addEventListener("click", (ev)=>{
      const m = $("#menu");
      if (m.style.display==="none") return;
      if (m.contains(ev.target)) return;
      if (String(ev.target?.getAttribute?.("data-act")||"") === "gear") return;
      closeMenu();
    });

    $("#pinClose").onclick = closePinModal;
    $("#pinCancel").onclick = closePinModal;
    $("#pinGen").onclick = ()=>{
      const p = randPin();
      $("#pinInput").value = p;
      $("#pinInput2").value = p;
    };
    $("#pinSave").onclick = async ()=>{
      const name = $("#pinEmpName").textContent;
      const target = STATE.employees.find(x=>x.name===name) || STATE.filtered.find(x=>x.name===name);
      if (!target) return showWarn("Nu gƒÉsesc angajatul pentru PIN.");
      const p1 = String($("#pinInput").value||"").trim();
      const p2 = String($("#pinInput2").value||"").trim();
      if (!/^\d{4,10}$/.test(p1)) return showWarn("PIN invalid (4‚Äì10 cifre).");
      if (p1 !== p2) return showWarn("PIN-urile nu coincid.");
      try{
        await apiSetPin(target, p1);
        closePinModal();
        toast("PIN salvat pentru " + target.name, true);
      }catch(e){ showWarn(e.message || String(e)); }
    };
  }

  async function refresh(){
    $("#loading").style.display = "";
    $("#empty").style.display = "none";
    $("#list").innerHTML = "";
    $("#subLine").textContent = "√éncƒÉrcare‚Ä¶";

    try{
      STATE.adminKey = await ensureAdminKey();
      STATE.adminName = getAdminName();

      const [emps, mmap] = await Promise.all([apiEmployees(), apiManagersMap()]);
      STATE.employees = emps;
      STATE.managersMap = mmap;

      if (!STATE.adminName){
        showWarn("Nu pot determina numele tƒÉu de admin din sesiune. Filtrul ¬´Angaja»õii mei¬ª poate returna 0.");
      }
      apply();
    }catch(e){
      console.error(e);
      showWarn(e.message || String(e));
      $("#loading").style.display = "none";
    }
  }

  async function init(){
    const now = new Date();
    const from = new Date(now.getFullYear(), now.getMonth(), 1);
    const to = new Date(now.getFullYear(), now.getMonth()+1, 0);
    STATE.from = from; STATE.to = to;
    $("#from").value = `${from.getFullYear()}-${pad2(from.getMonth()+1)}-${pad2(from.getDate())}`;
    $("#to").value   = `${to.getFullYear()}-${pad2(to.getMonth()+1)}-${pad2(to.getDate())}`;
    $("#from").addEventListener("change", ()=>{
      const d = new Date($("#from").value + "T00:00:00");
      if (!isNaN(d)) STATE.from = d;
      apply();
    });
    $("#to").addEventListener("change", ()=>{
      const d = new Date($("#to").value + "T00:00:00");
      if (!isNaN(d)) STATE.to = d;
      apply();
    });

    bind();
    await loadConfig();
    await refresh();
  }

  init();
})();
</script>
</div>
<script>(function(){try{const t=document.body.getAttribute('data-page-title')||'Admin';document.title=t;}catch(e){}})();</script><script src="admin-core.js"></script></body>
</html>
