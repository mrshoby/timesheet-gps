<!DOCTYPE html>

<html lang="ro">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>SERVELECT â€¢ Admin Pontaj</title>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&amp;display=swap" rel="stylesheet"/>
<link href="favicon.png" rel="icon"/>
<meta content="#516A75" name="theme-color"/>
<link href="admin-core.css" rel="stylesheet"/><link href="admin-embed.css" rel="stylesheet"/>
<style>
  /* ===== AngajaÈ›i (redesign ca 3.webp) ===== */
  :root{
    --bg:#f3f4fb;
    --card:#ffffff;
    --line:#e7e8f2;
    --text:#1f2330;
    --muted:#7c8096;
    --purple:#7a63ff;
    --green:#79c77d;
    --green2:#5fbf69;
    --btn:#f2f2fb;
  }
  body.admin-embed.view-employees{ background:var(--bg) !important; }
  .shell{ max-width:1180px; margin:0 auto; padding:18px 14px 28px; }
  nav.nav.card{ background:transparent !important; border:0 !important; box-shadow:none !important; padding:0 !important; margin:0 0 14px; }
  nav.nav.card .nav-actions{ gap:10px; }
  nav.nav.card .chip{ background:rgba(122,99,255,.12); color:var(--purple); border:1px solid rgba(122,99,255,.25); }
  .pageCard{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:22px;
    box-shadow:0 20px 50px rgba(30,30,60,.08);
    overflow:hidden;
  }
  .pageHead{
    padding:18px 18px 12px;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
  }
  .pageTitle{
    font-size:20px; font-weight:900; color:var(--text);
    display:flex; align-items:baseline; gap:10px;
  }
  .pageTitle small{
    font-size:12px; font-weight:800; color:var(--muted);
  }
  .filters{
    padding:0 18px 14px;
    display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;
  }
  .filters label{ display:flex; flex-direction:column; gap:6px; font-size:11px; font-weight:900; color:var(--muted
<main class="admin-layout" style="display:block">
  <section class="pageCard">
    <div class="pageHead">
      <div class="pageTitle">
        Index angajaÈ›i
        <small id="subTitle">â€”</small>
      </div>
      <div class="right">
        <button class="pill" id="refreshBtn" type="button">âŸ³ ReÃ®ncarcÄƒ</button>
      </div>
    </div>

    <div class="filters">
      <label class="grow">
        <span>CautÄƒ angajat</span>
        <input id="q" placeholder="TasteazÄƒ pentru a filtra..." />
      </label>

      <label>
        <span>PerioadÄƒ</span>
        <select id="range">
          <option value="today">AstÄƒzi</option>
          <option value="last7" selected>Ultimele 7 zile</option>
          <option value="month">Luna curentÄƒ</option>
          <option value="all">Toate datele</option>
        </select>
      </label>

      <label>
        <span>Departament</span>
        <select id="dept">
          <option value="all">Toate</option>
        </select>
      </label>

      <label>
        <span>Filtru</span>
        <select id="scope">
          <option value="mine">RepartizaÈ›i mie</option>
          <option value="all">ToÈ›i angajaÈ›ii</option>
        </select>
      </label>
    </div>

    <div class="tblWrap">
      <table class="empTbl">
        <thead>
          <tr>
            <th style="width:46%">
              ANGAJAT
              <span class="sort" id="sortName" title="SorteazÄƒ dupÄƒ angajat">â†‘<span style="margin-top:-2px">â†“</span></span>
            </th>
            <th style="width:32%">
              PERIOADA
              <span class="sort" id="sortPeriod" title="SorteazÄƒ dupÄƒ perioadÄƒ">â†‘<span style="margin-top:-2px">â†“</span></span>
            </th>
            <th style="width:22%">ACÈšIUNI</th>
          </tr>
        </thead>
        <tbody id="body">
          <tr><td class="empty" colspan="3">Se Ã®ncarcÄƒâ€¦</td></tr>
        </tbody>
      </table>
    </div>
  </section>
</main>

<div class="toast" id="toast">â€”</div>
ss="btn" href="#" id="employeeSelfLink" rel="noopener" style="display:none;margin:8px 0 10px" target="_blank">
  ğŸ§¾ Deschide pontajul angajatului
</a>
<div id="employeeDetailsBody">
<div class="admin-empty">Niciun angajat selectat.</div>
</div>
</section>
</div>
</section>
<!-- TAB NOU: Alerte LIVE -->
<section id="alertsPage" style="display:none">
<div class="admin-filter-line" style="margin:0 0 10px;">
<label>
<span>Tip alertÄƒ</span>
<select id="alertsTypeFilter">
<option value="all">Toate</option>
<option value="pause">PauzÄƒ</option>
<option value="norm">NormÄƒ</option>
<option value="extra">Extra</option>
<option value="system">Sistem</option>
</select>
</label>
<label>
<span>Departament</span>
<select id="alertsDeptFilter">
<option value="all">Toate</option>
</select>
</label>
<label style="flex:1;min-width:220px;">
<span>CautÄƒ</span>
<input id="alertsSearch" placeholder="Nume / mesaj..." type="text"/>
</label>
</div>
<section class="card admin-card" data-section="alerts">
<h2>Alerte LIVE pe ziua curentÄƒ</h2>
<div class="admin-small-text">
              Monitorizare Ã®n timp real (client-side) pentru:
              <ul style="margin:4px 0 0 16px;padding:0;font-size:11px;color:var(--muted);">
<li>PauzÄƒ &gt; limitÄƒ (implicit 40 min, din configurare) fÄƒrÄƒ UNPAUSE â€“ notificÄƒri din 15 Ã®n 15 minute.</li>
<li>NormÄƒ depÄƒÈ™itÄƒ (8h / 8h30 sau valori din <code>normSettings</code>) fÄƒrÄƒ FINISH â€“ notificÄƒri din 30 Ã®n 30 de minute.</li>
<li>EXTRA Ã®n curs &gt; 30 min â€“ notificÄƒri din 15 Ã®n 15 minute.</li>
</ul>
</div>
<div class="admin-list" id="liveAlertsActive"></div>
</section>
<section class="card admin-card" data-section="alerts">
<h2>Istoric notificÄƒri Ã®n sesiunea curentÄƒ</h2>
<div class="admin-small-text">
              Fiecare depÄƒÈ™ire genereazÄƒ o notificare iniÈ›ialÄƒ, apoi Ã®ncÄƒ una la fiecare interval (15 / 30 min) cÃ¢t timp condiÈ›ia rÄƒmÃ¢ne activÄƒ.
              Istoricul este local, doar pentru sesiunea curentÄƒ a paginii.
            </div>
<div class="table-wrap">
<table class="admin-table">
<thead>
<tr>
<th>Moment</th>
<th>Angajat</th>
<th>Departament</th>
<th>Tip</th>
<th>Mesaj</th>
</tr>
</thead>
<tbody id="liveAlertsHistoryBody"></tbody>
</table>
</div>
</section>
<!-- NOU: Alerte istorice din sistem (toate zilele anterioare) -->
<section class="card admin-card" data-section="alerts">
<h2>Alerte istorice din sistem</h2>
<div class="admin-small-text">
              Alerte generate de Apps Script pentru toate zilele (inclusiv cele anterioare), pe baza datelor salvate Ã®n foaia de pontaj.
            </div>
<div class="table-wrap">
<table class="admin-table">
<thead>
<tr>
<th>Moment</th>
<th>Angajat</th>
<th>Departament</th>
<th>Tip</th>
<th>Mesaj</th>
</tr>
</thead>
<tbody id="systemAlertsHistoryBody"></tbody>
</table>
</div>
</section>
</section>
</section>
<aside class="admin-side">
<!-- A2: Top angajaÈ›i (pliabil) -->
<section class="card admin-card collapsible" data-section="live">
<h2 class="admin-card-title">
            Top angajaÈ›i
            <span class="collapse-icon">â–¼</span>
</h2>
<div class="admin-card-body">
<div class="admin-small-text">
              Clasament all time:
              <button class="top-toggle active" id="topModeHours" type="button">Ore normÄƒ</button>
<button class="top-toggle" id="topModeAnomalies" type="button">Anomalii</button>
</div>
<div class="admin-list" id="topEmployees"></div>
</div>
</section>
<!-- A5: Live board (pliabil) -->
<section class="card admin-card collapsible" data-section="live">
<h2 class="admin-card-title">
            Live pontaj
            <span class="collapse-icon">â–¼</span>
</h2>
<div class="admin-card-body">
<div class="admin-small-text" id="liveBoardHint">
<div class="admin-small-text" id="liveBoardSummary" style="margin:6px 0 8px;"></div>
<span id="liveBoardHintText">
                Starea curentÄƒ a pontajului pentru ziua de azi (START / PAUSE / EXTRA / FINISH).
              </span>
</div>
<div style="margin:6px 0 8px;display:flex;gap:6px;flex-wrap:wrap;">
<button class="top-toggle active" id="liveBoardTodayBtn" type="button">Azi</button>
<button class="top-toggle" id="liveBoardPastBtn" type="button">Zile anterioare</button>
</div>
<div style="margin:10px 0 6px;display:flex;align-items:center;justify-content:space-between;gap:8px;">
<div class="admin-small-text" style="margin:0;font-weight:700;">AngajaÈ›i (status)</div>
<!-- (opÈ›ional) poÈ›i pune aici un badge count dacÄƒ vrei -->
</div>
<div class="admin-list" id="liveBoard"></div>
<div style="margin:10px 0 6px;display:flex;align-items:center;justify-content:space-between;gap:8px;">
<div class="admin-small-text" style="margin:0;font-weight:700;">Inactivi azi</div>
<span class="badge badge-info" id="liveInactiveCount" style="display:none"></span>
</div>
<div class="admin-list" id="liveBoardInactive"></div>
</div>
</section>
<!-- A5.5. Admin presence (cine e online) -->
<section class="card" id="adminPresenceCard">
<div class="card-head">
<h3>Admini activi</h3>
<div class="muted" id="adminPresenceHint">â€”</div>
</div>
<div class="card-body">
<div class="pres-list" id="adminPresenceList"></div>
</div>
</section>
<!-- A6: Alerte sistem (pliabil) -->
<section class="card admin-card collapsible" data-section="live">
<h2 class="admin-card-title">
            Alerte sistem
            <span class="collapse-icon">â–¼</span>
</h2>
<div class="admin-card-body">
<div class="admin-small-text">
              Ultimele notificÄƒri generate de sistem (pontaj uitat, anomalii etc.), venite din Apps Script.
            </div>
<div class="admin-list" id="alertsList"></div>
</div>
</section>
<!-- NotiÈ›e (pliabil) -->
<section class="card admin-card collapsible" data-section="live">
<h2 class="admin-card-title">
            NotiÈ›e
            <span class="collapse-icon">â–¼</span>
</h2>
<div class="admin-card-body">
<p class="admin-small-text">
              Pagina citeÈ™te datele prin Apps Script (<code>adminEventsEndpoint</code> din <code>config.json</code>).
              Foaia de pontaj rÄƒmÃ¢ne privatÄƒ; serverul Ã®ntoarce un JSON cu evenimente, concedii È™i meta (alerte, versiune),
              iar aici calculÄƒm statistici, ore pe zi, overtime È™i rapoarte PDF/CSV.
            </p>
</div>
</section>
</aside>
</main>
</div>
<script>(function(){try{const t=document.body.getAttribute('data-page-title')||'Admin';document.title=t;}catch(e){}})();</script>
<script>
(function(){
  // ===== Utilities =====
  const LS_ADMIN = 'pontaj/admin/v1';
  const LS_ADMIN_KEY = 'pontaj/adminKey/v1';
  const ADMIN_KEY_FALLBACK = 'Servelect_2026!_AdminKey';

  const $ = (id)=>document.getElementById(id);
  const toastEl = $('toast');
  function toast(msg){
    if (!toastEl) return;
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=>toastEl.classList.remove('show'), 2200);
  }

  function getAdminSession(){
    try{ return JSON.parse(localStorage.getItem(LS_ADMIN)||'null'); }catch{ return null; }
  }
  function ensureAdmin(){
    const s = getAdminSession();
    if (!s || !s.user){
      document.body.innerHTML = `
        <div style="max-width:820px;margin:40px auto;padding:18px;font-family:Montserrat,sans-serif">
          <div style="background:#fff;border:1px solid #e7e8f2;border-radius:16px;padding:18px">
            <h2 style="margin:0 0 6px">Nu eÈ™ti logat ca admin</h2>
            <div style="color:#7c8096;font-weight:700;margin-bottom:12px">
              Te rog intrÄƒ Ã®n index.html È™i logheazÄƒ-te Ã®n zona Admin, apoi revino aici.
            </div>
            <a href="index.html" style="display:inline-block;padding:10px 14px;border-radius:12px;background:#7a63ff;color:#fff;font-weight:900;text-decoration:none">Deschide index.html</a>
          </div>
        </div>`;
      return null;
    }
    return s;
  }


  function bindNav(){
    const adminLabel = document.getElementById('adminLabel');
    if (adminLabel && ADMIN && ADMIN.user) adminLabel.textContent = ADMIN.user;

    const btn = document.getElementById('adminHamburgerBtn');
    const menu = document.getElementById('adminHamburgerMenu');
    if (btn && menu){
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        const open = btn.getAttribute('aria-expanded') === 'true';
        btn.setAttribute('aria-expanded', String(!open));
        menu.style.display = open ? 'none' : 'block';
      });
      document.addEventListener('click', ()=>{
        btn.setAttribute('aria-expanded','false');
        menu.style.display = 'none';
      });
      menu.addEventListener('click', (e)=>e.stopPropagation());
    }

    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn){
      logoutBtn.addEventListener('click', ()=>{
        try{ localStorage.removeItem(LS_ADMIN); }catch{}
        toast('Deconectat.');
        setTimeout(()=>{ window.location.href='index.html'; }, 400);
      });
    }
  }

  async function loadConfig(){
    const candidates = [
      'config.json',
      './config.json',
      '../config.json',
      '/config.json'
    ];
    for (const p of candidates){
      try{
        const r = await fetch(p + '?ts=' + Date.now(), {cache:'no-store'});
        if (!r.ok) continue;
        const j = await r.json();
        return j;
      }catch(e){}
    }
    return null;
  }

  function ymd(d){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const da=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }
  function dmy(ymdStr){
    if (!ymdStr) return 'â€”';
    const m = String(ymdStr).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return ymdStr;
    return `${m[3]}.${m[2]}.${m[1]}`;
  }

  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const cb = 'cb_' + Math.random().toString(16).slice(2);
      const s = document.createElement('script');
      const sep = url.includes('?') ? '&' : '?';
      s.src = url + sep + 'callback=' + cb;
      s.async = true;
      const t = setTimeout(()=>cleanup(new Error('JSONP timeout')), 15000);
      function cleanup(err, data){
        clearTimeout(t);
        try{ delete window[cb]; }catch{}
        if (s && s.parentNode) s.parentNode.removeChild(s);
        if (err) reject(err); else resolve(data);
      }
      window[cb] = (data)=>cleanup(null, data);
      s.onerror = ()=>cleanup(new Error('JSONP error'));
      document.head.appendChild(s);
    });
  }

  // ===== State =====
  let CFG = null;
  let ENDPOINT = '';
  let ADMIN = null;
  let ADMIN_KEY = '';
  let managersByName = {}; // employeeName -> {managerName, managerEmail, ...}
  let pinsByName = {};     // name -> {hasPin, active, updatedAt}
  let eventsData = null;   // adminEvents response
  let sortMode = {key:'name', dir:1}; // 1 asc, -1 desc

  function initials(name){
    const parts = String(name||'').trim().split(/\s+/).filter(Boolean);
    const a = (parts[0]||'').charAt(0);
    const b = (parts[1]||'').charAt(0);
    return (a + b).toUpperCase() || '?';
  }
  function esc(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

  function getAvatarHtml(name){
    const url = CFG && CFG.employeeAvatars && CFG.employeeAvatars[name] ? String(CFG.employeeAvatars[name]) : '';
    if (url) return `<div class="avatar"><img src="${esc(url)}" alt=""></div>`;
    return `<div class="avatar">${esc(initials(name))}</div>`;
  }

  function calcPeriodFor(name){
    if (!eventsData || !Array.isArray(eventsData.events)) return {from:'', to:''};
    let min=null, max=null;
    for (const e of eventsData.events){
      if (!e || e.name !== name) continue;
      const day = String(e.day || '').slice(0,10); // server often provides day
      if (!day) continue;
      if (!min || day < min) min = day;
      if (!max || day > max) max = day;
    }
    return {from:min||'', to:max||''};
  }

  function inScope(empName){
    const scope = $('scope').value;
    if (scope === 'all') return true;
    const m = managersByName[empName];
    if (!m) return false;
    const adminLabel = String(ADMIN.user||'');
    const adminEmail = String(ADMIN.email||'');
    return (m.managerName && m.managerName === adminLabel) || (adminEmail && m.managerEmail && m.managerEmail === adminEmail);
  }

  function matchesFilters(emp){
    const q = String($('q').value||'').trim().toLowerCase();
    const dept = $('dept').value;
    if (!inScope(emp.name)) return false;
    if (dept !== 'all' && String(emp.dept||'') !== dept) return false;
    if (q){
      const hay = (emp.name + ' ' + (emp.dept||'')).toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  }

  function sortEmployees(list){
    const dir = sortMode.dir;
    if (sortMode.key === 'name'){
      return list.sort((a,b)=> String(a.name).localeCompare(String(b.name), 'ro') * dir);
    }
    if (sortMode.key === 'period'){
      return list.sort((a,b)=>{
        const pa = a._periodTo || '';
        const pb = b._periodTo || '';
        if (pa === pb) return String(a.name).localeCompare(String(b.name), 'ro') * dir;
        return (pa < pb ? -1 : 1) * dir;
      });
    }
    return list;
  }

  function render(){
    const body = $('body');
    if (!eventsData || !Array.isArray(eventsData.employees)){
      body.innerHTML = `<tr><td class="empty" colspan="3">Nu am primit listÄƒ de angajaÈ›i.</td></tr>`;
      return;
    }

    // dept options
    const depts = Array.from(new Set(eventsData.employees.map(e=>String(e.dept||'â€”')).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'ro'));
    const deptSel = $('dept');
    const prev = deptSel.value;
    deptSel.innerHTML = `<option value="all">Toate</option>` + depts.map(d=>`<option value="${esc(d)}">${esc(d)}</option>`).join('');
    if (depts.includes(prev)) deptSel.value = prev;

    // subtitle
    const meta = eventsData.meta || {};
    $('subTitle').textContent = `${dmy(meta.from)} â€“ ${dmy(meta.to)} â€¢ ${esc(ADMIN.user)}${$('scope').value==='mine' ? ' â€¢ repartizaÈ›i mie' : ''}`;

    let list = eventsData.employees.map(e=>{
      const p = calcPeriodFor(e.name);
      return {...e, _periodFrom:p.from, _periodTo:p.to};
    }).filter(matchesFilters);

    list = sortEmployees(list);

    if (!list.length){
      body.innerHTML = `<tr><td class="empty" colspan="3">Nu existÄƒ angajaÈ›i pentru filtrul curent.</td></tr>`;
      return;
    }

    body.innerHTML = list.map(emp=>{
      const pFrom = emp._periodFrom ? dmy(emp._periodFrom) : 'â€”';
      const pTo   = emp._periodTo ? dmy(emp._periodTo) : 'â€”';
      const hasPeriod = emp._periodFrom && emp._periodTo;
      const pinMeta = pinsByName[emp.name];
      const pinTag = pinMeta ? (pinMeta.hasPin ? `<span class="tag ok">ğŸ”’ PIN setat</span>` : `<span class="tag bad">PIN lipsÄƒ</span>`) : `<span class="tag">PIN: ?</span>`;

      return `<tr data-name="${esc(emp.name)}">
        <td>
          <div class="empCell">
            ${getAvatarHtml(emp.name)}
            <div class="empMeta">
              <div class="empName">${esc(emp.name)}</div>
              <div class="empDept">${esc(emp.dept || 'â€”')}</div>
              ${pinTag}
            </div>
          </div>
        </td>
        <td>
          <div class="period">
            ${hasPeriod ? `${esc(pFrom)} â€“ ${esc(pTo)}` : `<span class="muted">FÄƒrÄƒ pontaj Ã®n perioadÄƒ</span>`}
          </div>
        </td>
        <td>
          <div class="actions">
            <button class="btnOk" type="button" data-open="${esc(emp.name)}" title="Deschide / acÈ›iune rapidÄƒ">
              <span style="display:inline-flex;width:22px;height:22px;align-items:center;justify-content:center;background:rgba(255,255,255,.18);border-radius:8px">
                âœ“
              </span>
              AprobÄƒ
            </button>

            <button class="btnIcon" type="button" data-reject="${esc(emp.name)}" title="AcÈ›iune secundarÄƒ">âœ•</button>

            <div class="gearMenu">
              <button class="btnIcon" type="button" data-gear="${esc(emp.name)}" title="SetÄƒri">âš™</button>
              <div class="menu" id="menu_${esc(emp.name).replace(/[^a-z0-9]/gi,'_')}">
                <h4>SetÄƒri: ${esc(emp.name)}</h4>
                <div class="row">
                  <input type="password" inputmode="numeric" pattern="[0-9]*" maxlength="8" placeholder="PIN (4â€“8 cifre)" data-pin="${esc(emp.name)}">
                  <button class="save primary" type="button" data-savepin="${esc(emp.name)}">SalveazÄƒ</button>
                </div>
                <div class="row" style="margin-top:8px">
                  <button class="save" type="button" data-clearpin="${esc(emp.name)}">È˜terge PIN</button>
                  <button class="save" type="button" data-close="${esc(emp.name)}">Ãnchide</button>
                </div>
                <div class="hint">PIN-ul este folosit la login Ã®n <b>index.html</b> (chip â€Angajatâ€).</div>
              </div>
            </div>
          </div>
        </td>
      </tr>`;
    }).join("");

    bindRowActions();
  }

  function closeAllMenus(){
    document.querySelectorAll('.menu.open').forEach(m=>m.classList.remove('open'));
  }

  function bindRowActions(){
    // primary/secondary are placeholders for now
    document.querySelectorAll('[data-open]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const name = btn.getAttribute('data-open');
        toast('AcÈ›iune: ' + name);
      });
    });
    document.querySelectorAll('[data-reject]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const name = btn.getAttribute('data-reject');
        toast('AcÈ›iune secundarÄƒ: ' + name);
      });
    });

    // gear menu open/close
    document.querySelectorAll('[data-gear]').forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        const name = btn.getAttribute('data-gear');
        const id = 'menu_' + name.replace(/[^a-z0-9]/gi,'_');
        const menu = document.getElementById(id);
        if (!menu) return;
        const open = menu.classList.contains('open');
        closeAllMenus();
        if (!open) menu.classList.add('open');
      });
    });
    document.querySelectorAll('[data-close]').forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        closeAllMenus();
      });
    });

    document.querySelectorAll('[data-savepin]').forEach(btn=>{
      btn.addEventListener('click', async (ev)=>{
        ev.stopPropagation();
        const name = btn.getAttribute('data-savepin');
        const inp = document.querySelector('input[data-pin="'+CSS.escape(name)+'"]');
        const pin = inp ? String(inp.value||'').trim() : '';
        if (!/^\d{4,8}$/.test(pin)){
          toast('PIN invalid (4â€“8 cifre).');
          return;
        }
        btn.disabled = true;
        btn.textContent = '...';
        try{
          const res = await jsonp(ENDPOINT + '?fn=adminSetEmployeePin&key=' + encodeURIComponent(ADMIN_KEY) +
            '&name=' + encodeURIComponent(name) +
            '&dept=' + encodeURIComponent(getDeptFor(name)) +
            '&pin=' + encodeURIComponent(pin) +
            '&ts=' + Date.now()
          );
          if (!res || !res.ok) throw new Error((res && res.error) ? res.error : 'Eroare la salvare.');
          pinsByName[name] = {hasPin:true, active:true, updatedAt:res.updatedAt||''};
          toast('PIN salvat: ' + name);
          closeAllMenus();
          render();
        }catch(e){
          console.warn(e);
          toast('Eroare: ' + (e && e.message ? e.message : e));
        }finally{
          btn.disabled = false;
          btn.textContent = 'SalveazÄƒ';
        }
      });
    });

    document.querySelectorAll('[data-clearpin]').forEach(btn=>{
      btn.addEventListener('click', async (ev)=>{
        ev.stopPropagation();
        const name = btn.getAttribute('data-clearpin');
        btn.disabled = true;
        btn.textContent = '...';
        try{
          const res = await jsonp(ENDPOINT + '?fn=adminSetEmployeePin&key=' + encodeURIComponent(ADMIN_KEY) +
            '&name=' + encodeURIComponent(name) +
            '&dept=' + encodeURIComponent(getDeptFor(name)) +
            '&clear=1' +
            '&ts=' + Date.now()
          );
          if (!res || !res.ok) throw new Error((res && res.error) ? res.error : 'Eroare la È™tergere.');
          pinsByName[name] = {hasPin:false, active:true, updatedAt:res.updatedAt||''};
          toast('PIN È™ters: ' + name);
          closeAllMenus();
          render();
        }catch(e){
          console.warn(e);
          toast('Eroare: ' + (e && e.message ? e.message : e));
        }finally{
          btn.disabled = false;
          btn.textContent = 'È˜terge PIN';
        }
      });
    });
  }

  function getDeptFor(name){
    if (!eventsData || !Array.isArray(eventsData.employees)) return '';
    const e = eventsData.employees.find(x=>x && x.name===name);
    return e ? (e.dept||'') : '';
  }

  async function loadManagers(){
    try{
      const res = await jsonp(ENDPOINT + '?fn=adminManagersMap&key=' + encodeURIComponent(ADMIN_KEY) + '&ts=' + Date.now());
      if (res && res.ok && Array.isArray(res.items)){
        managersByName = {};
        res.items.forEach(it=>{
          if (it && it.employeeName){
            managersByName[it.employeeName] = it;
          }
        });
      }
    }catch(e){
      console.warn('adminManagersMap failed:', e);
      managersByName = {};
    }
  }

  async function loadPins(){
    try{
      const res = await jsonp(ENDPOINT + '?fn=adminEmployeePins&key=' + encodeURIComponent(ADMIN_KEY) + '&ts=' + Date.now());
      if (res && res.ok && Array.isArray(res.items)){
        pinsByName = {};
        res.items.forEach(it=>{
          if (it && it.name){
            pinsByName[it.name] = {hasPin:!!it.hasPin, active:it.active!==false, updatedAt:it.updatedAt||''};
          }
        });
      }
    }catch(e){
      console.warn('adminEmployeePins failed:', e);
      pinsByName = {};
    }
  }

  async function loadAdminEvents(){
    const range = $('range').value;
    const now = new Date();
    let from = null, to = null;
    if (range === 'today'){
      from = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      to   = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    } else if (range === 'last7'){
      to = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      from = new Date(to);
      from.setDate(from.getDate()-6);
    } else if (range === 'month'){
      from = new Date(now.getFullYear(), now.getMonth(), 1);
      to = new Date(now.getFullYear(), now.getMonth()+1, 0);
    } else { // all
      from = new Date(now.getFullYear(), 0, 1);
      to = new Date(now.getFullYear(), 11, 31);
    }

    const url = ENDPOINT + '?fn=adminEvents' +
      '&from=' + encodeURIComponent(ymd(from)) +
      '&to='   + encodeURIComponent(ymd(to)) +
      '&ts=' + Date.now();

    const data = await jsonp(url);
    if (!data || !data.ok) throw new Error((data && data.error) ? data.error : 'adminEvents error');
    eventsData = data;
  }

  async function refresh(){
    closeAllMenus();
    $('body').innerHTML = `<tr><td class="empty" colspan="3">Se Ã®ncarcÄƒâ€¦</td></tr>`;
    await loadManagers();
    await loadPins();
    await loadAdminEvents();
    render();
  }

  function bindUi(){
    ['q','dept','scope','range'].forEach(id=>{
      $(id).addEventListener('input', ()=>render());
      $(id).addEventListener('change', ()=>{ if (id==='range') refresh(); else render(); });
    });

    $('refreshBtn').addEventListener('click', ()=>refresh());

    $('sortName').addEventListener('click', ()=>{
      if (sortMode.key==='name') sortMode.dir *= -1; else { sortMode.key='name'; sortMode.dir=1; }
      render();
    });
    $('sortPeriod').addEventListener('click', ()=>{
      if (sortMode.key==='period') sortMode.dir *= -1; else { sortMode.key='period'; sortMode.dir=1; }
      render();
    });

    document.addEventListener('click', ()=>closeAllMenus());
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') closeAllMenus(); });
  }

  async function init(){
    ADMIN = ensureAdmin();
    if (!ADMIN) return;
    bindNav();

    CFG = await loadConfig();
    ENDPOINT = CFG && CFG.adminEventsEndpoint ? String(CFG.adminEventsEndpoint) : '';
    if (!ENDPOINT){
      $('body').innerHTML = `<tr><td class="empty" colspan="3">LipseÈ™te <b>adminEventsEndpoint</b> Ã®n config.json.</td></tr>`;
      return;
    }

    // admin key
    ADMIN_KEY = '';
    try{ ADMIN_KEY = String(localStorage.getItem(LS_ADMIN_KEY)||'').trim(); }catch{}
    if (!ADMIN_KEY){
      // fallback (same as existing project key)
      ADMIN_KEY = ADMIN_KEY_FALLBACK;
      try{ localStorage.setItem(LS_ADMIN_KEY, ADMIN_KEY); }catch{}
    }

    // scope default: for role admin show all, for manager show mine
    if (String(ADMIN.role||'').toLowerCase() === 'admin') $('scope').value = 'all';
    else $('scope').value = 'mine';

    bindUi();
    await refresh();
  }

  init().catch(e=>{
    console.warn(e);
    $('body').innerHTML = `<tr><td class="empty" colspan="3">Eroare: ${esc(e && e.message ? e.message : e)}</td></tr>`;
  });

})();
</script>
</body>
</html>
