<!DOCTYPE html>

<html lang="ro">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>SERVELECT â€¢ Admin Pontaj</title>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&amp;display=swap" rel="stylesheet"/>
<link href="favicon.png" rel="icon"/>
<meta content="#516A75" name="theme-color"/>
<link href="admin-core.css" rel="stylesheet"/><link href="admin-embed.css" rel="stylesheet"/>
<style>
  /* ===== Employees page (3.webp style) ===== */
  .emp-page{max-width:1180px;margin:0 auto;padding:18px 14px 28px}
  .emp-card{background:rgba(255,255,255,.92);border:1px solid rgba(255,255,255,.55);box-shadow:0 20px 60px rgba(20,18,40,.10);border-radius:22px;overflow:hidden}
  .emp-top{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:18px 18px 10px}
  .emp-top h1{margin:0;font-size:22px;letter-spacing:.2px}
  .emp-sub{margin:4px 0 0;font-size:12px;color:rgba(76,79,97,.75);font-weight:600}
  .emp-filters{display:flex;flex-wrap:wrap;gap:10px;align-items:end;padding:0 18px 14px}
  .emp-filters label{display:flex;flex-direction:column;gap:6px;font-size:11px;color:rgba(76,79,97,.75);font-weight:800}
  .emp-filters input,.emp-filters select{height:38px;border-radius:12px;border:1px solid rgba(20,18,40,.12);padding:0 12px;background:rgba(255,255,255,.95);font-weight:700;color:#2b2f3a;outline:none}
  .emp-filters input:focus,.emp-filters select:focus{border-color:rgba(113,93,240,.45);box-shadow:0 0 0 4px rgba(113,93,240,.10)}
  .emp-filters .grow{flex:1;min-width:240px}
  .chipline{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border-radius:999px;background:rgba(113,93,240,.10);border:1px solid rgba(113,93,240,.18);color:#4b3fd9;font-weight:900;font-size:12px}
  .pill.warn{backgr
<main class="admin-layout">
  <section class="emp-page">
    <div class="emp-card">
      <div class="emp-top">
        <div>
          <h1>AngajaÈ›i</h1>
          <div class="emp-sub" id="subLine">Se Ã®ncarcÄƒâ€¦</div>
        </div>
        <div class="chipline">
          <div class="pill" id="mePill">ðŸ‘¤ â€”</div>
          <div class="pill ok" id="scopePill" style="display:none">âœ… AngajaÈ›ii mei</div>
          <div class="pill warn" id="keyPill" style="display:none">ðŸ”‘ LipsÄƒ Admin Key</div>
        </div>
      </div>

      <div class="emp-filters">
        <label class="grow">
          <span>CautÄƒ angajat</span>
          <input id="q" placeholder="Scrie nume / departament / managerâ€¦"/>
        </label>

        <label>
          <span>Vizibilitate</span>
          <select id="scopeSel">
            <option value="mine">AngajaÈ›ii mei</option>
            <option value="all">ToÈ›i angajaÈ›ii</option>
          </select>
        </label>

        <label>
          <span>Departament</span>
          <select id="deptSel">
            <option value="all">Toate</option>
          </select>
        </label>

        <label>
          <span>PerioadÄƒ</span>
          <select id="rangeSel">
            <option value="week">SÄƒptÄƒmÃ¢na curentÄƒ</option>
            <option value="month">Luna curentÄƒ</option>
            <option value="custom">Custom</option>
          </select>
        </label>

        <label>
          <span>De la</span>
          <input id="from" type="date"/>
        </label>

        <label>
          <span>PÃ¢nÄƒ la</span>
          <input id="to" type="date"/>
        </label>
      </div>

      <table class="emp-table" aria-label="Lista angajaÈ›i">
        <thead class="emp-head">
          <tr>
            <th style="width:44%;">ANGAJAT <span class="sort" data-sort="name" title="SorteazÄƒ">â†•</span></th>
            <th style="width:26%;">PERIOADA <span class="sort" data-sort="period" title="SorteazÄƒ">â†•</span></th>
            <th style="width:30%;">ACÈšIUNI</th>
          </tr>
        </thead>
        <tbody id="list"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- settings menu -->
<div class="menu" id="rowMenu"></div>

<!-- modal pin -->
<div class="overlay" id="pinOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pinTitle">
    <div class="modalHead">
      <h3 id="pinTitle">SeteazÄƒ PIN</h3>
      <button class="btnG btnIcon" id="pinClose" title="ÃŽnchide">âœ•</button>
    </div>
    <div class="modalBody">
      <div class="muted" id="pinFor">â€”</div>
      <div style="height:10px"></div>
      <div class="modalRow">
        <label>
          <span class="muted">PIN (4â€“8 cifre)</span>
          <input id="pin1" inputmode="numeric" autocomplete="new-password" placeholder="ex: 1234"/>
        </label>
        <label>
          <span class="muted">Confirmare PIN</span>
          <input id="pin2" inputmode="numeric" autocomplete="new-password" placeholder="repetÄƒ PIN"/>
        </label>
      </div>
      <div style="display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap">
        <button class="btnG btnGhost" id="pinGen">ðŸŽ² GenereazÄƒ</button>
        <div class="muted">PIN-ul nu este afiÈ™at niciodatÄƒ Ã®n listÄƒ dupÄƒ salvare.</div>
      </div>
    </div>
    <div class="modalFoot">
      <button class="btnG btnGhost" id="pinClear">È˜terge PIN</button>
      <button class="btnG btnGreen" id="pinSave"><span class="ico">âœ“</span> SalveazÄƒ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
e" style="display:none">
<div class="admin-filter-line" style="margin:0 0 10px;">
<label>
<span>Tip alertÄƒ</span>
<select id="alertsTypeFilter">
<option value="all">Toate</option>
<option value="pause">PauzÄƒ</option>
<option value="norm">NormÄƒ</option>
<option value="extra">Extra</option>
<option value="system">Sistem</option>
</select>
</label>
<label>
<span>Departament</span>
<select id="alertsDeptFilter">
<option value="all">Toate</option>
</select>
</label>
<label style="flex:1;min-width:220px;">
<span>CautÄƒ</span>
<input id="alertsSearch" placeholder="Nume / mesaj..." type="text"/>
</label>
</div>
<section class="card admin-card" data-section="alerts">
<h2>Alerte LIVE pe ziua curentÄƒ</h2>
<div class="admin-small-text">
              Monitorizare Ã®n timp real (client-side) pentru:
              <ul style="margin:4px 0 0 16px;padding:0;font-size:11px;color:var(--muted);">
<li>PauzÄƒ &gt; limitÄƒ (implicit 40 min, din configurare) fÄƒrÄƒ UNPAUSE â€“ notificÄƒri din 15 Ã®n 15 minute.</li>
<li>NormÄƒ depÄƒÈ™itÄƒ (8h / 8h30 sau valori din <code>normSettings</code>) fÄƒrÄƒ FINISH â€“ notificÄƒri din 30 Ã®n 30 de minute.</li>
<li>EXTRA Ã®n curs &gt; 30 min â€“ notificÄƒri din 15 Ã®n 15 minute.</li>
</ul>
</div>
<div class="admin-list" id="liveAlertsActive"></div>
</section>
<section class="card admin-card" data-section="alerts">
<h2>Istoric notificÄƒri Ã®n sesiunea curentÄƒ</h2>
<div class="admin-small-text">
              Fiecare depÄƒÈ™ire genereazÄƒ o notificare iniÈ›ialÄƒ, apoi Ã®ncÄƒ una la fiecare interval (15 / 30 min) cÃ¢t timp condiÈ›ia rÄƒmÃ¢ne activÄƒ.
              Istoricul este local, doar pentru sesiunea curentÄƒ a paginii.
            </div>
<div class="table-wrap">
<table class="admin-table">
<thead>
<tr>
<th>Moment</th>
<th>Angajat</th>
<th>Departament</th>
<th>Tip</th>
<th>Mesaj</th>
</tr>
</thead>
<tbody id="liveAlertsHistoryBody"></tbody>
</table>
</div>
</section>
<!-- NOU: Alerte istorice din sistem (toate zilele anterioare) -->
<section class="card admin-card" data-section="alerts">
<h2>Alerte istorice din sistem</h2>
<div class="admin-small-text">
              Alerte generate de Apps Script pentru toate zilele (inclusiv cele anterioare), pe baza datelor salvate Ã®n foaia de pontaj.
            </div>
<div class="table-wrap">
<table class="admin-table">
<thead>
<tr>
<th>Moment</th>
<th>Angajat</th>
<th>Departament</th>
<th>Tip</th>
<th>Mesaj</th>
</tr>
</thead>
<tbody id="systemAlertsHistoryBody"></tbody>
</table>
</div>
</section>
</section>
</section>
<aside class="admin-side">
<!-- A2: Top angajaÈ›i (pliabil) -->
<section class="card admin-card collapsible" data-section="live">
<h2 class="admin-card-title">
            Top angajaÈ›i
            <span class="collapse-icon">â–¼</span>
</h2>
<div class="admin-card-body">
<div class="admin-small-text">
              Clasament all time:
              <button class="top-toggle active" id="topModeHours" type="button">Ore normÄƒ</button>
<button class="top-toggle" id="topModeAnomalies" type="button">Anomalii</button>
</div>
<div class="admin-list" id="topEmployees"></div>
</div>
</section>
<!-- A5: Live board (pliabil) -->
<section class="card admin-card collapsible" data-section="live">
<h2 class="admin-card-title">
            Live pontaj
            <span class="collapse-icon">â–¼</span>
</h2>
<div class="admin-card-body">
<div class="admin-small-text" id="liveBoardHint">
<div class="admin-small-text" id="liveBoardSummary" style="margin:6px 0 8px;"></div>
<span id="liveBoardHintText">
                Starea curentÄƒ a pontajului pentru ziua de azi (START / PAUSE / EXTRA / FINISH).
              </span>
</div>
<div style="margin:6px 0 8px;display:flex;gap:6px;flex-wrap:wrap;">
<button class="top-toggle active" id="liveBoardTodayBtn" type="button">Azi</button>
<button class="top-toggle" id="liveBoardPastBtn" type="button">Zile anterioare</button>
</div>
<div style="margin:10px 0 6px;display:flex;align-items:center;justify-content:space-between;gap:8px;">
<div class="admin-small-text" style="margin:0;font-weight:700;">AngajaÈ›i (status)</div>
<!-- (opÈ›ional) poÈ›i pune aici un badge count dacÄƒ vrei -->
</div>
<div class="admin-list" id="liveBoard"></div>
<div style="margin:10px 0 6px;display:flex;align-items:center;justify-content:space-between;gap:8px;">
<div class="admin-small-text" style="margin:0;font-weight:700;">Inactivi azi</div>
<span class="badge badge-info" id="liveInactiveCount" style="display:none"></span>
</div>
<div class="admin-list" id="liveBoardInactive"></div>
</div>
</section>
<!-- A5.5. Admin presence (cine e online) -->
<section class="card" id="adminPresenceCard">
<div class="card-head">
<h3>Admini activi</h3>
<div class="muted" id="adminPresenceHint">â€”</div>
</div>
<div class="card-body">
<div class="pres-list" id="adminPresenceList"></div>
</div>
</section>
<!-- A6: Alerte sistem (pliabil) -->
<section class="card admin-card collapsible" data-section="live">
<h2 class="admin-card-title">
            Alerte sistem
            <span class="collapse-icon">â–¼</span>
</h2>
<div class="admin-card-body">
<div class="admin-small-text">
              Ultimele notificÄƒri generate de sistem (pontaj uitat, anomalii etc.), venite din Apps Script.
            </div>
<div class="admin-list" id="alertsList"></div>
</div>
</section>
<!-- NotiÈ›e (pliabil) -->
<section class="card admin-card collapsible" data-section="live">
<h2 class="admin-card-title">
            NotiÈ›e
            <span class="collapse-icon">â–¼</span>
</h2>
<div class="admin-card-body">
<p class="admin-small-text">
              Pagina citeÈ™te datele prin Apps Script (<code>adminEventsEndpoint</code> din <code>config.json</code>).
              Foaia de pontaj rÄƒmÃ¢ne privatÄƒ; serverul Ã®ntoarce un JSON cu evenimente, concedii È™i meta (alerte, versiune),
              iar aici calculÄƒm statistici, ore pe zi, overtime È™i rapoarte PDF/CSV.
            </p>
</div>
</section>
</aside>
</main>
</div>
<script>(function(){try{const t=document.body.getAttribute('data-page-title')||'Admin';document.title=t;}catch(e){}})();</script>
<script>
(() => {
  // ===== util =====
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const esc = (x) => String(x ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  function toast(msg, ok=true){
    const el = $("#toast");
    el.textContent = msg;
    el.style.background = ok ? "#222" : "#b11c1c";
    el.classList.add("show");
    clearTimeout(el._t);
    el._t = setTimeout(()=>el.classList.remove("show"), 2800);
  }

  function ymdd(d){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const da=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }
  function fmtRo(d){
    const dd=String(d.getDate()).padStart(2,"0");
    const mm=String(d.getMonth()+1).padStart(2,"0");
    const yy=d.getFullYear();
    return `${dd}.${mm}.${yy}`;
  }

  // ===== admin session =====
  const LS_ADMIN = "pontaj/admin/v1";
  const LS_ADMIN_FALLBACK = "pontaj_admin_session";
  function getAdminSession(){
    const raw = localStorage.getItem(LS_ADMIN) || localStorage.getItem(LS_ADMIN_FALLBACK) || "";
    if (!raw) return null;
    try { return JSON.parse(raw); } catch(e){ return null; }
  }

  function getAdminKey(){
    return (
      localStorage.getItem("pontaj_adminKey") ||
      localStorage.getItem("pontaj/adminKey") ||
      localStorage.getItem("ADMIN_KEY") ||
      localStorage.getItem("adminKey") ||
      ""
    ).trim();
  }

  async function fetchJson(url){
    const r = await fetch(url, {cache:"no-store"});
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  }

  async function loadConfig(){
    const tries = ["config.json","./config.json","../config.json","/config.json"];
    for (const p of tries){
      try { return await fetchJson(p); } catch(e){}
    }
    throw new Error("Nu pot Ã®ncÄƒrca config.json");
  }

  async function loadAdminAuth(cfg){
    const url = cfg.adminAuthUrl || "admin-auth.json";
    try { return await fetchJson(url); } catch(e){}
    // fallback local
    const tries = ["admin-auth.json","./admin-auth.json","../admin-auth.json","/admin-auth.json"];
    for (const p of tries){
      try { return await fetchJson(p); } catch(e){}
    }
    throw new Error("Nu pot Ã®ncÄƒrca admin-auth.json");
  }

  // ===== JSONP =====
  function jsonp(endpoint, params){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(16).slice(2);
      const q = new URLSearchParams({...params, callback: cb});
      const src = endpoint + (endpoint.includes("?") ? "&" : "?") + q.toString();

      const s = document.createElement("script");
      s.src = src;
      s.async = true;

      let done = false;
      window[cb] = (data)=>{
        done = true;
        cleanup();
        resolve(data);
      };
      function cleanup(){
        try { delete window[cb]; } catch(e){ window[cb]=undefined; }
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }
      s.onerror = ()=>{ if (done) return; cleanup(); reject(new Error("JSONP error")); };
      document.head.appendChild(s);
      setTimeout(()=>{ if (done) return; cleanup(); reject(new Error("JSONP timeout")); }, 15000);
    });
  }

  // ===== state =====
  const STATE = {
    cfg:null,
    auth:null,
    me:null,
    isSuper:false,
    key:"",
    managersMap:{},
    employeeAuth:[],
    roster:[],
    sort:"name",
    sortDir:1
  };

  // ===== nav (hamburger + logout) =====
  function bindNav(){
    const btn = $("#adminHamburgerBtn");
    const menu = $("#adminHamburgerMenu");
    btn?.addEventListener("click", ()=>{
      const open = btn.getAttribute("aria-expanded")==="true";
      btn.setAttribute("aria-expanded", open ? "false":"true");
      menu?.classList.toggle("open", !open);
    });
    document.addEventListener("click", (e)=>{
      if (!menu || !btn) return;
      if (menu.contains(e.target) || btn.contains(e.target)) return;
      btn.setAttribute("aria-expanded","false");
      menu.classList.remove("open");
    });

    $("#logoutBtn")?.addEventListener("click", ()=>{
      localStorage.removeItem(LS_ADMIN);
      localStorage.removeItem(LS_ADMIN_FALLBACK);
      toast("Deconectat.");
      setTimeout(()=>location.href="index.html", 450);
    });
  }

  // ===== manager filter =====
  function myLabel(){
    return (STATE.me && (STATE.me.label || STATE.me.name)) ? String(STATE.me.label || STATE.me.name) : "";
  }
  function isMine(emp){
    const ml = myLabel().toLowerCase();
    if (!ml) return false;
    const m = emp.managerName ? String(emp.managerName).toLowerCase() : "";
    return m && m === ml;
  }

  function buildDeptOptions(list){
    const sel = $("#deptSel");
    const set = new Set();
    list.forEach(x=>{ if (x.dept) set.add(String(x.dept)); });
    const arr = Array.from(set).sort((a,b)=>a.localeCompare(b));
    sel.innerHTML = `<option value="all">Toate</option>` + arr.map(d=>`<option value="${esc(d)}">${esc(d)}</option>`).join("");
  }

  function computePeriodLabel(){
    const from = $("#from").value;
    const to = $("#to").value;
    if (!from || !to) return "â€”";
    const a = new Date(from+"T00:00:00");
    const b = new Date(to+"T00:00:00");
    return `${fmtRo(a)} - ${fmtRo(b)}`;
  }

  function applyRangePreset(){
    const now = new Date();
    const r = $("#rangeSel").value;
    if (r === "week"){
      const d = new Date(now);
      const day = (d.getDay() + 6) % 7; // monday=0
      d.setDate(d.getDate() - day);
      const start = d;
      const end = new Date(d);
      end.setDate(end.getDate()+6);
      $("#from").value = ymdd(start);
      $("#to").value = ymdd(end);
      $("#from").disabled = true;
      $("#to").disabled = true;
    } else if (r === "month"){
      const start = new Date(now.getFullYear(), now.getMonth(), 1);
      const end = new Date(now.getFullYear(), now.getMonth()+1, 0);
      $("#from").value = ymdd(start);
      $("#to").value = ymdd(end);
      $("#from").disabled = true;
      $("#to").disabled = true;
    } else {
      $("#from").disabled = false;
      $("#to").disabled = false;
      if (!$("#from").value) $("#from").value = ymdd(new Date(now.getFullYear(), now.getMonth(), 1));
      if (!$("#to").value) $("#to").value = ymdd(new Date(now.getFullYear(), now.getMonth()+1, 0));
    }
  }

  // ===== load data =====
  async function loadManagersMap(){
    const ep = STATE.cfg.adminEventsEndpoint;
    if (!ep) throw new Error("LipseÈ™te adminEventsEndpoint Ã®n config.json");
    const key = STATE.key;
    const r = await jsonp(ep, { fn:"adminManagersMap", key });
    if (!r || !r.ok) throw new Error(r?.message || "adminManagersMap failed");
    STATE.managersMap = r.map || {};
  }

  async function loadEmployeeAuth(){
    const ep = STATE.cfg.adminEventsEndpoint;
    const key = STATE.key;
    const r = await jsonp(ep, { fn:"adminEmployeeAuthList", key });
    if (!r || !r.ok) throw new Error(r?.message || "adminEmployeeAuthList failed");
    STATE.employeeAuth = r.items || [];
  }

  function mergeRoster(){
    const cfgList = Array.isArray(STATE.cfg.employees) ? STATE.cfg.employees : [];
    const map = new Map();
    for (const name of cfgList){
      const n = String(name||"").trim();
      if (!n) continue;
      map.set(n.toLowerCase(), { name:n, dept:"", active:true, hasPin:false });
    }
    for (const it of STATE.employeeAuth){
      const n = String(it.name||"").trim();
      if (!n) continue;
      const key = n.toLowerCase();
      map.set(key, { 
        name:n,
        dept: String(it.dept||""),
        active: it.active !== false,
        hasPin: !!it.hasPin,
        updatedAt: String(it.updatedAt||"")
      });
    }
    // attach manager
    const out = Array.from(map.values()).map(e=>{
      const mm = STATE.managersMap[e.name.toLowerCase()] || null;
      // managersMap key may be employeeKey; fallback by name as key:
      // We'll also search by matching stored employeeName field
      let mgrName = "";
      if (mm && mm.managerName) mgrName = String(mm.managerName||"");
      else {
        // brute find by employeeName
        const found = Object.values(STATE.managersMap).find(x => String(x.employeeName||"").toLowerCase() === e.name.toLowerCase());
        if (found) mgrName = String(found.managerName||"");
      }
      return { ...e, managerName: mgrName };
    });
    STATE.roster = out;
    buildDeptOptions(out);
  }

  // ===== render =====
  function render(){
    const q = ($("#q").value || "").trim().toLowerCase();
    const dept = $("#deptSel").value;
    const scope = $("#scopeSel").value;
    const periodLabel = computePeriodLabel();

    let list = STATE.roster.slice();

    // scope rules
    if (!STATE.isSuper) {
      $("#scopeSel").value = "mine";
      $("#scopeSel").disabled = true;
      $("#scopePill").style.display = "";
    } else {
      $("#scopeSel").disabled = false;
      $("#scopePill").style.display = (scope === "mine") ? "" : "none";
    }
    if (scope === "mine") list = list.filter(isMine);

    if (dept !== "all") list = list.filter(x => String(x.dept||"") === dept);

    if (q) {
      list = list.filter(x=>{
        const hay = `${x.name} ${x.dept||""} ${x.managerName||""}`.toLowerCase();
        return hay.includes(q);
      });
    }

    // sort
    if (STATE.sort === "name"){
      list.sort((a,b)=>a.name.localeCompare(b.name) * STATE.sortDir);
    }

    const tbody = $("#list");
    if (!list.length){
      tbody.innerHTML = `<tr class="emp-row"><td colspan="3" style="padding:22px 18px;color:rgba(76,79,97,.75);font-weight:900">Nu existÄƒ angajaÈ›i Ã®n filtrul curent.</td></tr>`;
      return;
    }

    tbody.innerHTML = list.map(emp=>{
      const avatarUrl = (STATE.cfg.employeeAvatars && STATE.cfg.employeeAvatars[emp.name]) ? String(STATE.cfg.employeeAvatars[emp.name]) : "";
      const initials = emp.name.split(/\s+/).slice(0,2).map(s=>s[0]||"").join("").toUpperCase();
      const pinBadge = emp.hasPin
        ? `<span class="badge pin">ðŸ”’ PIN setat</span>`
        : `<span class="badge nopin">âš  PIN lipsÄƒ</span>`;
      const mineBadge = isMine(emp) ? `<span class="badge mine">ðŸ‘¤ al meu</span>` : ``;
      const mgr = emp.managerName ? `<div class="emp-dept">Manager: <b>${esc(emp.managerName)}</b></div>` : ``;

      const period = `<div class="period">${esc(periodLabel)}</div><div class="muted">${esc(emp.updatedAt ? ("update " + emp.updatedAt) : "")}</div>`;
      const openLabel = "Deschide";
      const openBtn = `<button class="btnG btnGreen" data-act="open" data-name="${esc(emp.name)}">
          <span class="ico">âœ“</span> ${openLabel}
        </button>`;
      const rejectBtn = `<button class="btnG btnGhost" data-act="fixday" data-name="${esc(emp.name)}">ðŸ›  FixDay</button>`;
      const gearBtn = `<button class="btnG btnIcon" data-act="menu" data-name="${esc(emp.name)}" title="SetÄƒri">âš™</button>`;

      return `<tr class="emp-row">
        <td>
          <div class="emp-cell">
            <div class="avatar">${avatarUrl ? `<img src="${esc(avatarUrl)}" alt="">` : esc(initials)}</div>
            <div class="emp-meta">
              <div class="emp-name">${esc(emp.name)}</div>
              <div class="emp-dept">${esc(emp.dept || "â€”")}</div>
              ${mgr}
              <div class="emp-badges">${pinBadge}${mineBadge}</div>
            </div>
          </div>
        </td>
        <td>${period}</td>
        <td>
          <div class="acts">${openBtn}${rejectBtn}${gearBtn}</div>
        </td>
      </tr>`;
    }).join("");

    // bind actions
    $$("[data-act]", tbody).forEach(btn=>{
      btn.addEventListener("click", (e)=>onRowAction(e));
    });

    $("#subLine").textContent = `${list.length} angajaÈ›i afiÈ™aÈ›i â€¢ PerioadÄƒ: ${periodLabel}`;
  }

  // ===== actions =====
  const menu = $("#rowMenu");
  let menuFor = null;

  function closeMenu(){
    menu.classList.remove("open");
    menu.style.left = "-9999px";
    menu.style.top = "-9999px";
    menuFor = null;
  }

  function openMenu(anchor, empName){
    menuFor = empName;
    menu.innerHTML = `
      <button data-m="pin">ðŸ”‘ SeteazÄƒ PIN</button>
      <button data-m="clearpin">ðŸ§½ È˜terge PIN</button>
      <button data-m="toggle">${getEmp(empName)?.active ? "â›” DezactiveazÄƒ" : "âœ… ActiveazÄƒ"}</button>
    `;
    const r = anchor.getBoundingClientRect();
    const x = Math.min(window.innerWidth - 240, Math.max(12, r.right - 230));
    const y = Math.min(window.innerHeight - 140, Math.max(12, r.bottom + 8));
    menu.style.left = x + "px";
    menu.style.top = y + "px";
    menu.classList.add("open");

    $$("button", menu).forEach(b=>{
      b.addEventListener("click", async ()=>{
        const k = b.getAttribute("data-m");
        closeMenu();
        if (k === "pin") return openPinModal(empName);
        if (k === "clearpin") return savePin(empName, "");
        if (k === "toggle") return toggleActive(empName);
      });
    });
  }

  document.addEventListener("click", (e)=>{
    if (menu.classList.contains("open")){
      if (menu.contains(e.target)) return;
      closeMenu();
    }
  });

  function getEmp(name){
    const n = String(name||"").toLowerCase();
    return STATE.roster.find(x=>x.name.toLowerCase()===n) || null;
  }

  async function onRowAction(e){
    const btn = e.currentTarget;
    const act = btn.getAttribute("data-act");
    const name = btn.getAttribute("data-name");
    if (!name) return;

    if (act === "menu") return openMenu(btn, name);

    if (act === "fixday"){
      // open fix-day.html if exists
      const url = `fix-day.html#${encodeURIComponent(name)}`;
      window.open(url, "_blank", "noopener");
      return;
    }

    if (act === "open"){
      // open self-service for employee if available
      const base = STATE.cfg.selfServiceBaseUrl || (STATE.cfg.selfService && STATE.cfg.selfService.baseUrl) || "";
      const from = $("#from").value;
      const to = $("#to").value;
      if (base){
        const u = base + (base.includes("?") ? "&" : "?") + new URLSearchParams({ employee:name, from, to }).toString();
        window.open(u, "_blank", "noopener");
      } else {
        toast("selfServiceBaseUrl lipseÈ™te Ã®n config.json", false);
      }
      return;
    }
  }

  // ===== PIN modal =====
  const ov = $("#pinOverlay");
  let pinEmp = null;

  function openPinModal(name){
    pinEmp = name;
    $("#pinFor").innerHTML = `Angajat: <b>${esc(name)}</b>`;
    $("#pin1").value = "";
    $("#pin2").value = "";
    ov.classList.add("open");
    ov.setAttribute("aria-hidden","false");
    setTimeout(()=>$("#pin1").focus(), 10);
  }
  function closePinModal(){
    ov.classList.remove("open");
    ov.setAttribute("aria-hidden","true");
    pinEmp = null;
  }
  $("#pinClose").addEventListener("click", closePinModal);
  ov.addEventListener("click", (e)=>{ if (e.target === ov) closePinModal(); });

  $("#pinGen").addEventListener("click", ()=>{
    const pin = String(Math.floor(1000 + Math.random()*9000));
    $("#pin1").value = pin;
    $("#pin2").value = pin;
  });

  $("#pinSave").addEventListener("click", async ()=>{
    if (!pinEmp) return;
    const a = ($("#pin1").value||"").trim();
    const b = ($("#pin2").value||"").trim();
    if (!/^\d{4,8}$/.test(a)) return toast("PIN invalid (4â€“8 cifre).", false);
    if (a !== b) return toast("PIN-urile nu coincid.", false);
    await savePin(pinEmp, a);
    closePinModal();
  });

  $("#pinClear").addEventListener("click", async ()=>{
    if (!pinEmp) return;
    await savePin(pinEmp, "");
    closePinModal();
  });

  async function savePin(name, pin){
    try{
      const ep = STATE.cfg.adminEventsEndpoint;
      const r = await jsonp(ep, { fn:"adminSetEmployeePin", key: STATE.key, name, dept:(getEmp(name)?.dept||""), pin });
      if (!r || !r.ok) throw new Error(r?.message || "Eroare setare PIN");
      toast(pin ? "PIN salvat." : "PIN È™ters.");
      // refresh auth list
      await loadEmployeeAuth();
      mergeRoster();
      render();
    }catch(err){
      toast(err.message || String(err), false);
    }
  }

  async function toggleActive(name){
    try{
      const emp = getEmp(name);
      if (!emp) return;
      const ep = STATE.cfg.adminEventsEndpoint;
      const active = !emp.active;
      const r = await jsonp(ep, { fn:"adminSetEmployeePin", key: STATE.key, name, dept:(emp.dept||""), active: active ? "TRUE":"FALSE" });
      if (!r || !r.ok) throw new Error(r?.message || "Eroare activare/dezactivare");
      toast(active ? "Angajat activat." : "Angajat dezactivat.");
      await loadEmployeeAuth();
      mergeRoster();
      render();
    }catch(err){
      toast(err.message || String(err), false);
    }
  }

  // ===== init =====
  async function init(){
    bindNav();

    const sess = getAdminSession();
    if (!sess){
      toast("Nu eÈ™ti logat ca admin.", false);
      $("#subLine").textContent = "Nu eÈ™ti logat ca admin.";
      return;
    }

    STATE.cfg = await loadConfig();
    STATE.auth = await loadAdminAuth(STATE.cfg);

    // identify me by label in session or default to first admin
    const admins = Array.isArray(STATE.auth.admins) ? STATE.auth.admins : [];
    const label = String(sess.label || sess.name || "").trim();
    const me = admins.find(a=>String(a.label||"")===label) || (admins.length ? admins[0] : {label});
    STATE.me = me;

    // super admin: first admin or explicit label
    STATE.isSuper = (admins.length && me.label === admins[0].label) || String(me.label||"").toLowerCase().includes("servelect admin");

    $("#adminLabel").textContent = me.label || "Admin";
    $("#mePill").textContent = `ðŸ‘¤ ${me.label || "Admin"}`;

    STATE.key = getAdminKey();
    if (!STATE.key){
      $("#keyPill").style.display = "";
      toast("LipseÈ™te Admin Key (localStorage).", false);
      $("#subLine").textContent = "LipseÈ™te Admin Key. Deschide dashboard-ul admin È™i seteazÄƒ cheia, apoi revino.";
      return;
    }

    // hide "ToÈ›i angajaÈ›ii" for non-super
    if (!STATE.isSuper){
      $("#scopeSel").innerHTML = `<option value="mine">AngajaÈ›ii mei</option>`;
    }

    applyRangePreset();

    await loadManagersMap();
    await loadEmployeeAuth();
    mergeRoster();

    $("#subLine").textContent = "ListÄƒ Ã®ncÄƒrcatÄƒ.";
    render();

    // binds
    $("#q").addEventListener("input", ()=>render());
    $("#deptSel").addEventListener("change", ()=>render());
    $("#scopeSel").addEventListener("change", ()=>render());
    $("#rangeSel").addEventListener("change", ()=>{ applyRangePreset(); render(); });
    $("#from").addEventListener("change", ()=>render());
    $("#to").addEventListener("change", ()=>render());

    // sort handlers
    $$(".sort").forEach(s=>{
      s.addEventListener("click", ()=>{
        const key = s.getAttribute("data-sort");
        if (STATE.sort === key) STATE.sortDir *= -1;
        else { STATE.sort = key; STATE.sortDir = 1; }
        render();
      });
    });
  }

  init().catch(err=>{
    console.error(err);
    toast(err.message || String(err), false);
    $("#subLine").textContent = err.message || String(err);
  });
})();
</script>

</body>
</html>
