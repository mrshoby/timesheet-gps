<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Employee dashboard</title>
  <style>

:root{
      --bg:#f5f6ff;
      --card:#ffffff;
      --ink:#1f2330;
      --muted:#6f7890;
      --line:#e7e9f6;
      --accent:#6d5efc;
      --shadow:0 10px 30px rgba(20,18,40,.08);

      --c-inactive:#f1f3f9;
      --c-under:#ffe9c7;
      --c-complete:#dff7e4;
      --c-over:#d9ecff;
      --c-leave:#efe6ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1440px;margin:18px auto;padding:0 14px}
    .panel{background:var(--card); border:1px solid var(--line); border-radius:22px; box-shadow:var(--shadow); overflow:hidden;}
    .panelHead{padding:14px 16px; border-bottom:1px solid var(--line); display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .panelHead h2{margin:0;font-size:16px}
    .note{font-size:12px;color:var(--muted);font-weight:750}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{border:1px solid var(--line); background:#fff; color:var(--ink); padding:10px 12px; border-radius:14px; font-weight:850; cursor:pointer;}
    .btn:active{transform:translateY(1px)}
    .select{border:1px solid var(--line); background:#fff; padding:10px 12px;border-radius:14px; font-weight:800; outline:none;}

    .tableWrap{overflow:auto; max-height: calc(100vh - 210px);}
    table{border-collapse:separate;border-spacing:0; width:max(1100px, 100%); font-size:13px}
    thead th{
      position:sticky; top:0; z-index:5;
      background:#fff; border-bottom:1px solid var(--line);
      padding:10px 10px; text-align:center; color:var(--muted); font-weight:900; font-size:12px;
      white-space:nowrap;
    }
    thead th.stickyL{ left:0; z-index:7; text-align:left; box-shadow: 6px 0 0 rgba(0,0,0,0.02); }
    thead th.thEmp{min-width:260px}
    thead .wd{font-weight:900;color:rgba(110,120,145,.9)}
    tbody td{border-bottom:1px solid var(--line); background:#fff; padding:8px 8px; text-align:center;}
    tbody td.stickyL{position:sticky; left:0; z-index:6; text-align:left; box-shadow: 6px 0 0 rgba(0,0,0,0.02);}
    tbody tr:hover td{background:rgba(245,246,255,.55)}
    tbody tr:hover td.stickyL{background:#fff}

    .empCell{display:flex;align-items:center;gap:10px}
    .empPhoto{width:38px;height:38px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 10px 18px rgba(20,18,40,.10)}
    .empAvatar{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;
      background:#f0f2ff;border:2px solid #fff;box-shadow:0 10px 18px rgba(20,18,40,.10);font-weight:1000;color:#3a3f5b}
    .empName{font-weight:1000}
    .empDept{font-size:12px;color:rgba(110,120,145,.95);font-weight:800;margin-top:1px}
    .empMeta{display:flex;flex-direction:column;line-height:1.05}

    .thDay.weekCut, td.dayCell.weekCut{border-left:4px solid rgba(120,125,170,.15)}
    .dayBox{
      height:62px; border-radius:14px; border:1px solid rgba(0,0,0,.04);
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.55);
      gap:2px;
    }
    .dayBox .t{font-size:11px;font-weight:850;color:rgba(45,50,70,.95);line-height:1}
    .dayBox .t.muted{color:rgba(120,125,150,.55);font-weight:800}
    .dayBox .dur{margin-top:2px;font-size:12px;font-weight:1000;color:rgba(45,50,70,.98)}
    .dayBox .dur.muted{color:rgba(120,125,150,.45);font-weight:900}
    .dayBox .code{font-size:14px;font-weight:1100;color:#2f245c}

    .st-inactive{background:var(--c-inactive)}
    .st-under{background:var(--c-under)}
    .st-complete{background:var(--c-complete)}
    .st-over{background:var(--c-over)}
    .st-inprogress{background:rgba(109,94,252,.14)}
    .st-paused{background:rgba(255,77,77,.12)}
    .st-leave{background:var(--c-leave)}
    .weekend{opacity:.92}

    .legend{padding:14px 16px;border-top:1px solid var(--line);display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .dot{width:10px;height:10px;border-radius:99px;display:inline-block;margin-right:6px;vertical-align:middle}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:900;font-size:12px}

    .centerMsg{
      padding:26px 16px; text-align:center; color:rgba(80,90,120,.80); font-weight:900;
    }
    a{color:var(--accent);text-decoration:none;font-weight:900}
    a:hover{text-decoration:underline}

    @media (max-width:720px){
      thead th.thEmp{min-width:210px}
      .dayBox{height:58px;border-radius:12px}
    }

/* ===== Shell (meniu ca √Æn admin dashboard) ===== */
  body{
    background:linear-gradient(180deg,#eef0ff 0%, #f6f7ff 55%, #f3f4ff 100%);
  }

  .shell{
    max-width:1520px;
    margin:16px auto;
    padding:0 14px;
    display:grid;
    grid-template-columns:300px 1fr;
    gap:14px;
  }

  .side{
    background:rgba(255,255,255,.85);
    border:1px solid rgba(105,112,160,.18);
    border-radius:22px;
    box-shadow:0 18px 50px rgba(20,18,40,.10);
    overflow:hidden;
    position:sticky;
    top:14px;
    height:calc(100vh - 28px);
    display:flex;
    flex-direction:column;
    padding:12px;
  }

  .sideHead{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:6px 6px 10px;
  }

  .brand{
    display:flex;
    align-items:center;
    gap:10px;
    min-width:0;
  }

  .brandDot{
    width:44px;height:44px;
    border-radius:16px;
    background:linear-gradient(180deg, rgba(124,92,255,.95), rgba(124,92,255,.78));
    color:#fff;
    display:flex;align-items:center;justify-content:center;
    font-weight:1000;
    box-shadow:0 14px 26px rgba(124,92,255,.22);
    flex:0 0 auto;
  }

  .brandTxt{min-width:0}
  .brandTitle{
    color:#1f2340;
    font-weight:1000;
    letter-spacing:.2px;
    line-height:1.05;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .brandSub{
    margin-top:2px;
    color:rgba(40,48,80,.62);
    font-weight:800;
    font-size:12px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .collapseBtn{
    width:44px;height:44px;
    border-radius:16px;
    border:1px solid rgba(105,112,160,.18);
    background:#fff;
    cursor:pointer;
    font-weight:1000;
    color:#2f3450;
  }

  .nav{
    padding:6px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .navBtn{
    width:100%;
    display:flex;
    align-items:center;
    gap:12px;
    padding:12px 12px;
    border-radius:18px;
    border:1px solid rgba(105,112,160,.14);
    background:#fff;
    cursor:pointer;
    text-align:left;
  }

  .navBtn:hover{
    background:rgba(240,242,255,.55);
  }

  .navBtn.active{
    background:rgba(240,242,255,.85);
    border-color:rgba(124,92,255,.40);
    box-shadow:0 16px 34px rgba(124,92,255,.10);
  }

  .navIcon{
    width:42px;height:42px;
    border-radius:16px;
    background:rgba(240,242,255,.95);
    border:1px solid rgba(105,112,160,.14);
    display:flex;
    align-items:center;
    justify-content:center;
    flex:0 0 auto;
  }

  .navGlyph{font-size:18px}

  .navText{display:flex;flex-direction:column;gap:2px;min-width:0}
  .navTitle{
    font-weight:1000;
    color:#2a2f4b;
    font-size:13px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .navSub{
    font-weight:800;
    color:rgba(40,48,80,.60);
    font-size:11px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .sideFoot{
    margin-top:auto;
    padding:10px 6px 4px;
  }
  .sideHint{
    color:rgba(40,48,80,.62);
    font-weight:800;
    font-size:12px;
    line-height:1.35;
    padding:10px 12px;
    border-radius:18px;
    background:rgba(240,242,255,.55);
    border:1px solid rgba(105,112,160,.12);
  }

  .main{
    background:rgba(255,255,255,.85);
    border:1px solid rgba(105,112,160,.18);
    border-radius:22px;
    box-shadow:0 18px 50px rgba(20,18,40,.10);
    overflow:hidden;
  }

  .topbar{
    padding:14px 16px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:14px;
    background:linear-gradient(180deg, rgba(240,242,255,.80), rgba(255,255,255,.70));
    border-bottom:1px solid rgba(105,112,160,.16);
  }

  .tbLeft h1{margin:0;font-size:18px;font-weight:1000}
  .tbLeft .crumb{margin-top:4px;color:rgba(40,48,80,.70);font-weight:800;font-size:12px}

  .tbRight{display:flex;align-items:center;gap:12px}
  .profileMini{
    display:flex;align-items:center;gap:10px;
    padding:8px 10px;border-radius:16px;
    border:1px solid rgba(105,112,160,.18);
    background:#fff
  }
  .pAvatar{
    width:34px;height:34px;border-radius:999px;
    background:#eef1ff;border:2px solid #fff;
    box-shadow:0 8px 18px rgba(20,18,40,.10);
    display:flex;align-items:center;justify-content:center;
    font-weight:1000;color:#38405c;object-fit:cover
  }
  .pMeta{line-height:1.15}
  .pName{font-weight:1000;font-size:13px}
  .pMgr{font-weight:800;font-size:11px;color:rgba(40,48,80,.65)}
  .btnPill{
    padding:10px 12px;border-radius:14px;
    border:1px solid rgba(105,112,160,.18);
    background:#fff;font-weight:1000;cursor:pointer
  }
  .btnPill.primary{
    background:linear-gradient(180deg, rgba(124,92,255,.95), rgba(124,92,255,.78));
    color:#fff;border-color:rgba(124,92,255,.35)
  }

  .content{padding:14px}
  .view{display:none}
  .view.active{display:block}

  /* Collapse (ca √Æn admin) */
  .shell.collapsed{grid-template-columns:88px 1fr}
  .shell.collapsed .brandTxt{display:none}
  .shell.collapsed .collapseBtn{transform:rotate(180deg)}
  .shell.collapsed .navText{display:none}
  .shell.collapsed .navBtn{justify-content:center;padding:12px}
  .shell.collapsed .sideHint{display:none}
  .shell.collapsed .side{padding:12px 10px}

  /* User panel drawer */
  .drawerWrap{position:fixed;inset:0;display:none;justify-content:flex-end;background:rgba(20,18,40,.30);z-index:9999}
  .drawerWrap.show{display:flex}
  .drawer{
    width:min(420px, 92vw); height:100%;
    background:#fff;border-left:1px solid rgba(105,112,160,.18);
    box-shadow:-18px 0 46px rgba(20,18,40,.20);
    padding:16px;
  }
  .drawerHead{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .iconBtn{width:40px;height:40px;border-radius:14px;border:1px solid rgba(105,112,160,.18);background:#fff;font-weight:1000;cursor:pointer}
  .drawerCard{margin-top:14px;padding:14px;border-radius:18px;border:1px solid rgba(105,112,160,.16);background:rgba(240,242,255,.45)}
  .row2{display:flex;align-items:center;gap:12px}
  .bigAvatar{width:54px;height:54px;border-radius:999px;object-fit:cover;background:#eef1ff;border:2px solid #fff;box-shadow:0 10px 22px rgba(20,18,40,.12);display:flex;align-items:center;justify-content:center;font-weight:1000}
  .kv{margin-top:10px;display:grid;grid-template-columns:110px 1fr;gap:8px 10px;font-weight:800;font-size:12px;color:rgba(40,48,80,.82)}
  .k{color:rgba(40,48,80,.55);font-weight:900}
  .drawerActions{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}
  .drawerActions .btnPill{flex:1}

  @media (max-width: 980px){
    .shell{grid-template-columns:1fr}
    .side{position:relative;height:auto}
  }

/* ===== Leave requests + notifications ===== */
.reqGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px 14px}
.reqCard{border:1px solid rgba(105,112,160,.16);background:#fff;border-radius:18px;box-shadow:0 10px 24px rgba(20,18,40,.06);padding:14px}
.reqCard h3{margin:0 0 8px;font-size:13px;font-weight:1000}
.reqRow{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.reqRow.one{grid-template-columns:1fr}
.reqRow label{display:block;font-size:11px;font-weight:900;color:rgba(40,48,80,.72);margin-bottom:6px}
.reqRow input, .reqRow select, .reqRow textarea{
  width:100%;padding:10px 10px;border-radius:14px;border:1px solid rgba(105,112,160,.22);
  outline:none;font-weight:800;background:#fff
}
.reqRow textarea{min-height:86px;resize:vertical}
.reqActions{display:flex;gap:10px;margin-top:12px}
.reqActions .btnPill{flex:1}
.reqWide{grid-column:1 / -1}
.reqTable{width:100%;border-collapse:separate;border-spacing:0 8px}
.reqTable th{font-size:11px;color:rgba(40,48,80,.55);font-weight:1000;text-align:left;padding:0 10px}
.reqTable td{padding:10px 10px;background:rgba(240,242,255,.50);border:1px solid rgba(105,112,160,.14)}
.reqTable tr td:first-child{border-radius:14px 0 0 14px}
.reqTable tr td:last-child{border-radius:0 14px 14px 0}
.badge{display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:22px;padding:0 8px;border-radius:999px;font-weight:1000;font-size:11px}
.badge.pending{background:rgba(255,185,0,.18);color:#7a4d00;border:1px solid rgba(255,185,0,.35)}
.badge.approved{background:rgba(44,204,113,.16);color:#0f7a3a;border:1px solid rgba(44,204,113,.35)}
.badge.rejected{background:rgba(255,72,72,.14);color:#9a1c1c;border:1px solid rgba(255,72,72,.30)}
.dayBox{position:relative}
.excl{
  position:absolute;top:8px;right:8px;
  width:18px;height:18px;border-radius:999px;
  background:linear-gradient(180deg, rgba(255,185,0,.95), rgba(255,150,0,.80));
  color:#fff;font-weight:1000;font-size:12px;display:flex;align-items:center;justify-content:center;
  box-shadow:0 10px 18px rgba(255,150,0,.22);
}
.notifBadgeMini{
  margin-left:8px;
  background:linear-gradient(180deg, rgba(109,94,252,.95), rgba(109,94,252,.75));
  color:#fff;border:1px solid rgba(109,94,252,.35);
}
.notifItem{padding:10px 10px;border-radius:14px;border:1px solid rgba(105,112,160,.16);background:#fff;margin-top:10px}
.notifTitle{font-weight:1000;font-size:12px}
.notifMsg{margin-top:6px;color:rgba(40,48,80,.70);font-weight:800;font-size:12px;line-height:1.35}
.notifMeta{margin-top:8px;color:rgba(40,48,80,.45);font-weight:900;font-size:11px}


    .card{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:18px;box-shadow:0 16px 40px rgba(20,18,40,.06);padding:12px 12px}
    .avatarBig{width:54px;height:54px;border-radius:999px;background:#f0f2ff;border:2px solid #fff;box-shadow:0 12px 22px rgba(20,18,40,.10);display:grid;place-items:center;overflow:hidden}
    .avatarBig img{width:100%;height:100%;object-fit:cover;border-radius:999px}
    .avatarBig #setAvatarInitial{font-weight:1000;color:#3a3f5b}
    .dropZone{border:2px dashed rgba(80,90,140,.25);border-radius:16px;padding:16px 14px;text-align:center;
      background:rgba(245,246,255,.65);font-weight:850;color:rgba(60,65,90,.9);cursor:pointer}
    .dropZone.drag{background:rgba(220,235,255,.9);border-color:rgba(80,110,200,.45)}
    .modalOv{position:fixed;inset:0;background:rgba(0,0,0,.45);display:grid;place-items:center;z-index:9999;padding:18px}
    .modalBox{width:min(520px, 96vw);background:#fff;border-radius:22px;box-shadow:0 30px 90px rgba(0,0,0,.35);overflow:hidden;border:1px solid rgba(0,0,0,.06)}
    .modalHead{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;padding:14px 14px;border-bottom:1px solid rgba(0,0,0,.06);background:rgba(245,246,255,.6)}
    .mhTitle{font-weight:1000}
    .iconBtn{border:0;background:#fff;border-radius:12px;box-shadow:0 10px 18px rgba(20,18,40,.10);cursor:pointer;padding:10px 12px;font-weight:1000}
    .modalBody{padding:14px 14px}
    #avCanvas{width:100%;max-width:420px;aspect-ratio:1/1;border-radius:18px;border:1px solid rgba(0,0,0,.06);display:block;margin:0 auto;background:#f7f8ff}
    .cropRow{display:flex;gap:10px;align-items:center;margin-top:12px}
    .cropRow input[type="range"]{flex:1}
    .modalFoot{display:flex;gap:10px;padding:14px;border-top:1px solid rgba(0,0,0,.06);background:rgba(245,246,255,.4)}

</style>
</head>

<body>
  <div class="shell">
    <aside class="side">
  <div class="sideHead">
    <div class="brand">
      <div class="brandDot">‚ö°</div>
      <div class="brandTxt">
        <div class="brandTitle">Pontaj</div>
        <div class="brandSub">Employee Dashboard</div>
      </div>
    </div>
    <button class="collapseBtn" id="menuCollapse" type="button" title="Ascunde/aratƒÉ meniu">‚üµ</button>
  </div>

  <nav class="nav">
    <button class="navBtn active" data-view="calendar" type="button">
      <span class="navIcon"><span class="navGlyph">üìÖ</span></span>
      <span class="navText">
        <span class="navTitle">Calendar prezen»õƒÉ</span>
        <span class="navSub">Luna curentƒÉ</span>
      </span>
    </button>

    <button class="navBtn" data-view="requests" type="button">
      <span class="navIcon"><span class="navGlyph">üìù</span></span>
      <span class="navText">
        <span class="navTitle">Cereri</span>
        <span class="navSub">Concedii & evenimente</span>
      </span>
    </button>

    <button class="navBtn" data-view="docs" type="button">
      <span class="navIcon"><span class="navGlyph">üìÑ</span></span>
      <span class="navText">
        <span class="navTitle">Documente</span>
        <span class="navSub">Fi»ôiere & proceduri</span>
      </span>
    </button>

    <button class="navBtn" data-view="settings" type="button">
      <span class="navIcon"><span class="navGlyph">‚öô</span></span>
      <span class="navText">
        <span class="navTitle">SetƒÉri</span>
        <span class="navSub">Profil & sesiune</span>
      </span>
    </button>
  </nav>

  <div class="sideFoot">
    <div class="sideHint"><b>Tip:</b> dacƒÉ nu e»ôti logat, intrƒÉ √Æn index.html »ôi apasƒÉ ‚ÄûDeschide dashboard‚Äù.</div>
  </div>
</aside>

    <section class="main">
      <header class="topbar">
        <div class="tbLeft">
          <h1 id="pageTitle">Calendar prezen»õƒÉ</h1>
          <div class="crumb" id="pageCrumb">Dashboard / Calendar</div>
        </div>

        <div class="tbRight">
          <div class="profileMini" title="Utilizator">
            <img id="topAvatarImg" class="pAvatar" alt="" style="display:none"/>
            <div id="topAvatar" class="pAvatar">‚Ä¢</div>
            <div class="pMeta">
              <div class="pName" id="topName">‚Äî</div>
              <div class="pMgr" id="topMgr">Manager: ‚Äî</div>
            </div>
          </div>
          <button class="btnPill primary" id="btnUserPanel" type="button">User panel <span id="notifTopBadge" class="badge notifBadgeMini" style="display:none">0</span></button>
        </div>
      </header>

      <div class="content">
        <div class="view active" id="view-calendar">
          <div class="wrap">
    <div class="panel">
      <div class="panelHead">
        <div>
          <h2>Calendar prezen»õƒÉ</h2>
          <div class="note" id="sub">‚Äî</div>
        </div>
        <div class="controls">
          <button class="btn" id="prev" type="button">‚Äπ</button>
          <select id="monthSel" class="select"></select>
          <button class="btn" id="next" type="button">‚Ä∫</button>
        </div>
      </div>

      <div class="tableWrap">
        <table id="cal">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="legend">
        <div style="width:100%;padding:2px 0 6px;color:#574bb8;font-weight:950">
          Condi»õia de prezen»õƒÉ nu con»õine timp activ (pontaje ne√Æncheiate)
        </div>

        <div style="width:100%;display:flex;gap:14px;flex-wrap:wrap;align-items:center">
          <div><b>CO</b> - Concediu de odihnƒÉ</div>
          <div><b>BO</b> - Concediu medical</div>
          <div><b>CCC</b> - Concediu pentru cre»ôterea copilului</div>
          <div><b>CFP</b> - Concediu fƒÉrƒÉ platƒÉ</div>
          <div><b>EV</b> - Eveniment</div>
        </div>

        <div style="width:100%;display:flex;gap:14px;flex-wrap:wrap;align-items:center">
          <span class="pill"><span class="dot" style="background:rgba(109,94,252,.55)"></span>√én progres</span>
          <span class="pill"><span class="dot" style="background:rgba(255,77,77,.55)"></span>√én pauzƒÉ</span>
          <span class="pill"><span class="dot" style="background:var(--c-under)"></span>Sub normƒÉ</span>
          <span class="pill"><span class="dot" style="background:var(--c-complete)"></span>Complet</span>
          <span class="pill"><span class="dot" style="background:var(--c-over)"></span>Peste normƒÉ</span>
          <span class="pill"><span class="dot" style="background:var(--c-inactive)"></span>Inactiv/absent</span>
          <span class="pill"><span class="dot" style="background:var(--c-leave)"></span>Concediu</span>
        </div>
      </div>
    </div>
  </div>

<script>
  // ========= Helpers =========
  const $ = (s, r=document)=>r.querySelector(s);
  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }
  function initials(name){
    const p = String(name||"").trim().split(/\s+/).filter(Boolean);
    const a = p[0]?.[0]||"";
    const b = p[1]?.[0]||"";
    return (a+b).toUpperCase() || "‚Ä¢";
  }
  function parseIso(iso){
    if (!iso) return null;
    const d = new Date(String(iso).replace(" ", "T"));
    return isNaN(d) ? null : d;
  }
  function dayKey(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }
  function getWeekdayShort(dateStr){
    const d = new Date(dateStr+"T00:00:00");
    return ["Du","Lu","Ma","Mi","Jo","Vi","S√¢"][d.getDay()];
  }
  function hm(d){
    return String(d.getHours()).padStart(2,'0') + ":" + String(d.getMinutes()).padStart(2,'0');
  }
  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

  function jsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(16).slice(2);
      const s = document.createElement("script");
      let done = false;
      const tmr = setTimeout(()=>{ if (done) return; cleanup(); reject(new Error("JSONP timeout")); }, 25000);

      window[cb] = (data)=>{ done = true; cleanup(); resolve(data); };
      function cleanup(){
        try{ clearTimeout(tmr); }catch(e){}
        try{ delete window[cb]; }catch(e){ window[cb] = undefined; }
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }
      s.onerror = ()=>{ if (done) return; cleanup(); reject(new Error("JSONP error")); };
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
      document.head.appendChild(s);
    });
  }

  // ========= Config + Session =========
  const EMP_TOKEN_KEY = "pontaj_me_token";
  const EMP_NAME_KEY  = "pontaj_me_name";
  let CFG = null;

  async function loadConfig(){
    const tries = ["config.json","./config.json","../config.json","/config.json"];
    for (const p of tries){
      try{
        const r = await fetch(p+"?v="+Date.now(), {cache:"no-store"});
        if (!r.ok) continue;
        CFG = await r.json();
        return;
      }catch(e){}
    }
    throw new Error("Nu pot √ÆncƒÉrca config.json.");
  }
  function ep(){ return CFG?.leaveEndpoint || CFG?.stateEndpoint || CFG?.adminEventsEndpoint || ""; }

  function getEmpSession(){
    try{
      const token = localStorage.getItem(EMP_TOKEN_KEY) || "";
      const name  = localStorage.getItem(EMP_NAME_KEY) || "";
      return (token && name) ? { token, name } : null;
    }catch(e){ return null; }
  }

  // ========= Norms =========
  function getNormMinutesFor(name, dept){
    let normH = 8;
    const ns = CFG?.norms;
    if (ns?.defaultHours != null) normH = ns.defaultHours;
    if (ns?.departments && dept){
      const key = Object.keys(ns.departments).find(k => k.toLowerCase() === String(dept).toLowerCase());
      if (key && ns.departments[key]?.normHours != null) normH = ns.departments[key].normHours;
    }
    if (ns?.employees && name && ns.employees[name]?.normHours != null) normH = ns.employees[name].normHours;
    return Math.round(Number(normH)*60);
  }

  function computeDaySummary(events, normMin){
    const leaveCodes = ["CO","CM","BO","CCC","CFP","EV"];
    const rows = (events||[])
      .map(e=>({
        t: new Date(e.ts),
        action: String(e.action||"").toUpperCase().replace(/_/g," "),
        notes: e.notes||""
      }))
      .filter(x=>!isNaN(x.t))
      .sort((a,b)=>a.t-b.t);

    // leave detect
    let leaveCode = "";
    for (const r of rows){
      if (leaveCodes.includes(r.action)) { leaveCode = r.action; break; }
      const m = String(r.notes||"").match(/\b(CO|CM|BO|CCC|CFP|EV)\b/i);
      if (r.action === "LEAVE" && m) { leaveCode = m[1].toUpperCase(); break; }
    }
    if (leaveCode){
      return { workMin:0, pauseMin:0, status:"leave", startHm:"", endHm:"", label:leaveCode, sub:"", running:false, paused:false, leaveCode };
    }

    const starts = rows.filter(r=>r.action==="START" || r.action==="EXTRA START");
    const finishes = rows.filter(r=>r.action==="FINISH" || r.action==="EXTRA FINISH");
    const firstStart = starts.length ? starts[0].t : null;
    const lastFinish = finishes.length ? finishes[finishes.length-1].t : null;

    // work/pause timeline
    let running = false, paused = false;
    let tRunStart = null, tPauseStart = null;
    let workMs = 0, pauseMs = 0;

    for (const r of rows){
      if (r.action === "START" || r.action === "EXTRA START"){
        if (!running){ running = true; paused = false; tRunStart = r.t; tPauseStart = null; }
      }
      else if (r.action === "PAUSE"){
        if (running && !paused){ paused = true; tPauseStart = r.t; if (tRunStart){ workMs += (r.t - tRunStart); tRunStart = null; } }
      }
      else if (r.action === "UNPAUSE"){
        if (running && paused){ paused = false; if (tPauseStart){ pauseMs += (r.t - tPauseStart); tPauseStart = null; } tRunStart = r.t; }
      }
      else if (r.action === "FINISH" || r.action === "EXTRA FINISH"){
        if (paused && tPauseStart){ pauseMs += (r.t - tPauseStart); tPauseStart = null; }
        if (running && tRunStart){ workMs += (r.t - tRunStart); tRunStart = null; }
        running = false; paused = false;
      }
    }

    // if still running/paused, we don't count open segments as "work" in calendar condition
    const workMin = Math.round(workMs/60000);
    const pauseMin = Math.round(pauseMs/60000);

    const startHm = firstStart ? hm(firstStart) : "";
    const endHm   = lastFinish ? hm(lastFinish) : "";

    let status = "inactive";
    let label = "";
    let sub = "";

    if (firstStart && !lastFinish){
      status = paused ? "paused" : "inprogress";
      label = ""; sub = "";
    } else if (firstStart && lastFinish){
      const diff = clamp(workMin, 0, 24*60);
      label = (diff>=60) ? (Math.floor(diff/60).toString().padStart(2,"0")+":"+String(diff%60).padStart(2,"0")) : ("00:"+String(diff).padStart(2,"0"));
      if (diff < normMin) status = "under";
      else if (diff === normMin) status = "complete";
      else status = "over";
      if (pauseMin>0){
        const pm = clamp(pauseMin,0,24*60);
        sub = "PauzƒÉ " + (pm>=60 ? (Math.floor(pm/60)+"h "+(pm%60)+"m") : (pm+"m"));
      }
    } else {
      status = "inactive";
    }

    return { workMin, pauseMin, status, startHm, endHm, label, sub, running, paused, leaveCode:"" };
  }

  function buildMonthOptions(curYm){
    const sel = $("#monthSel");
    sel.innerHTML = "";
    const [cy, cm] = curYm.split("-").map(x=>parseInt(x,10));
    const base = new Date(cy, cm-1, 1);
    for (let i=-12; i<=1; i++){
      const d = new Date(base.getFullYear(), base.getMonth()+i, 1);
      const ym = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,'0');
      const opt = document.createElement("option");
      opt.value = ym;
      opt.textContent = d.toLocaleDateString("ro-RO",{month:"long", year:"numeric"});
      if (ym===curYm) opt.selected = true;
      sel.appendChild(opt);
    }
  }

  function renderCalendar({ym, name, dept, days, daysInMonth}){
    $("#sub").textContent = `${name}${dept ? " ‚Ä¢ " + dept : ""} ‚Ä¢ ${new Date(ym+"-01T00:00:00").toLocaleDateString("ro-RO",{month:"long", year:"numeric"})}`;

    const thead = $("#thead");
    thead.innerHTML = `<tr>
      <th class="stickyL thEmp">ANGAJAT</th>
      ${Array.from({length:daysInMonth}, (_,i)=>{
        const dk = `${ym}-${String(i+1).padStart(2,'0')}`;
        const wd = getWeekdayShort(dk);
        const dow = new Date(dk+"T00:00:00").getDay();
        const cut = (dow===1) ? " weekCut" : "";
        return `<th class="thDay${cut}" title="${dk}">${String(i+1).padStart(2,'0')}<br><span class="wd">${wd}</span></th>`;
      }).join("")}
    </tr>`;

    const tbody = $("#tbody");
    const avatarUrl = (CFG && CFG.employeeAvatars && CFG.employeeAvatars[name]) ? String(CFG.employeeAvatars[name]) : "";
    const avatarHtml = avatarUrl
      ? `<img class="empPhoto" src="${escapeHtml(avatarUrl)}" alt="">`
      : `<div class="empAvatar">${escapeHtml(initials(name))}</div>`;
    const deptLine = dept ? `<div class="empDept">${escapeHtml(dept)}</div>` : ``;

    const cells = days.map(d=>{
      const dateObj = new Date(d.dk + "T00:00:00");
      const dow = dateObj.getDay();
      const weekend = (dow === 0 || dow === 6) ? " weekend" : "";
      const weekCut = (dow === 1) ? " weekCut" : "";

      let inner = "";
      if (d.leaveCode){
        inner = `<div class="code">${escapeHtml(d.leaveCode)}</div>`;
      } else {
        const top = d.startHm ? `<div class="t">${escapeHtml(d.startHm)}</div>` : `<div class="t muted">‚Äî</div>`;
        const mid = d.endHm ? `<div class="t">${escapeHtml(d.endHm)}</div>` : `<div class="t muted"> </div>`;
        const bottom = d.label ? `<div class="dur">${escapeHtml(d.label)}</div>` : `<div class="dur muted"> </div>`;
        inner = `${top}${mid}${bottom}`;
      }

      const excl = (d.pendingCount && !d.leaveCode) ? `<div class="excl" title="Cerere √Æn a»ôteptare">!</div>` : (d.pendingCount ? `<div class="excl" title="Cerere √Æn a»ôteptare">!</div>` : ``);
      return `<td class="dayCell${weekCut}">
        <div class="dayBox st-${d.status}${weekend}" data-day="${escapeHtml(d.dk)}" title="${escapeHtml(d.dk)}">
          ${excl}
          ${inner}
        </div>
      </td>`;
    }).join("");

    tbody.innerHTML = `<tr>
      <td class="stickyL">
        <div class="empCell">
          ${avatarHtml}
          <div class="empMeta">
            <div class="empName">${escapeHtml(name)}</div>
            ${deptLine}
          </div>
        </div>
      </td>
      ${cells}
    </tr>`;
    // bind click pe zilele cu cereri pending -> sari la Cereri
    try{
      tbody.querySelectorAll('.dayBox').forEach(box=>{
        box.addEventListener('click', ()=>{
          const dk = box.getAttribute('data-day');
          const pend = (__PENDING_BY_DAY__.get(dk) || []);
          if (pend.length){
            try{ window.__jumpToRequests__ && window.__jumpToRequests__(dk); }catch(e){}
          }
        });
      });
    }catch(e){}

  }

  function showCenterMessage(html){
    $("#thead").innerHTML = "";
    $("#tbody").innerHTML = `<tr><td class="centerMsg">${html}</td></tr>`;
  }

  // ========= Data =========
  async function loadMonth(ym){
    const s = getEmpSession();
    if (!s){
      showCenterMessage(`Nu e»ôti logat. IntrƒÉ √Æn <a href="index.html">index.html</a> »ôi apasƒÉ ‚ÄûDeschide dashboard‚Äù.`);
      $("#sub").textContent = "Neautentificat";
      return;
    }
    const endpoint = ep();
    if (!endpoint){
      showCenterMessage("Lipse»ôte endpoint √Æn config.json (stateEndpoint sau adminEventsEndpoint).");
      return;
    }
    showCenterMessage("Se √ÆncarcƒÉ‚Ä¶");

    const url = endpoint + "?fn=mePresenceMonth"
      + "&ym=" + encodeURIComponent(ym)
      + "&token=" + encodeURIComponent(s.token)
      + "&ts=" + Date.now();

    const res = await jsonp(url);
    if (!res || !res.ok){
      const msg = res?.error || "Nu pot √ÆncƒÉrca datele.";
      showCenterMessage(escapeHtml(msg) + ` <div class="muted" style="margin-top:10px">DacƒÉ sesiunea a expirat, re-logheazƒÉ-te din <a href="index.html">index.html</a>.</div>`);
      return;
    }

    const name = res.name || s.name;
    const dept = res.dept || "";
    const events = Array.isArray(res.events) ? res.events : [];

    const leaves = Array.isArray(res.leaves) ? res.leaves : [];
    indexLeavesForMonth(leaves);

    // Build per-day summaries
    const [y, m] = ym.split("-").map(n=>parseInt(n,10));
    const first = new Date(y, m-1, 1);
    const next = new Date(y, m, 1);
    const daysInMonth = Math.round((next-first)/86400000);

    const byDay = new Map();
    for (const e of events){
      const d = parseIso(e.ts);
      if (!d) continue;
      const dk = dayKey(d);
      if (!byDay.has(dk)) byDay.set(dk, []);
      byDay.get(dk).push(e);
    }

    const normMin = getNormMinutesFor(name, dept);
    const days = [];
    for (let i=1;i<=daysInMonth;i++){
      const dk = `${ym}-${String(i).padStart(2,'0')}`;
      const evs = byDay.get(dk) || [];
      const s = computeDaySummary(evs, normMin);
      // overlay leave requests
      const pend = __PENDING_BY_DAY__.get(dk) || [];
      const appr = __APPROVED_BY_DAY__.get(dk) || [];
      if (!s.leaveCode && appr.length){
        s.status = 'leave';
        s.leaveCode = String(appr[0].code||'LEAVE');
        s.label = s.leaveCode;
      }
      s.pendingCount = pend.length;
      s.pendingLeaves = pend;
      s.dayLeaves = (__LEAVES_BY_DAY__.get(dk) || []);
      days.push({ dk, ...s });
    }

    renderCalendar({ ym, name, dept, days, daysInMonth });
  }

  
  // ========= Leave Requests + Notifications =========
  function addDays(dateStr, n){
    const d = new Date(dateStr+"T00:00:00");
    d.setDate(d.getDate()+n);
    return d.toISOString().slice(0,10);
  }
  function daysBetweenInclusive(a,b){
    const out = [];
    let cur = a;
    for (let i=0;i<62;i++){
      out.push(cur);
      if (cur===b) break;
      cur = addDays(cur,1);
    }
    return out;
  }
  function fmtTime(v){
    if (v === undefined || v === null) return "";
    // Date object
    try{
      if (v instanceof Date && !isNaN(v.getTime())){
        return String(v.getHours()).padStart(2,'0') + ":" + String(v.getMinutes()).padStart(2,'0');
      }
    }catch(e){}

    const s = String(v).trim();
    if (!s) return "";

    // "HH:mm" or "H:mm" (optional seconds)
    const m = s.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
    if (m){
      return String(m[1]).padStart(2,'0') + ":" + String(m[2]).padStart(2,'0');
    }

    // Google Sheets / Apps Script time may arrive as a full Date string (often 1899-12-30)
    const d = new Date(s);
    if (!isNaN(d.getTime())){
      return String(d.getHours()).padStart(2,'0') + ":" + String(d.getMinutes()).padStart(2,'0');
    }

    // numeric day fraction (0..1) sometimes from sheets
    const num = Number(s.replace(',', '.'));
    if (!Number.isNaN(num) && num >= 0 && num < 2){
      const mins = Math.round((num % 1) * 24 * 60);
      return String(Math.floor(mins/60)).padStart(2,'0') + ":" + String(mins%60).padStart(2,'0');
    }

    return s;
  }

  function fmtPeriod(item){
    if (String(item.kind||"").toLowerCase()==="invoire"){
      return `${item.startDate} ‚Ä¢ ${fmtTime(item.startTime) || "?"}‚Äì${fmtTime(item.endTime) || "?"}`;
    }
    return `${item.startDate} ‚Äì ${item.endDate} ‚Ä¢ ${item.code||""}`;
  }
  function statusBadge(st){
    const s = String(st||"").toLowerCase();
    if (s==="approved") return `<span class="badge approved">Aprobat</span>`;
    if (s==="rejected") return `<span class="badge rejected">Respins</span>`;
    return `<span class="badge pending">√én a»ôteptare</span>`;
  }

  let __LEAVES_BY_DAY__ = new Map(); // dk -> list
  let __PENDING_BY_DAY__ = new Map(); // dk -> pending list
  let __APPROVED_BY_DAY__ = new Map(); // dk -> approved list

  function indexLeavesForMonth(leaves){
    __LEAVES_BY_DAY__ = new Map();
    __PENDING_BY_DAY__ = new Map();
    __APPROVED_BY_DAY__ = new Map();
    (leaves||[]).forEach(it=>{
      const sd = String(it.startDate||"");
      const ed = String(it.endDate||sd);
      if (!sd) return;
      const days = daysBetweenInclusive(sd, ed);
      days.forEach(dk=>{
        if (!__LEAVES_BY_DAY__.has(dk)) __LEAVES_BY_DAY__.set(dk, []);
        __LEAVES_BY_DAY__.get(dk).push(it);
        const st = String(it.status||"").toLowerCase();
        if (st==="pending"){
          if (!__PENDING_BY_DAY__.has(dk)) __PENDING_BY_DAY__.set(dk, []);
          __PENDING_BY_DAY__.get(dk).push(it);
        } else if (st==="approved"){
          if (!__APPROVED_BY_DAY__.has(dk)) __APPROVED_BY_DAY__.set(dk, []);
          __APPROVED_BY_DAY__.get(dk).push(it);
        }
      });
    });
  }

  async function meLeaves(ym){
    const s = getEmpSession();
    const endpoint = ep();
    if (!s || !endpoint) return { ok:false, error:"Sesiune lipsƒÉ." };
    const url = endpoint + "?fn=meLeaves&ym=" + encodeURIComponent(ym) + "&token=" + encodeURIComponent(s.token) + "&ts=" + Date.now();
    try{ return await jsonp(url); }catch(err){ return { ok:false, error:(err?.message||String(err)||'JSONP error') }; }
  }

  async function leaveCreate(kind, payload){
  try{
    const s = getEmpSession();
    const endpoint = ep();
    if (!s || !endpoint) return { ok:false, error:"Sesiune lipsƒÉ." };
    const q = new URLSearchParams();
    q.set("fn","leaveCreate");
    q.set("kind", kind);
    q.set("token", s.token);
    Object.entries(payload||{}).forEach(([k,v])=>{ if (v!==undefined && v!==null) q.set(k, String(v)); });
    q.set("ts", String(Date.now()));
    const url = endpoint + "?" + q.toString();
    return await jsonp(url);
  }catch(err){
    return { ok:false, error: (err?.message || String(err) || "Eroare necunoscutƒÉ") };
  }
}


  async function meNotifications(){
    const s = getEmpSession();
    const endpoint = ep();
    if (!s || !endpoint) return { ok:false, error:"Sesiune lipsƒÉ." };
    const url = endpoint + "?fn=meNotifications&token=" + encodeURIComponent(s.token) + "&ts=" + Date.now();
    try{ return await jsonp(url); }catch(err){ return { ok:false, error:(err?.message||String(err)||'JSONP error') }; }
  }

  async function meNotificationsAck(ids){
    const s = getEmpSession();
    const endpoint = ep();
    if (!s || !endpoint) return { ok:false, error:"Sesiune lipsƒÉ." };
    const url = endpoint + "?fn=meNotificationsAck&token=" + encodeURIComponent(s.token)
      + "&ids=" + encodeURIComponent((ids||[]).join(","))
      + "&ts=" + Date.now();
    return await jsonp(url);
  }

  function fillReqMonths(curYm){
    const sel = $("#reqMonth");
    if (!sel) return;
    sel.innerHTML = "";
    const [cy, cm] = curYm.split("-").map(x=>parseInt(x,10));
    const base = new Date(cy, cm-1, 1);
    for (let i=-6; i<=1; i++){
      const d = new Date(base.getFullYear(), base.getMonth()+i, 1);
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      const opt = document.createElement("option");
      opt.value = ym;
      opt.textContent = d.toLocaleString("ro-RO", {month:"long", year:"numeric"});
      if (ym === curYm) opt.selected = true;
      sel.appendChild(opt);
    }
  }

  function renderReqTable(list){
    const tb = $("#reqTbody");
    if (!tb) return;
    const stFilter = ($("#reqStatus")?.value || "").toLowerCase();
    const rows = (list||[]).filter(it=>{
      if (!stFilter) return true;
      return String(it.status||"").toLowerCase() === stFilter;
    });

    if (!rows.length){
      tb.innerHTML = `<tr><td colspan="4" class="note" style="border-radius:14px">Nu existƒÉ cereri √Æn luna selectatƒÉ.</td></tr>`;
      return;
    }

    tb.innerHTML = rows.map(it=>{
      const kind = String(it.kind||"").toLowerCase()==="invoire" ? "√énvoire" : `Concediu ${escapeHtml(it.code||"")}`;
      const period = escapeHtml(fmtPeriod(it));
      const manager = escapeHtml(it.managerName || it.managerEmail || "‚Äî");
      return `<tr>
        <td>${kind}</td>
        <td>${period}</td>
        <td>${statusBadge(it.status)}</td>
        <td>${manager}</td>
      </tr>`;
    }).join("");
  }

  async function refreshRequests(ym){
    const res = await meLeaves(ym);
    if (!res || !res.ok){
      $("#reqTbody").innerHTML = `<tr><td colspan="4" class="note" style="border-radius:14px">Eroare: ${escapeHtml(res?.error||"Nu pot √ÆncƒÉrca cererile.")}</td></tr>`;
      return;
    }
    renderReqTable(res.list||[]);
  }

  function renderNotifications(list){
    const wrap = $("#notifList");
    const empty = $("#notifEmpty");
    if (!wrap) return;
    const items = Array.isArray(list)? list : [];
    const unread = items.filter(x=>!x.readAt).length;

    const badge = $("#notifTopBadge");
    if (badge){
      badge.textContent = String(unread);
      badge.style.display = unread ? "" : "none";
    }

    wrap.innerHTML = "";
    if (!items.length){
      if (empty) empty.style.display = "";
      return;
    }
    if (empty) empty.style.display = "none";

    items.slice(0,40).forEach(it=>{
      const t = escapeHtml(it.title||"Notificare");
      const msg = escapeHtml(it.message||"");
      const dt = it.createdAt ? new Date(it.createdAt).toLocaleString("ro-RO") : "";
      const read = it.readAt ? "opacity:.65" : "";
      const pill = it.readAt ? `<span class="badge" style="background:#eef1ff;border:1px solid rgba(105,112,160,.16);color:rgba(40,48,80,.65)">citit</span>`
                             : `<span class="badge pending">nou</span>`;
      const meta = escapeHtml(dt);
      const el = document.createElement("div");
      el.className = "notifItem";
      el.style = read;
      el.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div class="notifTitle">${t}</div>${pill}
      </div>
      <div class="notifMsg">${msg}</div>
      <div class="notifMeta">${meta}</div>`;
      wrap.appendChild(el);
    });
  }

  async function refreshNotifications(){
    const res = await meNotifications();
    if (!res || !res.ok){
      console.warn("meNotifications failed", res?.error);
      return;
    }
    renderNotifications(res.list||[]);
  }

  function bindRequestsUI(){
    const now = new Date();
    const YM = now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0");
    fillReqMonths(YM);

    $("#reqRefresh")?.addEventListener("click", ()=>{
      const ym = $("#reqMonth")?.value || YM;
      refreshRequests(ym);
      refreshNotifications();
    });

    $("#reqMonth")?.addEventListener("change", ()=>{
      refreshRequests($("#reqMonth").value);
    });
    $("#reqStatus")?.addEventListener("change", ()=>{
      refreshRequests($("#reqMonth").value);
    });

    $("#btnLeaveSend")?.addEventListener("click", async ()=>{
      $("#lvMsg").textContent = "Se trimite‚Ä¶";
      const payload = {
        code: $("#lvCode").value,
        startDate: $("#lvStart").value,
        endDate: $("#lvEnd").value,
        reason: $("#lvReason").value
      };
      const res = await leaveCreate("concediu", payload);
      if (!res || !res.ok){
        $("#lvMsg").textContent = "Eroare: " + (res?.error || "Nu pot trimite.");
        return;
      }
      $("#lvMsg").textContent = "Cerere concediu trimisƒÉ ‚úÖ" + ((res.managerName||res.managerEmail) ? (" cƒÉtre " + (res.managerName||res.managerEmail)) : "");
      refreshRequests($("#reqMonth").value);
      // refresh presence for current month too
      loadMonth($("#monthSel").value);
    });

    $("#btnInvSend")?.addEventListener("click", async ()=>{
      $("#invMsg").textContent = "Se trimite‚Ä¶";
      const payload = {
        date: $("#invDate").value,
        startDate: $("#invDate").value,
        startTime: $("#invStart").value,
        endTime: $("#invEnd").value,
        reason: $("#invReason").value,
        code: "INV"
      };
      const res = await leaveCreate("invoire", payload);
      if (!res || !res.ok){
        $("#invMsg").textContent = "Eroare: " + (res?.error || "Nu pot trimite.");
        return;
      }
      $("#invMsg").textContent = "Cerere √Ænvoire trimisƒÉ ‚úÖ" + ((res.managerName||res.managerEmail) ? (" cƒÉtre " + (res.managerName||res.managerEmail)) : "");
      refreshRequests($("#reqMonth").value);
      loadMonth($("#monthSel").value);
    });

    $("#btnNotifMarkAll")?.addEventListener("click", async ()=>{
      const res = await meNotifications();
      if (!res || !res.ok) return;
      const ids = (res.list||[]).filter(x=>!x.readAt).map(x=>x.id).filter(Boolean);
      if (!ids.length) return;
      await meNotificationsAck(ids);
      refreshNotifications();
    });

    // default populate date inputs with today
    const today = new Date().toISOString().slice(0,10);
    if ($("#lvStart") && !$("#lvStart").value) $("#lvStart").value = today;
    if ($("#lvEnd") && !$("#lvEnd").value) $("#lvEnd").value = today;
    if ($("#invDate") && !$("#invDate").value) $("#invDate").value = today;
    if ($("#invStart") && !$("#invStart").value) $("#invStart").value = "10:00";
    if ($("#invEnd") && !$("#invEnd").value) $("#invEnd").value = "12:00";
  }

  // Hook for menu changes (defined in the other script)
  window.__onViewChange__ = async (view)=>{
    if (view === "requests"){
      const ym = $("#reqMonth")?.value || $("#monthSel")?.value || "";
      if (ym) await refreshRequests(ym);
      await refreshNotifications();
    }
  };


// ========= Init =========
  (async () => {
    const now = new Date();
    let YM = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0");

    try{
      await loadConfig();
    }catch(e){
      showCenterMessage("Nu pot √ÆncƒÉrca config.json.");
      $("#sub").textContent = "Eroare config";
      console.error(e);
      return;
    }

    buildMonthOptions(YM);
    $("#monthSel").addEventListener("change", ()=>{ YM = $("#monthSel").value; loadMonth(YM); });
    $("#prev").addEventListener("click", ()=>{
      const [y,m] = YM.split("-").map(n=>parseInt(n,10));
      const d = new Date(y, m-2, 1);
      YM = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0");
      buildMonthOptions(YM);
      loadMonth(YM);
    });
    $("#next").addEventListener("click", ()=>{
      const [y,m] = YM.split("-").map(n=>parseInt(n,10));
      const d = new Date(y, m, 1);
      YM = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0");
      buildMonthOptions(YM);
      loadMonth(YM);
    });

    await loadMonth(YM);
  })();
</script>
        </div>

        
<div class="view" id="view-requests">
  <div class="panel">
    <div class="panelHead">
      <div>
        <h2>Cereri</h2>
        <div class="note">Trimite cereri de concediu / √Ænvoire. Vei primi notificare aici dupƒÉ aprobare sau respingere.</div>
      </div>
      <div class="controls">
        <button class="btnPill" id="reqRefresh" type="button">Re√ÆncarcƒÉ</button>
      </div>
    </div>

    <div class="reqGrid">
      <div class="reqCard">
        <h3>Trimite cerere concediu</h3>
        <div class="reqRow">
          <div>
            <label>De la</label>
            <input id="lvStart" type="date"/>
          </div>
          <div>
            <label>P√¢nƒÉ la</label>
            <input id="lvEnd" type="date"/>
          </div>
        </div>
        <div class="reqRow">
          <div>
            <label>Tip concediu</label>
            <select id="lvCode">
              <option value="">Alege‚Ä¶</option>
              <option value="CO">CO (odihnƒÉ)</option>
              <option value="CM">CM (medical)</option>
              <option value="BO">BO</option>
              <option value="CCC">CCC</option>
              <option value="CFP">CFP</option>
              <option value="EV">EV (eveniment)</option>
            </select>
          </div>
          <div>
            <label>Motiv (op»õional)</label>
            <input id="lvReason" type="text" placeholder="Ex: concediu planificat"/>
          </div>
        </div>
        <div class="reqActions">
          <button class="btnPill primary" id="btnLeaveSend" type="button">Trimite concediu</button>
        </div>
        <div class="note" id="lvMsg" style="margin-top:10px">‚Äî</div>
      </div>

      <div class="reqCard">
        <h3>Trimite cerere √Ænvoire</h3>
        <div class="reqRow">
          <div>
            <label>Data</label>
            <input id="invDate" type="date"/>
          </div>
          <div>
            <label>Interval orar</label>
            <div style="display:flex;gap:10px">
              <input id="invStart" type="time" step="300" style="flex:1"/>
              <input id="invEnd" type="time" step="300" style="flex:1"/>
            </div>
          </div>
        </div>
        <div class="reqRow one">
          <div>
            <label>Motiv (op»õional)</label>
            <input id="invReason" type="text" placeholder="Ex: problemƒÉ personalƒÉ"/>
          </div>
        </div>
        <div class="reqActions">
          <button class="btnPill primary" id="btnInvSend" type="button">Trimite √Ænvoire</button>
        </div>
        <div class="note" id="invMsg" style="margin-top:10px">‚Äî</div>
      </div>

      <div class="reqCard reqWide">
        <h3>Cererile mele</h3>
        <div class="reqRow">
          <div>
            <label>Luna</label>
            <select id="reqMonth"></select>
          </div>
          <div>
            <label>Status</label>
            <select id="reqStatus">
              <option value="">Toate</option>
              <option value="pending">√én a»ôteptare</option>
              <option value="approved">Aprobate</option>
              <option value="rejected">Respinse</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px;overflow:auto">
          <table class="reqTable">
            <thead>
              <tr>
                <th>Tip</th>
                <th>PerioadƒÉ / ore</th>
                <th>Status</th>
                <th>Manager</th>
              </tr>
            </thead>
            <tbody id="reqTbody">
              <tr><td colspan="4" class="note" style="border-radius:14px">Se √ÆncarcƒÉ‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="view" id="view-docs">
          <div class="panel">
            <div class="panelHead">
              <div>
                <h2>Documente</h2>
                <div class="note">Documente puse de companie / formulare / proceduri. (UI pregƒÉtit)</div>
              </div>
            </div>
            <div style="padding:14px 16px">
              <div class="note">Aici putem afi»ôa link-uri din config.json (ex: docsLinks) sau dintr-un sheet separat.</div>
              <div id="docsList" style="margin-top:12px"></div>
            </div>
          </div>
        </div>

        <div class="view" id="view-settings">
          <div class="panel">
            <div class="panelHead">
              <div>
                <h2>SetƒÉri</h2>
                <div class="note">Sesiune »ôi preferin»õe.</div>
              </div>
            </div>
            <div style="padding:14px 16px">
              <div class="note"><b>Nume:</b> <span id="setName">‚Äî</span></div>
              <div class="note" style="margin-top:6px"><b>Departament:</b> <span id="setDept">‚Äî</span></div>
              <div class="note" style="margin-top:6px"><b>Manager:</b> <span id="setMgr">‚Äî</span></div>

              <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
                <button class="btnPill" id="btnOpenIndex" type="button">Deschide index.html</button>
                <button class="btnPill" id="btnRefreshAll" type="button">Re√ÆncarcƒÉ date</button>
                <button class="btnPill primary" id="btnLogout" type="button">Logout</button>
              </div>

              
              <div class="card" style="margin-top:14px">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
                  <div style="display:flex;align-items:center;gap:12px">
                    <div class="avatarBig" id="setAvatarCircle">
                      <img id="setAvatarImg" alt="avatar" style="display:none" />
                      <div id="setAvatarInitial">‚Äî</div>
                    </div>
                    <div>
                      <div style="font-weight:1000">Avatar</div>
                      <div class="note">Trage &amp; lasƒÉ o imagine, apoi decupeazƒÉ »ôi salveazƒÉ. (PNG/JPG)</div>
                    </div>
                  </div>
                  <div style="display:flex;gap:10px;flex-wrap:wrap">
                    <button class="btnPill" id="btnAvatarChoose" type="button">Alege imagine</button>
                    <button class="btnPill primary" id="btnAvatarSave" type="button" disabled>SalveazƒÉ</button>
                    <button class="btnPill" id="btnAvatarClear" type="button">»òterge</button>
                    <input id="avatarFile" type="file" accept="image/*" style="display:none" />
                  </div>
                </div>

                <div class="dropZone" id="avatarDrop" style="margin-top:12px">
                  Trage &amp; lasƒÉ aici imaginea (sau apasƒÉ ‚ÄûAlege imagine‚Äù).
                </div>

                <div class="note" id="avatarStatus" style="margin-top:10px">‚Äî</div>
              </div>

<div class="note" style="margin-top:12px">
                DacƒÉ vrei, pot adƒÉuga aici: schimbare temƒÉ, schimbare PIN (doar dacƒÉ permi»õi), notificƒÉri, etc.
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- User panel drawer -->
  <div class="drawerWrap" id="drawerWrap">
    <div class="drawer">
      <div class="drawerHead">
        <div style="font-weight:1000;font-size:14px">User panel</div>
        <button class="iconBtn" id="drawerClose" type="button">‚úï</button>
      </div>

      <div class="drawerCard">
        <div class="row2">
          <img id="drawerAvatarImg" class="bigAvatar" alt="" style="display:none"/>
          <div id="drawerAvatar" class="bigAvatar">‚Ä¢</div>
          <div>
            <div style="font-weight:1000" id="drawerName">‚Äî</div>
            <div class="note" id="drawerSub">‚Äî</div>
          </div>
        </div>

        <div class="kv">
          <div class="k">Departament</div><div id="drawerDept">‚Äî</div>
          <div class="k">Manager</div><div id="drawerMgr">‚Äî</div>
          <div class="k">Sesiune</div><div id="drawerSess">‚Äî</div>
        </div>

        <div class="drawerActions">
          <button class="btnPill" id="drawerIndex" type="button">Index</button>
          <button class="btnPill" id="drawerReload" type="button">Reload</button>
          <button class="btnPill primary" id="drawerLogout" type="button">Logout</button>
        </div>
      </div>

      
      <div class="drawerCard" id="notifCard">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div style="font-weight:1000">NotificƒÉri</div>
          <button class="btnPill" id="btnNotifMarkAll" type="button" style="padding:8px 10px;border-radius:12px">MarcheazƒÉ citite</button>
        </div>
        <div id="notifList" style="margin-top:10px"></div>
        <div class="note" id="notifEmpty" style="margin-top:10px;display:none">Nu ai notificƒÉri.</div>
      </div>

      <div class="note" style="margin-top:12px">
        DacƒÉ vrei, pot adƒÉuga aici: istoricul de azi, pauze, overtime, alertƒÉri.
      </div>
    </div>
  </div>


<!-- Avatar crop modal -->
<div class="modalOv" id="avOv" style="display:none">
  <div class="modalBox">
    <div class="modalHead">
      <div>
        <div class="mhTitle">DecupeazƒÉ avatar</div>
        <div class="note">Trage imaginea cu mouse-ul. AjusteazƒÉ zoom-ul. Se salveazƒÉ pƒÉtrat 256√ó256.</div>
      </div>
      <button class="iconBtn" id="avClose" type="button">‚úï</button>
    </div>
    <div class="modalBody">
      <canvas id="avCanvas" width="320" height="320"></canvas>
      <div class="cropRow">
        <div class="note" style="min-width:44px">Zoom</div>
        <input id="avZoom" type="range" min="1" max="3" step="0.01" value="1" />
        <button class="btnPill" id="avReset" type="button">Reset</button>
      </div>
    </div>
    <div class="modalFoot">
      <button class="btnPill" id="avCancel" type="button">AnuleazƒÉ</button>
      <button class="btnPill primary" id="avUse" type="button">Folose»ôte</button>
    </div>
  </div>
</div>

<script>
/* ===== Employee dashboard menu + profile ===== */
(function(){
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  function initials(name){
    const parts = String(name||"").trim().split(/\s+/).filter(Boolean);
    const a = parts[0]?.[0]||"";
    const b = parts[1]?.[0]||"";
    return (a+b).toUpperCase() || "‚Ä¢";
  }

  function setPage(view){
    const map = {
      calendar: { title:"Calendar prezen»õƒÉ", crumb:"Dashboard / Calendar" },
      requests: { title:"Cereri", crumb:"Dashboard / Cereri" },
      docs: { title:"Documente", crumb:"Dashboard / Documente" },
      settings: { title:"SetƒÉri", crumb:"Dashboard / SetƒÉri" },
    };
    const meta = map[view] || map.calendar;
    $("#pageTitle").textContent = meta.title;
    $("#pageCrumb").textContent = meta.crumb;

    $$(".view").forEach(v=>v.classList.remove("active"));
    const el = $("#view-"+view);
    if (el) el.classList.add("active");

    $$(".navBtn").forEach(b=>b.classList.toggle("active", b.getAttribute("data-view")===view));
  }

  async function loadProfile(){
    try{
      const s = (typeof getEmpSession === "function") ? getEmpSession() : null;
      const endpoint = (typeof ep === "function") ? ep() : "";
      if (!s || !s.token || !endpoint) return;

      const url = endpoint + "?fn=meProfile&token=" + encodeURIComponent(s.token) + "&ts=" + Date.now();
      const res = await jsonp(url);
      if (!res || !res.ok) return;

      const name = res.name || s.name || "‚Äî";
      const dept = res.dept || "";
      const mgr = res.managerName || res.managerEmail || "";

      let avatarUrl = (res && res.avatarUrl) ? String(res.avatarUrl) : "";
      try{
        if (!avatarUrl && window.CFG && window.CFG.employeeAvatars && window.CFG.employeeAvatars[name]) avatarUrl = String(window.CFG.employeeAvatars[name]);
      }catch(e){}

      $("#topName").textContent = name;
      $("#topMgr").textContent = "Manager: " + (mgr || "‚Äî");

      if (avatarUrl){
        $("#topAvatarImg").src = avatarUrl;
        $("#topAvatarImg").style.display = "";
        $("#topAvatar").style.display = "none";
      } else {
        $("#topAvatar").textContent = initials(name);
        $("#topAvatar").style.display = "";
        $("#topAvatarImg").style.display = "none";
      }

      $("#setName").textContent = name;
      $("#setDept").textContent = dept || "‚Äî";
      $("#setMgr").textContent = mgr || "‚Äî";

      $("#drawerName").textContent = name;
      $("#drawerDept").textContent = dept || "‚Äî";
      $("#drawerMgr").textContent = mgr || "‚Äî";
      $("#drawerSub").textContent = dept ? ("Departament: " + dept) : "‚Äî";
      $("#drawerSess").textContent = "ActivƒÉ";

      if (avatarUrl){
        $("#drawerAvatarImg").src = avatarUrl;
        $("#drawerAvatarImg").style.display = "";
        $("#drawerAvatar").style.display = "none";
      } else {
        $("#drawerAvatar").textContent = initials(name);
        $("#drawerAvatar").style.display = "";
        $("#drawerAvatarImg").style.display = "none";
      try{ setAvatarEverywhere(avatarUrl, name); }catch(e){}
      }
    }catch(e){
      console.warn("meProfile failed", e);
    }
  }

  function openDrawer(){ $("#drawerWrap").classList.add("show"); }
  function closeDrawer(){ $("#drawerWrap").classList.remove("show"); }
  function logout(){
    try{
      localStorage.removeItem("pontaj_me_token");
      localStorage.removeItem("pontaj_me_name");
    }catch(e){}
    window.location.href = "index.html";
  }
  // ========= Avatar Settings (drag&drop + crop + resize + GitHub upload via JSONP) =========
  let __avatarDataUrl = "";
  let __crop = { img:null, zoom:1, offX:0, offY:0, drag:false, lastX:0, lastY:0 };

  function showAvatarStatus(msg, isErr){
    const el = $("#avatarStatus");
    if (!el) return;
    el.textContent = msg || "‚Äî";
    el.style.color = isErr ? "rgba(200,60,60,.95)" : "rgba(60,70,95,.95)";
    el.style.fontWeight = isErr ? "900" : "800";
  }

  function setAvatarEverywhere(url, name){
    const ini = initials(name || $("#topName")?.textContent || "");
    if (url){
      $("#topAvatarImg").src = url;
      $("#topAvatarImg").style.display = "";
      $("#topAvatar").style.display = "none";

      $("#drawerAvatarImg").src = url;
      $("#drawerAvatarImg").style.display = "";
      $("#drawerAvatar").style.display = "none";

      const si = $("#setAvatarImg"), st = $("#setAvatarInitial");
      if (si){ si.src = url; si.style.display = ""; }
      if (st){ st.style.display = "none"; st.textContent = ini || "‚Äî"; }
    } else {
      $("#topAvatar").textContent = ini;
      $("#topAvatar").style.display = "";
      $("#topAvatarImg").style.display = "none";

      $("#drawerAvatar").textContent = ini;
      $("#drawerAvatar").style.display = "";
      $("#drawerAvatarImg").style.display = "none";

      const si = $("#setAvatarImg"), st = $("#setAvatarInitial");
      if (si){ si.style.display = "none"; si.src = ""; }
      if (st){ st.textContent = ini || "‚Äî"; st.style.display = ""; }
    }
  }

  function openCropModal(img){
    __crop.img = img;
    __crop.zoom = 1;
    __crop.offX = 0;
    __crop.offY = 0;
    const z = $("#avZoom"); if (z) z.value = "1";
    drawCrop();
    const ov = $("#avOv");
    if (ov){ ov.style.display = "grid"; ov.classList.add("show"); }
  }

  function closeCropModal(){
    const ov = $("#avOv");
    if (ov){ ov.style.display = "none"; ov.classList.remove("show"); }
  }

  function drawCrop(){
    const c = $("#avCanvas");
    if (!c || !__crop.img) return;
    const ctx = c.getContext("2d");
    const S = c.width;
    ctx.clearRect(0,0,S,S);
    ctx.fillStyle = "#f7f8ff";
    ctx.fillRect(0,0,S,S);

    const img = __crop.img;
    const base = Math.max(S/img.width, S/img.height);
    const scale = base * __crop.zoom;

    const w = img.width * scale;
    const h = img.height * scale;
    const x = (S - w)/2 + __crop.offX;
    const y = (S - h)/2 + __crop.offY;

    ctx.drawImage(img, x, y, w, h);
    ctx.strokeStyle = "rgba(0,0,0,.10)";
    ctx.lineWidth = 2;
    ctx.strokeRect(1,1,S-2,S-2);
  }

  function exportCroppedPng(){
    const img = __crop.img;
    if (!img) return "";
    const out = document.createElement("canvas");
    out.width = 256;
    out.height = 256;
    const ctx = out.getContext("2d");
    const S = out.width;

    const base = Math.max(S/img.width, S/img.height);
    const scale = base * __crop.zoom;

    const w = img.width * scale;
    const h = img.height * scale;
    const preview = 320;
    const k = S / preview;

    const x = (S - w)/2 + (__crop.offX * k);
    const y = (S - h)/2 + (__crop.offY * k);

    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,S,S);
    ctx.drawImage(img, x, y, w, h);
    return out.toDataURL("image/png");
  }

  function loadImageFromFile(file){
    return new Promise((resolve, reject)=>{
      const fr = new FileReader();
      fr.onerror = ()=>reject(new Error("Nu pot citi fi»ôierul."));
      fr.onload = ()=>{
        const img = new Image();
        img.onload = ()=>resolve(img);
        img.onerror = ()=>reject(new Error("Imagine invalidƒÉ."));
        img.src = String(fr.result || "");
      };
      fr.readAsDataURL(file);
    });
  }

  async function uploadAvatarDataUrl(dataUrl){
    const s = (typeof getEmpSession === "function") ? getEmpSession() : null;
    const endpoint = (typeof ep === "function") ? ep() : "";
    if (!s || !s.token || !endpoint) throw new Error("Nu e»ôti logat sau lipse»ôte endpoint.");

    const token = String(s.token);
    const m = String(dataUrl||"").match(/^data:([^;]+);base64,(.+)$/);
    if (!m) throw new Error("DataURL invalid.");
    const mime = m[1];
    const b64 = m[2];
    // Use base64url (URL-safe) and remove padding to keep JSONP URLs short
    const b64u = b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');

    const uploadId = "av_" + Math.random().toString(16).slice(2) + "_" + Date.now();
    // Keep each JSONP URL comfortably under common limits (~2KB). Compute a safe chunk size dynamically.
    const MAX_URL = 1600;
    const overhead0 = (endpoint + "?fn=meAvatarUploadChunk&token=" + token
      + "&uploadId=" + encodeURIComponent(uploadId)
      + "&i=0&n=999&mime=" + encodeURIComponent(mime)
      + "&c=&ts=" + Date.now()).length;
    const chunkSize = Math.max(400, MAX_URL - overhead0);
    const total = Math.ceil(b64u.length / chunkSize);

    for (let i=0;i<total;i++){
      const part = b64u.slice(i*chunkSize, (i+1)*chunkSize);
      const url = endpoint + "?fn=meAvatarUploadChunk"
        + "&token=" + token
        + "&uploadId=" + encodeURIComponent(uploadId)
        + "&i=" + i
        + "&n=" + total
        + (i===0 ? ("&mime=" + encodeURIComponent(mime)) : "")
        + "&c=" + part
        + "&ts=" + Date.now();
const r = await jsonp(url);
      if (!r || !r.ok) throw new Error(r?.error || ("Eroare chunk #" + i));
      showAvatarStatus("Upload: " + (i+1) + "/" + total, false);
    }

    const finUrl = endpoint + "?fn=meAvatarUploadFinalize"
      + "&token=" + token
      + "&uploadId=" + encodeURIComponent(uploadId)
      + "&total=" + total
      + "&mime=" + encodeURIComponent(mime)
      + "&ts=" + Date.now();

    const fin = await jsonp(finUrl);
    if (!fin || !fin.ok) throw new Error(fin?.error || "Finalize error");
    return String(fin.avatarUrl||"");
  }

  async function bindAvatarSettings(){
    const choose = $("#btnAvatarChoose");
    const save = $("#btnAvatarSave");
    const clear = $("#btnAvatarClear");
    const file = $("#avatarFile");
    const drop = $("#avatarDrop");

    if (choose && file){
      choose.addEventListener("click", ()=>file.click());
    }
    if (file){
      file.addEventListener("change", async ()=>{
        if (!file.files || !file.files[0]) return;
        try{
          showAvatarStatus("Se √ÆncarcƒÉ imaginea‚Ä¶", false);
          const img = await loadImageFromFile(file.files[0]);
          openCropModal(img);
        }catch(err){
          showAvatarStatus(String(err && err.message ? err.message : err), true);
        }finally{
          file.value = "";
        }
      });
    }

    if (drop){
      const prevent = (ev)=>{ ev.preventDefault(); ev.stopPropagation(); };
      ["dragenter","dragover","dragleave","drop"].forEach(evt=>drop.addEventListener(evt, prevent, false));
      drop.addEventListener("dragenter", ()=>drop.classList.add("drag"));
      drop.addEventListener("dragleave", ()=>drop.classList.remove("drag"));
      drop.addEventListener("drop", async (ev)=>{
        drop.classList.remove("drag");
        const f = ev.dataTransfer && ev.dataTransfer.files ? ev.dataTransfer.files[0] : null;
        if (!f) return;
        try{
          showAvatarStatus("Se √ÆncarcƒÉ imaginea‚Ä¶", false);
          const img = await loadImageFromFile(f);
          openCropModal(img);
        }catch(err){
          showAvatarStatus(String(err && err.message ? err.message : err), true);
        }
      });
      drop.addEventListener("click", ()=> file && file.click());
    }

    $("#avClose")?.addEventListener("click", closeCropModal);
    $("#avCancel")?.addEventListener("click", closeCropModal);
    $("#avReset")?.addEventListener("click", ()=>{ __crop.zoom=1; __crop.offX=0; __crop.offY=0; const z=$("#avZoom"); if(z) z.value="1"; drawCrop(); });
    $("#avZoom")?.addEventListener("input", (ev)=>{ __crop.zoom = parseFloat(ev.target.value || "1"); drawCrop(); });

    const canvas = $("#avCanvas");
    if (canvas){
      canvas.addEventListener("pointerdown", (ev)=>{
        __crop.drag = true;
        __crop.lastX = ev.clientX;
        __crop.lastY = ev.clientY;
        canvas.setPointerCapture(ev.pointerId);
      });
      canvas.addEventListener("pointermove", (ev)=>{
        if (!__crop.drag) return;
        const dx = ev.clientX - __crop.lastX;
        const dy = ev.clientY - __crop.lastY;
        __crop.lastX = ev.clientX;
        __crop.lastY = ev.clientY;
        __crop.offX += dx;
        __crop.offY += dy;
        drawCrop();
      });
      canvas.addEventListener("pointerup", ()=>{ __crop.drag=false; });
      canvas.addEventListener("pointercancel", ()=>{ __crop.drag=false; });
    }

    $("#avUse")?.addEventListener("click", ()=>{
      __avatarDataUrl = exportCroppedPng();
      closeCropModal();
      if (save) save.disabled = !__avatarDataUrl;
      showAvatarStatus(__avatarDataUrl ? "Avatar pregƒÉtit. ApasƒÉ ‚ÄûSalveazƒÉ‚Äù." : "‚Äî", false);
    });

    if (save){
      save.addEventListener("click", async ()=>{
        try{
          if (!__avatarDataUrl) return;
          save.disabled = true;
          showAvatarStatus("Se urcƒÉ avatarul‚Ä¶", false);
          const url = await uploadAvatarDataUrl(__avatarDataUrl);
          const ses = (typeof getEmpSession === "function") ? getEmpSession() : null;
          setAvatarEverywhere(url, ses ? ses.name : "");
          showAvatarStatus("Salvat ‚úî", false);
          __avatarDataUrl = "";
        }catch(err){
          showAvatarStatus(String(err && err.message ? err.message : err), true);
        }finally{
          if (save) save.disabled = !__avatarDataUrl;
        }
      });
    }

    if (clear){
      clear.addEventListener("click", async ()=>{
        try{
          const s = (typeof getEmpSession === "function") ? getEmpSession() : null;
          const endpoint = (typeof ep === "function") ? ep() : "";
          if (!s || !s.token || !endpoint) throw new Error("Nu e»ôti logat.");
          showAvatarStatus("Se »ôterge‚Ä¶", false);
          const url = endpoint + "?fn=meAvatarClear&token=" + encodeURIComponent(s.token) + "&ts=" + Date.now();
          const r = await jsonp(url);
          if (!r || !r.ok) throw new Error(r?.error || "Eroare la »ôtergere.");
          setAvatarEverywhere("", s.name);
          showAvatarStatus("Avatar »ôters.", false);
        }catch(err){
          showAvatarStatus(String(err && err.message ? err.message : err), true);
        }
      });
    }
  }


  function bind(){
    $$(".navBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const v = btn.getAttribute("data-view");
        setPage(v);
        try{ window.__onViewChange__ && window.__onViewChange__(v); }catch(e){}
      });
    });

    $("#btnUserPanel")?.addEventListener("click", openDrawer);
    $("#drawerClose")?.addEventListener("click", closeDrawer);
    $("#drawerWrap")?.addEventListener("click", (ev)=>{ if (ev.target === $("#drawerWrap")) closeDrawer(); });

    $("#drawerIndex")?.addEventListener("click", ()=>window.open("index.html","_blank"));
    $("#drawerReload")?.addEventListener("click", ()=>window.location.reload());
    $("#drawerLogout")?.addEventListener("click", logout);

    $("#btnOpenIndex")?.addEventListener("click", ()=>window.open("index.html","_blank"));
    $("#btnRefreshAll")?.addEventListener("click", ()=>window.location.reload());
    $("#btnLogout")?.addEventListener("click", logout);
    try{ bindAvatarSettings(); }catch(e){}
// menu collapse (ca √Æn admin)
    const shell = document.querySelector('.shell');
    const btn = document.getElementById('menuCollapse');
    if (btn && shell){
      // restore state
      try{
        const v = localStorage.getItem('pontaj_emp_menu_collapsed');
        if (v === '1') shell.classList.add('collapsed');
      }catch(e){}
      btn.addEventListener('click', ()=>{
        shell.classList.toggle('collapsed');
        try{
          localStorage.setItem('pontaj_emp_menu_collapsed', shell.classList.contains('collapsed') ? '1' : '0');
        }catch(e){}
      });
    }
}

  window.addEventListener("load", ()=>{
    bind();
    try{ if (typeof bindRequestsUI === 'function') bindRequestsUI(); }catch(e){}
    setPage("calendar");
    let tries = 0;
    const t = setInterval(async ()=>{
      tries++;
      await loadProfile();
      const ok = $("#topName").textContent && $("#topName").textContent !== "‚Äî";
      if (ok || tries >= 8) clearInterval(t);
    }, 350);
  });
})();


  // allow calendar click to jump into Cereri
  window.__jumpToRequests__ = (dk)=>{ setPage('requests'); try{ if(document.getElementById('reqMonth')){ const ym = String(dk||'').slice(0,7); document.getElementById('reqMonth').value = ym; } }catch(e){}; try{ window.__onViewChange__ && window.__onViewChange__('requests'); }catch(e){} };
</script>

</body>

</html>
