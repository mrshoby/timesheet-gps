<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard — Calendar prezență</title>
  <style>
    :root{
      --bg:#f5f6ff;
      --card:#ffffff;
      --ink:#1f2330;
      --muted:#6f7890;
      --line:#e7e9f6;
      --accent:#6d5efc;
      --shadow:0 10px 30px rgba(20,18,40,.08);

      --c-inactive:#f1f3f9;
      --c-under:#ffe9c7;
      --c-complete:#dff7e4;
      --c-over:#d9ecff;
      --c-leave:#efe6ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1440px;margin:18px auto;padding:0 14px}
    .panel{background:var(--card); border:1px solid var(--line); border-radius:22px; box-shadow:var(--shadow); overflow:hidden;}
    .panelHead{padding:14px 16px; border-bottom:1px solid var(--line); display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .panelHead h2{margin:0;font-size:16px}
    .note{font-size:12px;color:var(--muted);font-weight:750}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{border:1px solid var(--line); background:#fff; color:var(--ink); padding:10px 12px; border-radius:14px; font-weight:850; cursor:pointer;}
    .btn:active{transform:translateY(1px)}
    .select{border:1px solid var(--line); background:#fff; padding:10px 12px;border-radius:14px; font-weight:800; outline:none;}

    .tableWrap{overflow:auto; max-height: calc(100vh - 210px);}
    table{border-collapse:separate;border-spacing:0; width:max(1100px, 100%); font-size:13px}
    thead th{
      position:sticky; top:0; z-index:5;
      background:#fff; border-bottom:1px solid var(--line);
      padding:10px 10px; text-align:center; color:var(--muted); font-weight:900; font-size:12px;
      white-space:nowrap;
    }
    thead th.stickyL{ left:0; z-index:7; text-align:left; box-shadow: 6px 0 0 rgba(0,0,0,0.02); }
    thead th.thEmp{min-width:260px}
    thead .wd{font-weight:900;color:rgba(110,120,145,.9)}
    tbody td{border-bottom:1px solid var(--line); background:#fff; padding:8px 8px; text-align:center;}
    tbody td.stickyL{position:sticky; left:0; z-index:6; text-align:left; box-shadow: 6px 0 0 rgba(0,0,0,0.02);}
    tbody tr:hover td{background:rgba(245,246,255,.55)}
    tbody tr:hover td.stickyL{background:#fff}

    .empCell{display:flex;align-items:center;gap:10px}
    .empPhoto{width:38px;height:38px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 10px 18px rgba(20,18,40,.10)}
    .empAvatar{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;
      background:#f0f2ff;border:2px solid #fff;box-shadow:0 10px 18px rgba(20,18,40,.10);font-weight:1000;color:#3a3f5b}
    .empName{font-weight:1000}
    .empDept{font-size:12px;color:rgba(110,120,145,.95);font-weight:800;margin-top:1px}
    .empMeta{display:flex;flex-direction:column;line-height:1.05}

    .thDay.weekCut, td.dayCell.weekCut{border-left:4px solid rgba(120,125,170,.15)}
    .dayBox{
      height:62px; border-radius:14px; border:1px solid rgba(0,0,0,.04);
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.55);
      gap:2px;
    }
    .dayBox .t{font-size:11px;font-weight:850;color:rgba(45,50,70,.95);line-height:1}
    .dayBox .t.muted{color:rgba(120,125,150,.55);font-weight:800}
    .dayBox .dur{margin-top:2px;font-size:12px;font-weight:1000;color:rgba(45,50,70,.98)}
    .dayBox .dur.muted{color:rgba(120,125,150,.45);font-weight:900}
    .dayBox .code{font-size:14px;font-weight:1100;color:#2f245c}

    .st-inactive{background:var(--c-inactive)}
    .st-under{background:var(--c-under)}
    .st-complete{background:var(--c-complete)}
    .st-over{background:var(--c-over)}
    .st-inprogress{background:rgba(109,94,252,.14)}
    .st-paused{background:rgba(255,77,77,.12)}
    .st-leave{background:var(--c-leave)}
    .weekend{opacity:.92}

    .legend{padding:14px 16px;border-top:1px solid var(--line);display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .dot{width:10px;height:10px;border-radius:99px;display:inline-block;margin-right:6px;vertical-align:middle}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:900;font-size:12px}

    .centerMsg{
      padding:26px 16px; text-align:center; color:rgba(80,90,120,.80); font-weight:900;
    }
    a{color:var(--accent);text-decoration:none;font-weight:900}
    a:hover{text-decoration:underline}

    @media (max-width:720px){
      thead th.thEmp{min-width:210px}
      .dayBox{height:58px;border-radius:12px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="panelHead">
        <div>
          <h2>Calendar prezență</h2>
          <div class="note" id="sub">—</div>
        </div>
        <div class="controls">
          <button class="btn" id="prev" type="button">‹</button>
          <select id="monthSel" class="select"></select>
          <button class="btn" id="next" type="button">›</button>
        </div>
      </div>

      <div class="tableWrap">
        <table id="cal">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="legend">
        <div style="width:100%;padding:2px 0 6px;color:#574bb8;font-weight:950">
          Condiția de prezență nu conține timp activ (pontaje neîncheiate)
        </div>

        <div style="width:100%;display:flex;gap:14px;flex-wrap:wrap;align-items:center">
          <div><b>CO</b> - Concediu de odihnă</div>
          <div><b>BO</b> - Concediu medical</div>
          <div><b>CCC</b> - Concediu pentru creșterea copilului</div>
          <div><b>CFP</b> - Concediu fără plată</div>
          <div><b>EV</b> - Eveniment</div>
        </div>

        <div style="width:100%;display:flex;gap:14px;flex-wrap:wrap;align-items:center">
          <span class="pill"><span class="dot" style="background:rgba(109,94,252,.55)"></span>În progres</span>
          <span class="pill"><span class="dot" style="background:rgba(255,77,77,.55)"></span>În pauză</span>
          <span class="pill"><span class="dot" style="background:var(--c-under)"></span>Sub normă</span>
          <span class="pill"><span class="dot" style="background:var(--c-complete)"></span>Complet</span>
          <span class="pill"><span class="dot" style="background:var(--c-over)"></span>Peste normă</span>
          <span class="pill"><span class="dot" style="background:var(--c-inactive)"></span>Inactiv/absent</span>
          <span class="pill"><span class="dot" style="background:var(--c-leave)"></span>Concediu</span>
        </div>
      </div>
    </div>
  </div>

<script>
  // ========= Helpers =========
  const $ = (s, r=document)=>r.querySelector(s);
  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }
  function initials(name){
    const p = String(name||"").trim().split(/\s+/).filter(Boolean);
    const a = p[0]?.[0]||"";
    const b = p[1]?.[0]||"";
    return (a+b).toUpperCase() || "•";
  }
  function parseIso(iso){
    if (!iso) return null;
    const d = new Date(String(iso).replace(" ", "T"));
    return isNaN(d) ? null : d;
  }
  function dayKey(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }
  function getWeekdayShort(dateStr){
    const d = new Date(dateStr+"T00:00:00");
    return ["Du","Lu","Ma","Mi","Jo","Vi","Sâ"][d.getDay()];
  }
  function hm(d){
    return String(d.getHours()).padStart(2,'0') + ":" + String(d.getMinutes()).padStart(2,'0');
  }
  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

  function jsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(16).slice(2);
      const s = document.createElement("script");
      let done = false;

      window[cb] = (data)=>{ done = true; cleanup(); resolve(data); };
      function cleanup(){
        try{ delete window[cb]; }catch(e){ window[cb] = undefined; }
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }
      s.onerror = ()=>{ if (done) return; cleanup(); reject(new Error("JSONP error")); };
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
      document.head.appendChild(s);
    });
  }

  // ========= Config + Session =========
  const EMP_TOKEN_KEY = "pontaj_me_token";
  const EMP_NAME_KEY  = "pontaj_me_name";
  let CFG = null;

  async function loadConfig(){
    const tries = ["config.json","./config.json","../config.json","/config.json"];
    for (const p of tries){
      try{
        const r = await fetch(p+"?v="+Date.now(), {cache:"no-store"});
        if (!r.ok) continue;
        CFG = await r.json();
        return;
      }catch(e){}
    }
    throw new Error("Nu pot încărca config.json.");
  }
  function ep(){ return CFG?.stateEndpoint || CFG?.adminEventsEndpoint || ""; }

  function getEmpSession(){
    try{
      const token = localStorage.getItem(EMP_TOKEN_KEY) || "";
      const name  = localStorage.getItem(EMP_NAME_KEY) || "";
      return (token && name) ? { token, name } : null;
    }catch(e){ return null; }
  }

  // ========= Norms =========
  function getNormMinutesFor(name, dept){
    let normH = 8;
    const ns = CFG?.norms;
    if (ns?.defaultHours != null) normH = ns.defaultHours;
    if (ns?.departments && dept){
      const key = Object.keys(ns.departments).find(k => k.toLowerCase() === String(dept).toLowerCase());
      if (key && ns.departments[key]?.normHours != null) normH = ns.departments[key].normHours;
    }
    if (ns?.employees && name && ns.employees[name]?.normHours != null) normH = ns.employees[name].normHours;
    return Math.round(Number(normH)*60);
  }

  function computeDaySummary(events, normMin){
    const leaveCodes = ["CO","CM","BO","CCC","CFP","EV"];
    const rows = (events||[])
      .map(e=>({
        t: new Date(e.ts),
        action: String(e.action||"").toUpperCase().replace(/_/g," "),
        notes: e.notes||""
      }))
      .filter(x=>!isNaN(x.t))
      .sort((a,b)=>a.t-b.t);

    // leave detect
    let leaveCode = "";
    for (const r of rows){
      if (leaveCodes.includes(r.action)) { leaveCode = r.action; break; }
      const m = String(r.notes||"").match(/\b(CO|CM|BO|CCC|CFP|EV)\b/i);
      if (r.action === "LEAVE" && m) { leaveCode = m[1].toUpperCase(); break; }
    }
    if (leaveCode){
      return { workMin:0, pauseMin:0, status:"leave", startHm:"", endHm:"", label:leaveCode, sub:"", running:false, paused:false, leaveCode };
    }

    const starts = rows.filter(r=>r.action==="START" || r.action==="EXTRA START");
    const finishes = rows.filter(r=>r.action==="FINISH" || r.action==="EXTRA FINISH");
    const firstStart = starts.length ? starts[0].t : null;
    const lastFinish = finishes.length ? finishes[finishes.length-1].t : null;

    // work/pause timeline
    let running = false, paused = false;
    let tRunStart = null, tPauseStart = null;
    let workMs = 0, pauseMs = 0;

    for (const r of rows){
      if (r.action === "START" || r.action === "EXTRA START"){
        if (!running){ running = true; paused = false; tRunStart = r.t; tPauseStart = null; }
      }
      else if (r.action === "PAUSE"){
        if (running && !paused){ paused = true; tPauseStart = r.t; if (tRunStart){ workMs += (r.t - tRunStart); tRunStart = null; } }
      }
      else if (r.action === "UNPAUSE"){
        if (running && paused){ paused = false; if (tPauseStart){ pauseMs += (r.t - tPauseStart); tPauseStart = null; } tRunStart = r.t; }
      }
      else if (r.action === "FINISH" || r.action === "EXTRA FINISH"){
        if (paused && tPauseStart){ pauseMs += (r.t - tPauseStart); tPauseStart = null; }
        if (running && tRunStart){ workMs += (r.t - tRunStart); tRunStart = null; }
        running = false; paused = false;
      }
    }

    // if still running/paused, we don't count open segments as "work" in calendar condition
    const workMin = Math.round(workMs/60000);
    const pauseMin = Math.round(pauseMs/60000);

    const startHm = firstStart ? hm(firstStart) : "";
    const endHm   = lastFinish ? hm(lastFinish) : "";

    let status = "inactive";
    let label = "";
    let sub = "";

    if (firstStart && !lastFinish){
      status = paused ? "paused" : "inprogress";
      label = ""; sub = "";
    } else if (firstStart && lastFinish){
      const diff = clamp(workMin, 0, 24*60);
      label = (diff>=60) ? (Math.floor(diff/60).toString().padStart(2,"0")+":"+String(diff%60).padStart(2,"0")) : ("00:"+String(diff).padStart(2,"0"));
      if (diff < normMin) status = "under";
      else if (diff === normMin) status = "complete";
      else status = "over";
      if (pauseMin>0){
        const pm = clamp(pauseMin,0,24*60);
        sub = "Pauză " + (pm>=60 ? (Math.floor(pm/60)+"h "+(pm%60)+"m") : (pm+"m"));
      }
    } else {
      status = "inactive";
    }

    return { workMin, pauseMin, status, startHm, endHm, label, sub, running, paused, leaveCode:"" };
  }

  function buildMonthOptions(curYm){
    const sel = $("#monthSel");
    sel.innerHTML = "";
    const [cy, cm] = curYm.split("-").map(x=>parseInt(x,10));
    const base = new Date(cy, cm-1, 1);
    for (let i=-12; i<=1; i++){
      const d = new Date(base.getFullYear(), base.getMonth()+i, 1);
      const ym = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,'0');
      const opt = document.createElement("option");
      opt.value = ym;
      opt.textContent = d.toLocaleDateString("ro-RO",{month:"long", year:"numeric"});
      if (ym===curYm) opt.selected = true;
      sel.appendChild(opt);
    }
  }

  function renderCalendar({ym, name, dept, days, daysInMonth}){
    $("#sub").textContent = `${name}${dept ? " • " + dept : ""} • ${new Date(ym+"-01T00:00:00").toLocaleDateString("ro-RO",{month:"long", year:"numeric"})}`;

    const thead = $("#thead");
    thead.innerHTML = `<tr>
      <th class="stickyL thEmp">ANGAJAT</th>
      ${Array.from({length:daysInMonth}, (_,i)=>{
        const dk = `${ym}-${String(i+1).padStart(2,'0')}`;
        const wd = getWeekdayShort(dk);
        const dow = new Date(dk+"T00:00:00").getDay();
        const cut = (dow===1) ? " weekCut" : "";
        return `<th class="thDay${cut}" title="${dk}">${String(i+1).padStart(2,'0')}<br><span class="wd">${wd}</span></th>`;
      }).join("")}
    </tr>`;

    const tbody = $("#tbody");
    const avatarUrl = (CFG && CFG.employeeAvatars && CFG.employeeAvatars[name]) ? String(CFG.employeeAvatars[name]) : "";
    const avatarHtml = avatarUrl
      ? `<img class="empPhoto" src="${escapeHtml(avatarUrl)}" alt="">`
      : `<div class="empAvatar">${escapeHtml(initials(name))}</div>`;
    const deptLine = dept ? `<div class="empDept">${escapeHtml(dept)}</div>` : ``;

    const cells = days.map(d=>{
      const dateObj = new Date(d.dk + "T00:00:00");
      const dow = dateObj.getDay();
      const weekend = (dow === 0 || dow === 6) ? " weekend" : "";
      const weekCut = (dow === 1) ? " weekCut" : "";

      let inner = "";
      if (d.leaveCode){
        inner = `<div class="code">${escapeHtml(d.leaveCode)}</div>`;
      } else {
        const top = d.startHm ? `<div class="t">${escapeHtml(d.startHm)}</div>` : `<div class="t muted">—</div>`;
        const mid = d.endHm ? `<div class="t">${escapeHtml(d.endHm)}</div>` : `<div class="t muted"> </div>`;
        const bottom = d.label ? `<div class="dur">${escapeHtml(d.label)}</div>` : `<div class="dur muted"> </div>`;
        inner = `${top}${mid}${bottom}`;
      }

      return `<td class="dayCell${weekCut}">
        <div class="dayBox st-${d.status}${weekend}" title="${escapeHtml(d.dk)}">
          ${inner}
        </div>
      </td>`;
    }).join("");

    tbody.innerHTML = `<tr>
      <td class="stickyL">
        <div class="empCell">
          ${avatarHtml}
          <div class="empMeta">
            <div class="empName">${escapeHtml(name)}</div>
            ${deptLine}
          </div>
        </div>
      </td>
      ${cells}
    </tr>`;
  }

  function showCenterMessage(html){
    $("#thead").innerHTML = "";
    $("#tbody").innerHTML = `<tr><td class="centerMsg">${html}</td></tr>`;
  }

  // ========= Data =========
  async function loadMonth(ym){
    const s = getEmpSession();
    if (!s){
      showCenterMessage(`Nu ești logat. Intră în <a href="index.html">index.html</a> și apasă „Deschide dashboard”.`);
      $("#sub").textContent = "Neautentificat";
      return;
    }
    const endpoint = ep();
    if (!endpoint){
      showCenterMessage("Lipsește endpoint în config.json (stateEndpoint sau adminEventsEndpoint).");
      return;
    }
    showCenterMessage("Se încarcă…");

    const url = endpoint + "?fn=mePresenceMonth"
      + "&ym=" + encodeURIComponent(ym)
      + "&token=" + encodeURIComponent(s.token)
      + "&ts=" + Date.now();

    const res = await jsonp(url);
    if (!res || !res.ok){
      const msg = res?.error || "Nu pot încărca datele.";
      showCenterMessage(escapeHtml(msg) + ` <div class="muted" style="margin-top:10px">Dacă sesiunea a expirat, re-loghează-te din <a href="index.html">index.html</a>.</div>`);
      return;
    }

    const name = res.name || s.name;
    const dept = res.dept || "";
    const events = Array.isArray(res.events) ? res.events : [];

    // Build per-day summaries
    const [y, m] = ym.split("-").map(n=>parseInt(n,10));
    const first = new Date(y, m-1, 1);
    const next = new Date(y, m, 1);
    const daysInMonth = Math.round((next-first)/86400000);

    const byDay = new Map();
    for (const e of events){
      const d = parseIso(e.ts);
      if (!d) continue;
      const dk = dayKey(d);
      if (!byDay.has(dk)) byDay.set(dk, []);
      byDay.get(dk).push(e);
    }

    const normMin = getNormMinutesFor(name, dept);
    const days = [];
    for (let i=1;i<=daysInMonth;i++){
      const dk = `${ym}-${String(i).padStart(2,'0')}`;
      const evs = byDay.get(dk) || [];
      const s = computeDaySummary(evs, normMin);
      days.push({ dk, ...s });
    }

    renderCalendar({ ym, name, dept, days, daysInMonth });
  }

  // ========= Init =========
  (async () => {
    const now = new Date();
    let YM = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0");

    try{
      await loadConfig();
    }catch(e){
      showCenterMessage("Nu pot încărca config.json.");
      $("#sub").textContent = "Eroare config";
      console.error(e);
      return;
    }

    buildMonthOptions(YM);
    $("#monthSel").addEventListener("change", ()=>{ YM = $("#monthSel").value; loadMonth(YM); });
    $("#prev").addEventListener("click", ()=>{
      const [y,m] = YM.split("-").map(n=>parseInt(n,10));
      const d = new Date(y, m-2, 1);
      YM = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0");
      buildMonthOptions(YM);
      loadMonth(YM);
    });
    $("#next").addEventListener("click", ()=>{
      const [y,m] = YM.split("-").map(n=>parseInt(n,10));
      const d = new Date(y, m, 1);
      YM = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0");
      buildMonthOptions(YM);
      loadMonth(YM);
    });

    await loadMonth(YM);
  })();
</script>
</body>
</html>
