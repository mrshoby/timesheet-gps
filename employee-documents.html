<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Documente â€¢ Employee</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    :root{
      --bg:#F6F7FB;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --border:rgba(15,23,42,.08);
      --accent:#6D5EF1;
      --accent2:#8A7BFF;
      --shadow: 0 12px 40px rgba(15,23,42,.08);
      --shadow2: 0 10px 24px rgba(15,23,42,.10);
      --radius:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .page{padding:18px 20px;}
    .topTabs{display:flex;gap:22px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
    .tab{font-weight:700;color:rgba(15,23,42,.55);padding:8px 4px;border-bottom:3px solid transparent;cursor:pointer;user-select:none}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);}
    .grid{display:grid;grid-template-columns: 420px 1fr;gap:18px;}
    @media (max-width: 1100px){.grid{grid-template-columns:1fr;}}
    .left{padding:14px}
    .right{padding:14px}
    .searchRow{display:flex;gap:12px;align-items:center;margin:6px 0 14px}
    .search{flex:1;display:flex;gap:10px;align-items:center;background:#fff;border:1px solid var(--border);border-radius:18px;padding:12px 14px;}
    .search input{border:0;outline:0;width:100%;font-size:14px}
    .catList{display:flex;flex-direction:column;gap:12px}
    .cat{padding:16px 18px;border-radius:18px;border:1px solid rgba(15,23,42,.08);background:#fff;cursor:pointer}
    .cat:hover{background:rgba(109,94,241,.04)}
    .cat.active{background:var(--accent);border-color:rgba(109,94,241,.35);color:#fff}
    .cat .count{font-size:13px;font-weight:800;opacity:.7}
    .cat.active .count{opacity:.9}
    .cat .label{font-size:24px;font-weight:800;margin-top:2px;letter-spacing:-.02em}
    .actionsRow{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap}
    .rightTitle{font-size:18px;font-weight:800}
    .btn{border:1px solid rgba(15,23,42,.12);background:#fff;color:var(--text);border-radius:14px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:rgba(109,94,241,.35);color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .list{border:1px solid rgba(15,23,42,.08);border-radius:18px;overflow:hidden;background:#fff}
    .row{display:grid;grid-template-columns: 140px 1fr 140px;gap:10px;align-items:center;padding:14px 14px;border-bottom:1px solid rgba(15,23,42,.06)}
    .row:last-child{border-bottom:0}
    .date{font-weight:900;font-size:18px;color:#0b1220;display:flex;gap:10px;align-items:center}
    .docIcon{width:34px;height:34px;border-radius:12px;border:1px solid rgba(15,23,42,.10);display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.02)}
    .name{font-weight:900;font-size:18px;}
    .sub{color:rgba(15,23,42,.55);font-weight:700;margin-top:2px}
    .open{justify-self:end}
    .empty{padding:20px;color:rgba(15,23,42,.55);font-weight:700}
    .note{margin-top:12px;color:rgba(15,23,42,.55);font-weight:700}
    .err{margin:10px 0 0;color:#b91c1c;font-weight:800}

    /* modal */
    .modalBack{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
    .modalBack.show{display:flex}
    .modal{width:min(980px,96vw);max-height:92vh;overflow:auto;background:#fff;border-radius:22px;border:1px solid rgba(15,23,42,.12);box-shadow:0 30px 90px rgba(15,23,42,.25)}
    .modalHead{padding:16px 18px;border-bottom:1px solid rgba(15,23,42,.08);display:flex;gap:10px;align-items:center;justify-content:space-between;position:sticky;top:0;background:#fff;z-index:2}
    .modalHead .t{font-weight:900;font-size:16px}
    .modalBody{padding:16px 18px}
    .fields{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.fields{grid-template-columns:1fr}}
    .f{border:1px solid rgba(15,23,42,.10);border-radius:16px;padding:12px}
    .f label{display:block;font-weight:900;font-size:12px;color:rgba(15,23,42,.65);margin-bottom:8px}
    .f input,.f select, .f textarea{width:100%;border:1px solid rgba(15,23,42,.12);border-radius:12px;padding:10px 10px;font-family:inherit;font-weight:700}
    .f textarea{min-height:80px;resize:vertical}
    .modalFoot{padding:16px 18px;border-top:1px solid rgba(15,23,42,.08);display:flex;gap:10px;justify-content:flex-end;position:sticky;bottom:0;background:#fff}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid rgba(15,23,42,.12);border-radius:999px;font-weight:800;color:rgba(15,23,42,.65);background:rgba(15,23,42,.02)}
    .spin{width:16px;height:16px;border-radius:999px;border:2px solid rgba(15,23,42,.22);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="page">
    <div class="topTabs">
      <div class="tab active" data-tab="cereri">Documentele cereri</div>
      <div class="tab" data-tab="contractuale">Documente contractuale</div>
      <div class="tab" data-tab="adeverinte">AdeverinÈ›e</div>
      <div class="tab" data-tab="altele">Alte documente</div>
      <div class="tab" data-tab="publice">Documente publice</div>
    </div>

    <div class="grid">
      <div class="card left">
        <div class="catList" id="catList"></div>
        <div class="note">Aici vezi È™abloanele (PDF) setate de managerul tÄƒu È™i documentele completate de tine.</div>
        <div class="err" id="err"></div>
      </div>

      <div class="card right">
        <div class="actionsRow">
          <div>
            <div class="rightTitle" id="rightTitle">â€”</div>
            <div class="pill" id="mgrPill" title="Manager">Manager: â€”</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button class="btn" id="btnViewTpl" type="button" disabled>Vezi È™ablon</button>
            <button class="btn primary" id="btnFill" type="button" disabled>CompleteazÄƒ & SalveazÄƒ</button>
          </div>
        </div>

        <div class="searchRow">
          <div class="search">
            <span style="opacity:.55;font-weight:900">ðŸ”Ž</span>
            <input id="q" placeholder="CautÄƒ..." />
          </div>
          <button class="btn" id="btnRefresh" type="button">Refresh</button>
        </div>

        <div class="list" id="list"></div>
      </div>
    </div>
  </div>

  <!-- Modal completeazÄƒ -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <div class="t" id="modalTitle">CompleteazÄƒ</div>
        <button class="btn" id="btnCloseModal" type="button">ÃŽnchide</button>
      </div>
      <div class="modalBody">
        <div class="pill" id="modalStatus"><span class="spin"></span> Se Ã®ncarcÄƒ È™ablonul...</div>
        <div style="height:12px"></div>
        <div class="fields" id="fields"></div>
        <div class="note" style="margin-top:12px">
          NotÄƒ: cÃ¢mpurile apar doar dacÄƒ È™ablonul PDF este fillable (AcroForm). DacÄƒ nu apar cÃ¢mpuri, cere adminului sÄƒ urce un È™ablon fillable.
        </div>
        <div class="err" id="modalErr"></div>
      </div>
      <div class="modalFoot">
        <button class="btn" id="btnDownloadPreview" type="button" disabled>Preview (deschide)</button>
        <button class="btn primary" id="btnSavePdf" type="button" disabled>SalveazÄƒ PDF (trimite)</button>
      </div>
    </div>
  </div>

<script>
  const DOC_TYPES = [
  { key:'concediu_odihna', label:'Concedii de odihnÄƒ' },
  { key:'concediu_medical', label:'Concedii medicale' },
  { key:'concediu_fara_plata', label:'Concedii fÄƒrÄƒ platÄƒ' },
  { key:'telemunca', label:'Cereri telemuncÄƒ' },
  { key:'ore_suplimentare', label:'Cereri de ore suplimentare' },
  { key:'evenimente', label:'Cereri evenimente' },
  { key:'invoire', label:'Cereri Ã®nvoire' }
];

  // session keys (same as employee-dashboard.html)
  const EMP_TOKEN_KEY = "pontaj_me_token";
  const EMP_NAME_KEY  = "pontaj_me_name";

  let CFG = null;
  let ENDPOINT = "";
  let state = {
    managerEmail: "",
    templates: {},   // typeKey -> {templateUrl, typeLabel}
    docs: [],          // list of completed docs
    selectedType: DOC_TYPES[0].key,
    q: ""
  };

  function $(id){ return document.getElementById(id); }

  async function loadConfig(){
    const tries = ["config.json","./config.json","../config.json","/config.json"];
    let lastErr = null;
    for (const p of tries){
      try{
        const r = await fetch(p + "?v=" + Date.now(), {cache:"no-store"});
        if (!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      }catch(e){ lastErr = e; }
    }
    throw lastErr || new Error("Nu pot citi config.json.");
  }

  function endpointBase(cfg){
    const raw = cfg.documentsEndpoint || cfg.leaveEndpoint || cfg.adminEventsEndpoint || cfg.webappUrl || cfg.scriptUrl || "";
    return String(raw||"").replace(/\?.*$/, "").trim();
  }

  function jsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement("script");
      const cleanup = ()=>{ try{delete window[cb];}catch(_){
      }; s.remove(); };
      const t = setTimeout(()=>{ cleanup(); reject(new Error("JSONP timeout")); }, 25000);
      window[cb] = (data)=>{ clearTimeout(t); cleanup(); resolve(data); };
      s.onerror = ()=>{ clearTimeout(t); cleanup(); reject(new Error("JSONP error")); };
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
      document.head.appendChild(s);
    });
  }

  async function postNoCors(endpoint, payload){
    await fetch(endpoint + "?fn=meDocUploadChunkPost", {
      method:"POST",
      mode:"no-cors",
      headers:{"Content-Type":"text/plain;charset=UTF-8"},
      body: JSON.stringify(Object.assign({}, payload, { fn:"meDocUploadChunkPost" }))
    });
  }

  function bytesToB64Url(bytes){
    let bin = "";
    const chunk = 0x8000;
    for (let i=0;i<bytes.length;i+=chunk){
      bin += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));
    }
    const b64 = btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    return b64;
  }

  function fmtDate(d){
    try{
      const dt = new Date(d);
      if (isNaN(dt)) return "";
      const dd = String(dt.getDate()).padStart(2,'0');
      const mm = String(dt.getMonth()+1).padStart(2,'0');
      const yy = dt.getFullYear();
      return dd + "." + mm + "." + yy;
    }catch(_){
      return "";
    }
  }

  function setErr(msg){ $("err").textContent = msg || ""; }

  function renderCats(){
    const wrap = $("catList");
    wrap.innerHTML = "";
    const counts = new Map(DOC_TYPES.map(t=>[t.key, 0]));
    for (const d of state.docs) counts.set(d.typeKey, (counts.get(d.typeKey)||0)+1);

    for (const t of DOC_TYPES){
      const div = document.createElement("div");
      div.className = "cat" + (t.key===state.selectedType ? " active" : "");
      const c = counts.get(t.key)||0;
      div.innerHTML = `
        <div class="count">${c} fiÈ™iere</div>
        <div class="label">${t.label}</div>
      `;
      div.onclick = ()=>{ state.selectedType = t.key; renderAll(); };
      wrap.appendChild(div);
    }
  }

  function renderList(){
    const list = $("list");
    const t = DOC_TYPES.find(x=>x.key===state.selectedType) || DOC_TYPES[0];
    $("rightTitle").textContent = t.label;

    const tpl = state.templates[state.selectedType];
    $("btnViewTpl").disabled = !tpl || !tpl.templateUrl;
    $("btnFill").disabled = !tpl || !tpl.templateUrl;

    const q = state.q.trim().toLowerCase();
    const filtered = state.docs
      .filter(d => d.typeKey === state.selectedType)
      .filter(d => !q || (String(d.typeLabel||"").toLowerCase().includes(q) || String(d.docId||"").toLowerCase().includes(q)));

    if (!filtered.length){
      list.innerHTML = `<div class="empty">Nu existÄƒ documente completate pentru aceastÄƒ categorie.</div>`;
      return;
    }

    list.innerHTML = "";
    for (const d of filtered){
      const row = document.createElement("div");
      row.className = "row";
      const date = fmtDate(d.createdAt);
      row.innerHTML = `
        <div class="date"><span class="docIcon">ðŸ“„</span> <span>${date}</span></div>
        <div>
          <div class="name">${d.typeLabel || t.label}</div>
          <div class="sub">Completat de tine</div>
        </div>
        <div class="open">
          <button class="btn" type="button">Deschide</button>
        </div>
      `;
      row.querySelector("button").onclick = ()=>{ window.open(d.pdfUrl, "_blank"); };
      list.appendChild(row);
    }
  }

  function renderAll(){
    renderCats();
    renderList();
  }

  async function refresh(){
    setErr("");
    try{
      if (!CFG) CFG = await loadConfig();
      ENDPOINT = endpointBase(CFG);
      if (!ENDPOINT) throw new Error("LipseÈ™te leaveEndpoint/documentsEndpoint Ã®n config.json.");

      const token = (localStorage.getItem(EMP_TOKEN_KEY) || "").trim();
      if (!token){
        setErr("Nu eÈ™ti logat. Deschide employee-dashboard È™i apasÄƒ Login (sau seteazÄƒ pontaj_me_token).");
        return;
      }

      // templates
      const tplUrl = ENDPOINT + "?fn=meDocTemplates&token=" + encodeURIComponent(token) + "&ts=" + Date.now();
      const tpls = await jsonp(tplUrl);
      if (!tpls || !tpls.ok) throw new Error(tpls?.error || "Nu pot Ã®ncÄƒrca È™abloanele.");
      state.managerEmail = tpls.managerEmail || "";
      $("mgrPill").textContent = "Manager: " + (state.managerEmail || "â€”");
      state.templates = tpls.map || {};

      // docs list
      const docsUrl = ENDPOINT + "?fn=meDocumentsList&token=" + encodeURIComponent(token) + "&ts=" + Date.now();
      const docs = await jsonp(docsUrl);
      if (!docs || !docs.ok) throw new Error(docs?.error || "Nu pot Ã®ncÄƒrca documentele.");
      state.docs = Array.isArray(docs.list) ? docs.list : [];

      renderAll();
    }catch(err){
      setErr(String(err && err.message ? err.message : err));
    }
  }

  // ========== modal fill ==========
  let modalPdfDoc = null;
  let modalFields = [];
  let modalTplUrl = "";
  let modalPreviewBlobUrl = "";

  function showModal(show) {
    $("modalBack").classList.toggle("show", !!show);
    if (!show) {
      $("fields").innerHTML = "";
      $("modalErr").textContent = "";
      $("modalStatus").innerHTML = '<span class="spin"></span> Se Ã®ncarcÄƒ È™ablonul...';
      $("btnSavePdf").disabled = true;
      $("btnDownloadPreview").disabled = true;
      modalPdfDoc = null;
      modalFields = [];
      modalTplUrl = "";
      if (modalPreviewBlobUrl) {
        URL.revokeObjectURL(modalPreviewBlobUrl);
        modalPreviewBlobUrl = "";
      }
    }
  }

  async function openFillModal() {
    $("modalErr").textContent = "";
    const tpl = state.templates[state.selectedType];
    if (!tpl || !tpl.templateUrl) return;
    modalTplUrl = tpl.templateUrl;

    showModal(true);
    $("modalTitle").textContent = "CompleteazÄƒ: " + (tpl.typeLabel || (DOC_TYPES.find(x=>x.key===state.selectedType)?.label || "Document"));

    try {
      const r = await fetch(modalTplUrl, {cache:"no-store"});
      if (!r.ok) throw new Error("Nu pot descÄƒrca È™ablonul (HTTP " + r.status + ").");
      const ab = await r.arrayBuffer();
      const pdfDoc = await PDFLib.PDFDocument.load(ab);
      modalPdfDoc = pdfDoc;
      const form = pdfDoc.getForm();
      const fields = form.getFields();
      modalFields = fields;

      const wrap = $("fields");
      wrap.innerHTML = "";

      if (!fields.length) {
        $("modalStatus").textContent = "È˜ablonul nu are cÃ¢mpuri (AcroForm).";
      } else {
        $("modalStatus").textContent = "CompleteazÄƒ cÃ¢mpurile:";
      }

      for (const f of fields) {
        const name = f.getName();
        const type = (f.constructor && f.constructor.name) ? f.constructor.name : "Field";
        const box = document.createElement("div");
        box.className = "f";
        let inputHtml = "";
        const id = "f_" + Math.random().toString(36).slice(2);
        if (type === "PDFCheckBox") {
          inputHtml = `<input type="checkbox" id="${id}">`;
        } else if (type === "PDFDropdown") {
          const opts = (f.getOptions ? f.getOptions() : []) || [];
          inputHtml = `<select id="${id}">${opts.map(o=>`<option value="${String(o)}">${String(o)}</option>`).join("")}</select>`;
        } else {
          inputHtml = `<input type="text" id="${id}" placeholder="...">`;
        }
        box.innerHTML = `<label title="${type}">${name}</label>${inputHtml}`;
        box.dataset.fieldName = name;
        box.dataset.fieldType = type;
        wrap.appendChild(box);
      }

      $("btnSavePdf").disabled = false;
      $("btnDownloadPreview").disabled = false;

      $("btnDownloadPreview").onclick = async ()=>{
        const bytes = await buildPdfBytes(false);
        const blob = new Blob([bytes], {type:"application/pdf"});
        modalPreviewBlobUrl = URL.createObjectURL(blob);
        window.open(modalPreviewBlobUrl, "_blank");
      };

    } catch (err) {
      $("modalErr").textContent = String(err && err.message ? err.message : err);
      $("modalStatus").textContent = "Eroare la Ã®ncÄƒrcarea È™ablonului.";
    }
  }

  async function buildPdfBytes(flatten=true) {
    if (!modalPdfDoc) throw new Error("Nu e Ã®ncÄƒrcat È™ablonul.");
    const pdfDoc = modalPdfDoc;
    const form = pdfDoc.getForm();

    // apply values from UI
    const nodes = Array.from(document.querySelectorAll("#fields .f"));
    for (const n of nodes) {
      const name = n.dataset.fieldName;
      const type = n.dataset.fieldType;
      if (!name) continue;
      try {
        if (type === "PDFCheckBox") {
          const v = n.querySelector("input").checked;
          const field = form.getCheckBox(name);
          if (v) field.check(); else field.uncheck();
        } else if (type === "PDFDropdown") {
          const v = n.querySelector("select").value;
          const field = form.getDropdown(name);
          field.select(v);
        } else {
          const v = n.querySelector("input").value || "";
          const field = form.getTextField(name);
          field.setText(String(v));
        }
      } catch (_) {
        // ignore field errors (missing type mismatch)
      }
    }

    if (flatten) {
      try { form.flatten(); } catch(_){}
    }
    const bytes = await pdfDoc.save({useObjectStreams:false});
    return bytes;
  }

  async function uploadPdf(bytes) {
    const token = (localStorage.getItem(EMP_TOKEN_KEY) || "").trim();
    if (!token) throw new Error("Nu eÈ™ti logat.");

    const CH = 120000;
    const b64url = bytesToB64Url(new Uint8Array(bytes));
    const n = Math.max(1, Math.ceil(b64url.length / CH));

    $("modalStatus").innerHTML = '<span class="spin"></span> Init upload...';

    const typeKey = state.selectedType;
    const typeLabel = (state.templates[typeKey]?.typeLabel) || (DOC_TYPES.find(x=>x.key===typeKey)?.label) || typeKey;

    const initUrl = ENDPOINT + "?fn=meDocUploadInit&token=" + encodeURIComponent(token)
      + "&typeKey=" + encodeURIComponent(typeKey)
      + "&typeLabel=" + encodeURIComponent(typeLabel)
      + "&mime=" + encodeURIComponent("application/pdf")
      + "&n=" + n + "&ts=" + Date.now();

    const init = await jsonp(initUrl);
    if (!init || !init.ok) throw new Error(init?.error || "Init failed.");
    const uid = init.uid, uk = init.uk;
    if (!uid || !uk) throw new Error("LipseÈ™te uid/uk.");

    for (let i=0;i<n;i++) {
      const c = b64url.slice(i*CH, (i+1)*CH);
      $("modalStatus").innerHTML = '<span class="spin"></span> Upload chunk ' + (i+1) + '/' + n + ' ...';
      await postNoCors(ENDPOINT, { uid, uk, i, n, c });
    }

    $("modalStatus").innerHTML = '<span class="spin"></span> Finalize...';
    const finUrl = ENDPOINT + "?fn=meDocUploadFinalize&uid=" + encodeURIComponent(uid)
      + "&uk=" + encodeURIComponent(uk) + "&n=" + n + "&ts=" + Date.now();
    const fin = await jsonp(finUrl);
    if (!fin || !fin.ok) throw new Error(fin?.error || "Finalize failed.");

    $("modalStatus").textContent = "Salvat! Documentul a fost trimis.";
    return fin;
  }

  async function saveModalPdf() {
    $("modalErr").textContent = "";
    try {
      const bytes = await buildPdfBytes(true);
      await uploadPdf(bytes);
      await refresh();
    } catch (err) {
      $("modalErr").textContent = String(err && err.message ? err.message : err);
      $("modalStatus").textContent = "Eroare.";
      return;
    }
  }

  // events
  $("q").addEventListener("input", (e)=>{ state.q = e.target.value || ""; renderList(); });
  $("btnRefresh").onclick = ()=>refresh();
  $("btnViewTpl").onclick = ()=>{
    const tpl = state.templates[state.selectedType];
    if (tpl?.templateUrl) window.open(tpl.templateUrl, "_blank");
  };
  $("btnFill").onclick = ()=>openFillModal();

  $("btnCloseModal").onclick = ()=>showModal(false);
  $("modalBack").addEventListener("click", (e)=>{ if (e.target === $("modalBack")) showModal(false); });
  $("btnSavePdf").onclick = ()=>saveModalPdf();

  // tabs (UI only for now)
  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
    });
  });

  refresh();
</script>
</body>
</html>
