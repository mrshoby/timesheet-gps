<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Documente • Employee</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#F6F7FB;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(15,23,42,.08);
      --accent:#6D5EF1;
      --accent2:#8A7BFF;
      --shadow: 0 12px 40px rgba(15,23,42,.08);
      --shadow2: 0 10px 24px rgba(15,23,42,.10);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:1280px;
      margin:0 auto;
      padding:18px 16px 22px;
    }
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .tabs{
      display:flex;
      gap:26px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .tab{
      background:transparent;
      border:0;
      padding:10px 2px;
      font:inherit;
      cursor:pointer;
      color:var(--muted);
      font-weight:700;
      position:relative;
    }
    .tab.active{ color:var(--accent); }
    .tab.active:after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:2px;
      height:3px;
      border-radius:99px;
      background:var(--accent);
    }
    .topRight{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .avatarWrap{
      position:relative;
      width:40px;height:40px;
      border-radius:999px;
      overflow:hidden;
      border:2px solid #fff;
      box-shadow: 0 10px 22px rgba(15,23,42,.10);
      background:#eef1ff;
      display:grid;place-items:center;
      font-weight:800;
      color:#374151;
      flex:0 0 auto;
    }
    .avatarWrap img{width:100%;height:100%;object-fit:cover;display:block}
    .badge{
      position:absolute;
      top:-6px; right:-6px;
      min-width:18px;height:18px;
      padding:0 5px;
      border-radius:999px;
      background:var(--accent);
      color:#fff;
      border:2px solid #fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:11px;
      box-shadow: 0 10px 18px rgba(109,94,241,.25);
    }
    .iconBtn{
      width:40px;height:40px;border-radius:14px;
      border:1px solid var(--border);
      background:var(--card);
      cursor:pointer;
      display:grid;place-items:center;
      box-shadow: 0 6px 16px rgba(15,23,42,.06);
    }
    .iconBtn:hover{border-color:rgba(109,94,241,.35)}

    .layout{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      align-items:start;
      margin-top:6px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .leftList{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .cat{
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px 16px;
      cursor:pointer;
      background:#fff;
      transition:.15s ease;
    }
    .cat:hover{ border-color: rgba(109,94,241,.22); background: rgba(109,94,241,.03); }
    .cat.active{
      background: linear-gradient(180deg, rgba(109,94,241,.95), rgba(109,94,241,.80));
      border-color: rgba(109,94,241,.25);
      color:#fff;
      box-shadow: 0 18px 34px rgba(109,94,241,.22);
    }
    .cat .count{
      font-weight:700;
      font-size:13px;
      color:rgba(100,116,139,.9);
    }
    .cat.active .count{ color: rgba(255,255,255,.82); }
    .cat .name{
      margin-top:2px;
      font-weight:800;
      font-size:18px;
      letter-spacing:.2px;
    }

    .right{
      padding:16px;
    }
    .searchRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .search{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      min-width:260px;
      max-width:420px;
      width:100%;
    }
    .search input{
      border:0;
      outline:none;
      font:inherit;
      width:100%;
      color:var(--text);
      font-weight:600;
      background:transparent;
    }
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
    }
    .thead{
      display:grid;
      grid-template-columns: 120px 1fr;
      padding:10px 12px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.2px;
    }
    .row{
      display:grid;
      grid-template-columns: 44px 120px 1fr;
      align-items:center;
      gap:12px;
      padding:14px 12px;
      border-top:1px solid rgba(15,23,42,.06);
    }
    .fileIco{
      width:34px;height:34px;border-radius:12px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.03);
      display:grid;place-items:center;
    }
    .dateCell{
      font-weight:800;
      font-size:18px;
      color:#111827;
      letter-spacing:.2px;
    }
    .nameCell .title{
      font-weight:900;
      font-size:18px;
      color:#111827;
      letter-spacing:.2px;
      line-height:1.12;
    }
    .nameCell .sub{
      margin-top:4px;
      font-weight:700;
      color:rgba(100,116,139,.9);
    }
    .footerNav{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      padding:14px 6px 0;
    }
    .pagerBtn{
      width:44px;height:44px;border-radius:16px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      display:grid;place-items:center;
      box-shadow: 0 6px 16px rgba(15,23,42,.06);
    }
    .pagerBtn:disabled{opacity:.45; cursor:not-allowed; box-shadow:none}
    .empty{
      padding:22px 12px;
      color:rgba(100,116,139,.95);
      font-weight:800;
    }
    .hint{
      padding:10px 12px 0;
      color:rgba(100,116,139,.85);
      font-weight:700;
      font-size:12px;
    }

    @media(max-width:980px){
      .layout{ grid-template-columns: 1fr; }
      .searchRow{ flex-wrap:wrap; }
      .cat .name{ font-size:16px; }
      .dateCell,.nameCell .title{ font-size:16px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="tabs" id="tabs"></div>

      <div class="topRight">
        <button class="iconBtn" id="btnRefresh" title="Refresh">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M20 12a8 8 0 10-2.3 5.7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M20 12v-6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <div class="avatarWrap" title="Profil">
          <img id="avatarImg" alt="" style="display:none"/>
          <div id="avatarFallback">•</div>
          <div class="badge" id="badge" style="display:none">0</div>
        </div>
      </div>
    </div>

    <div class="layout">
      <div class="card">
        <div class="leftList" id="cats"></div>
      </div>

      <div class="card">
        <div class="right">
          <div class="searchRow">
            <div class="search">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M11 19a8 8 0 110-16 8 8 0 010 16z" stroke="currentColor" stroke-width="2"/>
              </svg>
              <input id="q" placeholder="Caută" />
            </div>
            <div style="font-weight:800;color:rgba(100,116,139,.85)" id="meta">—</div>
          </div>

          <div class="thead">
            <div>DATĂ</div>
            <div>NUME</div>
          </div>

          <div id="rows"></div>

          <div class="footerNav">
            <button class="pagerBtn" id="prev" title="Pagina anterioară">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <button class="pagerBtn" id="next" title="Pagina următoare">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>

          <div class="hint" id="hint"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ===== Small utils =====
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const EMP_TOKEN_KEY = "pontaj_me_token";

  function esc(s){
    return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }
  function initials(name){
    const p = String(name||"").trim().split(/\\s+/).filter(Boolean);
    const a = p[0]?.[0]||"";
    const b = p[1]?.[0]||"";
    return (a+b).toUpperCase() || "•";
  }
  function ddmmyyyy(isoDate){
    const s = String(isoDate||"").trim();
    if (!s) return "—";
    // accept YYYY-MM-DD
    const m = s.match(/^(\\d{4})-(\\d{2})-(\\d{2})/);
    if (m) return `${m[3]}.${m[2]}.${m[1]}`;
    // fallback: try Date
    const d = new Date(s);
    if (!isNaN(d)) {
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${dd}.${mm}.${yy}`;
    }
    return s;
  }

  function jsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(16).slice(2);
      const s = document.createElement("script");
      let done = false;

      window[cb] = (data)=>{ done = true; cleanup(); resolve(data); };
      function cleanup(){
        try{ delete window[cb]; }catch(e){ window[cb] = undefined; }
        try{ s.remove(); }catch(e){}
      }
      s.onerror = ()=>{ if (done) return; cleanup(); reject(new Error("JSONP error")); };
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb + "&_=" + Date.now();
      document.head.appendChild(s);
    });
  }

  // ===== Config =====
  let CFG = null;
  async function loadConfig(){
    const tries = ["config.json","./config.json","../config.json","/config.json"];
    for (const p of tries){
      try{
        const r = await fetch(p+"?v="+Date.now(), {cache:"no-store"});
        if (!r.ok) continue;
        CFG = await r.json();
        return;
      }catch(e){}
    }
    throw new Error("Nu pot încărca config.json.");
  }
  function ep(){ return (CFG?.leaveEndpoint || CFG?.stateEndpoint || CFG?.adminEventsEndpoint || "").replace(/\?.*$/,''); }

  // ===== Tabs (UI only) =====
  const TABS = [
    {id:"requests", label:"Documentele cereri"},
    {id:"contracts", label:"Documente contractuale"},
    {id:"certs", label:"Adeverințe"},
    {id:"other", label:"Alte documente"},
    {id:"public", label:"Documente publice"},
  ];

  // ===== Categories (as in screenshot) =====
  const CATS = [
    {id:"odihna", label:"Concedii de odihnă"},
    {id:"medical", label:"Concedii medicale"},
    {id:"fara_plata", label:"Concedii fără plată"},
    {id:"telework", label:"Cereri telemuncă"},
    {id:"overtime", label:"Cereri de ore suplimentare"},
    {id:"events", label:"Cereri evenimente"},
  ];

  // Internal state
  let STATE = {
    tab:"requests",
    cat:"odihna",
    q:"",
    page:0,
    pageSize:6,
    me:{ token:"", name:"" },
    allItems:[], // {catId, dateIso, title, by, meta, url?}
    catCounts:{},
  };

  function setAvatar(url, name){
    const img = $("#avatarImg");
    const fb = $("#avatarFallback");
    if (url){
      img.src = url;
      img.style.display = "block";
      fb.style.display = "none";
    }else{
      img.style.display = "none";
      fb.style.display = "grid";
      fb.textContent = initials(name);
    }
  }

  function renderTabs(){
    const host = $("#tabs");
    host.innerHTML = "";
    for (const t of TABS){
      const b = document.createElement("button");
      b.className = "tab" + (STATE.tab===t.id ? " active" : "");
      b.textContent = t.label;
      b.addEventListener("click", ()=>{
        STATE.tab = t.id;
        STATE.page = 0;
        renderAll();
      });
      host.appendChild(b);
    }
  }

  function renderCats(){
    const host = $("#cats");
    host.innerHTML = "";
    for (const c of CATS){
      const count = STATE.catCounts[c.id] ?? 0;
      const b = document.createElement("div");
      b.className = "cat" + (STATE.cat===c.id ? " active" : "");
      b.innerHTML = `
        <div class="count">${count} fișiere</div>
        <div class="name">${esc(c.label)}</div>
      `;
      b.addEventListener("click", ()=>{
        STATE.cat = c.id;
        STATE.page = 0;
        renderAll();
      });
      host.appendChild(b);
    }
  }

  function getTabItems(){
    if (STATE.tab === "requests"){
      return STATE.allItems;
    }
    // Optional: allow config-driven lists
    const keyMap = {
      contracts: "contractDocs",
      certs: "certDocs",
      other: "otherDocs",
      public: "publicDocs"
    };
    const k = keyMap[STATE.tab];
    const arr = (CFG && CFG.documents && Array.isArray(CFG.documents[k])) ? CFG.documents[k] : [];
    return arr.map(x=>({
      catId: STATE.cat, // not used
      dateIso: x.date || x.createdAt || "",
      title: x.title || x.name || "Document",
      by: x.by || x.author || "Companie",
      meta: x.meta || "",
      url: x.url || x.link || ""
    }));
  }

  function filteredItems(){
    const items = getTabItems();
    const q = String(STATE.q||"").trim().toLowerCase();
    const cat = STATE.cat;
    return items.filter(it=>{
      if (STATE.tab === "requests"){
        if (it.catId !== cat) return false;
      }
      if (!q) return true;
      return (String(it.title||"").toLowerCase().includes(q) || String(it.meta||"").toLowerCase().includes(q));
    });
  }

  function renderRows(){
    const host = $("#rows");
    const items = filteredItems();
    const totalPages = Math.max(1, Math.ceil(items.length / STATE.pageSize));
    STATE.page = Math.max(0, Math.min(STATE.page, totalPages-1));
    const start = STATE.page*STATE.pageSize;
    const pageItems = items.slice(start, start+STATE.pageSize);

    $("#meta").textContent = `${items.length} rezultate`;
    $("#prev").disabled = (STATE.page<=0);
    $("#next").disabled = (STATE.page>=totalPages-1);

    if (!pageItems.length){
      host.innerHTML = `<div class="empty">Nu există documente de afișat aici.</div>`;
      $("#hint").textContent = (STATE.tab==="requests")
        ? "Tip: cererile de concediu/invoire apar aici automat. Pentru telemuncă/ore suplimentare putem conecta ulterior un sheet separat."
        : "Tip: poți defini listele din config.json în obiectul documents.* (publicDocs / contractDocs / certDocs / otherDocs).";
      return;
    }

    host.innerHTML = "";
    for (const it of pageItems){
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="fileIco" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" stroke="currentColor" stroke-width="2"/>
            <path d="M14 2v6h6" stroke="currentColor" stroke-width="2"/>
          </svg>
        </div>
        <div class="dateCell">${esc(ddmmyyyy(it.dateIso))}</div>
        <div class="nameCell">
          <div class="title">${esc(it.title)}</div>
          <div class="sub">${esc(it.by || "")}</div>
        </div>
      `;
      if (it.url){
        row.style.cursor = "pointer";
        row.addEventListener("click", ()=>window.open(it.url, "_blank"));
      }
      host.appendChild(row);
    }
    $("#hint").textContent = `Pagina ${STATE.page+1} / ${totalPages}`;
  }

  function renderAll(){
    renderTabs();
    renderCats();
    renderRows();
  }

  function catOfLeave(x){
    const kind = String(x.kind||"").toLowerCase();
    const code = String(x.code||"").toUpperCase();
    if (code === "CO") return "odihna";
    if (code === "CFP") return "fara_plata";
    if (code === "EV") return "events";
    if (code === "BO" || code === "CM") return "medical";
    if (kind === "invoire") return "events";
    // CCC etc -> events for now
    return "events";
  }

  function titleOfLeave(x){
    const kind = String(x.kind||"").toLowerCase();
    if (kind === "invoire"){
      const d = ddmmyyyy(x.startDate || x.createdAt);
      return `Învoire ${d}`;
    }
    const code = String(x.code||"").trim().toUpperCase() || "CO";
    const s = ddmmyyyy(x.startDate);
    const e = ddmmyyyy(x.endDate);
    if (s !== "—" && e !== "—" && s !== e) return `Concediu ${code} ${s} – ${e}`;
    return `Concediu ${code} ${s}`;
  }

  async function loadMeProfile(){
    // best-effort: use same endpoint as employee-dashboard
    const base = ep();
    if (!base || !STATE.me.token) return null;
    try{
      const data = await jsonp(`${base}?fn=meProfile&token=${encodeURIComponent(STATE.me.token)}`);
      if (data && data.ok && data.profile) return data.profile;
    }catch(e){}
    return null;
  }

  function ymFromDate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    return `${y}-${m}`;
  }

  function lastMonths(n){
    const out = [];
    const d = new Date();
    d.setDate(1);
    for (let i=0;i<n;i++){
      out.push(ymFromDate(d));
      d.setMonth(d.getMonth()-1);
    }
    return out;
  }

  async function loadLeavesLast12(){
    const base = ep();
    if (!base) throw new Error("Lipseaște leaveEndpoint în config.json.");
    if (!STATE.me.token) throw new Error("Nu ești logat. Deschide întâi index.html și autentifică-te.");
    const months = lastMonths(12);
    const all = [];
    const seen = new Set();

    for (const ym of months){
      const url = `${base}?fn=meLeaves&token=${encodeURIComponent(STATE.me.token)}&ym=${encodeURIComponent(ym)}`;
      try{
        const data = await jsonp(url);
        if (!data || !data.ok || !Array.isArray(data.list)) continue;
        for (const x of data.list){
          const id = String(x.id||"");
          if (id && seen.has(id)) continue;
          if (id) seen.add(id);
          all.push(x);
        }
      }catch(e){
        // ignore per-month failure
      }
    }
    return all;
  }

  function setCountsFromItems(items){
    const counts = {};
    for (const c of CATS) counts[c.id] = 0;
    for (const it of items){
      counts[it.catId] = (counts[it.catId]||0) + 1;
    }
    STATE.catCounts = counts;
  }

  async function init(){
    $("#btnRefresh").addEventListener("click", ()=>location.reload());
    $("#q").addEventListener("input", (e)=>{
      STATE.q = e.target.value || "";
      STATE.page = 0;
      renderRows();
    });
    $("#prev").addEventListener("click", ()=>{
      STATE.page = Math.max(0, STATE.page-1);
      renderRows();
    });
    $("#next").addEventListener("click", ()=>{
      STATE.page = STATE.page+1;
      renderRows();
    });

    await loadConfig();
    try{
      STATE.me.token = localStorage.getItem(EMP_TOKEN_KEY) || "";
      // name is optional
      STATE.me.name = localStorage.getItem("pontaj_me_name") || "";
    }catch(e){}

    // avatar
    const prof = await loadMeProfile();
    if (prof){
      STATE.me.name = prof.name || STATE.me.name;
      setAvatar(prof.avatarUrl || "", STATE.me.name);
      // badge = pending notifications count (optional)
      const pending = Number(prof.notifUnread || 0);
      if (pending > 0){ $("#badge").style.display="flex"; $("#badge").textContent = String(pending); }
    } else {
      setAvatar("", STATE.me.name);
    }

    // Data
    try{
      const leaves = await loadLeavesLast12();
      STATE.allItems = leaves.map(x=>({
        catId: catOfLeave(x),
        dateIso: x.startDate || x.createdAt || "",
        title: titleOfLeave(x),
        by: "Adăugat de tine",
        meta: String(x.status||""),
        url: "" // optional: if you attach docs later, put link here
      })).sort((a,b)=>String(b.dateIso||"").localeCompare(String(a.dateIso||"")));

      setCountsFromItems(STATE.allItems);
    }catch(err){
      STATE.allItems = [];
      setCountsFromItems([]);
      $("#hint").textContent = String(err && err.message ? err.message : err);
    }

    // default category: first with count>0 else first
    const firstNonZero = CATS.find(c => (STATE.catCounts[c.id]||0) > 0);
    STATE.cat = (firstNonZero ? firstNonZero.id : CATS[0].id);

    renderAll();
  }

  init();
</script>
</body>
</html>
