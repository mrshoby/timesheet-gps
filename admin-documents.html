<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Documente â€¢ Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#F6F7FB;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --border:rgba(15,23,42,.08);
      --accent:#6D5EF1;
      --accent2:#8A7BFF;
      --shadow: 0 12px 40px rgba(15,23,42,.08);
      --shadow2: 0 10px 24px rgba(15,23,42,.10);
      --radius:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .page{padding:18px 20px;}
    .topTabs{display:flex;gap:22px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
    .tab{font-weight:800;color:rgba(15,23,42,.55);padding:8px 4px;border-bottom:3px solid transparent;cursor:pointer;user-select:none}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);}
    .grid{display:grid;grid-template-columns: 420px 1fr;gap:18px;}
    @media (max-width: 1100px){.grid{grid-template-columns:1fr;}}
    .left{padding:14px}
    .right{padding:14px}
    .catList{display:flex;flex-direction:column;gap:12px}
    .cat{padding:16px 18px;border-radius:18px;border:1px solid rgba(15,23,42,.08);background:#fff;cursor:pointer}
    .cat:hover{background:rgba(109,94,241,.04)}
    .cat.active{background:var(--accent);border-color:rgba(109,94,241,.35);color:#fff}
    .cat .count{font-size:13px;font-weight:900;opacity:.7}
    .cat.active .count{opacity:.9}
    .cat .label{font-size:24px;font-weight:900;margin-top:2px;letter-spacing:-.02em}
    .actionsRow{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap}
    .rightTitle{font-size:18px;font-weight:900}
    .btn{border:1px solid rgba(15,23,42,.12);background:#fff;color:var(--text);border-radius:14px;padding:10px 12px;font-weight:900;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:rgba(109,94,241,.35);color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .searchRow{display:flex;gap:12px;align-items:center;margin:6px 0 14px}
    .search{flex:1;display:flex;gap:10px;align-items:center;background:#fff;border:1px solid var(--border);border-radius:18px;padding:12px 14px;}
    .search input{border:0;outline:0;width:100%;font-size:14px}
    .list{border:1px solid rgba(15,23,42,.08);border-radius:18px;overflow:hidden;background:#fff}
    .row{display:grid;grid-template-columns: 160px 1fr 180px;gap:10px;align-items:center;padding:14px 14px;border-bottom:1px solid rgba(15,23,42,.06)}
    .row:last-child{border-bottom:0}
    .date{font-weight:900;font-size:16px;color:#0b1220;display:flex;gap:10px;align-items:center}
    .docIcon{width:34px;height:34px;border-radius:12px;border:1px solid rgba(15,23,42,.10);display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.02)}
    .name{font-weight:900;font-size:18px;}
    .sub{color:rgba(15,23,42,.55);font-weight:800;margin-top:2px}
    .open{justify-self:end}
    .empty{padding:20px;color:rgba(15,23,42,.55);font-weight:800}
    .note{margin-top:12px;color:rgba(15,23,42,.55);font-weight:800}
    .err{margin:10px 0 0;color:#b91c1c;font-weight:900}

    /* employee picker */
    .picker{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .select{flex:1;min-width:240px;border:1px solid rgba(15,23,42,.12);border-radius:14px;padding:10px 12px;font-weight:800;background:#fff}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid rgba(15,23,42,.12);border-radius:999px;font-weight:900;color:rgba(15,23,42,.65);background:rgba(15,23,42,.02)}

    /* settings tab */
    .settingsWrap{display:none}
    .settingsWrap.show{display:block}
    .tplGrid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    .tpl{border:1px solid rgba(15,23,42,.10);border-radius:18px;padding:14px;background:#fff;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .tpl .leftSide{display:flex;flex-direction:column;gap:4px}
    .tpl .ttl{font-weight:900}
    .tpl .meta{font-weight:800;color:rgba(15,23,42,.55)}
    .tiny{font-size:12px}
  </style>
</head>
<body>
  <div class="page">
    <div class="topTabs">
      <div class="tab active" data-tab="cereri">Documentele cereri</div>
      <div class="tab" data-tab="contractuale">Documente contractuale</div>
      <div class="tab" data-tab="adeverinte">AdeverinÈ›e</div>
      <div class="tab" data-tab="altele">Alte documente</div>
      <div class="tab" data-tab="publice">Documente publice</div>
      <div class="tab" data-tab="setari">SetÄƒri cereri</div>
    </div>

    <div class="grid">
      <div class="card left">
        <div class="picker">
          <select class="select" id="selEmployee"></select>
          <button class="btn" id="btnSetManager" type="button">Manager</button>
        </div>
        <div class="pill" id="mgrPill">Manager: â€”</div>
        <div style="height:10px"></div>
        <div class="catList" id="catList"></div>
        <div class="note">Aici vezi doar PDF-urile completate (digitale), nu cererile brute.</div>
        <div class="err" id="err"></div>
      </div>

      <div class="card right">
        <div id="viewMain">
          <div class="actionsRow">
            <div>
              <div class="rightTitle" id="rightTitle">â€”</div>
              <div class="pill" id="empPill" title="Angajat">Angajat: â€”</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <button class="btn" id="btnRefresh" type="button">Refresh</button>
            </div>
          </div>

          <div class="searchRow">
            <div class="search">
              <span style="opacity:.55;font-weight:900">ðŸ”Ž</span>
              <input id="q" placeholder="CautÄƒ..." />
            </div>
          </div>

          <div class="list" id="list"></div>
        </div>

        <div id="viewSettings" class="settingsWrap">
          <div class="actionsRow">
            <div>
              <div class="rightTitle">SetÄƒri cereri</div>
              <div class="note">ÃŽncarcÄƒ È™abloane PDF fillable pentru fiecare tip. AngajaÈ›ii vor vedea buton de completare.</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <button class="btn" id="btnReloadTpl" type="button">Reload È™abloane</button>
            </div>
          </div>
          <div class="tplGrid" id="tplGrid"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  const DOC_TYPES = [
  { key:'concediu_odihna', label:'Concedii de odihnÄƒ' },
  { key:'concediu_medical', label:'Concedii medicale' },
  { key:'concediu_fara_plata', label:'Concedii fÄƒrÄƒ platÄƒ' },
  { key:'telemunca', label:'Cereri telemuncÄƒ' },
  { key:'ore_suplimentare', label:'Cereri de ore suplimentare' },
  { key:'evenimente', label:'Cereri evenimente' },
  { key:'invoire', label:'Cereri Ã®nvoire' }
];

  const LS_ADMIN_KEY = "pontaj_adminKey";
  const LS_ADMIN_ME_EMAIL = "pontaj_admin_me_email";
  const LS_ADMIN_ME_NAME  = "pontaj_admin_me_name";

  let CFG = null;
  let ENDPOINT = "";
  let state = {
    managerEmail: "",
    managerName: "",
    employees: [],
    selectedEmployeeName: "",
    docs: [],
    templates: {},
    selectedType: DOC_TYPES[0].key,
    q: ""
  };

  function $(id){ return document.getElementById(id); }

  async function loadConfig(){
    const tries = ["config.json","./config.json","../config.json","/config.json"];
    let lastErr = null;
    for (const p of tries){
      try{
        const r = await fetch(p + "?v=" + Date.now(), {cache:"no-store"});
        if (!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      }catch(e){ lastErr = e; }
    }
    throw lastErr || new Error("Nu pot citi config.json.");
  }

  function endpointBase(cfg){
    const raw = cfg.documentsEndpoint || cfg.adminEventsEndpoint || cfg.leaveEndpoint || cfg.webappUrl || cfg.scriptUrl || "";
    return String(raw||"").replace(/\?.*$/, "").trim();
  }

  function keyQS(){
    const k = (CFG && CFG.adminKey) ? String(CFG.adminKey) : "";
    const ls = (localStorage.getItem("ADMIN_KEY") || localStorage.getItem(LS_ADMIN_KEY) || "");
    const key = (k || ls || "").trim();
    return key ? ("&key=" + encodeURIComponent(key)) : "";
  }

  function jsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement("script");
      const cleanup = ()=>{ try{delete window[cb];}catch(_){
      }; s.remove(); };
      const t = setTimeout(()=>{ cleanup(); reject(new Error("JSONP timeout")); }, 25000);
      window[cb] = (data)=>{ clearTimeout(t); cleanup(); resolve(data); };
      s.onerror = ()=>{ clearTimeout(t); cleanup(); reject(new Error("JSONP error")); };
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
      document.head.appendChild(s);
    });
  }

  async function postNoCors(endpoint, payload){
    await fetch(endpoint + "?fn=adminDocTemplateUploadChunkPost", {
      method:"POST",
      mode:"no-cors",
      headers:{"Content-Type":"text/plain;charset=UTF-8"},
      body: JSON.stringify(Object.assign({}, payload, { fn:"adminDocTemplateUploadChunkPost" }))
    });
  }

  function bytesToB64Url(bytes){
    let bin = "";
    const chunk = 0x8000;
    for (let i=0;i<bytes.length;i+=chunk){
      bin += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));
    }
    const b64 = btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    return b64;
  }

  function fmtDate(d){
    try{
      const dt = new Date(d);
      if (isNaN(dt)) return "";
      const dd = String(dt.getDate()).padStart(2,'0');
      const mm = String(dt.getMonth()+1).padStart(2,'0');
      const yy = dt.getFullYear();
      return dd + "." + mm + "." + yy;
    }catch(_){
      return "";
    }
  }

  function setErr(msg){ $("err").textContent = msg || ""; }

  function _detectAdminIdentity(){
    // best-effort: try known session keys used in other admin pages
    const keys = ["pontaj/admin/v1","pontaj_admin_session","pontaj_admin","admin_session"];
    for (const k of keys){
      let raw = "";
      try{ raw = (localStorage.getItem(k) || "").trim(); }catch(e){}
      if (!raw) continue;

      // sometimes value can be plain email
      if (raw.includes("@") && raw[0] !== "{"){
        return { email: raw, name: "" };
      }

      try{
        const o = JSON.parse(raw);
        if (!o) continue;
        const email = (o.email || o.user || o.username || o.login || o.mail || "").trim();
        const name  = (o.label || o.name || o.fullName || o.displayName || "").trim();
        if (email && email.includes("@")) return { email, name };
        // sometimes "user" can be the name and email absent
        if (name && name.includes("@")) return { email: name, name: "" };
      }catch(e){}
    }
    return null;
  }

  function ensureManager(){
    let meEmail = "";
    let meName  = "";

    try{ meEmail = (localStorage.getItem(LS_ADMIN_ME_EMAIL) || "").trim(); }catch(e){}
    try{ meName  = (localStorage.getItem(LS_ADMIN_ME_NAME)  || "").trim(); }catch(e){}

    // fallback: infer from admin session (most admin pages already set it)
    if (!meEmail){
      const id = _detectAdminIdentity();
      if (id && id.email){
        meEmail = id.email;
        if (!meName) meName = id.name || "";
        // persist for next time, so upload works without prompt
        try{ localStorage.setItem(LS_ADMIN_ME_EMAIL, meEmail); }catch(e){}
        if (meName) try{ localStorage.setItem(LS_ADMIN_ME_NAME, meName); }catch(e){}
      }
    }

    if (meEmail){
      state.managerEmail = meEmail;
      state.managerName  = meName;
    }

    $("mgrPill").textContent = "Manager: " + (state.managerEmail || "â€”");
  }

  async function loadEmployees(){
    const url = ENDPOINT + "?fn=adminEmployees" + keyQS() + "&ts=" + Date.now();
    const data = await jsonp(url);
    if (!data || !data.ok) throw new Error(data?.error || "Nu pot Ã®ncÄƒrca lista de angajaÈ›i.");
    const list = data.employees || data.list || data.rows || [];
    state.employees = Array.isArray(list) ? list : [];

    // filter by managerEmail if set
    let visible = state.employees;
    if (state.managerEmail) {
      visible = visible.filter(e => String(e.managerEmail||"").toLowerCase() === state.managerEmail.toLowerCase());
    }

    // fill select
    const sel = $("selEmployee");
    sel.innerHTML = "";
    if (!visible.length) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = state.managerEmail ? "Nu ai angajaÈ›i repartizaÈ›i." : "Niciun angajat.";
      sel.appendChild(opt);
      state.selectedEmployeeName = "";
      return;
    }
    for (const e of visible) {
      const opt = document.createElement("option");
      opt.value = e.name || "";
      opt.textContent = (e.name || "â€”") + (e.dept ? (" â€¢ " + e.dept) : "");
      sel.appendChild(opt);
    }
    state.selectedEmployeeName = sel.value || visible[0].name || "";
    $("empPill").textContent = "Angajat: " + (state.selectedEmployeeName || "â€”");
  }

  async function loadTemplates(){
    if (!state.managerEmail) {
      state.templates = {};
      return;
    }
    const url = ENDPOINT + "?fn=adminDocTemplatesGet" + keyQS()
      + "&managerEmail=" + encodeURIComponent(state.managerEmail)
      + "&ts=" + Date.now();
    const data = await jsonp(url);
    if (!data || !data.ok) throw new Error(data?.error || "Nu pot Ã®ncÄƒrca È™abloanele.");
    state.templates = data.map || {};
  }

  async function loadDocs(){
    if (!state.managerEmail) {
      state.docs = [];
      return;
    }
    const emp = state.selectedEmployeeName || "";
    const url = ENDPOINT + "?fn=adminDocumentsList" + keyQS()
      + "&managerEmail=" + encodeURIComponent(state.managerEmail)
      + (emp ? ("&employeeName=" + encodeURIComponent(emp)) : "")
      + "&ts=" + Date.now();
    const data = await jsonp(url);
    if (!data || !data.ok) throw new Error(data?.error || "Nu pot Ã®ncÄƒrca documentele.");
    state.docs = Array.isArray(data.list) ? data.list : [];
  }

  function renderCats(){
    const wrap = $("catList");
    wrap.innerHTML = "";
    const counts = new Map(DOC_TYPES.map(t=>[t.key, 0]));
    for (const d of state.docs) counts.set(d.typeKey, (counts.get(d.typeKey)||0)+1);

    for (const t of DOC_TYPES){
      const div = document.createElement("div");
      div.className = "cat" + (t.key===state.selectedType ? " active" : "");
      const c = counts.get(t.key)||0;
      div.innerHTML = `
        <div class="count">${c} fiÈ™iere</div>
        <div class="label">${t.label}</div>
      `;
      div.onclick = ()=>{ state.selectedType = t.key; renderAll(); };
      wrap.appendChild(div);
    }
  }

  function renderList(){
    const list = $("list");
    const t = DOC_TYPES.find(x=>x.key===state.selectedType) || DOC_TYPES[0];
    $("rightTitle").textContent = t.label;
    $("empPill").textContent = "Angajat: " + (state.selectedEmployeeName || "â€”");

    const q = state.q.trim().toLowerCase();
    const filtered = state.docs
      .filter(d => d.typeKey === state.selectedType)
      .filter(d => !q || (String(d.typeLabel||"").toLowerCase().includes(q) || String(d.docId||"").toLowerCase().includes(q)));

    if (!filtered.length){
      list.innerHTML = `<div class="empty">Nu existÄƒ documente completate pentru aceastÄƒ categorie.</div>`;
      return;
    }

    list.innerHTML = "";
    for (const d of filtered){
      const row = document.createElement("div");
      row.className = "row";
      const date = fmtDate(d.createdAt);
      row.innerHTML = `
        <div class="date"><span class="docIcon">ðŸ“„</span> <span>${date}</span></div>
        <div>
          <div class="name">${d.typeLabel || t.label}</div>
          <div class="sub">${d.employeeName || ""}</div>
        </div>
        <div class="open">
          <button class="btn" type="button">Deschide</button>
        </div>
      `;
      row.querySelector("button").onclick = ()=>{ window.open(d.pdfUrl, "_blank"); };
      list.appendChild(row);
    }
  }

  function renderSettings(){
    const grid = $("tplGrid");
    grid.innerHTML = "";
    for (const t of DOC_TYPES){
      const current = state.templates[t.key] || null;
      const box = document.createElement("div");
      box.className = "tpl";
      const has = !!(current && current.templateUrl);
      box.innerHTML = `
        <div class="leftSide">
          <div class="ttl">${t.label}</div>
          <div class="meta tiny">${has ? "È˜ablon setat" : "LipseÈ™te È™ablon"}</div>
          <div class="meta tiny">${has && current.updatedAt ? ("Actualizat: " + fmtDate(current.updatedAt)) : ""}</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button class="btn" type="button" ${has ? "" : "disabled"}>Deschide</button>
          <label class="btn primary" style="display:inline-flex;gap:8px;align-items:center">
            Upload PDF
            <input type="file" accept="application/pdf" style="display:none"/>
          </label>
        </div>
      `;
      const btnOpen = box.querySelector("button");
      if (has) btnOpen.onclick = ()=>window.open(current.templateUrl, "_blank");

      const inp = box.querySelector("input[type=file]");
      inp.onchange = async (ev)=>{
        const f = ev.target.files && ev.target.files[0];
        if (!f) return;
        try{
          await uploadTemplate(t.key, t.label, f);
          await loadTemplates();
          renderSettings();
        }catch(err){
          setErr(String(err && err.message ? err.message : err));
        }finally{
          inp.value = "";
        }
      };

      grid.appendChild(box);
    }
  }

  function renderAll(){
    renderCats();
    renderList();
  }

  async function uploadTemplate(typeKey, typeLabel, file){
    if (!state.managerEmail) throw new Error("SeteazÄƒ Manager (email) ca sÄƒ poÈ›i Ã®ncÄƒrca È™abloane.");
    const ab = await file.arrayBuffer();
    const b64url = bytesToB64Url(new Uint8Array(ab));
    const CH = 120000;
    const n = Math.max(1, Math.ceil(b64url.length / CH));

    const initUrl = ENDPOINT + "?fn=adminDocTemplateUploadInit" + keyQS()
      + "&managerEmail=" + encodeURIComponent(state.managerEmail)
      + "&typeKey=" + encodeURIComponent(typeKey)
      + "&typeLabel=" + encodeURIComponent(typeLabel)
      + "&mime=" + encodeURIComponent("application/pdf")
      + "&n=" + n + "&ts=" + Date.now();

    const init = await jsonp(initUrl);
    if (!init || !init.ok) throw new Error(init?.error || "Init failed.");
    const uid = init.uid, uk = init.uk;
    if (!uid || !uk) throw new Error("LipseÈ™te uid/uk.");

    for (let i=0;i<n;i++) {
      const c = b64url.slice(i*CH, (i+1)*CH);
      await postNoCors(ENDPOINT, { uid, uk, i, n, c });
    }

    const finUrl = ENDPOINT + "?fn=adminDocTemplateUploadFinalize" + keyQS()
      + "&uid=" + encodeURIComponent(uid) + "&uk=" + encodeURIComponent(uk)
      + "&n=" + n + "&ts=" + Date.now();
    const fin = await jsonp(finUrl);
    if (!fin || !fin.ok) throw new Error(fin?.error || "Finalize failed.");
    return fin;
  }

  async function refreshAll(){
    setErr("");
    try{
      if (!CFG) CFG = await loadConfig();
      ENDPOINT = endpointBase(CFG);
      if (!ENDPOINT) throw new Error("LipseÈ™te adminEventsEndpoint/leaveEndpoint/documentsEndpoint Ã®n config.json.");

      ensureManager();
      await loadEmployees();
      await loadTemplates();
      await loadDocs();

      renderAll();
      renderSettings();
    }catch(err){
      setErr(String(err && err.message ? err.message : err));
    }
  }

  // events
  $("q").addEventListener("input", (e)=>{ state.q = e.target.value || ""; renderList(); });
  $("btnRefresh").onclick = ()=>refreshAll();
  $("btnReloadTpl").onclick = async ()=>{ try{ await loadTemplates(); renderSettings(); }catch(err){ setErr(String(err && err.message ? err.message : err)); } };

  $("selEmployee").addEventListener("change", async ()=>{
    state.selectedEmployeeName = $("selEmployee").value || "";
    await loadDocs();
    renderAll();
  });

  $("btnSetManager").onclick = ()=>{
    const current = state.managerEmail || "";
    const email = prompt("Email manager/admin (pentru filtrare + È™abloane):", current);
    if (email === null) return;
    const name = prompt("Nume manager (opÈ›ional):", state.managerName || "");
    localStorage.setItem(LS_ADMIN_ME_EMAIL, (email||"").trim());
    localStorage.setItem(LS_ADMIN_ME_NAME, (name||"").trim());
    ensureManager();
    refreshAll();
  };

  // tabs
  function setTab(tab){
    document.querySelectorAll(".tab").forEach(x=>x.classList.toggle("active", x.dataset.tab===tab));
    $("viewSettings").classList.toggle("show", tab==="setari");
    $("viewMain").style.display = (tab==="setari") ? "none" : "block";
  }
  document.querySelectorAll(".tab").forEach(t=>t.addEventListener("click", ()=>setTab(t.dataset.tab)));
  setTab("cereri");

  refreshAll();
</script>
</body>
</html>
