<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Documente â€¢ Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#F6F7FB;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --border:rgba(15,23,42,.08);
      --accent:#6D5EF1;
      --accent2:#8A7BFF;
      --shadow: 0 12px 40px rgba(15,23,42,.08);
      --shadow2: 0 10px 24px rgba(15,23,42,.10);
      --radius:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .page{padding:18px 20px;}
    .topTabs{display:flex;gap:22px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
    .tab{font-weight:800;color:rgba(15,23,42,.55);padding:8px 4px;border-bottom:3px solid transparent;cursor:pointer;user-select:none}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);}
    .grid{display:grid;grid-template-columns: 420px 1fr;gap:18px;}
    @media (max-width: 1100px){.grid{grid-template-columns:1fr;}}
    .left{padding:14px}
    .right{padding:14px}
    .catList{display:flex;flex-direction:column;gap:12px}
    .cat{padding:16px 18px;border-radius:18px;border:1px solid rgba(15,23,42,.08);background:#fff;cursor:pointer}
    .cat:hover{background:rgba(109,94,241,.04)}
    .cat.active{background:var(--accent);border-color:rgba(109,94,241,.35);color:#fff}
    .cat .count{font-size:13px;font-weight:900;opacity:.7}
    .cat.active .count{opacity:.9}
    .cat .label{font-size:24px;font-weight:900;margin-top:2px;letter-spacing:-.02em}
    .actionsRow{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap}
    .rightTitle{font-size:18px;font-weight:900}
    .btn{border:1px solid rgba(15,23,42,.12);background:#fff;color:var(--text);border-radius:14px;padding:10px 12px;font-weight:900;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:rgba(109,94,241,.35);color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .searchRow{display:flex;gap:12px;align-items:center;margin:6px 0 14px}
    .search{flex:1;display:flex;gap:10px;align-items:center;background:#fff;border:1px solid var(--border);border-radius:18px;padding:12px 14px;}
    .search input{border:0;outline:0;width:100%;font-size:14px}
    .list{border:1px solid rgba(15,23,42,.08);border-radius:18px;overflow:hidden;background:#fff}
    .row{display:grid;grid-template-columns: 160px 1fr 180px;gap:10px;align-items:center;padding:14px 14px;border-bottom:1px solid rgba(15,23,42,.06)}
    .row:last-child{border-bottom:0}
    .date{font-weight:900;font-size:16px;color:#0b1220;display:flex;gap:10px;align-items:center}
    .docIcon{width:34px;height:34px;border-radius:12px;border:1px solid rgba(15,23,42,.10);display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.02)}
    .name{font-weight:900;font-size:18px;}
    .sub{color:rgba(15,23,42,.55);font-weight:800;margin-top:2px}
    .open{justify-self:end}
    .empty{padding:20px;color:rgba(15,23,42,.55);font-weight:800}
    .note{margin-top:12px;color:rgba(15,23,42,.55);font-weight:800}
    .err{margin:10px 0 0;color:#b91c1c;font-weight:900}

    /* employee picker */
    .picker{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .select{flex:1;min-width:240px;border:1px solid rgba(15,23,42,.12);border-radius:14px;padding:10px 12px;font-weight:800;background:#fff}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid rgba(15,23,42,.12);border-radius:999px;font-weight:900;color:rgba(15,23,42,.65);background:rgba(15,23,42,.02)}

    /* settings tab */
    .settingsWrap{display:none}
    .settingsWrap.show{display:block}
    .tplGrid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    .tpl{border:1px solid rgba(15,23,42,.10);border-radius:18px;padding:14px;background:#fff;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .tpl .leftSide{display:flex;flex-direction:column;gap:4px}
    .tpl .ttl{font-weight:900}
    .tpl .meta{font-weight:800;color:rgba(15,23,42,.55)}
    .tiny{font-size:12px}
  </style>
</head>
<body>
  <div class="page">
    <div class="topTabs">
      <div class="tab active" data-tab="cereri">Documentele cereri</div>
      <div class="tab" data-tab="contractuale">Documente contractuale</div>
      <div class="tab" data-tab="adeverinte">AdeverinÈ›e</div>
      <div class="tab" data-tab="altele">Alte documente</div>
      <div class="tab" data-tab="publice">Documente publice</div>
      <div class="tab" data-tab="setari">SetÄƒri cereri</div>
    </div>

    <div class="grid">
      <div class="card left">
        <div class="picker">
          <select class="select" id="selEmployee"></select>
          <button class="btn" id="btnSetManager" type="button">Manager</button>
        </div>
        <div class="pill" id="mgrPill">Manager: â€”</div>
        <div style="height:10px"></div>
        <div class="catList" id="catList"></div>
        <div class="note">Aici vezi doar PDF-urile completate (digitale), nu cererile brute.</div>
        <div class="err" id="err"></div>
      </div>

      <div class="card right">
        <div id="viewMain">
          <div class="actionsRow">
            <div>
              <div class="rightTitle" id="rightTitle">â€”</div>
              <div class="pill" id="empPill" title="Angajat">Angajat: â€”</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <button class="btn" id="btnRefresh" type="button">Refresh</button>
            </div>
          </div>

          <div class="searchRow">
            <div class="search">
              <span style="opacity:.55;font-weight:900">ðŸ”Ž</span>
              <input id="q" placeholder="CautÄƒ..." />
            </div>
          </div>

          <div class="list" id="list"></div>
        </div>

        <div id="viewSettings" class="settingsWrap">
          <div class="actionsRow">
            <div>
              <div class="rightTitle">SetÄƒri cereri</div>
              <div class="note">ÃŽncarcÄƒ È™abloane PDF fillable pentru fiecare tip. AngajaÈ›ii vor vedea buton de completare.</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <button class="btn" id="btnReloadTpl" type="button">Reload È™abloane</button>
            </div>
          </div>
          <div class="tplGrid" id="tplGrid"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  const DOC_TYPES = [
  { key:'concediu_odihna', label:'Concedii de odihnÄƒ' },
  { key:'concediu_medical', label:'Concedii medicale' },
  { key:'concediu_fara_plata', label:'Concedii fÄƒrÄƒ platÄƒ' },
  { key:'telemunca', label:'Cereri telemuncÄƒ' },
  { key:'ore_suplimentare', label:'Cereri de ore suplimentare' },
  { key:'evenimente', label:'Cereri evenimente' },
  { key:'invoire', label:'Cereri Ã®nvoire' }
];

  const LS_ADMIN_KEY = "pontaj_adminKey";
  const LS_ADMIN_ME_EMAIL = "pontaj_admin_me_email";
  const LS_ADMIN_ME_NAME  = "pontaj_admin_me_name";
  const LS_ADMIN_SESSION  = "pontaj/admin/v1";
  const LS_ADMIN_SESSION_FALLBACK = "pontaj_admin_session";

  let CFG = null;
  let ENDPOINT = "";
  let state = {
    managerEmail: "",
    managerName: "",
    employees: [],
    selectedEmployeeName: "",
    docs: [],
    templates: {},
    selectedType: DOC_TYPES[0].key,
    q: ""
  };

  function $(id){ return document.getElementById(id); }

  async function loadConfig(){
    const tries = ["config.json","./config.json","../config.json","/config.json"];
    let lastErr = null;
    for (const p of tries){
      try{
        const r = await fetch(p + "?v=" + Date.now(), {cache:"no-store"});
        if (!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      }catch(e){ lastErr = e; }
    }
    throw lastErr || new Error("Nu pot citi config.json.");
  }

  function endpointBase(cfg){
    const raw = cfg.documentsEndpoint || cfg.adminEventsEndpoint || cfg.leaveEndpoint || cfg.webappUrl || cfg.scriptUrl || "";
    return String(raw||"").replace(/\?.*$/, "").trim();
  }

  function keyQS(){
    const k = (CFG && CFG.adminKey) ? String(CFG.adminKey) : "";
    const ls = (localStorage.getItem("ADMIN_KEY") || localStorage.getItem(LS_ADMIN_KEY) || "");
    const key = (k || ls || "").trim();
    return key ? ("&key=" + encodeURIComponent(key)) : "";
  }

  function jsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement("script");
      const cleanup = ()=>{ try{delete window[cb];}catch(_){
      }; s.remove(); };
      const t = setTimeout(()=>{ cleanup(); reject(new Error("JSONP timeout")); }, 25000);
      window[cb] = (data)=>{ clearTimeout(t); cleanup(); resolve(data); };
      s.onerror = ()=>{ clearTimeout(t); cleanup(); reject(new Error("JSONP error")); };
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
      document.head.appendChild(s);
    });
  }

  async function postNoCors(endpoint, payload){
    await fetch(endpoint + "?fn=adminDocTemplateUploadChunkPost", {
      method:"POST",
      mode:"no-cors",
      headers:{"Content-Type":"text/plain;charset=UTF-8"},
      body: JSON.stringify(Object.assign({}, payload, { fn:"adminDocTemplateUploadChunkPost" }))
    });
  }

  function bytesToB64Url(bytes){
    let bin = "";
    const chunk = 0x8000;
    for (let i=0;i<bytes.length;i+=chunk){
      bin += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));
    }
    const b64 = btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    return b64;
  }

  function fmtDate(d){
    try{
      const dt = new Date(d);
      if (isNaN(dt)) return "";
      const dd = String(dt.getDate()).padStart(2,'0');
      const mm = String(dt.getMonth()+1).padStart(2,'0');
      const yy = dt.getFullYear();
      return dd + "." + mm + "." + yy;
    }catch(_){
      return "";
    }
  }

  function setErr(msg){ $("err").textContent = msg || ""; }

  
  // ===== Admin identity (who am I?) =====
  const ADMINS = { loaded:false, list:[], byEmail:new Map(), byName:new Map() };

  function _parseAdminAuth(data){
    const arr = Array.isArray(data) ? data : (data.admins || data.list || data.users || []);
    const list = (Array.isArray(arr) ? arr : [])
      .map(a => ({
        name: String(a.label || a.name || a.displayName || a.n || a.user || a.username || a.managerName || '').trim(),
        email: String(a.email || a.e || a.mail || a.managerEmail || '').trim()
      }))
      .filter(a => a.name || a.email);

    // de-dup (by email|name)
    const seen = new Set();
    const dedup = list.filter(a=>{
      const k = (a.email||'').toLowerCase() + '|' + (a.name||'').toLowerCase();
      if (seen.has(k)) return false;
      seen.add(k);
      return true;
    });

    ADMINS.list = dedup;
    ADMINS.byEmail = new Map(ADMINS.list.filter(a=>a.email).map(a=>[a.email.toLowerCase(), a]));
    ADMINS.byName  = new Map(ADMINS.list.filter(a=>a.name).map(a=>[a.name.toLowerCase(), a]));
  }

  async function loadAdminAuth(){
    if (ADMINS.loaded) return;
    ADMINS.loaded = true;

    try{
      const cfg = (window.CFG || CFG || {}) || {};
      const candidates = [];
      const mainUrl = String(cfg.adminAuthUrl || '').trim();
      if (mainUrl) candidates.push(mainUrl);
      candidates.push('admin-auth.json','./admin-auth.json','../admin-auth.json','/admin-auth.json');

      const seen = new Set();
      const urls = candidates
        .map(u => String(u || '').trim())
        .filter(u => u && !seen.has(u) && (seen.add(u), true));

      let lastErr = null;
      for (const u of urls){
        try{
          const r = await fetch(u + (u.includes('?') ? '&' : '?') + 'v=' + Date.now(), {cache:'no-store'});
          if (!r.ok) throw new Error('HTTP ' + r.status);
          const data = await r.json();
          _parseAdminAuth(data);
          return;
        }catch(e){ lastErr = e; }
      }
      if (lastErr) console.warn('admin-auth load failed:', lastErr);
    }catch(e){
      console.warn('admin-auth load failed:', e);
    }
  }

  function _detectAdminIdentity(){
    // Best-effort: try known session keys used in other admin pages
    const keys = ["pontaj/admin/v1","pontaj_admin_session","pontaj_admin","admin_session"];
    for (const k of keys){
      let raw = "";
      try{ raw = (localStorage.getItem(k) || "").trim(); }catch(e){}
      if (!raw) continue;

      // sometimes value can be plain id/email
      if (raw[0] !== "{"){
        return { id: raw, name: "" };
      }

      try{
        const o = JSON.parse(raw);
        if (!o) continue;

        // NOTE: in unele pagini o.user poate fi nume (nu email). AcceptÄƒm ca "id".
        const id = String(o.email || o.userEmail || o.user || o.username || o.login || o.mail || o.id || "").trim();
        const name = String(o.label || o.name || o.fullName || o.displayName || o.userName || "").trim();

        if (id) return { id, name };
        if (name) return { id: name, name: "" };
      }catch(e){}
    }
    return null;
  }


  function _readAdminSessionObj_(){
    const keys = [LS_ADMIN_SESSION, LS_ADMIN_SESSION_FALLBACK, "pontaj_admin", "admin_session"];
    for (const k of keys){
      let raw = "";
      try{ raw = (localStorage.getItem(k) || "").trim(); }catch(e){}
      if (!raw) continue;
      if (raw[0] !== "{") return { user: raw };
      try{ return JSON.parse(raw); }catch(e){}
    }
    return null;
  }

  function _writeAdminSessionObj_(obj){
    try{ localStorage.setItem(LS_ADMIN_SESSION, JSON.stringify(obj||{})); }catch(e){}
  }

  function openAdminIdentityPicker(){
    // Returns {name,email} or null
    return new Promise(async (resolve)=>{
      try{ await loadAdminAuth(); }catch(e){}
      const list = (ADMINS && ADMINS.list) ? ADMINS.list.slice() : [];
      if (!list.length){
        resolve(null);
        return;
      }

      const ov = document.createElement('div');
      ov.style.cssText = "position:fixed;inset:0;background:rgba(15,23,42,.45);display:flex;align-items:center;justify-content:center;z-index:99999;";
      const card = document.createElement('div');
      card.style.cssText = "width:min(520px,92vw);background:#fff;border-radius:18px;box-shadow:0 20px 60px rgba(15,23,42,.25);padding:18px 18px 14px;font-family:Inter,system-ui,Segoe UI,Arial;";

      const h = document.createElement('div');
      h.style.cssText = "display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px";
      const title = document.createElement('div');
      title.textContent = "SelecteazÄƒ contul tÄƒu admin/manager";
      title.style.cssText = "font-weight:800;font-size:18px;color:#0f172a";
      const x = document.createElement('button');
      x.textContent = "âœ•";
      x.style.cssText = "border:0;background:#f1f5f9;border-radius:12px;width:38px;height:38px;cursor:pointer;font-weight:800";
      h.appendChild(title); h.appendChild(x);

      const sub = document.createElement('div');
      sub.textContent = "Se salveazÄƒ local È™i te recunoaÈ™te global Ã®n toate paginile Admin.";
      sub.style.cssText = "color:#475569;font-size:13px;margin-bottom:10px";

      const lab = document.createElement('label');
      lab.textContent = "Admin/Manager";
      lab.style.cssText = "display:block;font-size:12px;color:#334155;margin-bottom:6px";

      const sel = document.createElement('select');
      sel.style.cssText = "width:100%;padding:12px 12px;border:1px solid #e2e8f0;border-radius:12px;font-size:14px";

      list.forEach(a=>{
        const opt = document.createElement('option');
        const val = String((a.email || a.name || '')).trim();
        const text = (a.name && a.email) ? (a.name + " â€” " + a.email) : (a.name || a.email || '');
        opt.value = val;
        opt.textContent = text || val || 'Admin';
        sel.appendChild(opt);
      });

      // preselect if we have something already
      const ses = _readAdminSessionObj_() || {};
      const pre = String(ses.email || ses.userEmail || ses.user || "").trim();
      if (pre){
        for (const o of sel.options){
          if (String(o.value||"").toLowerCase() === pre.toLowerCase()){
            sel.value = o.value;
            break;
          }
        }
      }

      const btnRow = document.createElement('div');
      btnRow.style.cssText = "display:flex;gap:10px;justify-content:flex-end;margin-top:14px";
      const cancel = document.createElement('button');
      cancel.textContent = "AnuleazÄƒ";
      cancel.style.cssText = "padding:10px 14px;border-radius:12px;border:1px solid #e2e8f0;background:#fff;cursor:pointer;font-weight:700";
      const ok = document.createElement('button');
      ok.textContent = "SalveazÄƒ";
      ok.style.cssText = "padding:10px 14px;border-radius:12px;border:0;background:#6d5efc;color:#fff;cursor:pointer;font-weight:800";
      btnRow.appendChild(cancel); btnRow.appendChild(ok);

      card.appendChild(h);
      card.appendChild(sub);
      card.appendChild(lab);
      card.appendChild(sel);
      card.appendChild(btnRow);
      ov.appendChild(card);
      document.body.appendChild(ov);

      function close(val){
        try{ ov.remove(); }catch(e){}
        resolve(val||null);
      }
      ov.addEventListener('click', (e)=>{ if(e.target===ov) close(null); });
      x.onclick = ()=>close(null);
      cancel.onclick = ()=>close(null);
      ok.onclick = ()=>{
        const v = String(sel.value||"").trim();
        const found = list.find(a => String((a.email||a.name||'')).trim() === v) || null;
        close(found || {name:v, email:""});
      };
    });
  }

  async function ensureManager(){
    let meId   = "";
    let meName = "";

    try{ meId   = (localStorage.getItem(LS_ADMIN_ME_EMAIL) || "").trim(); }catch(e){}
    try{ meName = (localStorage.getItem(LS_ADMIN_ME_NAME)  || "").trim(); }catch(e){}

    // fallback: infer from admin session (most admin pages already set it)
    if (!meId){
      const id = _detectAdminIdentity();
      if (id && id.id){
        meId = String(id.id || "").trim();
        if (!meName) meName = String(id.name || "").trim();

        // persist for next time, so upload works without prompt
        try{ localStorage.setItem(LS_ADMIN_ME_EMAIL, meId); }catch(e){}
        if (meName) try{ localStorage.setItem(LS_ADMIN_ME_NAME, meName); }catch(e){}
      }
    }
    // if still not set, ask once (picker) and persist session for global use
    if (!meId){
      const pick = await openAdminIdentityPicker();
      if (pick){
        meId = String((pick.email || pick.name || "")).trim();
        meName = String((pick.name || pick.email || "")).trim();
        try{ localStorage.setItem(LS_ADMIN_ME_EMAIL, meId); }catch(e){}
        try{ localStorage.setItem(LS_ADMIN_ME_NAME,  meName); }catch(e){}
        // also persist global admin session so every page recognizes you
        const ses = _readAdminSessionObj_() || {};
        const out = Object.assign({}, ses, { user: meName || meId || ses.user || 'Admin', email: (meId.includes('@') ? meId : (ses.email||'')), at: new Date().toISOString() });
        _writeAdminSessionObj_(out);
      }
    }



    // If we only have a name/label, try to resolve to real email from admin-auth.json (if available)
    await loadAdminAuth();
    if (meId && !meId.includes("@")){
      const k = meId.toLowerCase();
      const a = ADMINS.byEmail.get(k) || ADMINS.byName.get(k) || null;
      if (a && a.email){
        state.managerEmail = String(a.email).trim();
        state.managerName  = meName || a.name || meId;
      }else{
        // fallback: use id as-is (compat with managerEmail stored as label)
        state.managerEmail = meId;
        state.managerName  = meName || meId;
      }
    }else if (meId){
      state.managerEmail = meId;
      state.managerName  = meName;
    }

    $("mgrPill").textContent = "Manager: " + ((state.managerName || state.managerEmail) || "â€”");
  }
async function loadEmployees(){
    const url = ENDPOINT + "?fn=adminEmployees" + keyQS() + "&ts=" + Date.now();
    const data = await jsonp(url);
    if (!data || !data.ok) throw new Error(data?.error || "Nu pot Ã®ncÄƒrca lista de angajaÈ›i.");
    const list = data.employees || data.list || data.rows || [];
    state.employees = Array.isArray(list) ? list : [];

    // filter by managerEmail if set
    let visible = state.employees;
    if (state.managerEmail) {
      visible = visible.filter(e => String(e.managerEmail||"").toLowerCase() === state.managerEmail.toLowerCase());
    }

    // fill select
    const sel = $("selEmployee");
    sel.innerHTML = "";
    if (!visible.length) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = state.managerEmail ? "Nu ai angajaÈ›i repartizaÈ›i." : "Niciun angajat.";
      sel.appendChild(opt);
      state.selectedEmployeeName = "";
      return;
    }
    for (const e of visible) {
      const opt = document.createElement("option");
      opt.value = e.name || "";
      opt.textContent = (e.name || "â€”") + (e.dept ? (" â€¢ " + e.dept) : "");
      sel.appendChild(opt);
    }
    state.selectedEmployeeName = sel.value || visible[0].name || "";
    $("empPill").textContent = "Angajat: " + (state.selectedEmployeeName || "â€”");
  }

  async function loadTemplates(){
    if (!state.managerEmail) {
      state.templates = {};
      return;
    }
    const url = ENDPOINT + "?fn=adminDocTemplatesGet" + keyQS()
      + "&managerEmail=" + encodeURIComponent(state.managerEmail)
      + "&ts=" + Date.now();
    const data = await jsonp(url);
    if (!data || !data.ok) throw new Error(data?.error || "Nu pot Ã®ncÄƒrca È™abloanele.");
    state.templates = data.map || {};
  }

  async function loadDocs(){
    if (!state.managerEmail) {
      state.docs = [];
      return;
    }
    const emp = state.selectedEmployeeName || "";
    const url = ENDPOINT + "?fn=adminDocumentsList" + keyQS()
      + "&managerEmail=" + encodeURIComponent(state.managerEmail)
      + (emp ? ("&employeeName=" + encodeURIComponent(emp)) : "")
      + "&ts=" + Date.now();
    const data = await jsonp(url);
    if (!data || !data.ok) throw new Error(data?.error || "Nu pot Ã®ncÄƒrca documentele.");
    state.docs = Array.isArray(data.list) ? data.list : [];
  }

  function renderCats(){
    const wrap = $("catList");
    wrap.innerHTML = "";
    const counts = new Map(DOC_TYPES.map(t=>[t.key, 0]));
    for (const d of state.docs) counts.set(d.typeKey, (counts.get(d.typeKey)||0)+1);

    for (const t of DOC_TYPES){
      const div = document.createElement("div");
      div.className = "cat" + (t.key===state.selectedType ? " active" : "");
      const c = counts.get(t.key)||0;
      div.innerHTML = `
        <div class="count">${c} fiÈ™iere</div>
        <div class="label">${t.label}</div>
      `;
      div.onclick = ()=>{ state.selectedType = t.key; renderAll(); };
      wrap.appendChild(div);
    }
  }

  function renderList(){
    const list = $("list");
    const t = DOC_TYPES.find(x=>x.key===state.selectedType) || DOC_TYPES[0];
    $("rightTitle").textContent = t.label;
    $("empPill").textContent = "Angajat: " + (state.selectedEmployeeName || "â€”");

    const q = state.q.trim().toLowerCase();
    const filtered = state.docs
      .filter(d => d.typeKey === state.selectedType)
      .filter(d => !q || (String(d.typeLabel||"").toLowerCase().includes(q) || String(d.docId||"").toLowerCase().includes(q)));

    if (!filtered.length){
      list.innerHTML = `<div class="empty">Nu existÄƒ documente completate pentru aceastÄƒ categorie.</div>`;
      return;
    }

    list.innerHTML = "";
    for (const d of filtered){
      const row = document.createElement("div");
      row.className = "row";
      const date = fmtDate(d.createdAt);
      row.innerHTML = `
        <div class="date"><span class="docIcon">ðŸ“„</span> <span>${date}</span></div>
        <div>
          <div class="name">${d.typeLabel || t.label}</div>
          <div class="sub">${d.employeeName || ""}</div>
        </div>
        <div class="open">
          <button class="btn" type="button">Deschide</button>
        </div>
      `;
      row.querySelector("button").onclick = ()=>{ window.open(d.pdfUrl, "_blank"); };
      list.appendChild(row);
    }
  }

  function renderSettings(){
    const grid = $("tplGrid");
    grid.innerHTML = "";
    for (const t of DOC_TYPES){
      const current = state.templates[t.key] || null;
      const box = document.createElement("div");
      box.className = "tpl";
      const has = !!(current && current.templateUrl);
      box.innerHTML = `
        <div class="leftSide">
          <div class="ttl">${t.label}</div>
          <div class="meta tiny">${has ? "È˜ablon setat" : "LipseÈ™te È™ablon"}</div>
          <div class="meta tiny">${has && current.updatedAt ? ("Actualizat: " + fmtDate(current.updatedAt)) : ""}</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button class="btn" type="button" ${has ? "" : "disabled"}>Deschide</button>
          <label class="btn primary" style="display:inline-flex;gap:8px;align-items:center">
            Upload PDF
            <input type="file" accept="application/pdf" style="display:none"/>
          </label>
        </div>
      `;
      const btnOpen = box.querySelector("button");
      if (has) btnOpen.onclick = ()=>window.open(current.templateUrl, "_blank");

      const inp = box.querySelector("input[type=file]");
      inp.onchange = async (ev)=>{
        const f = ev.target.files && ev.target.files[0];
        if (!f) return;
        try{
          await uploadTemplate(t.key, t.label, f);
          await loadTemplates();
          renderSettings();
        }catch(err){
          setErr(String(err && err.message ? err.message : err));
        }finally{
          inp.value = "";
        }
      };

      grid.appendChild(box);
    }
  }

  function renderAll(){
    renderCats();
    renderList();
  }

  async function uploadTemplate(typeKey, typeLabel, file){
    if (!state.managerEmail){ await ensureManager(); }
    if (!state.managerEmail) throw new Error("Nu eÈ™ti identificat ca admin/manager. IntrÄƒ Ã®n index.html È™i fÄƒ login (sau apasÄƒ Â«SeteazÄƒ ManagerÂ» o singurÄƒ datÄƒ).");
    const ab = await file.arrayBuffer();
    const b64url = bytesToB64Url(new Uint8Array(ab));
    const CH = 120000;
    const n = Math.max(1, Math.ceil(b64url.length / CH));

    const initUrl = ENDPOINT + "?fn=adminDocTemplateUploadInit" + keyQS()
      + "&managerEmail=" + encodeURIComponent(state.managerEmail)
      + "&typeKey=" + encodeURIComponent(typeKey)
      + "&typeLabel=" + encodeURIComponent(typeLabel)
      + "&mime=" + encodeURIComponent("application/pdf")
      + "&n=" + n + "&ts=" + Date.now();

    const init = await jsonp(initUrl);
    if (!init || !init.ok) throw new Error(init?.error || "Init failed.");
    const uid = init.uid, uk = init.uk;
    if (!uid || !uk) throw new Error("LipseÈ™te uid/uk.");

    for (let i=0;i<n;i++) {
      const c = b64url.slice(i*CH, (i+1)*CH);
      await postNoCors(ENDPOINT, { uid, uk, i, n, c });
    }

    const finUrl = ENDPOINT + "?fn=adminDocTemplateUploadFinalize" + keyQS()
      + "&uid=" + encodeURIComponent(uid) + "&uk=" + encodeURIComponent(uk)
      + "&n=" + n + "&ts=" + Date.now();
    const fin = await jsonp(finUrl);
    if (!fin || !fin.ok) throw new Error(fin?.error || "Finalize failed.");
    return fin;
  }

  async function refreshAll(){
    setErr("");
    try{
      if (!CFG) CFG = await loadConfig();
      ENDPOINT = endpointBase(CFG);
      if (!ENDPOINT) throw new Error("LipseÈ™te adminEventsEndpoint/leaveEndpoint/documentsEndpoint Ã®n config.json.");

      await ensureManager();
      await loadEmployees();
      await loadTemplates();
      await loadDocs();

      renderAll();
      renderSettings();
    }catch(err){
      setErr(String(err && err.message ? err.message : err));
    }
  }

  // events
  $("q").addEventListener("input", (e)=>{ state.q = e.target.value || ""; renderList(); });
  $("btnRefresh").onclick = ()=>refreshAll();
  $("btnReloadTpl").onclick = async ()=>{ try{ await loadTemplates(); renderSettings(); }catch(err){ setErr(String(err && err.message ? err.message : err)); } };

  $("selEmployee").addEventListener("change", async ()=>{
    state.selectedEmployeeName = $("selEmployee").value || "";
    await loadDocs();
    renderAll();
  });

  $("btnSetManager").onclick = ()=>{
    const current = state.managerEmail || "";
    const email = prompt("Identitate manager/admin (email sau nume/label) â€” pentru filtrare + È™abloane:", current);
    if (email === null) return;
    const name = prompt("Nume manager (opÈ›ional):", state.managerName || "");
    localStorage.setItem(LS_ADMIN_ME_EMAIL, (email||"").trim());
    localStorage.setItem(LS_ADMIN_ME_NAME, (name||"").trim());
    ensureManager().then(()=>refreshAll());
  };

  // tabs
  function setTab(tab){
    document.querySelectorAll(".tab").forEach(x=>x.classList.toggle("active", x.dataset.tab===tab));
    $("viewSettings").classList.toggle("show", tab==="setari");
    $("viewMain").style.display = (tab==="setari") ? "none" : "block";
  }
  document.querySelectorAll(".tab").forEach(t=>t.addEventListener("click", ()=>setTab(t.dataset.tab)));
  setTab("cereri");

  refreshAll();
</script>
</body>
</html>
