<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Documente • Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#F6F7FB;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(15,23,42,.08);
      --accent:#6D5EF1;
      --accent2:#8A7BFF;
      --shadow: 0 12px 40px rgba(15,23,42,.08);
      --shadow2: 0 10px 24px rgba(15,23,42,.10);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:1500px;
      margin:0 auto;
      padding:18px 16px 22px;
    }
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .title{
      font-weight:900;
      font-size:18px;
      letter-spacing:.2px;
    }
    .sub{
      margin-top:4px;
      color:rgba(100,116,139,.9);
      font-weight:700;
      font-size:12px;
    }
    .topRight{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .chip{
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--border);
      background:#fff;
      box-shadow: 0 6px 16px rgba(15,23,42,.06);
      font-weight:800;
      color:rgba(15,23,42,.82);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .avatarWrap{
      position:relative;
      width:40px;height:40px;
      border-radius:999px;
      overflow:hidden;
      border:2px solid #fff;
      box-shadow: 0 10px 22px rgba(15,23,42,.10);
      background:#eef1ff;
      display:grid;place-items:center;
      font-weight:800;
      color:#374151;
      flex:0 0 auto;
    }
    .avatarWrap img{width:100%;height:100%;object-fit:cover;display:block}

    .layout{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      align-items:start;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* Employee list */
    .empHead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(15,23,42,.06);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .search{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      width:100%;
    }
    .search input{
      border:0;outline:none;background:transparent;
      width:100%;
      font:inherit;
      font-weight:700;
    }
    .empList{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: calc(100vh - 180px);
      overflow:auto;
    }
    .emp{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 12px;
      border-radius:18px;
      border:1px solid rgba(15,23,42,.08);
      background:#fff;
      cursor:pointer;
      transition:.15s ease;
    }
    .emp:hover{ border-color: rgba(109,94,241,.22); background: rgba(109,94,241,.03); }
    .emp.active{
      background: rgba(109,94,241,.08);
      border-color: rgba(109,94,241,.35);
      box-shadow: 0 18px 34px rgba(109,94,241,.10);
    }
    .empAva{
      width:38px;height:38px;border-radius:999px;
      background:#eef1ff;border:2px solid #fff;
      box-shadow:0 10px 18px rgba(15,23,42,.10);
      overflow:hidden;display:grid;place-items:center;
      font-weight:900;color:#374151;
      flex:0 0 auto;
    }
    .empAva img{width:100%;height:100%;object-fit:cover;display:block}
    .empMeta{min-width:0}
    .empName{
      font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .empDept{
      margin-top:2px;
      color:rgba(100,116,139,.9);
      font-weight:700;
      font-size:12px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* Documents UI (same look as employee-documents) */
    .tabs{
      display:flex;
      gap:26px;
      flex-wrap:wrap;
      align-items:flex-end;
      padding:12px 16px 0;
    }
    .tab{
      background:transparent;
      border:0;
      padding:10px 2px;
      font:inherit;
      cursor:pointer;
      color:var(--muted);
      font-weight:700;
      position:relative;
    }
    .tab.active{ color:var(--accent); }
    .tab.active:after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:2px;
      height:3px;
      border-radius:99px;
      background:var(--accent);
    }

    .docBody{
      padding:14px 16px 16px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      align-items:start;
    }
    .catCard{
      border:1px solid rgba(15,23,42,.08);
      border-radius:22px;
      overflow:hidden;
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
      background:#fff;
    }
    .leftList{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .cat{
      border:1px solid rgba(15,23,42,.08);
      border-radius:18px;
      padding:14px 16px;
      cursor:pointer;
      background:#fff;
      transition:.15s ease;
    }
    .cat:hover{ border-color: rgba(109,94,241,.22); background: rgba(109,94,241,.03); }
    .cat.active{
      background: linear-gradient(180deg, rgba(109,94,241,.95), rgba(109,94,241,.80));
      border-color: rgba(109,94,241,.25);
      color:#fff;
      box-shadow: 0 18px 34px rgba(109,94,241,.22);
    }
    .cat .count{
      font-weight:700;
      font-size:13px;
      color:rgba(100,116,139,.9);
    }
    .cat.active .count{ color: rgba(255,255,255,.82); }
    .cat .name{
      margin-top:2px;
      font-weight:800;
      font-size:18px;
      letter-spacing:.2px;
    }

    .right{
      border:1px solid rgba(15,23,42,.08);
      border-radius:22px;
      overflow:hidden;
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
      background:#fff;
      padding:16px;
    }
    .searchRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .docSearch{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid rgba(15,23,42,.08);
      border-radius:16px;
      background:#fff;
      min-width:260px;
      max-width:420px;
      width:100%;
    }
    .docSearch input{border:0;outline:none;font:inherit;width:100%;font-weight:600;background:transparent}
    .thead{
      display:grid;
      grid-template-columns: 120px 1fr;
      padding:10px 12px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.2px;
    }
    .row{
      display:grid;
      grid-template-columns: 44px 120px 1fr;
      align-items:center;
      gap:12px;
      padding:14px 12px;
      border-top:1px solid rgba(15,23,42,.06);
    }
    .fileIco{
      width:34px;height:34px;border-radius:12px;
      border:1px solid rgba(15,23,42,.08);
      background:rgba(15,23,42,.03);
      display:grid;place-items:center;
    }
    .dateCell{
      font-weight:800;
      font-size:18px;
      color:#111827;
      letter-spacing:.2px;
    }
    .nameCell .title{
      font-weight:900;
      font-size:18px;
      color:#111827;
      letter-spacing:.2px;
      line-height:1.12;
    }
    .nameCell .sub{
      margin-top:4px;
      font-weight:700;
      color:rgba(100,116,139,.9);
    }
    .footerNav{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      padding:14px 6px 0;
    }
    .pagerBtn{
      width:44px;height:44px;border-radius:16px;
      border:1px solid rgba(15,23,42,.08);
      background:#fff;
      cursor:pointer;
      display:grid;place-items:center;
      box-shadow: 0 6px 16px rgba(15,23,42,.06);
    }
    .pagerBtn:disabled{opacity:.45; cursor:not-allowed; box-shadow:none}
    .empty{
      padding:22px 12px;
      color:rgba(100,116,139,.95);
      font-weight:800;
    }
    .hint{
      padding:10px 12px 0;
      color:rgba(100,116,139,.85);
      font-weight:700;
      font-size:12px;
    }

    @media(max-width:1200px){
      .layout{grid-template-columns: 1fr;}
      .docBody{grid-template-columns: 1fr;}
      .empList{max-height:none}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">Documente angajați</div>
        <div class="sub">Alege un angajat repartizat ție și vezi documentele/cererile lui (concedii, învoiri etc.).</div>
      </div>

      <div class="topRight">
        <div class="chip" id="meChip" title="Cont admin">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 11a4 4 0 100-8 4 4 0 000 8z" stroke="currentColor" stroke-width="2"/>
          </svg>
          <span id="meLabel">Admin</span>
        </div>
        <div class="avatarWrap" title="Profil">
          <img id="meAvatarImg" alt="" style="display:none"/>
          <div id="meAvatarFallback">•</div>
        </div>
      </div>
    </div>

    <div class="layout">
      <div class="card">
        <div class="empHead">
          <div class="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M11 19a8 8 0 110-16 8 8 0 010 16z" stroke="currentColor" stroke-width="2"/>
            </svg>
            <input id="empQ" placeholder="Caută angajat" />
          </div>
        </div>
        <div class="empList" id="empList"></div>
      </div>

      <div class="card">
        <div class="tabs" id="tabs"></div>
        <div class="docBody">
          <div class="catCard">
            <div class="leftList" id="cats"></div>
          </div>

          <div class="right">
            <div class="searchRow">
              <div class="docSearch">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M11 19a8 8 0 110-16 8 8 0 010 16z" stroke="currentColor" stroke-width="2"/>
                </svg>
                <input id="q" placeholder="Caută" />
              </div>
              <div style="font-weight:800;color:rgba(100,116,139,.85)" id="meta">—</div>
            </div>

            <div class="thead">
              <div>DATĂ</div>
              <div>NUME</div>
            </div>

            <div id="rows"></div>

            <div class="footerNav">
              <button class="pagerBtn" id="prev" title="Pagina anterioară">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <button class="pagerBtn" id="next" title="Pagina următoare">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>

            <div class="hint" id="hint"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  function esc(s){
    return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }
  function initials(name){
    const p = String(name||"").trim().split(/\\s+/).filter(Boolean);
    const a = p[0]?.[0]||"";
    const b = p[1]?.[0]||"";
    return (a+b).toUpperCase() || "•";
  }
  function ddmmyyyy(isoDate){
    const s = String(isoDate||"").trim();
    if (!s) return "—";
    const m = s.match(/^(\\d{4})-(\\d{2})-(\\d{2})/);
    if (m) return `${m[3]}.${m[2]}.${m[1]}`;
    const d = new Date(s);
    if (!isNaN(d)) {
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${dd}.${mm}.${yy}`;
    }
    return s;
  }
  function ymFromDate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    return `${y}-${m}`;
  }
  function lastMonths(n){
    const out = [];
    const d = new Date();
    d.setDate(1);
    for (let i=0;i<n;i++){
      out.push(ymFromDate(d));
      d.setMonth(d.getMonth()-1);
    }
    return out;
  }

  function jsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(16).slice(2);
      const s = document.createElement("script");
      let done = false;
      window[cb] = (data)=>{ done = true; cleanup(); resolve(data); };
      function cleanup(){
        try{ delete window[cb]; }catch(e){ window[cb] = undefined; }
        try{ s.remove(); }catch(e){}
      }
      s.onerror = ()=>{ if (done) return; cleanup(); reject(new Error("JSONP error")); };
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb + "&_=" + Date.now();
      document.head.appendChild(s);
    });
  }

  // ===== Config =====
  let CFG = null;
  async function loadConfig(){
    const tries = ["config.json","./config.json","../config.json","/config.json"];
    for (const p of tries){
      try{
        const r = await fetch(p+"?v="+Date.now(), {cache:"no-store"});
        if (!r.ok) continue;
        CFG = await r.json();
        return;
      }catch(e){}
    }
    throw new Error("Nu pot încărca config.json.");
  }
  function base(){
    return String(CFG?.adminEventsEndpoint || CFG?.leaveEndpoint || CFG?.stateEndpoint || "").replace(/\\?.*$/,'').trim();
  }

  // ===== Admin session =====
  function getAdminKey(){
    try{
      return localStorage.getItem('pontaj_adminKey')
          || localStorage.getItem('pontaj/adminKey')
          || localStorage.getItem('ADMIN_KEY')
          || '';
    }catch(e){ return ''; }
  }
  function getAdminIdentity(){
    try{
      const s = localStorage.getItem('pontaj/admin/v1');
      if (s){
        const o = JSON.parse(s);
        return {
          email: String(o.email||o.user||'').trim(),
          name: String(o.name||o.label||o.user||'Admin').trim()
        };
      }
    }catch(e){}
    return { email:'', name:'Admin' };
  }

  // ===== Tabs and categories =====
  const TABS = [
    {id:"requests", label:"Documentele cereri"},
    {id:"contracts", label:"Documente contractuale"},
    {id:"certs", label:"Adeverințe"},
    {id:"other", label:"Alte documente"},
    {id:"public", label:"Documente publice"},
  ];
  const CATS = [
    {id:"odihna", label:"Concedii de odihnă"},
    {id:"medical", label:"Concedii medicale"},
    {id:"fara_plata", label:"Concedii fără plată"},
    {id:"telework", label:"Cereri telemuncă"},
    {id:"overtime", label:"Cereri de ore suplimentare"},
    {id:"events", label:"Cereri evenimente"},
  ];

  let STATE = {
    tab:"requests",
    cat:"odihna",
    q:"",
    page:0,
    pageSize:6,
    admin:{ key:"", me:{email:"", name:""} },
    employees:[], // {employeeKey,name,dept,avatarUrl,managerEmail,managerName}
    empQ:"",
    selectedEmpKey:"",
    selectedEmpName:"",
    leavesCache: new Map(), // empKey -> list
    allItems:[], // for selected employee, mapped docs (requests tab)
    catCounts:{},
  };

  function setAvatar(elImg, elFallback, url, name){
    if (url){
      elImg.src = url;
      elImg.style.display = "block";
      elFallback.style.display = "none";
    }else{
      elImg.style.display = "none";
      elFallback.style.display = "grid";
      elFallback.textContent = initials(name);
    }
  }

  function renderTabs(){
    const host = $("#tabs");
    host.innerHTML = "";
    for (const t of TABS){
      const b = document.createElement("button");
      b.className = "tab" + (STATE.tab===t.id ? " active" : "");
      b.textContent = t.label;
      b.addEventListener("click", ()=>{
        STATE.tab = t.id;
        STATE.page = 0;
        renderAll();
      });
      host.appendChild(b);
    }
  }

  function renderCats(){
    const host = $("#cats");
    host.innerHTML = "";
    for (const c of CATS){
      const count = STATE.catCounts[c.id] ?? 0;
      const b = document.createElement("div");
      b.className = "cat" + (STATE.cat===c.id ? " active" : "");
      b.innerHTML = `
        <div class="count">${count} fișiere</div>
        <div class="name">${esc(c.label)}</div>
      `;
      b.addEventListener("click", ()=>{
        STATE.cat = c.id;
        STATE.page = 0;
        renderAll();
      });
      host.appendChild(b);
    }
  }

  function getTabItems(){
    if (STATE.tab === "requests"){
      return STATE.allItems;
    }
    const keyMap = {
      contracts: "contractDocs",
      certs: "certDocs",
      other: "otherDocs",
      public: "publicDocs"
    };
    const k = keyMap[STATE.tab];
    const arr = (CFG && CFG.documents && Array.isArray(CFG.documents[k])) ? CFG.documents[k] : [];
    return arr.map(x=>({
      catId: STATE.cat,
      dateIso: x.date || x.createdAt || "",
      title: x.title || x.name || "Document",
      by: x.by || x.author || "Companie",
      meta: x.meta || "",
      url: x.url || x.link || ""
    }));
  }

  function filteredItems(){
    const items = getTabItems();
    const q = String(STATE.q||"").trim().toLowerCase();
    const cat = STATE.cat;
    return items.filter(it=>{
      if (STATE.tab === "requests"){
        if (it.catId !== cat) return false;
      }
      if (!q) return true;
      return (String(it.title||"").toLowerCase().includes(q) || String(it.meta||"").toLowerCase().includes(q));
    });
  }

  function renderRows(){
    const host = $("#rows");
    const items = filteredItems();
    const totalPages = Math.max(1, Math.ceil(items.length / STATE.pageSize));
    STATE.page = Math.max(0, Math.min(STATE.page, totalPages-1));
    const start = STATE.page*STATE.pageSize;
    const pageItems = items.slice(start, start+STATE.pageSize);

    $("#meta").textContent = `${items.length} rezultate`;
    $("#prev").disabled = (STATE.page<=0);
    $("#next").disabled = (STATE.page>=totalPages-1);

    if (!STATE.selectedEmpKey){
      host.innerHTML = `<div class="empty">Alege un angajat din stânga.</div>`;
      $("#hint").textContent = "";
      return;
    }

    if (!pageItems.length){
      host.innerHTML = `<div class="empty">Nu există documente de afișat aici.</div>`;
      $("#hint").textContent = (STATE.tab==="requests")
        ? "Tip: aici apar cererile de concediu/invoire. Pentru telemuncă/ore suplimentare putem conecta ulterior un sheet separat."
        : "Tip: poți defini listele din config.json în obiectul documents.* (publicDocs / contractDocs / certDocs / otherDocs).";
      return;
    }

    host.innerHTML = "";
    for (const it of pageItems){
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="fileIco" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" stroke="currentColor" stroke-width="2"/>
            <path d="M14 2v6h6" stroke="currentColor" stroke-width="2"/>
          </svg>
        </div>
        <div class="dateCell">${esc(ddmmyyyy(it.dateIso))}</div>
        <div class="nameCell">
          <div class="title">${esc(it.title)}</div>
          <div class="sub">${esc(it.by || "")}</div>
        </div>
      `;
      if (it.url){
        row.style.cursor = "pointer";
        row.addEventListener("click", ()=>window.open(it.url, "_blank"));
      }
      host.appendChild(row);
    }
    $("#hint").textContent = `Pagina ${STATE.page+1} / ${totalPages}`;
  }

  function renderAll(){
    renderTabs();
    renderCats();
    renderRows();
  }

  function catOfLeave(x){
    const kind = String(x.kind||"").toLowerCase();
    const code = String(x.code||"").toUpperCase();
    if (code === "CO") return "odihna";
    if (code === "CFP") return "fara_plata";
    if (code === "EV") return "events";
    if (code === "BO" || code === "CM") return "medical";
    if (kind === "invoire") return "events";
    return "events";
  }
  function titleOfLeave(x){
    const kind = String(x.kind||"").toLowerCase();
    if (kind === "invoire"){
      const d = ddmmyyyy(x.startDate || x.createdAt);
      return `Învoire ${d}`;
    }
    const code = String(x.code||"").trim().toUpperCase() || "CO";
    const s = ddmmyyyy(x.startDate);
    const e = ddmmyyyy(x.endDate);
    if (s !== "—" && e !== "—" && s !== e) return `Concediu ${code} ${s} – ${e}`;
    return `Concediu ${code} ${s}`;
  }

  function setCountsFromItems(items){
    const counts = {};
    for (const c of CATS) counts[c.id] = 0;
    for (const it of items){
      counts[it.catId] = (counts[it.catId]||0) + 1;
    }
    STATE.catCounts = counts;
  }

  async function loadEmployees(){
    const b = base();
    if (!b) throw new Error("Lipseaște endpoint în config.json.");
    const url = `${b}?fn=adminEmployees${keyQS()}`;
    const data = await jsonp(url);
    if (!data || !data.ok || !Array.isArray(data.list)) throw new Error(data && data.error ? data.error : "Nu pot încărca lista de angajați.");
    return data.list;
  }

  function keyQS(){
    const k = encodeURIComponent(STATE.admin.key || "");
    return k ? `&ADMIN_KEY=${k}` : "";
  }

  function filterEmployeesAssigned(all){
    const me = (STATE.admin.me.email || "").toLowerCase();
    if (!me) return all;
    // if managerEmail missing, show all (fallback)
    const hasAnyManager = all.some(x => String(x.managerEmail||"").trim());
    if (!hasAnyManager) return all;
    return all.filter(x => String(x.managerEmail||"").toLowerCase() === me);
  }

  function renderEmployees(){
    const host = $("#empList");
    const q = String(STATE.empQ||"").trim().toLowerCase();
    const list = STATE.employees.filter(e=>{
      if (!q) return true;
      return String(e.name||"").toLowerCase().includes(q) || String(e.dept||"").toLowerCase().includes(q);
    });

    if (!list.length){
      host.innerHTML = `<div class="empty">Nu există angajați de afișat.</div>`;
      return;
    }

    host.innerHTML = "";
    for (const e of list){
      const row = document.createElement("div");
      row.className = "emp" + (STATE.selectedEmpKey===e.employeeKey ? " active" : "");
      const ava = e.avatarUrl || "";
      row.innerHTML = `
        <div class="empAva">
          ${ava ? `<img src="${esc(ava)}" alt="">` : `<span>${esc(initials(e.name))}</span>`}
        </div>
        <div class="empMeta">
          <div class="empName">${esc(e.name)}</div>
          <div class="empDept">${esc(e.dept || (e.managerName ? ("Mgr: "+e.managerName) : ""))}</div>
        </div>
      `;
      row.addEventListener("click", async ()=>{
        STATE.selectedEmpKey = e.employeeKey;
        STATE.selectedEmpName = e.name;
        STATE.page = 0;
        STATE.q = "";
        $("#q").value = "";
        await loadDocsForSelected();
        renderEmployees();
        renderAll();
      });
      host.appendChild(row);
    }
  }

  async function loadDocsForSelected(){
    if (!STATE.selectedEmpKey) return;
    // Use cache
    if (STATE.leavesCache.has(STATE.selectedEmpKey)){
      const leaves = STATE.leavesCache.get(STATE.selectedEmpKey) || [];
      buildItemsFromLeaves(leaves);
      return;
    }

    const b = base();
    const months = lastMonths(12);
    const all = [];
    const seen = new Set();
    for (const ym of months){
      const url = `${b}?fn=adminLeavesMonth&ym=${encodeURIComponent(ym)}${keyQS()}`;
      try{
        const data = await jsonp(url);
        if (!data || !data.ok || !Array.isArray(data.list)) continue;
        for (const x of data.list){
          const nm = String(x.employeeName||"");
          if (STATE.selectedEmpName && nm && nm.trim().toLowerCase() !== STATE.selectedEmpName.trim().toLowerCase()) continue;
          const id = String(x.id||"");
          if (id && seen.has(id)) continue;
          if (id) seen.add(id);
          all.push(x);
        }
      }catch(e){}
    }
    STATE.leavesCache.set(STATE.selectedEmpKey, all);
    buildItemsFromLeaves(all);
  }

  function buildItemsFromLeaves(leaves){
    STATE.allItems = (leaves||[])
      .map(x=>({
        catId: catOfLeave(x),
        dateIso: x.startDate || x.createdAt || "",
        title: titleOfLeave(x),
        by: "Adăugat de " + (x.employeeName || STATE.selectedEmpName || "angajat"),
        meta: String(x.status||""),
        url: ""
      }))
      .sort((a,b)=>String(b.dateIso||"").localeCompare(String(a.dateIso||"")));
    setCountsFromItems(STATE.allItems);

    const firstNonZero = CATS.find(c => (STATE.catCounts[c.id]||0) > 0);
    STATE.cat = (firstNonZero ? firstNonZero.id : CATS[0].id);
  }

  async function init(){
    await loadConfig();

    STATE.admin.key = getAdminKey();
    STATE.admin.me = getAdminIdentity();

    $("#meLabel").textContent = STATE.admin.me.name || "Admin";
    setAvatar($("#meAvatarImg"), $("#meAvatarFallback"), "", STATE.admin.me.name);

    $("#empQ").addEventListener("input", (e)=>{ STATE.empQ = e.target.value || ""; renderEmployees(); });

    $("#q").addEventListener("input", (e)=>{ STATE.q = e.target.value || ""; STATE.page=0; renderRows(); });
    $("#prev").addEventListener("click", ()=>{ STATE.page=Math.max(0, STATE.page-1); renderRows(); });
    $("#next").addEventListener("click", ()=>{ STATE.page=STATE.page+1; renderRows(); });

    // basic errors
    if (!STATE.admin.key){
      $("#empList").innerHTML = `<div class="empty">Lipsește ADMIN_KEY în localStorage. Deschide admin-dashboard.html (login) și revino.</div>`;
      return;
    }

    try{
      const all = await loadEmployees();
      STATE.employees = filterEmployeesAssigned(all);
      // select first
      if (STATE.employees.length){
        STATE.selectedEmpKey = STATE.employees[0].employeeKey;
        STATE.selectedEmpName = STATE.employees[0].name;
        await loadDocsForSelected();
      }
      renderEmployees();
      renderAll();
    }catch(err){
      $("#empList").innerHTML = `<div class="empty">${esc(String(err && err.message ? err.message : err))}</div>`;
    }
  }

  init();
</script>
</body>
</html>
