<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendar prezență (tabel lunar)</title>
  <style>
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #151233;
      --muted: #6b6a88;
      --line: rgba(17, 16, 52, .10);
      --shadow: 0 10px 30px rgba(17, 16, 52, .08);
      --purple: #5a3fff;
      --purple-2: #7b61ff;

      /* status colors (aprox ca în exemple) */
      --st-inprogress: #6a5cff;   /* mov */
      --st-subnorm:    #ff5b5b;   /* roșu */
      --st-complete:   #41c97a;   /* verde */
      --st-overnorm:   #a66bff;   /* mov deschis */
      --st-inactive:   #b7b9c8;   /* gri */
      --st-leave:      #39b8ff;   /* albastru */
      --st-pause:      #f6b53b;   /* galben/orange */
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }

    .wrap{
      padding: 18px 18px 22px;
      max-width: 1600px;
      margin: 0 auto;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }

    .search{
      flex: 1;
      max-width: 340px;
      display:flex;
      align-items:center;
      gap:10px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 2px 10px rgba(17, 16, 52, .03);
    }
    .search svg{ width:18px; height:18px; color: var(--muted); }
    .search input{
      border:0;
      outline:none;
      width:100%;
      font-size:14px;
      background: transparent;
      color: var(--text);
    }
    .search input::placeholder{ color: #9a9ab2; }

    .monthbar{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 240px;
      justify-content:center;
    }
    .monthbtn{
      width:36px; height:36px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: var(--card);
      display:grid;
      place-items:center;
      cursor:pointer;
      box-shadow: 0 2px 10px rgba(17, 16, 52, .03);
    }
    .monthbtn:hover{ border-color: rgba(90,63,255,.35); }
    .monthbtn svg{ width:18px; height:18px; color: var(--text); opacity:.75; }

    .monthlabel{
      font-weight: 700;
      letter-spacing: .2px;
      font-size: 15px;
      color: var(--text);
      padding: 4px 8px;
      border-radius: 10px;
    }

    .actions{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .iconbtn{
      width:36px; height:36px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: var(--card);
      display:grid;
      place-items:center;
      cursor:pointer;
      box-shadow: 0 2px 10px rgba(17, 16, 52, .03);
    }
    .iconbtn:hover{ border-color: rgba(90,63,255,.35); }
    .iconbtn svg{ width:18px; height:18px; color: var(--text); opacity:.75; }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .table-wrap{
      overflow:auto;
      max-height: calc(100vh - 220px);
    }

    table{
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      min-width: 1100px;
      font-size: 12px;
    }

    thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: var(--card);
      border-bottom: 1px solid var(--line);
      text-align:center;
      padding: 10px 8px;
      color: var(--muted);
      font-weight: 700;
      white-space: nowrap;
    }

    thead th:first-child{
      left: 0;
      z-index: 7;
      text-align:left;
      padding-left: 14px;
    }

    tbody td, tbody th{
      border-bottom: 1px solid rgba(17, 16, 52, .07);
      border-right: 1px solid rgba(17, 16, 52, .06);
      padding: 0;
      background: #fff;
    }

    tbody tr:last-child td, tbody tr:last-child th{
      border-bottom: 0;
    }

    tbody th{
      position: sticky;
      left: 0;
      z-index: 4;
      background: #fff;
      min-width: 260px;
      border-right: 1px solid var(--line);
    }

    .empCell{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 12px 14px;
    }
    .empIndex{
      width: 28px;
      color: #9a9ab2;
      font-weight: 700;
      text-align:center;
      flex: 0 0 28px;
    }
    .avatar{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(90,63,255,.25), rgba(90,63,255,.08));
      border: 1px solid rgba(90,63,255,.18);
      display:grid;
      place-items:center;
      font-weight: 800;
      color: var(--purple);
      flex: 0 0 34px;
    }
    .empMeta{
      display:flex;
      flex-direction:column;
      min-width: 0;
    }
    .empName{
      font-weight: 800;
      font-size: 13px;
      color: var(--text);
      line-height: 1.1;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 180px;
    }
    .empDept{
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 180px;
    }

    .dayHead{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:2px;
      line-height: 1;
    }
    .dayNum{ font-size: 12px; color: var(--text); font-weight: 800; }
    .dayDow{ font-size: 10px; color: #9a9ab2; font-weight: 700; text-transform: uppercase; }

    .cell{
      position: relative;
      height: 58px;
      width: 92px;
      padding: 7px 8px 7px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:4px;
      overflow:hidden;
    }

    .cell::before{
      content:'';
      position:absolute;
      top:0; left:0; right:0;
      height: 4px;
      background: var(--st-inactive);
      opacity: .95;
    }

    .cellTop{
      display:flex;
      justify-content:space-between;
      font-size: 10px;
      color: #8f8fad;
      gap:6px;
      white-space: nowrap;
    }
    .cellTop span{
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .cellMid{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-weight: 900;
      letter-spacing: .2px;
      color: #1a183b;
      min-height: 14px;
    }

    .cellTotal{
      text-align:center;
      font-weight: 900;
      font-size: 12px;
      color: #151233;
      letter-spacing: .3px;
      white-space: nowrap;
    }

    .cell.empty .cellTop,
    .cell.empty .cellMid,
    .cell.empty .cellTotal{ opacity: .0; }
    .cell.empty{ background: #fff; }

    /* statuses */
    .st-inprogress::before{ background: var(--st-inprogress); }
    .st-subnorm::before{ background: var(--st-subnorm); }
    .st-complete::before{ background: var(--st-complete); }
    .st-overnorm::before{ background: var(--st-overnorm); }
    .st-inactive::before{ background: var(--st-inactive); }
    .st-leave::before{ background: var(--st-leave); }
    .st-pause::before{ background: var(--st-pause); }

    .st-leave .cellMid{ color: #0f2b49; }
    .st-inactive .cellTotal{ color: #8f8fad; }
    .st-inprogress{ background: rgba(106,92,255,.04); }
    .st-subnorm{ background: rgba(255,91,91,.04); }
    .st-complete{ background: rgba(65,201,122,.05); }
    .st-overnorm{ background: rgba(166,107,255,.05); }
    .st-leave{ background: rgba(57,184,255,.05); }
    .st-pause{ background: rgba(246,181,59,.05); }

    .weekendHead{
      background: linear-gradient(180deg, rgba(17, 16, 52, .02), rgba(17, 16, 52, 0));
    }
    .weekendCell{ background: rgba(17, 16, 52, .02); }

    .hint{
      padding: 14px 18px 10px;
      color: var(--muted);
      font-size: 12px;
    }

    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      padding: 10px 18px 18px;
      color: var(--muted);
      font-size: 12px;
      align-items:center;
    }
    .dot{
      width:9px; height:9px;
      border-radius: 999px;
      display:inline-block;
      margin-right:8px;
      vertical-align: middle;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      background: rgba(17, 16, 52, .06);
      border: 1px solid rgba(17, 16, 52, .08);
      border-radius: 8px;
      padding: 2px 6px;
      font-size: 11px;
      color: #2b2950;
    }

    .banner{
      margin: 10px 0 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid rgba(90,63,255,.15);
      background: linear-gradient(180deg, rgba(90,63,255,.07), rgba(90,63,255,.02));
      color: #3d2fbf;
      font-size: 12px;
      font-weight: 700;
    }
    .banner small{ font-weight: 600; color: rgba(61,47,191,.85); }
    .pill{
      background: rgba(90,63,255,.11);
      border: 1px solid rgba(90,63,255,.18);
      color: rgba(61,47,191,.95);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 800;
      white-space: nowrap;
    }

    /* Loading */
    .loading{
      padding: 26px 18px;
      color: var(--muted);
      font-weight: 700;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .spinner{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 3px solid rgba(90,63,255,.18);
      border-top-color: rgba(90,63,255,.85);
      animation: spin .9s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    /* Responsive tweaks */
    @media (max-width: 900px){
      .monthbar{ display:none; }
      .table-wrap{ max-height: calc(100vh - 190px); }
      tbody th{ min-width: 220px; }
      .cell{ width: 84px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="search">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"/>
          <path d="M16.3 16.3 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <input id="q" placeholder="Caută angajat" autocomplete="off" />
      </div>

      <div class="monthbar">
        <button id="prevMonth" class="monthbtn" title="Luna precedentă">
          <svg viewBox="0 0 24 24" fill="none"><path d="M14 6 8 12l6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <div class="monthlabel" id="monthLabel">—</div>
        <button id="nextMonth" class="monthbtn" title="Luna următoare">
          <svg viewBox="0 0 24 24" fill="none"><path d="M10 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>

      <div class="actions">
        <button class="iconbtn" id="exportPdf" title="Export PDF (placeholder)">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7 3h7l3 3v15a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V6a3 3 0 0 1 3-3Z" stroke="currentColor" stroke-width="2"/>
            <path d="M14 3v4a2 2 0 0 0 2 2h4" stroke="currentColor" stroke-width="2"/>
            <path d="M7.5 15.5h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M7.5 18.5h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        <button class="iconbtn" id="exportXls" title="Export Excel (placeholder)">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7 3h7l3 3v15a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V6a3 3 0 0 1 3-3Z" stroke="currentColor" stroke-width="2"/>
            <path d="M14 3v4a2 2 0 0 0 2 2h4" stroke="currentColor" stroke-width="2"/>
            <path d="M8 15l3 4m3-4-3 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="banner">
      <div>Condiția de prezență nu conține timp activ <small>(pontaje neîncheiate)</small></div>
      <div class="pill"><span class="kbd">START</span> fără <span class="kbd">FINISH</span></div>
    </div>

    <div class="card">
      <div id="loading" class="loading"><span class="spinner"></span>Se încarcă prezența lunară…</div>
      <div class="table-wrap" id="tableWrap" style="display:none;">
        <table id="tbl"></table>
      </div>

      <div class="hint">
        Tips: poți derula orizontal și vertical. Coloana cu angajați și header-ul rămân <b>sticky</b>.
      </div>

      <div class="legend">
        <span><i class="dot" style="background:var(--st-inprogress)"></i>În progres</span>
        <span><i class="dot" style="background:var(--st-subnorm)"></i>Sub normă</span>
        <span><i class="dot" style="background:var(--st-complete)"></i>Complet</span>
        <span><i class="dot" style="background:var(--st-overnorm)"></i>Peste normă</span>
        <span><i class="dot" style="background:var(--st-inactive)"></i>Inactiv/absent</span>
        <span><i class="dot" style="background:var(--st-leave)"></i>Concediu</span>
        <span><i class="dot" style="background:var(--st-pause)"></i>În pauză</span>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const DOW = ['Du','Lu','Ma','Mi','Jo','Vi','Sâ'];
    const DOW2 = ['Dum','Lun','Mar','Mie','Joi','Vin','Sâm'];
    const MONTHS = ['Ianuarie','Februarie','Martie','Aprilie','Mai','Iunie','Iulie','August','Septembrie','Octombrie','Noiembrie','Decembrie'];

    const qEl = document.getElementById('q');
    const monthLabelEl = document.getElementById('monthLabel');
    const prevBtn = document.getElementById('prevMonth');
    const nextBtn = document.getElementById('nextMonth');
    const tblEl = document.getElementById('tbl');
    const loadingEl = document.getElementById('loading');
    const tableWrapEl = document.getElementById('tableWrap');

    const exportPdf = document.getElementById('exportPdf');
    const exportXls = document.getElementById('exportXls');

    let CFG = null;
    let curYear = (new Date()).getFullYear();
    let curMonth = (new Date()).getMonth(); // 0-11

    let ALL_EVENTS = [];
    let EMPLOYEES = [];

    exportPdf.addEventListener('click', ()=> alert('Export PDF: aici îl legăm la raportul PDF lunar (în pasul următor).'));
    exportXls.addEventListener('click', ()=> alert('Export Excel: aici îl legăm la export CSV/XLS (în pasul următor).'));

    function pad2(n){ return String(n).padStart(2,'0'); }

    function ymd(d){
      return d.getFullYear() + '-' + pad2(d.getMonth()+1) + '-' + pad2(d.getDate());
    }
    function hm(d){
      return pad2(d.getHours()) + ':' + pad2(d.getMinutes());
    }
    function isWeekend(dateObj){
      const dow = dateObj.getDay();
      return dow === 0 || dow === 6;
    }

    async function loadConfigSmart(){
      const paths = ['./config.json','../config.json','/config.json'];
      for (const p of paths){
        try{
          const r = await fetch(p, {cache:'no-store'});
          if (!r.ok) continue;
          const j = await r.json();
          if (j && (j.adminEventsEndpoint || j.adminEventsUrl || j.endpoint || j.webAppUrl)) return j;
        }catch(_){}
      }
      return {};
    }

    function buildUrl(base, params){
      const u = new URL(base, window.location.href);
      Object.entries(params || {}).forEach(([k,v])=>{
        if (v === undefined || v === null || v === '') return;
        u.searchParams.set(k, String(v));
      });
      return u.toString();
    }

    function adminEndpointBase(){
      const b = (CFG && (CFG.adminEventsEndpoint || CFG.adminEventsUrl || CFG.endpoint || CFG.webAppUrl)) || '';
      if (!b) return '';
      // dacă e deja URL complet, ok
      return b;
    }

    function initials(name){
      const s = String(name||'').trim();
      if (!s) return '•';
      const parts = s.split(/\s+/).filter(Boolean);
      const a = parts[0] ? parts[0][0] : '';
      const b = parts.length>1 ? parts[parts.length-1][0] : '';
      return (a+b).toUpperCase();
    }

    function parseISO(ts){
      const d = new Date(ts);
      return isNaN(d.getTime()) ? null : d;
    }

    function groupByNameDay(events){
      const m = new Map();
      for (const ev of (events||[])){
        if (!ev || !ev.name || !ev.ts) continue;
        const d = parseISO(ev.ts);
        if (!d) continue;
        const key = ev.name + '||' + ymd(d);
        if (!m.has(key)) m.set(key, []);
        m.get(key).push(ev);
      }
      for (const [k, arr] of m.entries()){
        arr.sort((a,b)=> (new Date(a.ts)) - (new Date(b.ts)));
      }
      return m;
    }

    function computeDaySummary(evs){
      // normalize action names (server poate da start/pause/unpause/finish etc)
      const a = (x)=> String(x||'').toLowerCase().trim();
      let running=false, paused=false;
      let startTs=null, pauseStart=null;
      let workMs=0, pauseMs=0;
      let firstStart=null, lastFinish=null;

      for (const ev of (evs||[])){
        const d = parseISO(ev.ts);
        if (!d) continue;
        const t = d.getTime();
        const act = a(ev.action);
        if (act === 'start'){
          if (!firstStart) firstStart = d;
          // dacă eram deja running, resetăm segment (cazuri rare)
          running = true;
          paused = false;
          startTs = t;
          pauseStart = null;
        } else if (act === 'pause'){
          if (running && !paused){
            paused = true;
            pauseStart = t;
          }
        } else if (act === 'unpause'){
          if (running && paused && pauseStart != null){
            const delta = Math.max(0, t - pauseStart);
            pauseMs += delta;
            paused = false;
            pauseStart = null;
          }
        } else if (act === 'finish'){
          lastFinish = d;
          if (running && startTs != null){
            // dacă finish în pauză, închidem pauza
            if (paused && pauseStart != null){
              const delta = Math.max(0, t - pauseStart);
              pauseMs += delta;
              paused = false;
              pauseStart = null;
            }
            const diff = Math.max(0, t - startTs);
            workMs += Math.max(0, diff - pauseMs);
          }
          running = false;
          startTs = null;
          pauseStart = null;
          // reset pauseMs segment? aici îl lăsăm total (simplu)
        }
      }

      const hasStart = !!firstStart;
      const hasFinish= !!lastFinish;
      const completed = hasStart && hasFinish;
      const open = hasStart && !hasFinish;

      return {
        start: firstStart,
        finish: lastFinish,
        workMs: workMs,
        pauseMs: pauseMs,
        completed,
        open,
        // heuristics: dacă e pauză "deschisă" (start + pause fără unpause/finish) → pause state
        pausedOpen: false
      };
    }

    function msToHHMM(ms){
      const m = Math.max(0, Math.round(ms/60000));
      const hh = Math.floor(m/60);
      const mm = m%60;
      return pad2(hh) + ':' + pad2(mm);
    }

    function statusForCell(sum, normMs){
      if (!sum) return 'inactive';
      if (!sum.start && !sum.finish) return 'inactive';
      if (sum.open) return 'inprogress';
      if (sum.completed){
        const work = sum.workMs || 0;
        if (work <= 0) return 'inactive';
        if (work < normMs * 0.92) return 'subnorm';
        if (work > normMs * 1.10) return 'overnorm';
        return 'complete';
      }
      return 'inactive';
    }

    function render(){
      const monthStart = new Date(curYear, curMonth, 1);
      const monthEnd = new Date(curYear, curMonth+1, 0);

      monthLabelEl.textContent = MONTHS[curMonth] + ' ' + curYear;

      const days = [];
      for (let d=1; d<=monthEnd.getDate(); d++){
        const dt = new Date(curYear, curMonth, d);
        days.push(dt);
      }

      // filter employees by query
      const q = String(qEl.value||'').trim().toLowerCase();
      const list = q
        ? EMPLOYEES.filter(e => (e.name||'').toLowerCase().includes(q))
        : EMPLOYEES.slice();

      const byNameDay = groupByNameDay(ALL_EVENTS);
      const normMs = ((CFG && CFG.defaultNormHours) ? Number(CFG.defaultNormHours) : 8) * 60 * 60 * 1000;

      // build table HTML
      let thead = '<thead><tr>';
      thead += '<th><div style="display:flex;align-items:center;gap:8px;"><span style="font-weight:900;color:var(--text);">ANGAJAT</span><span style="color:#9a9ab2;font-weight:800;">↕</span></div></th>';

      for (const dt of days){
        const weekend = isWeekend(dt);
        thead += `<th class="${weekend?'weekendHead':''}"><div class="dayHead"><div class="dayNum">${pad2(dt.getDate())}</div><div class="dayDow">${DOW2[dt.getDay()]}</div></div></th>`;
      }
      thead += '</tr></thead>';

      let tbody = '<tbody>';
      list.forEach((emp, idx) => {
        tbody += '<tr>';
        tbody += `<th><div class="empCell">
            <div class="empIndex">${idx+1}</div>
            <div class="avatar">${initials(emp.name)}</div>
            <div class="empMeta">
              <div class="empName">${escapeHtml(emp.name)}</div>
              <div class="empDept">${escapeHtml(emp.dept || '—')}</div>
            </div>
          </div></th>`;

        for (const dt of days){
          const dk = ymd(dt);
          const key = emp.name + '||' + dk;
          const evs = byNameDay.get(key) || [];
          const sum = evs.length ? computeDaySummary(evs) : null;

          // TODO: leave integration (în pasul următor putem colora CO/BO etc)
          const st = statusForCell(sum, normMs);

          const cls = 'cell ' +
            (st==='inprogress'?'st-inprogress':
            st==='subnorm'?'st-subnorm':
            st==='complete'?'st-complete':
            st==='overnorm'?'st-overnorm':
            st==='leave'?'st-leave':
            st==='pause'?'st-pause':'st-inactive') +
            (isWeekend(dt) ? ' weekendCell' : '');

          const s1 = sum && sum.start ? hm(sum.start) : '';
          const s2 = sum && sum.finish ? hm(sum.finish) : '';
          const total = sum && (sum.workMs>0) ? msToHHMM(sum.workMs) : '';

          // dacă nu e nimic, păstrăm celula clean
          const empty = (!s1 && !s2 && !total);

          tbody += `<td>
              <div class="${cls}${empty?' empty':''}" title="${emp.name} • ${dk}">
                <div class="cellTop"><span>${s1||' '}</span><span>${s2||' '}</span></div>
                <div class="cellMid">${st==='leave' ? 'CO' : (empty ? '&nbsp;' : '')}</div>
                <div class="cellTotal">${total||' '}</div>
              </div>
            </td>`;
        }

        tbody += '</tr>';
      });
      tbody += '</tbody>';

      tblEl.innerHTML = thead + tbody;

      // show
      loadingEl.style.display = 'none';
      tableWrapEl.style.display = '';
    }

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, (c)=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }

    async function loadMonthData(){
      loadingEl.style.display = '';
      tableWrapEl.style.display = 'none';

      if (!CFG) CFG = await loadConfigSmart();
      const base = adminEndpointBase();
      if (!base){
        loadingEl.innerHTML = '<b style="color:#c0392b">Lipsește adminEventsEndpoint în config.json</b>';
        return;
      }

      const monthStart = new Date(curYear, curMonth, 1);
      const monthEnd = new Date(curYear, curMonth+1, 0);

      const url = buildUrl(base, {
        fn: 'adminEvents',
        from: ymd(monthStart),
        to: ymd(monthEnd),
        v: Date.now()
      });

      try{
        const r = await fetch(url, {cache:'no-store'});
        const txt = await r.text();
        let data = null;
        try{ data = JSON.parse(txt); }catch(e){}

        if (!data || !data.ok || !Array.isArray(data.events)){
          throw new Error('adminEventsEndpoint nu a întors {ok:true, events:[]}.');
        }

        ALL_EVENTS = data.events.map(ev => ({
          ts: ev.ts,
          name: ev.name || '',
          dept: ev.dept || '',
          action: String(ev.action||'').toLowerCase().trim()
        })).filter(ev => ev.ts && ev.name);

        // employees list
        const set = new Map();
        for (const ev of ALL_EVENTS){
          if (!set.has(ev.name)){
            set.set(ev.name, {name: ev.name, dept: ev.dept || ''});
          } else if (!set.get(ev.name).dept && ev.dept){
            set.get(ev.name).dept = ev.dept;
          }
        }
        EMPLOYEES = Array.from(set.values()).sort((a,b)=> a.name.localeCompare(b.name,'ro'));

        render();
      }catch(err){
        console.error(err);
        loadingEl.innerHTML = '<b style="color:#c0392b">Eroare:</b> ' + escapeHtml(err.message || String(err));
        tableWrapEl.style.display = 'none';
      }
    }

    function shiftMonth(delta){
      curMonth += delta;
      if (curMonth < 0){
        curMonth = 11;
        curYear--;
      } else if (curMonth > 11){
        curMonth = 0;
        curYear++;
      }
      loadMonthData();
    }

    prevBtn.addEventListener('click', ()=> shiftMonth(-1));
    nextBtn.addEventListener('click', ()=> shiftMonth(+1));
    qEl.addEventListener('input', ()=> render());

    // init
    loadMonthData();

  })();
  </script>
</body>
</html>
