<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin â€” Concedii (v18)</title>
  <style>
    :root{
      --bg:#f5f6ff;
      --card:#ffffff;
      --ink:#1f2330;
      --muted:#6f7890;
      --line:#e7e9f6;
      --accent:#6d5efc;
      --shadow:0 10px 30px rgba(20,18,40,.08);
      --r:18px;

      --c-pending:#fff3d6;
      --c-approved:#e3f7e8;
      --c-rejected:#ffe0e0;
      --c-neutral:#f6f7fb;

      --purple:#2f245c;
      --purple2:#3a2d71;
      --purpleInk:#f5f4ff;
      --purpleMuted: rgba(245,244,255,.72);
      --purpleLine: rgba(255,255,255,.12);
    
      /* Leave & invoiri colors */
      --lv-CO:#f0b429;      --lv-CO-bg:rgba(240,180,41,.18);  --lv-CO-cell:rgba(240,180,41,.08);
      --lv-BO:#7c3aed;      --lv-BO-bg:rgba(124,58,237,.16); --lv-BO-cell:rgba(124,58,237,.07);
      --lv-CCC:#0ea5a0;     --lv-CCC-bg:rgba(14,165,160,.16);--lv-CCC-cell:rgba(14,165,160,.07);
      --lv-CFP:#64748b;     --lv-CFP-bg:rgba(100,116,139,.14);--lv-CFP-cell:rgba(100,116,139,.06);
      --lv-EV:#f97316;      --lv-EV-bg:rgba(249,115,22,.16); --lv-EV-cell:rgba(249,115,22,.07);
      --lv-INV:#0ea5e9;     --lv-INV-bg:rgba(14,165,233,.16);--lv-INV-cell:rgba(14,165,233,.07);
}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1600px;margin:18px auto;padding:0 14px}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .head{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .title{display:flex;flex-direction:column;gap:2px}
    .title h1{margin:0;font-size:18px}
    .title .sub{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:flex;align-items:center;gap:8px;background:var(--c-neutral);border:1px solid var(--line);border-radius:14px;padding:8px 10px}
    .pill input,.pill select{border:0;background:transparent;outline:none;font:inherit;color:var(--ink)}
    .btn{border:1px solid var(--line);background:var(--card);border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:600}
    .btn.primary{background:rgba(109,94,252,.12);border-color:rgba(109,94,252,.25);color:var(--accent)}
    .btn:active{transform:translateY(1px)}
    .toggle{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);border-radius:14px;background:var(--c-neutral);user-select:none}
    .toggle input{width:16px;height:16px}

    .grid{display:grid;grid-template-columns: 1fr 360px;gap:14px;padding:14px}
    @media(max-width:1100px){ .grid{grid-template-columns:1fr} }

    .tableWrap{background:var(--card);border:1px solid var(--line);border-radius:18px;overflow:hidden}
    .tableScroll{overflow:auto}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:980px}
    thead th{position:sticky;top:0;z-index:5;background:#fbfbff;border-bottom:1px solid var(--line);font-size:12px;color:var(--muted);text-align:center;padding:10px 6px}
    thead th:first-child{left:0;z-index:7;text-align:left;padding-left:14px;min-width:260px}
    tbody td, tbody th{border-bottom:1px solid var(--line);border-right:1px solid var(--line);height:64px;vertical-align:middle;text-align:center;font-size:13px;color:var(--ink);background:#fff}
    tbody tr:last-child td, tbody tr:last-child th{border-bottom:0}
    tbody td:last-child, thead th:last-child{border-right:0}
    tbody th{position:sticky;left:0;z-index:6;background:#fff;text-align:left;padding:10px 12px;min-width:260px;border-right:1px solid var(--line)}
    .who{display:flex;align-items:center;gap:10px}
    .av{width:34px;height:34px;border-radius:999px;background:#e9ecff;display:grid;place-items:center;font-weight:800;color:#3a2d71;flex:0 0 auto;overflow:hidden}
    .name{display:flex;flex-direction:column;line-height:1.1}
    .name .n{font-weight:700}
    .name .d{font-size:12px;color:var(--muted)}

    .cell{position:relative;cursor:pointer}
    .cell:hover{background:#fafaff}
    .tag{display:inline-flex;align-items:center;justify-content:center;min-width:44px;padding:6px 10px;border-radius:12px;font-weight:800}
    .tag.co{background:rgba(109,94,252,.10);color:var(--accent)}
    .tag.inv{background:rgba(47,36,92,.08);color:var(--purple)}
    .mini{display:block;margin-top:4px;font-size:11px;color:var(--muted);font-weight:600}

    .pending{background:var(--c-pending)}
    .approved{background:var(--c-approved)}
    .rejected{background:var(--c-rejected)}
    .bang{
      position:absolute;top:6px;right:6px;width:18px;height:18px;border-radius:999px;
      background:#ffb020;color:#1f2330;font-weight:900;font-size:12px;display:grid;place-items:center;
      border:2px solid #fff;
    }

    .side{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:12px}
    .side h3{margin:0 0 10px 0;font-size:14px}
    .side .muted{color:var(--muted);font-size:12px}
    .list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .item{border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff;display:flex;justify-content:space-between;gap:10px}
    .item strong{display:block}
    .item .meta{font-size:12px;color:var(--muted)}
    .item .actions{display:flex;gap:8px;align-items:center}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800;background:#f3f4ff;color:var(--accent);border:1px solid rgba(109,94,252,.25)}
    .err{margin-top:10px;padding:10px;border-radius:12px;background:#fff0f0;border:1px solid #ffd2d2;color:#9b1c1c;font-weight:700}

    /* Approval modal (purple) */
    .ov{position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
    .ov.show{display:flex}

    .ov.open{display:flex}
    .modal{
      width:min(520px, 96vw);
      background:linear-gradient(180deg,var(--purple2),var(--purple));
      color:var(--purpleInk);
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .modal .body{padding:18px}
    .k{color:var(--purpleMuted);font-size:12px;margin-top:10px}
    .v{font-weight:800;font-size:16px;margin-top:2px}
    .row{display:flex;gap:12px;align-items:center;margin-top:14px}
    .avatars{display:flex;gap:8px;margin-top:8px}
    .avatars .av{background:rgba(255,255,255,.16);color:var(--purpleInk);border:1px solid var(--purpleLine)}
    .modal textarea{
      width:100%;margin-top:12px;min-height:80px;resize:vertical;
      border-radius:12px;border:1px solid var(--purpleLine);
      background:rgba(255,255,255,.10);color:var(--purpleInk);
      padding:10px;font:inherit;outline:none
    }
    .modal .foot{
      display:flex;gap:10px;padding:14px;border-top:1px solid var(--purpleLine);
      background:rgba(0,0,0,.08)
    }
    .bbtn{
      flex:1;display:flex;align-items:center;justify-content:center;gap:8px;
      border-radius:12px;padding:12px 10px;font-weight:900;cursor:pointer;border:1px solid transparent
    }
    .bbtn.secondary{background:rgba(255,255,255,.12);border-color:var(--purpleLine);color:var(--purpleInk)}
    .bbtn.approve{background:#6bc676;color:#0b2b12}
    .bbtn.reject{background:rgba(255,255,255,.12);border:1px solid var(--purpleLine);color:var(--purpleInk)}
    .bbtn.icon{flex:0 0 54px}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#1f2330;color:#fff;padding:10px 12px;border-radius:12px;font-weight:700;box-shadow:var(--shadow);display:none;z-index:99999}
    .toast.show{display:block}
  

    .dow{font-size:10px; color:var(--muted); margin-top:2px; font-weight:800}
    .lvcell{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px; height:100%; min-height:64px}
    .lvcell .c{font-weight:900; letter-spacing:.3px}
    .lvcell .t{font-size:11px; color:rgba(27,27,40,.7); font-weight:800}
    .lvcell .mini{font-size:10px; opacity:.75}
    .lvcell .bang{position:absolute;top:6px;right:6px}
    .av2{width:40px;height:40px;border-radius:999px;background:#e9ecff;display:grid;place-items:center;font-weight:900;color:#3a2d71;border:2px solid rgba(255,255,255,.7);overflow:hidden}
    .avatar img, .av img, .av2 img{width:100%;height:100%;object-fit:cover;display:block}



    /* ===== Redesign (v15) â€” calendar ca Ã®n 2.png + liste ca Ã®n 3.png/4.png ===== */
    .presenceFrame{
      background:rgba(109,94,252,.18);
      border-radius:28px;
      padding:18px;
      margin-top:14px;
      box-shadow:var(--shadow);
    }
    .presenceTop{
      display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:12px
    }
    .presenceSearch{
      display:flex;align-items:center;gap:10px;
      background:#fff;border:1px solid var(--line);border-radius:14px;
      padding:10px 12px;min-width:320px;
    }
    .presenceSearch .ico{opacity:.6}
    .presenceSearch input{border:0;outline:0;background:transparent;width:100%;font-size:14px}
    .presenceIcons{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .iconBtn{
      width:40px;height:40px;border-radius:12px;border:1px solid var(--line);
      background:#fff;cursor:pointer;font-size:16px;display:grid;place-items:center
    }

    .monthPill{
      height:40px;border-radius:12px;border:1px solid var(--line);
      background:#fff;padding:0 10px;display:flex;align-items:center
    }
    .monthPill select{
      border:none;outline:none;background:transparent;font:inherit;color:var(--ink);
      padding:0;margin:0
    }
    .iconBtn.toggleOn{
      background:rgba(109,94,252,.10);
      border-color:rgba(109,94,252,.35);
      color:var(--accent)
    }

    .iconBtn:hover{background:#fbfbff}

    .presenceFrame .tableScroll{max-height:520px;}
    .presenceFrame .tableScroll{overflow:auto;}


    /* calendar: douÄƒ coloane sticky (# + angajat) */
    table{min-width:1100px}
    thead th{font-weight:800;text-transform:uppercase;letter-spacing:.04em}
    thead th .dow{margin-top:2px;font-weight:700;text-transform:none;letter-spacing:0}
    .sort{font-weight:900;color:var(--accent);opacity:.9;margin-left:6px}

    thead th.idxH{
      position:sticky;left:0;z-index:9;text-align:center;min-width:52px;width:52px;
      background:#fbfbff;border-right:1px solid var(--line)
    }
    thead th.empH{
      position:sticky;left:52px;z-index:8;text-align:left;padding-left:14px;min-width:280px;
      background:#fbfbff;border-right:1px solid var(--line)
    }

    tbody th.idxC{
      position:sticky;left:0;z-index:8;text-align:center;min-width:52px;width:52px;
      color:#9aa3b8;background:#fff;font-weight:700;border-right:1px solid var(--line)
    }
    tbody th.empC{
      position:sticky;left:52px;z-index:7;background:#fff;text-align:left;min-width:280px;
      border-right:1px solid var(--line)
    }

    /* weekend shading */
    th.weekend, td.weekend{background:#f7f7fb}

    /* leave cell look: ca tag-urile din calendar prezenÈ›Äƒ */
    td.day{padding:0}
    .lvcell{
      position:relative;cursor:pointer;height:64px;width:100%;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:4px;
    }
    .lvcell:hover{background:#fafaff}
    .lvTag{
      width:86%;border-radius:4px 4px 8px 8px;
      padding:6px 6px 5px;display:flex;flex-direction:column;align-items:center;
      background:#fbfbff;border:1px solid var(--line);
      border-top:4px solid rgba(109,94,252,.55);
      font-weight:900;color:#2f245c;letter-spacing:.02em;
      line-height:1.05;
    }

    /* Leave tag colors (calendar) */
    td.day.hasLV.t-CO{background:var(--lv-CO-cell)}
    td.day.hasLV.t-BO{background:var(--lv-BO-cell)}
    td.day.hasLV.t-CCC{background:var(--lv-CCC-cell)}
    td.day.hasLV.t-CFP{background:var(--lv-CFP-cell)}
    td.day.hasLV.t-EV{background:var(--lv-EV-cell)}
    td.day.hasLV.t-INV{background:var(--lv-INV-cell)}

    .lvTag.t-CO{border-top-color:var(--lv-CO); background:var(--lv-CO-bg)}
    .lvTag.t-BO{border-top-color:var(--lv-BO); background:var(--lv-BO-bg)}
    .lvTag.t-CCC{border-top-color:var(--lv-CCC); background:var(--lv-CCC-bg)}
    .lvTag.t-CFP{border-top-color:var(--lv-CFP); background:var(--lv-CFP-bg)}
    .lvTag.t-EV{border-top-color:var(--lv-EV); background:var(--lv-EV-bg)}
    .lvTag.t-INV{border-top-color:var(--lv-INV); background:var(--lv-INV-bg)}

    .lvcell .bang{background:var(--lv-CO); color:#1b1b1b} /* will be overridden by type via inline var */
    .lvcell[data-type="CO"] .bang{background:var(--lv-CO)}
    .lvcell[data-type="BO"] .bang{background:var(--lv-BO); color:#fff}
    .lvcell[data-type="CCC"] .bang{background:var(--lv-CCC); color:#fff}
    .lvcell[data-type="CFP"] .bang{background:var(--lv-CFP); color:#fff}
    .lvcell[data-type="EV"] .bang{background:var(--lv-EV); color:#fff}
    .lvcell[data-type="INV"] .bang{background:var(--lv-INV); color:#fff}

    /* Legend (leave types only) */
    .legendBox{margin-top:14px;display:flex;flex-direction:column;gap:8px}
    .legendNote{font-size:13px;color:var(--accent);font-weight:700}
    .legendRow{display:flex;flex-wrap:wrap;gap:18px;align-items:center}
    .legItem{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:13px}
    .dot{width:9px;height:9px;border-radius:50%}
    .dot.co{background:var(--lv-CO)}
    .dot.bo{background:var(--lv-BO)}
    .dot.ccc{background:var(--lv-CCC)}
    .dot.cfp{background:var(--lv-CFP)}
    .dot.ev{background:var(--lv-EV)}
    .dot.inv{background:var(--lv-INV)}
    .lvTag .code{font-size:13px}
    .lvTag .t{font-size:11px;color:var(--muted);font-weight:800;margin-top:2px}
    .lvMore{font-size:11px;color:var(--muted);font-weight:800}
    .bang{top:8px;right:8px}

    /* Stiva de liste (sub calendar) */
    .stack{display:flex;flex-direction:column;gap:18px;margin-top:18px}
    .stackCard{
      background:#fff;border:1px solid var(--line);border-radius:22px;
      padding:18px;box-shadow:var(--shadow)
    }
    .stackHead{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin-bottom:14px}
    .stackTitle .h{font-size:18px;font-weight:900;color:#1f2330}
    .stackTitle .s{font-size:13px;color:var(--muted);margin-top:2px}

    .tblWrap{border:1px solid var(--line);border-radius:18px;overflow:hidden;background:#fff}
    .simpleTbl{width:100%;border-collapse:separate;border-spacing:0;min-width:0}
    .simpleTbl thead th{
      position:static;background:#fff;border-bottom:1px solid var(--line);
      font-size:18px;color:#2f245c;text-align:left;padding:18px 16px;
      text-transform:uppercase;letter-spacing:.04em
    }
    .simpleTbl tbody td{
      border-bottom:1px solid var(--line);padding:18px 16px;font-size:16px;color:#1f2330
    }
    .simpleTbl tbody tr:last-child td{border-bottom:0}

    .empCell{display:flex;align-items:center;gap:14px}
    .avatar{
      width:40px;height:40px;border-radius:999px;overflow:hidden;
      display:grid;place-items:center;background:#e9ecff;color:#3a2d71;font-weight:900
    }
    .empName{font-weight:800;color:#2f245c}
    .mut{font-size:13px;color:var(--muted);margin-top:2px}
    .statusTxt{font-weight:900}
    .st-approved{color:#55b86a}
    .st-rejected{color:#d4533a}
    .st-pending{color:#6d5efc}

    .empty{padding:18px;color:var(--muted);font-weight:700;display:none}

    /* Actions table buttons (exact feel ca 4.png) */
    .actions{display:flex;gap:12px;justify-content:flex-end}
    .btnA{
      height:44px;border-radius:12px;border:1px solid transparent;cursor:pointer;
      font-weight:900;font-size:16px;padding:0 18px;display:inline-flex;align-items:center;gap:10px
    }
    .btnApprove{background:#6fc477;color:#fff}
    .btnApprove:hover{filter:brightness(.98)}
    .btnReject{
      width:54px;justify-content:center;background:#ecebfb;border-color:#dddaf7;color:#2f245c
    }
    .btnReject:hover{background:#e6e4fb}

    /* responsive */
    @media (max-width: 1100px){
      .presenceSearch{min-width:200px}
      .simpleTbl thead th{font-size:16px}
      .simpleTbl tbody td{font-size:15px}
    }


    /* ===== Submeniuri (ca Ã®n admin dashboard) ===== */
    .subtabs{
      margin: 6px 0 14px;
      padding: 12px 18px 0;
      background: rgba(109,94,252,.10);
      border-radius: 14px;
      display:flex;
      gap: 28px;
      align-items:flex-end;
      border: 1px solid rgba(231,233,246,.9);
      box-shadow: 0 8px 18px rgba(20,18,40,.05);
    }
    .stab{
      appearance:none;
      border:0;
      background:transparent;
      cursor:pointer;
      padding: 14px 6px 12px;
      font-weight: 700;
      font-size: 20px;
      color: #8a90a8;
      border-bottom: 4px solid transparent;
      transition: color .15s ease, border-color .15s ease;
    }
    .stab:hover{ color:#5e67a8; }
    .stab.active{
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .tabViews{ display:block; }
    .tabView{ display:none; }
    .tabView.active{ display:block; }

    /* pe mobil: tabs scrollabile */
    @media (max-width: 820px){
      .subtabs{ overflow:auto; white-space:nowrap; gap:18px; }
      .stab{ font-size: 18px; }
    }

</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <!-- Submeniuri -->
    <div class="subtabs" id="subtabs">
      <button class="stab active" data-tab="cal">Concedii &amp; Ã®nvoiri</button>
      <button class="stab" data-tab="pending">ÃŽn aÈ™teptare</button>
      <button class="stab" data-tab="quick">AprobÄƒri rapide</button>
    </div>

    <div class="tabViews">
      <div class="tabView active" id="view-cal">
<!-- Calendar (stil identic cu Calendar prezenÈ›Äƒ) -->
    <div class="presenceFrame">
      <div class="presenceTop">
        <div class="presenceSearch">
          <span class="ico">ðŸ”Ž</span>
          <input id="q2" placeholder="CautÄƒ angajat" aria-label="CautÄƒ angajat (calendar)"/>
        </div>
                <div class="presenceIcons">
          <button class="iconBtn" id="prev" title="Luna anterioarÄƒ">â€¹</button>
          <div class="monthPill" title="SelecteazÄƒ luna">
            <select id="monthSel" aria-label="SelecteazÄƒ luna"></select>
          </div>
          <button class="iconBtn" id="next" title="Luna urmÄƒtoare">â€º</button>

          <input type="checkbox" id="onlyMine" checked hidden />
          <button class="iconBtn toggle" id="onlyMineBtn" title="Doar ale mele" aria-pressed="true">ðŸ‘¤</button>

          <button class="iconBtn" id="refresh" title="Refresh">âŸ³</button>
          <button class="iconBtn" id="dl" title="Download (placeholder)">â¤“</button>
          <button class="iconBtn" id="xl" title="Excel (placeholder)">â§‰</button>
        </div>
      </div>

      <div class="tableWrap">
        <div class="tableScroll" id="calScroll">
          <table id="cal" aria-label="Calendar concedii">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <div id="err" class="err" style="display:none"></div>
      <div class="muted" id="dbg" style="margin-top:10px"></div>

      <div class="legendBox" aria-label="LegendÄƒ concedii È™i Ã®nvoiri">
        <div class="legendNote">LegendÄƒ (concedii &amp; Ã®nvoiri)</div>
        <div class="legendRow">
          <div class="legItem"><span class="dot co"></span><b>CO</b> â€“ Concediu de odihnÄƒ</div>
          <div class="legItem"><span class="dot bo"></span><b>BO</b> â€“ Concediu medical</div>
          <div class="legItem"><span class="dot ccc"></span><b>CCC</b> â€“ Concediu creÈ™tere copil</div>
          <div class="legItem"><span class="dot cfp"></span><b>CFP</b> â€“ Concediu fÄƒrÄƒ platÄƒ</div>
          <div class="legItem"><span class="dot ev"></span><b>EV</b> â€“ Eveniment</div>
          <div class="legItem"><span class="dot inv"></span><b>ÃŽNV</b> â€“ ÃŽnvoire</div>
        </div>
      </div>

    </div>
      </div>

      <div class="tabView" id="view-pending">
        <div class="stack">
          <div class="stackCard">
        <div class="stackHead">
          <div class="stackTitle">
            <div class="h">ÃŽn aÈ™teptare <span class="badge" id="pendingCount">0</span></div>
            <div class="s">Cererile din luna selectatÄƒ (pending / aprobate / respinse).</div>
          </div>
        </div>

        <div class="tblWrap">
          <table class="simpleTbl" id="reqTable" aria-label="Lista cereri">
            <thead>
              <tr>
                <th>ANGAJAT <span class="sort">â†‘â†“</span></th>
                <th>TIP DE CONCEDIU <span class="sort">â†‘â†“</span></th>
                <th>TIP ÃŽNVOIRE <span class="sort">â†‘â†“</span></th>
                <th>STATUS <span class="sort">â†‘â†“</span></th>
              </tr>
            </thead>
            <tbody id="reqBody"></tbody>
          </table>
          <div class="empty" id="reqEmpty" style="display:none">Nu existÄƒ cereri Ã®n luna selectatÄƒ.</div>
        </div>
      </div>
        </div>
      </div>

      <div class="tabView" id="view-quick">
        <div class="stack">
          <div class="stackCard">
        <div class="stackHead">
          <div class="stackTitle">
            <div class="h">AprobÄƒri rapide</div>
            <div class="s">AprobÄƒ / respinge direct din listÄƒ (doar cereri pending).</div>
          </div>
        </div>

        <div class="tblWrap">
          <table class="simpleTbl actionsTbl" id="actTable" aria-label="AprobÄƒri rapide">
            <thead>
              <tr>
                <th>ANGAJAT <span class="sort">â†‘â†“</span></th>
                <th>PERIOADÄ‚ <span class="sort">â†‘â†“</span></th>
                <th>ACÈšIUNI</th>
              </tr>
            </thead>
            <tbody id="actBody"></tbody>
          </table>
          <div class="empty" id="actEmpty" style="display:none">Nu existÄƒ cereri pending Ã®n luna selectatÄƒ.</div>
        </div>
      </div>
        </div>
      </div>
    </div>


    </div>
  </div>
</div>

<!-- Approval modal -->
<div class="ov" id="ov">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="body">
      <div class="k">PerioadÄƒ</div>
      <div class="v" id="mPeriod">â€”</div>

      <div class="k">NumÄƒr</div>
      <div class="v" id="mCount">â€”</div>

      <div class="k">Motiv</div>
      <div class="v" id="mReason">â€”</div>

      <div class="k">Ziua selectatÄƒ</div>
      <div class="v" id="mDay">â€”</div>

      <div class="k">ÃŽn aceeaÈ™i zi cu</div>
      <div class="avatars" id="sameDayAv"></div>

      <div class="k">ÃŽn aceeaÈ™i perioadÄƒ cu</div>
      <div class="avatars" id="samePeriodAv"></div>

      <textarea id="mNote" placeholder="NotÄƒ (opÈ›ional) â€” se aplicÄƒ la approve/reject"></textarea>
    </div>
    <div class="foot">
      <button class="bbtn secondary icon" id="mDl" title="Export (placeholder)">â¤“</button>
      <button class="bbtn reject" id="mReject">âœ• Respinge</button>
      <button class="bbtn approve" id="mApprove">âœ“ AprobÄƒ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">â€”</div>

<script>
(() => {
  // ===== Config loading (same smart loader used elsewhere) =====
  const CFG_PATHS = ["./config.json","../config.json","/config.json"];
  let CFG = null;

  // ===== Avatars =====
  let __avatarMap = {}; // keyName(employeeName) -> avatarUrl

  function buildAvatarMap(list){
    const m = {};
    (list||[]).forEach(l=>{
      const emp = String(l?.employeeName || "").trim();
      const url = String(l?.avatarUrl || l?.avatarURL || "").trim();
      if (emp && url) m[keyName(emp)] = url;
    });
    return m;
  }
  function getAvatarUrl(name){
    const k = keyName(name);
    return (__avatarMap && __avatarMap[k]) ? String(__avatarMap[k]) : "";
  }
  function avatarInnerHtml(name){
    const u = getAvatarUrl(name);
    return u ? `<img src="${esc(u)}" alt="">` : esc(initials(name));
  }


  const LS_ADMIN = "pontaj/admin/v1";
  const LS_ADMIN_KEY = "pontaj_adminKey";

  function $(sel){ return document.querySelector(sel); }

  function esc(s){
    return String(s==null?"":s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }
  function toast(msg){
    const t = $("#toast");
    if (!t) return;
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }
  function setError(msg){
    const e = $("#err");
    if (!e) return;
    if(!msg){ e.style.display="none"; e.textContent=""; return; }
    e.style.display="block";
    e.textContent = msg;
  }

  async function loadCFG(){
    for (const p of CFG_PATHS){
      try{
        const r = await fetch(p, { cache:"no-store" });
        if (!r.ok) continue;
        CFG = await r.json();
        return;
      }catch(e){}
    }
    CFG = {};
  }
  function ep(){ return (CFG && (CFG.leaveEndpoint || CFG.adminEventsEndpoint || CFG.stateEndpoint)) || ""; }

  // ===== Admin session =====
  function getAdminSession(){
    const raw = (localStorage.getItem(LS_ADMIN) || "").trim();
    if (!raw) return null;
    let obj = null;
    try{ obj = JSON.parse(raw); }catch(_){ obj = null; }
    if (obj && typeof obj === "object"){
      const label = (obj.label || obj.name || obj.user || obj.email || obj.id || "").toString().trim();
      const email = (obj.email || obj.userEmail || obj.mail || "").toString().trim();
      if (!label && !email) return null;
      return { raw: obj, label: label || email, email: email || "" };
    }
    return { raw: { value: raw }, label: raw, email: "" };
  }

  function getAdminKey(){
    let k = "";
    try{ k = (localStorage.getItem(LS_ADMIN_KEY) || "").trim(); }catch(e){}
    if (!k){
      k = (prompt("Cheie admin (ADMIN_KEY) pentru aprobÄƒri:", "") || "").trim();
      if (k){ try{ localStorage.setItem(LS_ADMIN_KEY, k); }catch(e){} }
    }
    return k;
  }

  // ===== JSONP =====
  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const cb = "cb_"+Math.random().toString(16).slice(2);
      const s = document.createElement("script");
      const t = setTimeout(()=>{ cleanup(); reject(new Error("JSONP timeout")); }, 20000);
      function cleanup(){
        clearTimeout(t);
        try{ delete window[cb]; }catch(_){ window[cb]=undefined; }
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }
      window[cb] = (data)=>{ cleanup(); resolve(data); };
      s.onerror = ()=>{ cleanup(); reject(new Error("JSONP error")); };
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
      document.body.appendChild(s);
    });
  }

  // ===== helpers =====
  function norm(s){ return String(s||"").trim().toLowerCase(); }
  function deacc(s){ return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }
  function keyName(s){ return deacc(norm(s)).replace(/\s+/g," ").trim(); }

  function tokens(s){
    return keyName(s).split(/[^a-z0-9]+/).filter(Boolean);
  }
  function samePerson(a,b){
    const A = keyName(a), B = keyName(b);
    if (!A || !B) return false;
    if (A === B) return true;
    if (A.includes(B) || B.includes(A)) return true;
    // token match (useful for emails)
    const ta = tokens(A), tb = tokens(B);
    const small = ta.length<=tb.length ? ta : tb;
    const big = ta.length<=tb.length ? tb : ta;
    // require at least 1 token match, or all tokens from smaller contained
    let hits = 0;
    for (const t of small){
      if (big.includes(t)) hits++;
    }
    return hits >= Math.min(2, small.length); // usually "alin ceclan" => 2 hits
  }

  function initials(name){
    const parts = String(name||"").trim().split(/\s+/).filter(Boolean);
    const a = parts[0]?.[0] || "?";
    const b = parts.length>1 ? parts[parts.length-1][0] : "";
    return (a+b).toUpperCase();
  }

  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtTime(v){
    if (v === null || v === undefined || v === "") return "";
    // String like "09:30" or "9:30"
    if (typeof v === "string"){
      const m = v.match(/(\d{1,2}):(\d{2})/);
      if (m) return pad2(m[1]) + ":" + m[2];
      // ISO datetime or Date string
      const d = new Date(v);
      if (!isNaN(d.getTime())) return pad2(d.getHours()) + ":" + pad2(d.getMinutes());
      return v;
    }
    // Date object (Google Sheets time often comes as 1899-12-30...)
    if (v instanceof Date){
      if (!isNaN(v.getTime())) return pad2(v.getHours()) + ":" + pad2(v.getMinutes());
      return "";
    }
    // Number: Google Sheets serial date/time or fraction of day
    if (typeof v === "number" && isFinite(v)){
      let frac = v % 1;
      if (frac < 0) frac += 1;
      const totalMin = Math.round(frac * 24 * 60);
      const hh = Math.floor(totalMin / 60) % 24;
      const mm = totalMin % 60;
      return pad2(hh) + ":" + pad2(mm);
    }
    try{
      const d = new Date(v);
      if (!isNaN(d.getTime())) return pad2(d.getHours()) + ":" + pad2(d.getMinutes());
    }catch(e){}
    return "";
  }


  function daysInMonth(ym){
    const [y,m] = ym.split("-").map(Number);
    return new Date(y, m, 0).getDate();
  }
  function dowShort(d){
    const arr=["Du","Lu","Ma","Mi","Jo","Vi","SÃ¢"];
    return arr[d.getDay()];
  }
  function iso(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da= String(d.getDate()).padStart(2,"0");
    return y+"-"+m+"-"+da;
  }
  function parseIsoDate(s){
    const m = String(s||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return null;
    return new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), 12,0,0,0);
  }
  function between(d, a, b){
    return d && a && b && d.getTime() >= a.getTime() && d.getTime() <= b.getTime();
  }

  // ===== data =====
  let LEAVES_ALL = [];
  let LEAVES_VIEW = [];
  let MANAGERS = null; // { keyName(emp): {managerName, managerEmail} }

  async function loadManagersMap(endpoint, key){
    if (MANAGERS) return MANAGERS;
    try{
      const u = endpoint + "?fn=adminManagersMap&key=" + encodeURIComponent(key) + "&ts=" + Date.now();
      const data = await jsonp(u);
      if (data && data.ok && data.map){
        MANAGERS = data.map;
        return MANAGERS;
      }
    }catch(_){}
    MANAGERS = {};
    return MANAGERS;
  }

  function enrichLeave(l){
    const emp = String(l.employeeName||"").trim();
    const k = keyName(emp);
    const m = (MANAGERS && MANAGERS[k]) ? MANAGERS[k] : null;
    const mgrName = String(l.managerName||"").trim() || (m ? String(m.managerName||"").trim() : "");
    const mgrEmail = String(l.managerEmail||"").trim() || (m ? String(m.managerEmail||"").trim() : "");
    return {
      ...l,
      _empKey: k,
      _mgrName: mgrName,
      _mgrEmail: mgrEmail
    };
  }

  function filterMine(list, admin){
    const onlyMine = $("#onlyMine")?.checked;
    if (!onlyMine) return list;
    if (!admin) return list; // can't filter
    const adminId = admin.label || admin.email || "";
    if (!adminId) return list;

    return list.filter(l=>{
      const a = l._mgrName || "";
      const b = l._mgrEmail || "";
      // if request has no manager assigned, hide it in "mine"
      if (!a && !b) return false;
      return samePerson(a, adminId) || samePerson(b, adminId) || samePerson(a, admin.email||"") || samePerson(b, admin.email||"");
    });
  }

  function filterSearch(list){
    const q = norm($("#q")?.value || "");
    if (!q) return list;
    const qq = deacc(q);
    return list.filter(l=>{
      const n = deacc(norm(l.employeeName||""));
      const c = deacc(norm(l.code||""));
      return n.includes(qq) || c.includes(qq);
    });
  }

  function buildView(admin){
    const enriched = LEAVES_ALL.map(enrichLeave);
    __avatarMap = buildAvatarMap(enriched);
    let list = enriched;
    list = filterMine(list, admin);
    list = filterSearch(list);
    LEAVES_VIEW = list;
  }

  // ===== UI render =====
  function render(ym, admin){
    const thead = $("#thead");
    const tbody = $("#tbody");
    if (!thead || !tbody) return;

    // header
    const dim = daysInMonth(ym);
    let h = `<tr>
      <th class="idxH">#</th>
      <th class="empH">ANGAJAT <span class="sort">â†‘â†“</span></th>`;
    for (let d=1; d<=dim; d++){
      const dt = new Date(Number(ym.slice(0,4)), Number(ym.slice(5,7))-1, d, 12,0,0,0);
      const wk = isWeekend(dt) ? " weekend" : "";
      h += `<th class="${wk.trim()}">${String(d).padStart(2,"0")}<div class="dow">${dowShort(dt)}</div></th>`;
    }
    h += `</tr>`;
    thead.innerHTML = h;

    // group leaves by employee
    const byEmp = new Map();
    for (const l of LEAVES_VIEW){
      const emp = String(l.employeeName||"").trim() || "â€”";
      if (!byEmp.has(emp)) byEmp.set(emp, []);
      byEmp.get(emp).push(l);
    }
    const emps = Array.from(byEmp.keys()).sort((a,b)=>keyName(a).localeCompare(keyName(b)));

    // rows
    let html = "";
    let rowIdx = 1;
    for (const emp of emps){
      const list = byEmp.get(emp) || [];
      // map day -> leaves
      const cellMap = new Map(); // d => [leaves]
      for (const l of list){
        const sd = parseIsoDate(l.startDate);
        const ed = parseIsoDate(l.endDate || l.startDate);
        if (!sd || !ed) continue;
        for (let d=1; d<=dim; d++){
          const day = new Date(Number(ym.slice(0,4)), Number(ym.slice(5,7))-1, d, 12,0,0,0);
          if (between(day, sd, ed)){
            if (!cellMap.has(d)) cellMap.set(d, []);
            cellMap.get(d).push(l);
          }
        }
      }

      const mgr = list[0]?._mgrName || list[0]?._mgrEmail || "";
      const mgrTxt = mgr ? `Manager: ${mgr}` : `Manager: â€”`;

      html += `<tr>
        <th class="idxC">${rowIdx++}</th>
        <th class="empC">
          <div class="who">
            <div class="av">${avatarInnerHtml(emp)}</div>
            <div class="name">
              <div class="n">${esc(emp)}</div>
              <div class="d">${esc(mgrTxt)}</div>
            </div>
          </div>
        </th>`;

      for (let d=1; d<=dim; d++){
        const dt = new Date(Number(ym.slice(0,4)), Number(ym.slice(5,7))-1, d, 12,0,0,0);
        const wk = isWeekend(dt) ? " weekend" : "";
        const arr = cellMap.get(d) || [];
        if (!arr.length){
          html += `<td class="day${wk}"></td>`;
          continue;
        }
        const first = arr[0];
        const isInv = norm(first.kind)==="invoire";
        let typeKey = isInv ? "INV" : (String(first.code||"").trim().toUpperCase() || "UNK");
        if (!["CO","BO","CCC","CFP","EV","INV"].includes(typeKey)) typeKey = isInv ? "INV" : "UNK";
        const code = isInv ? "ÃŽNV" : typeKey;
        const pending = arr.some(x=>norm(x.status)==="pending");
        const more = arr.length>1 ? `<div class="lvMore">+${arr.length-1}</div>` : "";
        const bang = pending ? `<div class="bang">!</div>` : "";
        const time = isInv ? `<div class="t">${fmtTime(first.startTime)}â€“${fmtTime(first.endTime)}</div>` : "";
        const dataPayload = encodeURIComponent(JSON.stringify(arr));
        html += `<td class="day${wk} hasLV t-${typeKey}">
          <div class="lvcell" data-type="${typeKey}" data-day="${String(d).padStart(2,"0")}" data-arr="${dataPayload}">
            ${bang}
            <div class="lvTag t-${typeKey}">
              <div class="code">${esc(code)}</div>
              ${time}
            </div>
            ${more}
          </div>
        </td>`;
      }
      html += `</tr>`;
    }
    tbody.innerHTML = html;

    // click (delegare robustÄƒ) â€” deschide modalul de aprobare
    tbody.onclick = (ev)=>{
      const el = ev.target && ev.target.closest ? ev.target.closest(".lvcell") : null;
      if (!el) return;
      try{
        const day = ym + "-" + el.getAttribute("data-day");
        const arr = JSON.parse(decodeURIComponent(el.getAttribute("data-arr")||"[]"));
        openModal(arr, day, admin);
      }catch(e){ console.warn("openModal failed", e); }
    };

    // ===== Listele de jos =====
    const pending = LEAVES_VIEW.filter(l=>norm(l.status)==="pending");
    const pc = $("#pendingCount"); if (pc) pc.textContent = String(pending.length);

    // table 1: status list (all)
    const reqBody = $("#reqBody");
    const reqEmpty = $("#reqEmpty");
    if (reqBody) reqBody.innerHTML = "";
    if (reqEmpty) reqEmpty.style.display = LEAVES_VIEW.length ? "none" : "block";

    if (reqBody && LEAVES_VIEW.length){
      const listAll = [...LEAVES_VIEW].sort((a,b)=>String(b.createdAt||"").localeCompare(String(a.createdAt||"")));
      for (const l of listAll){
        const empName = String(l.employeeName||"â€”").trim() || "â€”";
        const isInv = norm(l.kind)==="invoire";
        const leaveTxt = isInv ? "â€”" : (leaveLabel(l.code) || "â€”");
        const invTxt = isInv ? invLabel(l) : "â€”";
        const st = norm(l.status);
        const stTxt = st==="approved" ? "Solicitare aprobatÄƒ" : (st==="rejected" ? "Solicitare respinsÄƒ" : "Solicitare Ã®n aÈ™teptare");
        const stCls = st==="approved" ? "st-approved" : (st==="rejected" ? "st-rejected" : "st-pending");
        const arrPayload = encodeURIComponent(JSON.stringify([l]));
        const tr = document.createElement("tr");
        tr.setAttribute("data-arr", arrPayload);
        tr.setAttribute("data-day", (l.startDate||""));
        tr.innerHTML = `
          <td>
            <div class="empCell">
              <div class="avatar">${avatarInnerHtml(empName)}</div>
              <div>
                <div class="empName">${esc(empName)}</div>
              </div>
            </div>
          </td>
          <td>${esc(leaveTxt)}</td>
          <td>${esc(invTxt)}</td>
          <td><span class="statusTxt ${stCls}">${stTxt}</span></td>`;
        tr.addEventListener("click", ()=>{
          try{ openModal([l], l.startDate || (ym+"-01"), admin); }catch(_){}
        });
        reqBody.appendChild(tr);
      }
    }

    // table 2: quick approvals (pending only)
    const actBody = $("#actBody");
    const actEmpty = $("#actEmpty");
    if (actBody) actBody.innerHTML = "";
    if (actEmpty) actEmpty.style.display = pending.length ? "none" : "block";

    if (actBody && pending.length){
      const listP = [...pending].sort((a,b)=>String(a.startDate||"").localeCompare(String(b.startDate||"")));
      for (const l of listP){
        const empName = String(l.employeeName||"â€”").trim() || "â€”";
        const per = periodLabel(l);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <div class="empCell">
              <div class="avatar">${avatarInnerHtml(empName)}</div>
              <div>
                <div class="empName">${esc(empName)}</div>
                <div class="mut">${esc(per.meta)}</div>
              </div>
            </div>
          </td>
          <td style="font-weight:900;color:#2f245c">${esc(per.main)}</td>
          <td>
            <div class="actions">
              <button class="btnA btnApprove" data-act="approve" data-id="${esc(l.id||"")}">âœ“ AprobÄƒ</button>
              <button class="btnA btnReject" data-act="reject" data-id="${esc(l.id||"")}">âœ•</button>
            </div>
          </td>`;
        actBody.appendChild(tr);
      }

      actBody.onclick = async (ev)=>{
        const b = ev.target && ev.target.closest ? ev.target.closest("button[data-act]") : null;
        if (!b) return;
        ev.preventDefault();
        ev.stopPropagation();
        const id = b.getAttribute("data-id");
        const act = b.getAttribute("data-act");
        const decision = act==="approve" ? "approved" : "rejected";
        const l = pending.find(x=>String(x.id)===String(id));
        if (!l) return;
        await decideOne(l, decision);
      };
    }

    // debug text
    const dbg = $("#dbg");
    if (dbg){
      const a = admin ? (admin.label || admin.email || "â€”") : "â€”";
      dbg.textContent = `ÃŽncÄƒrcate: ${LEAVES_ALL.length} â€¢ AfiÈ™ate: ${LEAVES_VIEW.length} â€¢ Admin: ${a}`;
    }
  }

  function isWeekend(d){
    const x = d.getDay();
    return x===0 || x===6;
  }

  function leaveLabel(code){
    const c = String(code||"").toUpperCase().trim();
    const map = {
      "CO":"Concediu de odihnÄƒ",
      "BO":"Concediu medical",
      "CCC":"Concediu pentru creÈ™terea copilului",
      "CFP":"Concediu fÄƒrÄƒ platÄƒ",
      "EV":"Eveniment"
    };
    return map[c] || (c ? c : "â€”");
  }

  function invLabel(l){
    const d = l.startDate || "â€”";
    const a = fmtTime(l.startTime);
    const b = fmtTime(l.endTime);
    // dacÄƒ nu avem ore valide, nu afiÈ™Äƒm '1899' niciodatÄƒ
    if (a==="â€”" && b==="â€”") return "ÃŽnvoire";
    return `ÃŽnvoire (${a}â€“${b})`;
  }

  function periodLabel(l){
    const isInv = norm(l.kind)==="invoire";
    if (isInv){
      const d = fmtDateRO(l.startDate);
      const a = fmtTime(l.startTime);
      const b = fmtTime(l.endTime);
      return { main: `${d}`, meta: `ÃŽnvoire â€¢ ${a}â€“${b}` };
    }
    const a = fmtDateRO(l.startDate);
    const b = fmtDateRO(l.endDate || l.startDate);
    const lbl = leaveLabel(l.code);
    return { main: `${a} â€“ ${b}`, meta: lbl };
  }

  function fmtDateRO(iso){
    if (!iso) return "â€”";
    const d = parseIsoDate(iso);
    if (!d) return String(iso);
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    return `${dd}.${mm}.${yy}`;
  }

  async function decideOne(l, decision){
    const endpoint = ep();
    if (!endpoint){ setError("LipseÈ™te endpoint Ã®n config.json."); return; }
    const key = getAdminKey();
    if (!key){ setError("LipseÈ™te ADMIN_KEY."); return; }

    const admin = getAdminSession();
    const by = (admin && (admin.label || admin.email)) ? (admin.label || admin.email) : "admin";

    const note = ""; // UI rapidÄƒ: fÄƒrÄƒ notÄƒ

    const url = endpoint + "?fn=adminLeaveDecide"
      + "&id=" + encodeURIComponent(l.id)
      + "&decision=" + encodeURIComponent(decision)
      + "&note=" + encodeURIComponent(note)
      + "&by=" + encodeURIComponent(by)
      + "&key=" + encodeURIComponent(key)
      + "&ts=" + Date.now();

    try{
      const res = await jsonp(url);
      if (!res || !res.ok) throw new Error(res?.error || "Eroare la salvare.");
      toast(decision === "approved" ? "Aprobat." : "Respins.");
      await loadMonth(CUR_YM);
    }catch(err){
      setError(String(err && err.message ? err.message : err));
    }
  }



  // ===== Modal (approval) =====
  let CURRENT = null; // {arr, day}
  function openModal(arr, day, admin){
    if (!arr || !arr.length) return;
    CURRENT = { arr, day };
    const l = arr[0];

    const ov = $("#ov");
    if (!ov) return;
    ov.classList.add("show");

    // fill
    const mPeriod = $("#mPeriod"), mCount=$("#mCount"), mReason=$("#mReason"), mDay=$("#mDay");
    const mNote=$("#mNote");
    if (mNote) mNote.value = "";

    const kind = norm(l.kind);
    if (kind === "invoire"){
      if (mPeriod) mPeriod.textContent = `${l.startDate} â€¢ ${fmtTime(l.startTime)}â€“${fmtTime(l.endTime)}`;
      if (mCount) mCount.textContent = "ÃŽnvoire (ore)";
    } else {
      if (mPeriod) mPeriod.textContent = `${l.startDate} - ${l.endDate}`;
      if (mCount) mCount.textContent = `${countDays(l.startDate, l.endDate)} zile`;
    }
    if (mReason) mReason.textContent = l.reason || "â€”";
    if (mDay) mDay.textContent = day || l.startDate || "â€”";

    // same day / period avatars
    fillAvatars("#sameDayAv", listSameDay(arr, day));
    fillAvatars("#samePeriodAv", listSamePeriod(arr));

    // buttons
    const mApprove = $("#mApprove"), mReject=$("#mReject");
    if (mApprove) mApprove.disabled = false;
    if (mReject) mReject.disabled = false;
  }

  function closeModal(){
    const ov = $("#ov");
    if (!ov) return;
    ov.classList.remove("show");
    CURRENT = null;
  }

  function fillAvatars(sel, people){
    const box = $(sel);
    if (!box) return;
    box.innerHTML = "";
    if (!people.length){
      box.innerHTML = `<div class="muted">â€”</div>`;
      return;
    }
    people.slice(0,6).forEach(p=>{
      const d = document.createElement("div");
      d.className = "av2";
      d.title = p;
      const url = getAvatarUrl(p);
      if (url){
        const img = document.createElement("img");
        img.src = url;
        img.alt = "";
        d.appendChild(img);
      } else {
        d.textContent = initials(p);
      }
      box.appendChild(d);
    });
  }

  function countDays(sd, ed){
    const a = parseIsoDate(sd), b = parseIsoDate(ed);
    if (!a || !b) return 0;
    const ms = b.getTime() - a.getTime();
    return Math.floor(ms / 86400000) + 1;
  }

  function listSameDay(arr, day){
    // within current view, show others in same day
    const d = day || "";
    const names = new Set();
    for (const l of LEAVES_VIEW){
      if (!l.startDate) continue;
      const sd = parseIsoDate(l.startDate);
      const ed = parseIsoDate(l.endDate || l.startDate);
      const sel = parseIsoDate(d);
      if (!sd || !ed || !sel) continue;
      if (between(sel, sd, ed)) names.add(String(l.employeeName||"").trim());
    }
    // remove current employee
    for (const x of arr){
      names.delete(String(x.employeeName||"").trim());
    }
    return Array.from(names);
  }

  function listSamePeriod(arr){
    const first = arr[0];
    const sd = parseIsoDate(first.startDate);
    const ed = parseIsoDate(first.endDate || first.startDate);
    if (!sd || !ed) return [];
    const names = new Set();
    for (const l of LEAVES_VIEW){
      const a = parseIsoDate(l.startDate);
      const b = parseIsoDate(l.endDate || l.startDate);
      if (!a || !b) continue;
      // overlap
      if (b < sd || a > ed) continue;
      names.add(String(l.employeeName||"").trim());
    }
    for (const x of arr){ names.delete(String(x.employeeName||"").trim()); }
    return Array.from(names);
  }

  async function decide(decision){
    if (!CURRENT || !CURRENT.arr || !CURRENT.arr.length) return;
    const endpoint = ep();
    if (!endpoint){ setError("LipseÈ™te endpoint Ã®n config.json."); return; }
    const key = getAdminKey();
    if (!key){ setError("LipseÈ™te ADMIN_KEY."); return; }

    const admin = getAdminSession();
    const by = (admin && (admin.label || admin.email)) ? (admin.label || admin.email) : "admin";

    // decide only first request for now (if multiple in same cell, admin can click each from pending list)
    const l = CURRENT.arr[0];
    const note = ($("#mNote")?.value || "").trim();

    const url = endpoint + "?fn=adminLeaveDecide"
      + "&id=" + encodeURIComponent(l.id)
      + "&decision=" + encodeURIComponent(decision)
      + "&note=" + encodeURIComponent(note)
      + "&by=" + encodeURIComponent(by)
      + "&key=" + encodeURIComponent(key)
      + "&ts=" + Date.now();

    try{
      const res = await jsonp(url);
      if (!res || !res.ok) throw new Error(res?.error || "Eroare la salvare.");
      toast(decision === "approved" ? "Aprobat." : "Respins.");
      closeModal();
      await loadMonth(CUR_YM);
    }catch(err){
      setError(String(err && err.message ? err.message : err));
    }
  }

  // ===== load month =====
  let CUR_YM = "";

  async function loadMonth(ym){
    setError("");
    const endpoint = ep();
    if(!endpoint){ setError("LipseÈ™te leaveEndpoint/adminEventsEndpoint Ã®n config.json."); return; }

    const key = getAdminKey();
    if(!key){ setError("LipseÈ™te ADMIN_KEY."); return; }

    CUR_YM = ym;

    const admin = getAdminSession();
    const adminName = admin ? (admin.label || admin.email || "") : "";
    const adminEmail = admin ? (admin.email || "") : "";

    const url = endpoint + "?fn=adminLeavesMonth"
      + "&ym=" + encodeURIComponent(ym)
      + "&key=" + encodeURIComponent(key)
      + "&adminName=" + encodeURIComponent(adminName)
      + "&adminEmail=" + encodeURIComponent(adminEmail)
      + "&mine=0"
      + "&ts=" + Date.now();

    try{
      const [data] = await Promise.all([
        jsonp(url),
        loadManagersMap(endpoint, key)
      ]);

      if (!data || !data.ok) throw new Error(data?.error || "Eroare la Ã®ncÄƒrcare.");
      LEAVES_ALL = Array.isArray(data.list) ? data.list : [];
      buildView(admin);
      render(ym, admin);
    }catch(err){
      setError(String(err && err.message ? err.message : err));
    }
  }

  // ===== init =====
  function ymNow(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    return `${y}-${m}`;
  }

  function bind(){

    // submeniuri
    (function(){
      const btns = document.querySelectorAll(".stab");
      const views = {
        cal: document.getElementById("view-cal"),
        pending: document.getElementById("view-pending"),
        quick: document.getElementById("view-quick"),
      };
      function show(tab){
        btns.forEach(b=> b.classList.toggle("active", b.dataset.tab===tab));
        Object.keys(views).forEach(k=>{
          const el = views[k];
          if(!el) return;
          el.classList.toggle("active", k===tab);
        });
        try{ history.replaceState(null,"", "#" + tab); }catch(_){}
      }
      btns.forEach(b=>{
        b.addEventListener("click", ()=>{
          show(b.dataset.tab);
          window.scrollTo({top:0, behavior:"smooth"});
        });
      });
      const h = (location.hash||"").replace("#","");
      if (h && views[h]) show(h);
      else show("cal");
    })();

    // sync search boxes (top + calendar)
    const q1 = $("#q"), q2 = $("#q2");
    if (q1 && q2){
      const sync = (src, dst) => { dst.value = src.value; };
      q1.addEventListener("input", ()=>{ sync(q1,q2); buildView(getAdminSession()); render(CUR_YM, getAdminSession()); }, {passive:true});
      q2.addEventListener("input", ()=>{ sync(q2,q1); buildView(getAdminSession()); render(CUR_YM, getAdminSession()); }, {passive:true});
    }

    // month selector
    const monthSel = $("#monthSel");
    if (monthSel){
      const now = ymNow();
      monthSel.value = now;
      monthSel.addEventListener("change", ()=>loadMonth(monthSel.value));
    }

    $("#prev")?.addEventListener("click", ()=>{
      const m = ($("#monthSel")?.value || ymNow()).split("-").map(Number);
      const d = new Date(m[0], m[1]-2, 1);
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      if ($("#monthSel")) $("#monthSel").value = ym;
      loadMonth(ym);
    });

    $("#next")?.addEventListener("click", ()=>{
      const m = ($("#monthSel")?.value || ymNow()).split("-").map(Number);
      const d = new Date(m[0], m[1], 1);
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      if ($("#monthSel")) $("#monthSel").value = ym;
      loadMonth(ym);
    });

    $("#refresh")?.addEventListener("click", ()=>loadMonth($("#monthSel")?.value || ymNow()));
    $("#q")?.addEventListener("input", ()=>{
      const admin = getAdminSession();
      buildView(admin);
      render(CUR_YM || ($("#monthSel")?.value || ymNow()), admin);
    });
    $("#onlyMine")?.addEventListener("change", ()=>{
      const admin = getAdminSession();
      buildView(admin);
      render(CUR_YM || ($("#monthSel")?.value || ymNow()), admin);
    });


    // sync "Doar ale mele" (buton pÄƒtrat)
    const onlyCb = $("#onlyMine");
    const onlyBtn = $("#onlyMineBtn");
    const syncOnlyMine = ()=>{
      if (!onlyCb || !onlyBtn) return;
      onlyBtn.classList.toggle("toggleOn", !!onlyCb.checked);
      onlyBtn.setAttribute("aria-pressed", onlyCb.checked ? "true" : "false");
    };
    syncOnlyMine();
    onlyBtn?.addEventListener("click", ()=>{
      if (!onlyCb) return;
      onlyCb.checked = !onlyCb.checked;
      onlyCb.dispatchEvent(new Event("change"));
      syncOnlyMine();
    });
    onlyCb?.addEventListener("change", syncOnlyMine);

    // modal
    $("#ov")?.addEventListener("click", (e)=>{
      if (e.target && e.target.id === "ov") closeModal();
    });
    $("#mApprove")?.addEventListener("click", ()=>decide("approved"));
    $("#mReject")?.addEventListener("click", ()=>decide("rejected"));
    $("#mDl")?.addEventListener("click", ()=>toast("Export: Ã®n curÃ¢nd"));
    document.addEventListener("keydown", (e)=>{
      if (e.key === "Escape") closeModal();
    });
  }

  async function init(){
    await loadCFG();
    bind();
    const ym = $("#monthSel")?.value || ymNow();
    CUR_YM = ym;
    await loadMonth(ym);
  }

  document.addEventListener("DOMContentLoaded", init);
})();
</script>
</body>
</html>
