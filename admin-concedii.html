<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin â€” Concedii</title>
  <style>
    :root{
      --bg: transparent;
      --card:#ffffff;
      --ink:#1f2330;
      --muted:#6f7890;
      --line:#e7e9f6;
      --accent:#6d5efc;
      --shadow:0 10px 30px rgba(20,18,40,.08);
      --r:18px;

      --c-pending:#fff3d6;
      --c-approved:#e3f7e8;
      --c-rejected:#ffe0e0;
      --c-neutral:#f6f7fb;

      /* Legend dots (approx, matches screenshot palette) */
      --dot-inprog:#6d5efc;
      --dot-subnorm:#ff6b6b;
      --dot-complet:#64c377;
      --dot-peste:#b65efc;
      --dot-inactiv:#a5a9b5;
      --dot-concediu:#33cfff;
      --dot-pauza:#ff4fd8;

      /* Leave type colors */
      --t-co:#6d5efc;
      --t-bo:#33cfff;
      --t-ccc:#b65efc;
      --t-cfp:#ff6b6b;
      --t-ev:#ffb020;
      --t-inv:#2f245c;

      --purple:#2f245c;
      --purple2:#3a2d71;
      --purpleInk:#f5f4ff;
      --purpleMuted: rgba(245,244,255,.72);
      --purpleLine: rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}

    .wrap{width:100%;padding:0}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .head{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .title{display:flex;flex-direction:column;gap:2px}
    .title h1{margin:0;font-size:18px}
    .title .sub{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:flex;align-items:center;gap:8px;background:var(--c-neutral);border:1px solid var(--line);border-radius:14px;padding:8px 10px}
    .pill input,.pill select{border:0;background:transparent;outline:none;font:inherit;color:var(--ink)}
    .btn{border:1px solid var(--line);background:var(--card);border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:700}
    .btn.primary{background:rgba(109,94,252,.12);border-color:rgba(109,94,252,.25);color:var(--accent)}
    .btn:active{transform:translateY(1px)}
    .toggle{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);border-radius:14px;background:var(--c-neutral);user-select:none}
    .toggle input{width:16px;height:16px}

    /* Tabs (like screenshot 6.png) */
    .tabsBar{
      background:rgba(109,94,252,.06);
      border-bottom:1px solid var(--line);
      padding:14px 18px 12px 18px;
      display:flex;gap:22px;align-items:flex-end;flex-wrap:wrap;
    }
    .tabBtn{
      border:0;background:transparent;cursor:pointer;
      font:inherit;font-weight:900;
      color:rgba(27,27,40,.55);
      padding:8px 2px;
      position:relative;
      font-size:18px;
    }
    .tabBtn.active{color:var(--accent)}
    .tabBtn.active:after{
      content:"";
      position:absolute;left:0;right:0;bottom:-2px;height:3px;border-radius:3px;
      background:var(--accent);
    }

    .page{display:none;padding:16px}
    .page.active{display:block}

    /* Concedii & invoiri layout: left employees + big calendar */
    .split{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:14px;
      align-items:start;
      min-height: calc(100vh - 160px);
    }
    @media(max-width:1100px){
      .split{grid-template-columns: 1fr}
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .cardHead h3{margin:0;font-size:14px}
    .muted{color:var(--muted);font-size:12px}

    .empSearch{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
    }
    .searchBox{
      display:flex;align-items:center;gap:8px;
      background:#fff;border:1px solid var(--line);
      border-radius:12px;padding:10px 12px;
    }
    .searchBox input{
      border:0;outline:none;background:transparent;
      font:inherit;width:100%;
    }
    .empList{
      padding:10px;
      overflow:auto;
      max-height: 580px; /* synced via JS after render */
    }
    .empItem{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      display:flex;gap:10px;align-items:center;
      background:#fff;
      cursor:pointer;
      margin-bottom:8px;
    }
    .empItem:hover{background:#fafaff}
    .empItem.active{
      border-color:rgba(109,94,252,.35);
      box-shadow:0 8px 18px rgba(109,94,252,.12);
    }
    .av{width:38px;height:38px;border-radius:999px;background:#e9ecff;display:grid;place-items:center;font-weight:900;color:#3a2d71;flex:0 0 auto}
    .empMeta{display:flex;flex-direction:column;gap:2px;min-width:0}
    .empMeta .n{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .empMeta .d{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .chip{
      margin-left:auto;
      display:inline-flex;align-items:center;justify-content:center;
      min-width:26px;height:22px;padding:0 8px;border-radius:999px;
      font-size:12px;font-weight:900;
      border:1px solid rgba(109,94,252,.25);
      background:#f3f4ff;color:var(--accent);
      flex:0 0 auto;
    }
    .chip.warn{border-color:rgba(255,176,32,.35);background:rgba(255,176,32,.14);color:#8b4f00}

    /* Big calendar (presence-table look) */
    .calWrap{padding:14px}
    .calTable{
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background:#fff;
    }
    .calGrid{
      --days: 31;
      display:grid;
      grid-template-columns: 280px repeat(var(--days), minmax(0, 1fr));
    }
    .hCell{
      background:#fbfbff;
      border-bottom:1px solid var(--line);
      font-size:12px;color:var(--muted);
      text-align:center;
      padding:10px 4px;
      font-weight:900;
    }
    .hLeft{
      text-align:left;
      padding-left:14px;
    }
    .hCell .dow{display:block;font-size:10px;color:rgba(111,120,144,.9);margin-top:2px;font-weight:900}
    .leftCell{
      border-right:1px solid var(--line);
      border-bottom:1px solid var(--line);
      padding:12px 14px;
      display:flex;align-items:center;gap:10px;
      background:#fff;
    }
    .leftCell .name{display:flex;flex-direction:column;gap:2px;line-height:1.1}
    .leftCell .name .n{font-weight:900}
    .leftCell .name .d{font-size:12px;color:var(--muted)}
    .dayCell{
      border-right:1px solid var(--line);
      border-bottom:1px solid var(--line);
      height:74px;
      background:#fff;
      position:relative;
      cursor:pointer;
      min-width:0;
    }
    .dayCell:last-child{border-right:0}
    .dayCell:hover{background:#fafaff}

    .box{
      position:absolute; inset:0;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:3px;
      padding:6px 4px;
    }
    .code{font-weight:1000;font-size:13px;letter-spacing:.4px;line-height:1}
    .time{font-weight:900;font-size:10px;color:rgba(27,27,40,.72);line-height:1}
    .more{font-weight:900;font-size:10px;color:rgba(27,27,40,.55);line-height:1;margin-top:1px}

    .bang{
      position:absolute;top:6px;right:6px;width:18px;height:18px;border-radius:999px;
      background:#ffb020;color:#1f2330;font-weight:1000;font-size:12px;display:grid;place-items:center;
      border:2px solid #fff;
      z-index:5;
    }

    /* type stylings */
    .t-co{--t:var(--t-co)}
    .t-bo{--t:var(--t-bo)}
    .t-ccc{--t:var(--t-ccc)}
    .t-cfp{--t:var(--t-cfp)}
    .t-ev{--t:var(--t-ev)}
    .t-inv{--t:var(--t-inv)}
    .typeBox{
      border-top:4px solid var(--t, rgba(0,0,0,.12));
      border-bottom:3px solid rgba(31,35,48,.10);
      background:linear-gradient(180deg, rgba(255,255,255,1) 0%, rgba(250,250,255,1) 100%);
    }
    .typeBox.soft{
      background:rgba(51,207,255,.06);
    }

    /* status overlay tints */
    .st-pending{background:rgba(255,176,32,.10)}
    .st-approved{background:rgba(100,195,119,.10)}
    .st-rejected{background:rgba(255,107,107,.10)}

    .legend{
      margin-top:12px;
      padding:12px 10px 2px 10px;
      color:var(--muted);
      font-size:13px;
    }
    .legend .line1{color:var(--accent);font-weight:900;margin-bottom:10px}
    .legend .codes{display:flex;gap:18px;flex-wrap:wrap;margin-bottom:10px}
    .legend .codes b{color:var(--ink)}
    .legend .dots{display:flex;gap:16px;flex-wrap:wrap;align-items:center}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px}
    .d-inprog{background:var(--dot-inprog)}
    .d-subnorm{background:var(--dot-subnorm)}
    .d-complet{background:var(--dot-complet)}
    .d-peste{background:var(--dot-peste)}
    .d-inactiv{background:var(--dot-inactiv)}
    .d-concediu{background:var(--dot-concediu)}
    .d-pauza{background:var(--dot-pauza)}

    /* Tables for Pending + Quick approvals */
    .tableCard{padding:14px}
    .tbl{
      width:100%;
      border-collapse:separate;border-spacing:0;
      border:1px solid var(--line);
      border-radius:16px;overflow:hidden;
      background:#fff;
    }
    .tbl th,.tbl td{
      border-bottom:1px solid var(--line);
      padding:16px 12px;
      font-size:14px;
      vertical-align:middle;
    }
    .tbl th{
      background:#fbfbff;
      font-size:15px;
      color:#2f245c;
      letter-spacing:.4px;
      text-transform:uppercase;
      font-weight:1000;
    }
    .tbl tr:last-child td{border-bottom:0}
    .tbl .whoCell{display:flex;align-items:center;gap:12px;font-weight:900}
    .statusTxt{font-weight:1000}
    .s-approved{color:#64c377}
    .s-rejected{color:#ff6b6b}
    .s-pending{color:var(--accent)}

    .actRow{display:flex;gap:10px;justify-content:flex-end}
    .actBtn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      border-radius:12px;
      padding:12px 16px;
      font-weight:1000;
      border:1px solid var(--line);
      cursor:pointer;
      background:#fff;
      min-width:140px;
    }
    .actBtn.approve{background:#6bc676;color:#0b2b12;border-color:rgba(107,198,118,.35)}
    .actBtn.reject{background:rgba(109,94,252,.10);color:var(--ink);border-color:rgba(109,94,252,.25)}
    .actBtn:active{transform:translateY(1px)}

    .empty{
      padding:18px;border:1px dashed rgba(109,94,252,.35);
      border-radius:16px;background:rgba(109,94,252,.06);
      color:var(--muted);font-weight:800;
    }

    .err{margin-top:10px;padding:10px;border-radius:12px;background:#fff0f0;border:1px solid #ffd2d2;color:#9b1c1c;font-weight:800}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#1f2330;color:#fff;padding:10px 12px;border-radius:12px;font-weight:900;box-shadow:var(--shadow);display:none;z-index:99999}
    .toast.show{display:block}

    /* Approval modal (purple) */
    .ov{position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
    .ov.show{display:flex}
    .modal{
      width:min(520px, 96vw);
      background:linear-gradient(180deg,var(--purple2),var(--purple));
      color:var(--purpleInk);
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .modal .body{padding:18px}
    .k{color:var(--purpleMuted);font-size:12px;margin-top:10px}
    .v{font-weight:1000;font-size:16px;margin-top:2px}
    .avatars{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .av2{width:40px;height:40px;border-radius:999px;background:rgba(255,255,255,.16);color:var(--purpleInk);border:1px solid var(--purpleLine);display:grid;place-items:center;font-weight:1000}
    .modal textarea{
      width:100%;margin-top:12px;min-height:80px;resize:vertical;
      border-radius:12px;border:1px solid var(--purpleLine);
      background:rgba(255,255,255,.10);color:var(--purpleInk);
      padding:10px;font:inherit;outline:none
    }
    .modal .foot{
      display:flex;gap:10px;padding:14px;border-top:1px solid var(--purpleLine);
      background:rgba(0,0,0,.08)
    }
    .bbtn{
      flex:1;display:flex;align-items:center;justify-content:center;gap:8px;
      border-radius:12px;padding:12px 10px;font-weight:1000;cursor:pointer;border:1px solid transparent
    }
    .bbtn.secondary{background:rgba(255,255,255,.12);border-color:var(--purpleLine);color:var(--purpleInk)}
    .bbtn.approve{background:#6bc676;color:#0b2b12}
    .bbtn.reject{background:rgba(255,255,255,.12);border:1px solid var(--purpleLine);color:var(--purpleInk)}
    .bbtn.icon{flex:0 0 54px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="head">
        <div class="title">
          <h1>Concedii &amp; Ã®nvoiri</h1>
          <div class="sub" id="sub">AprobÄƒri</div>
        </div>
        <div class="controls">
          <button class="btn" id="prev">â€¹</button>
          <div class="pill"><select id="monthSel"></select></div>
          <button class="btn" id="next">â€º</button>
          <label class="toggle" title="FiltreazÄƒ doar cererile repartizate È›ie">
            <input type="checkbox" id="onlyMine" checked />
            <span>Doar ale mele</span>
          </label>
          <button class="btn primary" id="refresh">Refresh</button>
        </div>
      </div>

      <div class="tabsBar">
        <button class="tabBtn active" data-tab="cal">Concedii &amp; Ã®nvoiri</button>
        <button class="tabBtn" data-tab="pending">ÃŽn aÈ™teptare</button>
        <button class="tabBtn" data-tab="fast">AprobÄƒri rapide</button>
      </div>

      <!-- TAB 1: Calendar -->
      <div class="page active" id="tab-cal">
        <div id="err" class="err" style="display:none"></div>
        <div class="split">
          <div class="card" id="empCard">
            <div class="empSearch">
              <div class="searchBox">
                <span style="opacity:.65">ðŸ”Ž</span>
                <input id="empQ" placeholder="CautÄƒ angajat" />
              </div>
            </div>
            <div class="empList" id="empList"></div>
          </div>

          <div class="card" id="calCard">
            <div class="cardHead">
              <div>
                <h3 id="calTitle">Calendar cereri</h3>
                <div class="muted" id="dbg">â€”</div>
              </div>
              <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                <div class="pill" title="CautÄƒ Ã®n cereri (nume sau cod)"><span style="opacity:.7">ðŸ”Ž</span><input id="q" placeholder="CautÄƒ..." /></div>
              </div>
            </div>

            <div class="calWrap">
              <div class="calTable">
                <div class="calGrid" id="calGrid" style="--days:31"></div>
              </div>

              <div class="legend">
                <div class="line1">CondiÈ›ia de prezenÈ›Äƒ nu conÈ›ine timp activ (pontaje neÃ®ncheiate)</div>
                <div class="codes">
                  <span><b>CO</b> - Concediu de odihnÄƒ</span>
                  <span><b>BO</b> - Concediu medical</span>
                  <span><b>CCC</b> - Concediu pentru creÈ™terea copilului</span>
                  <span><b>CFP</b> - Concediu fÄƒrÄƒ platÄƒ</span>
                  <span><b>EV</b> - Eveniment</span>
                  <span><b>ÃŽNV</b> - ÃŽnvoire</span>
                </div>
                <div class="dots">
                  <span><span class="dot d-inprog"></span>ÃŽn progres</span>
                  <span><span class="dot d-subnorm"></span>Sub norma</span>
                  <span><span class="dot d-complet"></span>Complet</span>
                  <span><span class="dot d-peste"></span>Peste norma</span>
                  <span><span class="dot d-inactiv"></span>Inactiv/absent</span>
                  <span><span class="dot d-concediu"></span>Concediu</span>
                  <span><span class="dot d-pauza"></span>ÃŽn pauzÄƒ</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB 2: Pending -->
      <div class="page" id="tab-pending">
        <div id="err2" class="err" style="display:none"></div>
        <div class="tableCard">
          <table class="tbl" id="pendingTbl">
            <thead>
              <tr>
                <th style="width:34%">ANGAJAT</th>
                <th style="width:26%">TIP DE CONCEDIU</th>
                <th style="width:22%">TIP ÃŽNVOIRE</th>
                <th style="width:18%">STATUS</th>
              </tr>
            </thead>
            <tbody id="pendingTbody"></tbody>
          </table>
          <div id="pendingEmpty" class="empty" style="display:none;margin-top:12px">Nu existÄƒ cereri Ã®n luna selectatÄƒ.</div>
        </div>
      </div>

      <!-- TAB 3: Quick approvals -->
      <div class="page" id="tab-fast">
        <div id="err3" class="err" style="display:none"></div>
        <div class="tableCard">
          <table class="tbl">
            <thead>
              <tr>
                <th style="width:40%">ANGAJAT</th>
                <th style="width:30%">PERIOADÄ‚</th>
                <th style="width:30%;text-align:right">ACÈšIUNI</th>
              </tr>
            </thead>
            <tbody id="fastTbody"></tbody>
          </table>
          <div id="fastEmpty" class="empty" style="display:none;margin-top:12px">Nu existÄƒ cereri pending Ã®n luna selectatÄƒ.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Approval modal -->
  <div class="ov" id="ov">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="body">
        <div class="k">PerioadÄƒ</div>
        <div class="v" id="mPeriod">â€”</div>

        <div class="k">NumÄƒr zile / ore</div>
        <div class="v" id="mCount">â€”</div>

        <div class="k">Motiv</div>
        <div class="v" id="mReason">â€”</div>

        <div class="k">Ziua selectatÄƒ</div>
        <div class="v" id="mDay">â€”</div>

        <div class="k">ÃŽn aceeaÈ™i zi cu</div>
        <div class="avatars" id="sameDayAv"></div>

        <div class="k">ÃŽn aceeaÈ™i perioadÄƒ cu</div>
        <div class="avatars" id="samePeriodAv"></div>

        <textarea id="mNote" placeholder="NotÄƒ (opÈ›ional) â€” se aplicÄƒ la approve/reject"></textarea>
      </div>
      <div class="foot">
        <button class="bbtn secondary icon" id="mDl" title="Export (placeholder)">â¤“</button>
        <button class="bbtn reject" id="mReject">âœ• Respinge</button>
        <button class="bbtn approve" id="mApprove">âœ“ AprobÄƒ</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">â€”</div>

<script>
(() => {
  // ===== Config loading =====
  const CFG_PATHS = ["./config.json","../config.json","/config.json"];
  let CFG = null;

  const LS_ADMIN = "pontaj/admin/v1";
  const LS_ADMIN_KEY = "pontaj_adminKey";
  const LS_SELECTED_EMP = "pontaj/concedii/selectedEmp";

  function $(sel){ return document.querySelector(sel); }
  function $all(sel){ return Array.from(document.querySelectorAll(sel)); }

  function toast(msg){
    const t = $("#toast");
    if (!t) return;
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }

  function setError(msg, which=1){
    const id = which===1 ? "#err" : (which===2 ? "#err2" : "#err3");
    const e = $(id);
    if (!e) return;
    if(!msg){ e.style.display="none"; e.textContent=""; return; }
    e.style.display="block";
    e.textContent = msg;
  }

  async function loadCFG(){
    for (const p of CFG_PATHS){
      try{
        const r = await fetch(p, { cache:"no-store" });
        if (!r.ok) continue;
        CFG = await r.json();
        return;
      }catch(e){}
    }
    CFG = {};
  }
  function ep(){ return (CFG && (CFG.leaveEndpoint || CFG.adminEventsEndpoint || CFG.stateEndpoint)) || ""; }

  // ===== Admin session =====
  function getAdminSession(){
    const raw = (localStorage.getItem(LS_ADMIN) || "").trim();
    if (!raw) return null;
    let obj = null;
    try{ obj = JSON.parse(raw); }catch(_){ obj = null; }
    if (obj && typeof obj === "object"){
      const label = (obj.label || obj.name || obj.user || obj.email || obj.id || "").toString().trim();
      const email = (obj.email || obj.userEmail || obj.mail || "").toString().trim();
      if (!label && !email) return null;
      return { raw: obj, label: label || email, email: email || "" };
    }
    return { raw: { value: raw }, label: raw, email: "" };
  }

  function getAdminKey(){
    let k = "";
    try{ k = (localStorage.getItem(LS_ADMIN_KEY) || "").trim(); }catch(e){}
    if (!k){
      k = (prompt("Cheie admin (ADMIN_KEY) pentru aprobÄƒri:", "") || "").trim();
      if (k){ try{ localStorage.setItem(LS_ADMIN_KEY, k); }catch(e){} }
    }
    return k;
  }

  // ===== JSONP =====
  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const cb = "cb_"+Math.random().toString(16).slice(2);
      const s = document.createElement("script");
      const t = setTimeout(()=>{ cleanup(); reject(new Error("JSONP timeout")); }, 20000);
      function cleanup(){
        clearTimeout(t);
        try{ delete window[cb]; }catch(_){ window[cb]=undefined; }
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }
      window[cb] = (data)=>{ cleanup(); resolve(data); };
      s.onerror = ()=>{ cleanup(); reject(new Error("JSONP error")); };
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
      document.body.appendChild(s);
    });
  }

  // ===== helpers =====
  function norm(s){ return String(s||"").trim().toLowerCase(); }
  function deacc(s){ return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }
  function keyName(s){ return deacc(norm(s)).replace(/\s+/g," ").trim(); }
  function tokens(s){ return keyName(s).split(/[^a-z0-9]+/).filter(Boolean); }

  function samePerson(a,b){
    const A = keyName(a), B = keyName(b);
    if (!A || !B) return false;
    if (A === B) return true;
    if (A.includes(B) || B.includes(A)) return true;
    const ta = tokens(A), tb = tokens(B);
    const small = ta.length<=tb.length ? ta : tb;
    const big = ta.length<=tb.length ? tb : ta;
    let hits = 0;
    for (const t of small){
      if (big.includes(t)) hits++;
    }
    return hits >= Math.min(2, small.length);
  }

  function initials(name){
    const parts = String(name||"").trim().split(/\s+/).filter(Boolean);
    const a = parts[0]?.[0] || "?";
    const b = parts.length>1 ? parts[parts.length-1][0] : "";
    return (a+b).toUpperCase();
  }

  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtTime(v){
    if (v === null || v === undefined || v === "") return "";
    if (typeof v === "string"){
      const m = v.match(/(\d{1,2}):(\d{2})/);
      if (m) return pad2(m[1]) + ":" + m[2];
      const d = new Date(v);
      if (!isNaN(d.getTime())) return pad2(d.getHours()) + ":" + pad2(d.getMinutes());
      return v;
    }
    if (v instanceof Date){
      if (!isNaN(v.getTime())) return pad2(v.getHours()) + ":" + pad2(v.getMinutes());
      return "";
    }
    if (typeof v === "number" && isFinite(v)){
      let frac = v % 1;
      if (frac < 0) frac += 1;
      const totalMin = Math.round(frac * 24 * 60);
      const hh = Math.floor(totalMin / 60) % 24;
      const mm = totalMin % 60;
      return pad2(hh) + ":" + pad2(mm);
    }
    try{
      const d = new Date(v);
      if (!isNaN(d.getTime())) return pad2(d.getHours()) + ":" + pad2(d.getMinutes());
    }catch(e){}
    return "";
  }

  function daysInMonth(ym){
    const [y,m] = ym.split("-").map(Number);
    return new Date(y, m, 0).getDate();
  }
  function dowShort(d){
    const arr=["Du","Lu","Ma","Mi","Jo","Vi","SÃ¢"];
    return arr[d.getDay()];
  }
  function parseIsoDate(s){
    const m = String(s||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return null;
    return new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), 12,0,0,0);
  }
  function between(d, a, b){
    return d && a && b && d.getTime() >= a.getTime() && d.getTime() <= b.getTime();
  }

  function statusKey(s){
    const v = norm(s);
    if (v === "approved") return "approved";
    if (v === "rejected") return "rejected";
    return "pending";
  }

  function typeKey(l){
    const k = norm(l.kind);
    if (k === "invoire") return "inv";
    const c = String(l.code||"").toUpperCase().trim();
    if (c === "CO") return "co";
    if (c === "BO") return "bo";
    if (c === "CCC") return "ccc";
    if (c === "CFP") return "cfp";
    if (c === "EV") return "ev";
    return "co";
  }

  function prettyLeaveType(l){
    const k = norm(l.kind);
    if (k === "invoire") return "ÃŽnvoire";
    const c = String(l.code||"").toUpperCase().trim();
    const map = { CO:"Concediu de odihnÄƒ", BO:"Concediu medical", CCC:"Concediu creÈ™tere copil", CFP:"Concediu fÄƒrÄƒ platÄƒ", EV:"Eveniment" };
    return map[c] || (c || "Concediu");
  }

  function prettyStatus(s){
    const k = statusKey(s);
    if (k==="approved") return {text:"Solicitare aprobatÄƒ", cls:"s-approved"};
    if (k==="rejected") return {text:"Solicitare respinsÄƒ", cls:"s-rejected"};
    return {text:"Solicitare Ã®n aÈ™teptare", cls:"s-pending"};
  }

  // ===== data =====
  let LEAVES_ALL = [];
  let LEAVES_VIEW = [];
  let MANAGERS = null; // { empKey: {managerName, managerEmail} }
  let SELECTED_EMP = null; // empKey
  let CUR_YM = "";

  async function loadManagersMap(endpoint, key){
    if (MANAGERS) return MANAGERS;
    try{
      const u = endpoint + "?fn=adminManagersMap&key=" + encodeURIComponent(key) + "&ts=" + Date.now();
      const data = await jsonp(u);
      if (data && data.ok && data.map){
        MANAGERS = data.map;
        return MANAGERS;
      }
    }catch(_){}
    MANAGERS = {};
    return MANAGERS;
  }

  function enrichLeave(l){
    const emp = String(l.employeeName||"").trim();
    const empKey = keyName(emp) + "|" + keyName(l.department||l.dept||"");
    const m = (MANAGERS && MANAGERS[keyName(emp)]) ? MANAGERS[keyName(emp)] : null;
    const mgrName = String(l.managerName||"").trim() || (m ? String(m.managerName||"").trim() : "");
    const mgrEmail = String(l.managerEmail||"").trim() || (m ? String(m.managerEmail||"").trim() : "");
    return {
      ...l,
      employeeName: emp,
      dept: String(l.department||l.dept||"").trim(),
      _empKey: empKey,
      _mgrName: mgrName,
      _mgrEmail: mgrEmail,
      _status: statusKey(l.status),
      _type: typeKey(l),
    };
  }

  function filterMine(list, admin){
    const onlyMine = $("#onlyMine")?.checked;
    if (!onlyMine) return list;
    if (!admin) return list;
    const adminId = admin.label || admin.email || "";
    if (!adminId) return list;

    return list.filter(l=>{
      const a = l._mgrName || "";
      const b = l._mgrEmail || "";
      if (!a && !b) return false;
      return samePerson(a, adminId) || samePerson(b, adminId) || samePerson(a, admin.email||"") || samePerson(b, admin.email||"");
    });
  }

  function filterSearch(list){
    const q = norm($("#q")?.value || "");
    if (!q) return list;
    const qq = deacc(q);
    return list.filter(l=>{
      const n = deacc(norm(l.employeeName||""));
      const c = deacc(norm(l.code||""));
      const k = deacc(norm(l.kind||""));
      return n.includes(qq) || c.includes(qq) || k.includes(qq);
    });
  }

  function buildView(admin){
    const enriched = LEAVES_ALL.map(enrichLeave);
    let list = enriched;
    list = filterMine(list, admin);
    list = filterSearch(list);
    LEAVES_VIEW = list;
  }

  function buildEmployees(){
    const q = norm($("#empQ")?.value || "");
    const qq = deacc(q);

    const map = new Map();
    for (const l of LEAVES_VIEW){
      const k = l._empKey;
      if (!k) continue;
      if (!map.has(k)){
        map.set(k, { key:k, name:l.employeeName||"â€”", dept:l.dept||"", mgr:l._mgrName||l._mgrEmail||"", pending:0, total:0 });
      }
      const e = map.get(k);
      e.total++;
      if (l._status === "pending") e.pending++;
      // keep mgr if exists
      if (!e.mgr && (l._mgrName||l._mgrEmail)) e.mgr = (l._mgrName||l._mgrEmail);
    }
    let arr = Array.from(map.values())
      .sort((a,b)=> keyName(a.name).localeCompare(keyName(b.name)));
    if (qq){
      arr = arr.filter(e=>{
        const n = deacc(norm(e.name));
        const d = deacc(norm(e.dept));
        return n.includes(qq) || d.includes(qq);
      });
    }
    return arr;
  }

  // ===== render: employees list + calendar =====
  function renderEmployees(){
    const list = $("#empList");
    if (!list) return;
    const emps = buildEmployees();

    // choose selected
    if (!SELECTED_EMP){
      try{ SELECTED_EMP = (localStorage.getItem(LS_SELECTED_EMP)||"").trim() || ""; }catch(e){}
    }
    if (!SELECTED_EMP || !emps.some(e=>e.key===SELECTED_EMP)){
      SELECTED_EMP = emps[0]?.key || null;
      if (SELECTED_EMP){ try{ localStorage.setItem(LS_SELECTED_EMP, SELECTED_EMP); }catch(e){} }
    }

    list.innerHTML = "";
    if (!emps.length){
      list.innerHTML = `<div class="empty" style="margin:10px">Nu existÄƒ cereri pentru luna selectatÄƒ.</div>`;
      return;
    }

    for (const e of emps){
      const div = document.createElement("div");
      div.className = "empItem" + (e.key===SELECTED_EMP ? " active" : "");
      const chipClass = e.pending ? "chip warn" : "chip";
      div.innerHTML = `
        <div class="av">${initials(e.name)}</div>
        <div class="empMeta">
          <div class="n">${escapeHtml(e.name)}</div>
          <div class="d">${escapeHtml(e.dept || "â€”")}${e.mgr ? " â€¢ Manager: " + escapeHtml(e.mgr) : ""}</div>
        </div>
        <div class="${chipClass}" title="${e.pending ? "Pending" : "Total"}">${e.pending ? e.pending : e.total}</div>
      `;
      div.addEventListener("click", ()=>{
        SELECTED_EMP = e.key;
        try{ localStorage.setItem(LS_SELECTED_EMP, SELECTED_EMP); }catch(_){}
        renderEmployees();
        renderCalendar(CUR_YM, getAdminSession());
      });
      list.appendChild(div);
    }
  }

  function renderCalendar(ym, admin){
    const grid = $("#calGrid");
    if (!grid) return;

    const dim = daysInMonth(ym);
    grid.style.setProperty("--days", String(dim));

    // find selected employee meta
    const emps = buildEmployees();
    const emp = emps.find(x=>x.key===SELECTED_EMP) || emps[0];
    if (!emp){
      grid.innerHTML = "";
      return;
    }

    // build day map for selected employee
    const selectedLeaves = LEAVES_VIEW.filter(l=>l._empKey === emp.key);
    const dayMap = new Map(); // dayNumber => entries
    for (const l of selectedLeaves){
      const sd = parseIsoDate(l.startDate);
      const ed = parseIsoDate(l.endDate || l.startDate);
      if (!sd || !ed) continue;
      for (let d=1; d<=dim; d++){
        const day = new Date(Number(ym.slice(0,4)), Number(ym.slice(5,7))-1, d, 12,0,0,0);
        if (between(day, sd, ed)){
          if (!dayMap.has(d)) dayMap.set(d, []);
          dayMap.get(d).push(l);
        }
      }
    }

    // header row + one employee row
    let html = "";
    html += `<div class="hCell hLeft">ANGAJAT</div>`;
    for (let d=1; d<=dim; d++){
      const dt = new Date(Number(ym.slice(0,4)), Number(ym.slice(5,7))-1, d, 12,0,0,0);
      html += `<div class="hCell">${String(d).padStart(2,"0")}<span class="dow">${dowShort(dt)}</span></div>`;
    }

    // left cell with employee
    const mgrTxt = emp.mgr ? `Manager: ${emp.mgr}` : "Manager: â€”";
    html += `<div class="leftCell">
      <div class="av">${initials(emp.name)}</div>
      <div class="name">
        <div class="n">${escapeHtml(emp.name)}</div>
        <div class="d">${escapeHtml(mgrTxt)}</div>
      </div>
    </div>`;

    for (let d=1; d<=dim; d++){
      const arr = (dayMap.get(d) || []).slice().sort((a,b)=>{
        // pending first, then concediu before invoire
        const s = (a._status===b._status) ? 0 : (a._status==="pending" ? -1 : 1);
        if (s) return s;
        return (a._type==="inv") - (b._type==="inv");
      });

      if (!arr.length){
        html += `<div class="dayCell" data-day="${String(d).padStart(2,"0")}"></div>`;
        continue;
      }

      const first = arr[0];
      const pending = arr.some(x=>x._status==="pending");
      const st = pending ? "pending" : (arr.some(x=>x._status==="rejected") ? "rejected" : "approved");
      const t = first._type;

      const code = (t==="inv") ? "ÃŽNV" : (String(first.code||"").toUpperCase().trim() || "â€”");
      const time = (t==="inv") ? `${fmtTime(first.startTime)}-${fmtTime(first.endTime)}` : "";
      const more = arr.length>1 ? `+${arr.length-1}` : "";
      const payload = encodeURIComponent(JSON.stringify(arr));

      html += `<div class="dayCell" data-day="${String(d).padStart(2,"0")}">
        ${pending ? `<div class="bang">!</div>` : ``}
        <div class="box typeBox t-${t} st-${st}" data-arr="${payload}">
          <div class="code">${escapeHtml(code)}</div>
          ${time ? `<div class="time">${escapeHtml(time)}</div>` : ``}
          ${more ? `<div class="more">${escapeHtml(more)}</div>` : ``}
        </div>
      </div>`;
    }

    grid.innerHTML = html;

    // event delegation for cell click
    grid.onclick = (ev)=>{
      const box = ev.target && ev.target.closest ? ev.target.closest(".box") : null;
      if (!box) return;
      const dayCell = box.closest(".dayCell");
      const day = ym + "-" + (dayCell?.getAttribute("data-day") || "01");
      let arr = [];
      try{ arr = JSON.parse(decodeURIComponent(box.getAttribute("data-arr") || "[]")); }catch(e){ arr = []; }
      openModal(arr, day);
    };

    // title & debug
    const title = $("#calTitle");
    if (title) title.textContent = `Calendar cereri â€” ${emp.name}`;
    const dbg = $("#dbg");
    if (dbg){
      const a = admin ? (admin.label || admin.email || "â€”") : "â€”";
      const pendingCount = LEAVES_VIEW.filter(l=>l._status==="pending").length;
      dbg.textContent = `ÃŽncÄƒrcate: ${LEAVES_ALL.length} â€¢ AfiÈ™ate: ${LEAVES_VIEW.length} â€¢ Pending: ${pendingCount} â€¢ Admin: ${a}`;
    }

    // sync left list height to calendar card
    syncEmpListHeight();
  }

  function syncEmpListHeight(){
    const empList = $("#empList");
    const calCard = $("#calCard");
    const empCard = $("#empCard");
    if (!empList || !calCard || !empCard) return;
    if (window.matchMedia && window.matchMedia("(max-width:1100px)").matches){
      empList.style.maxHeight = "320px";
      return;
    }
    // approximate: keep list within calendar card height
    const h = calCard.getBoundingClientRect().height;
    empList.style.maxHeight = Math.max(240, Math.floor(h - 70)) + "px";
  }

  // ===== render: pending table + quick approvals =====
  function renderPendingTable(){
    const tb = $("#pendingTbody");
    const empty = $("#pendingEmpty");
    if (!tb) return;

    const rows = LEAVES_VIEW.slice().sort((a,b)=>{
      const o = (a._status===b._status) ? 0 : (a._status==="pending" ? -1 : 1);
      if (o) return o;
      return keyName(a.employeeName).localeCompare(keyName(b.employeeName));
    });

    tb.innerHTML = "";
    if (!rows.length){
      if (empty) empty.style.display = "block";
      return;
    }
    if (empty) empty.style.display = "none";

    for (const l of rows){
      const tr = document.createElement("tr");
      const invText = (l._type==="inv") ? `ÃŽnvoire (${fmtTime(l.startTime)}â€“${fmtTime(l.endTime)})` : "â€”";
      const leaveText = (l._type==="inv") ? "â€”" : prettyLeaveType(l);
      const st = prettyStatus(l._status);

      tr.innerHTML = `
        <td>
          <div class="whoCell">
            <div class="av">${initials(l.employeeName)}</div>
            <div>
              <div style="font-weight:1000">${escapeHtml(l.employeeName)}</div>
              <div class="muted" style="margin-top:2px">${escapeHtml(l.dept||"â€”")}</div>
            </div>
          </div>
        </td>
        <td>${escapeHtml(leaveText)}</td>
        <td>${escapeHtml(invText)}</td>
        <td><span class="statusTxt ${st.cls}">${escapeHtml(st.text)}</span></td>
      `;
      tr.addEventListener("click", ()=>{
        const day = l.startDate || (CUR_YM + "-01");
        openModal([l], day);
      });
      tb.appendChild(tr);
    }
  }

  function renderQuickApprovals(){
    const tb = $("#fastTbody");
    const empty = $("#fastEmpty");
    if (!tb) return;

    const pend = LEAVES_VIEW.filter(l=>l._status==="pending").sort((a,b)=>{
      return keyName(a.employeeName).localeCompare(keyName(b.employeeName));
    });

    tb.innerHTML = "";
    if (!pend.length){
      if (empty) empty.style.display = "block";
      return;
    }
    if (empty) empty.style.display = "none";

    for (const l of pend){
      const tr = document.createElement("tr");
      const period = (l._type==="inv")
        ? `${l.startDate} â€¢ ${fmtTime(l.startTime)}â€“${fmtTime(l.endTime)}`
        : `${l.startDate} - ${l.endDate || l.startDate}`;
      tr.innerHTML = `
        <td>
          <div class="whoCell">
            <div class="av">${initials(l.employeeName)}</div>
            <div>
              <div style="font-weight:1000">${escapeHtml(l.employeeName)}</div>
              <div class="muted" style="margin-top:2px">${escapeHtml(l.dept||"â€”")}</div>
            </div>
          </div>
        </td>
        <td style="font-weight:1000">${escapeHtml(period)}</td>
        <td style="text-align:right">
          <div class="actRow">
            <button class="actBtn approve">âœ“ AprobÄƒ</button>
            <button class="actBtn reject">âœ• Respinge</button>
          </div>
        </td>
      `;
      const [bAp, bRej] = Array.from(tr.querySelectorAll("button"));
      bAp.addEventListener("click", (e)=>{ e.stopPropagation(); decideOne(l, "approved"); });
      bRej.addEventListener("click", (e)=>{ e.stopPropagation(); decideOne(l, "rejected"); });
      tr.addEventListener("click", ()=> openModal([l], l.startDate || (CUR_YM+"-01")) );
      tb.appendChild(tr);
    }
  }

  // ===== Modal logic =====
  let CURRENT = null; // {arr, day}
  function openModal(arr, day){
    if (!arr || !arr.length) return;
    CURRENT = { arr, day };
    const ov = $("#ov");
    if (!ov) return;
    ov.classList.add("show");

    const l = arr[0];
    const mPeriod = $("#mPeriod"), mCount=$("#mCount"), mReason=$("#mReason"), mDay=$("#mDay");
    const mNote=$("#mNote");
    if (mNote) mNote.value = "";

    if (l._type === "inv"){
      if (mPeriod) mPeriod.textContent = `${l.startDate} â€¢ ${fmtTime(l.startTime)}â€“${fmtTime(l.endTime)}`;
      if (mCount) mCount.textContent = "ÃŽnvoire (ore)";
    } else {
      if (mPeriod) mPeriod.textContent = `${l.startDate} - ${l.endDate || l.startDate}`;
      if (mCount) mCount.textContent = `${countDays(l.startDate, l.endDate || l.startDate)} zile`;
    }
    if (mReason) mReason.textContent = l.reason || "â€”";
    if (mDay) mDay.textContent = day || l.startDate || "â€”";

    fillAvatars("#sameDayAv", listSameDay(arr, day));
    fillAvatars("#samePeriodAv", listSamePeriod(arr));

    // disable actions if not pending
    const isPending = arr.some(x=>x._status==="pending");
    const mApprove = $("#mApprove"), mReject=$("#mReject");
    if (mApprove) mApprove.disabled = !isPending;
    if (mReject) mReject.disabled = !isPending;
  }

  function closeModal(){
    const ov = $("#ov");
    if (!ov) return;
    ov.classList.remove("show");
    CURRENT = null;
  }

  function fillAvatars(sel, people){
    const box = $(sel);
    if (!box) return;
    box.innerHTML = "";
    if (!people.length){
      box.innerHTML = `<div class="muted">â€”</div>`;
      return;
    }
    people.slice(0,8).forEach(p=>{
      const d = document.createElement("div");
      d.className = "av2";
      d.title = p;
      d.textContent = initials(p);
      box.appendChild(d);
    });
  }

  function countDays(sd, ed){
    const a = parseIsoDate(sd), b = parseIsoDate(ed);
    if (!a || !b) return 0;
    const ms = b.getTime() - a.getTime();
    return Math.floor(ms / 86400000) + 1;
  }

  function listSameDay(arr, day){
    const sel = parseIsoDate(day);
    if (!sel) return [];
    const names = new Set();
    for (const l of LEAVES_VIEW){
      const sd = parseIsoDate(l.startDate);
      const ed = parseIsoDate(l.endDate || l.startDate);
      if (!sd || !ed) continue;
      if (between(sel, sd, ed)) names.add(String(l.employeeName||"").trim());
    }
    for (const x of arr){ names.delete(String(x.employeeName||"").trim()); }
    return Array.from(names);
  }

  function listSamePeriod(arr){
    const first = arr[0];
    const sd = parseIsoDate(first.startDate);
    const ed = parseIsoDate(first.endDate || first.startDate);
    if (!sd || !ed) return [];
    const names = new Set();
    for (const l of LEAVES_VIEW){
      const a = parseIsoDate(l.startDate);
      const b = parseIsoDate(l.endDate || l.startDate);
      if (!a || !b) continue;
      if (b < sd || a > ed) continue;
      names.add(String(l.employeeName||"").trim());
    }
    for (const x of arr){ names.delete(String(x.employeeName||"").trim()); }
    return Array.from(names);
  }

  async function decide(decision){
    if (!CURRENT || !CURRENT.arr || !CURRENT.arr.length) return;
    // decide first pending request in array
    const l = CURRENT.arr.find(x=>x._status==="pending") || CURRENT.arr[0];
    await decideOne(l, decision, true);
  }

  async function decideOne(l, decision, fromModal=false){
    const endpoint = ep();
    if (!endpoint){ setError("LipseÈ™te endpoint Ã®n config.json.", 1); return; }
    const key = getAdminKey();
    if (!key){ setError("LipseÈ™te ADMIN_KEY.", 1); return; }

    const admin = getAdminSession();
    const by = (admin && (admin.label || admin.email)) ? (admin.label || admin.email) : "admin";
    const note = (fromModal ? ($("#mNote")?.value || "").trim() : "");

    const url = endpoint + "?fn=adminLeaveDecide"
      + "&id=" + encodeURIComponent(l.id)
      + "&decision=" + encodeURIComponent(decision)
      + "&note=" + encodeURIComponent(note)
      + "&by=" + encodeURIComponent(by)
      + "&key=" + encodeURIComponent(key)
      + "&ts=" + Date.now();

    try{
      const res = await jsonp(url);
      if (!res || !res.ok) throw new Error(res?.error || "Eroare la salvare.");
      toast(decision === "approved" ? "Aprobat." : "Respins.");
      if (fromModal) closeModal();
      await loadMonth(CUR_YM);
    }catch(err){
      setError(String(err && err.message ? err.message : err), 1);
    }
  }

  // ===== Load month =====
  async function loadMonth(ym){
    setError("",1); setError("",2); setError("",3);
    const endpoint = ep();
    if(!endpoint){ setError("LipseÈ™te leaveEndpoint/adminEventsEndpoint Ã®n config.json."); return; }

    const key = getAdminKey();
    if(!key){ setError("LipseÈ™te ADMIN_KEY."); return; }

    CUR_YM = ym;

    const admin = getAdminSession();
    const adminName = admin ? (admin.label || admin.email || "") : "";
    const adminEmail = admin ? (admin.email || "") : "";

    const url = endpoint + "?fn=adminLeavesMonth"
      + "&ym=" + encodeURIComponent(ym)
      + "&key=" + encodeURIComponent(key)
      + "&adminName=" + encodeURIComponent(adminName)
      + "&adminEmail=" + encodeURIComponent(adminEmail)
      + "&mine=0"
      + "&ts=" + Date.now();

    try{
      const [data] = await Promise.all([
        jsonp(url),
        loadManagersMap(endpoint, key)
      ]);

      if (!data || !data.ok) throw new Error(data?.error || "Eroare la Ã®ncÄƒrcare.");
      LEAVES_ALL = Array.isArray(data.list) ? data.list : (Array.isArray(data.leaves) ? data.leaves : []);
      buildView(admin);

      renderEmployees();
      renderCalendar(ym, admin);
      renderPendingTable();
      renderQuickApprovals();
    }catch(err){
      setError(String(err && err.message ? err.message : err));
    }
  }

  // ===== tabs =====
  function setTab(name){
    $all(".tabBtn").forEach(b=> b.classList.toggle("active", b.dataset.tab===name));
    $all(".page").forEach(p=> p.classList.toggle("active", p.id === "tab-"+name));
    // height sync on next frame
    requestAnimationFrame(syncEmpListHeight);
  }

  // ===== init =====
  function ymNow(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    return `${y}-${m}`;
  }

  function fillMonthSel(){
    const sel = $("#monthSel");
    if (!sel) return;
    const now = new Date();
    const list = [];
    for (let i=-12;i<=12;i++){
      const d = new Date(now.getFullYear(), now.getMonth()+i, 1);
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      const label = d.toLocaleDateString("ro-RO", { month:"long", year:"numeric" });
      list.push({ym,label});
    }
    sel.innerHTML = list.map(x=>`<option value="${x.ym}">${escapeHtml(x.label)}</option>`).join("");
    sel.value = ymNow();
  }

  function bind(){
    fillMonthSel();

    $("#monthSel")?.addEventListener("change", ()=>loadMonth($("#monthSel").value));
    $("#prev")?.addEventListener("click", ()=>{
      const m = ($("#monthSel")?.value || ymNow()).split("-").map(Number);
      const d = new Date(m[0], m[1]-2, 1);
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      $("#monthSel").value = ym;
      loadMonth(ym);
    });
    $("#next")?.addEventListener("click", ()=>{
      const m = ($("#monthSel")?.value || ymNow()).split("-").map(Number);
      const d = new Date(m[0], m[1], 1);
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      $("#monthSel").value = ym;
      loadMonth(ym);
    });
    $("#refresh")?.addEventListener("click", ()=>loadMonth($("#monthSel")?.value || ymNow()));
    $("#onlyMine")?.addEventListener("change", ()=>{
      const admin = getAdminSession();
      buildView(admin);
      renderEmployees();
      renderCalendar(CUR_YM, admin);
      renderPendingTable();
      renderQuickApprovals();
    });

    $("#q")?.addEventListener("input", ()=>{
      const admin = getAdminSession();
      buildView(admin);
      renderEmployees();
      renderCalendar(CUR_YM, admin);
      renderPendingTable();
      renderQuickApprovals();
    });
    $("#empQ")?.addEventListener("input", ()=>renderEmployees());

    // tabs click
    $all(".tabBtn").forEach(b=> b.addEventListener("click", ()=>setTab(b.dataset.tab)));

    // modal
    $("#ov")?.addEventListener("click", (e)=>{
      if (e.target && e.target.id === "ov") closeModal();
    });
    $("#mApprove")?.addEventListener("click", ()=>decide("approved"));
    $("#mReject")?.addEventListener("click", ()=>decide("rejected"));
    $("#mDl")?.addEventListener("click", ()=>toast("Export: Ã®n curÃ¢nd"));
    document.addEventListener("keydown", (e)=>{ if (e.key==="Escape") closeModal(); });
    window.addEventListener("resize", ()=>requestAnimationFrame(syncEmpListHeight));
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, ch => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[ch]));
  }

  async function init(){
    await loadCFG();
    bind();
    const ym = $("#monthSel")?.value || ymNow();
    CUR_YM = ym;
    await loadMonth(ym);
  }

  document.addEventListener("DOMContentLoaded", init);
})();
</script>
</body>
</html>
