<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin â€” Concedii</title>
  <style>
    :root{
      --bg:#f5f6ff;
      --card:#ffffff;
      --ink:#1f2330;
      --muted:#6f7890;
      --line:#e7e9f6;
      --accent:#6d5efc;
      --shadow:0 10px 30px rgba(20,18,40,.08);
      --r:18px;

      --c-pending:#fff3d6;
      --c-approved:#e3f7e8;
      --c-rejected:#ffe0e0;
      --c-neutral:#f6f7fb;

      --purple:#2f245c;
      --purple2:#3a2d71;
      --purpleInk:#f5f4ff;
      --purpleMuted: rgba(245,244,255,.72);
      --purpleLine: rgba(255,255,255,.12);

      --ok:#64b36b;
      --bad:#d76555;
      --wait:#6d5efc;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1600px;margin:18px auto;padding:0 14px}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .head{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .title{display:flex;flex-direction:column;gap:2px}
    .title h1{margin:0;font-size:18px}
    .title .sub{font-size:12px;color:var(--muted)}

    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:flex;align-items:center;gap:8px;background:var(--c-neutral);border:1px solid var(--line);border-radius:14px;padding:8px 10px}
    .pill input,.pill select{border:0;background:transparent;outline:none;font:inherit;color:var(--ink)}
    .btn{border:1px solid var(--line);background:var(--card);border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:600}
    .btn.primary{background:rgba(109,94,252,.12);border-color:rgba(109,94,252,.25);color:var(--accent)}
    .btn:active{transform:translateY(1px)}
    .toggle{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);border-radius:14px;background:var(--c-neutral);user-select:none}
    .toggle input{width:16px;height:16px}

    .stack{display:flex;flex-direction:column;gap:14px;padding:14px}

    /* ===== Calendar (match 2.png) ===== */
    .tableWrap{background:var(--card);border:1px solid var(--line);border-radius:18px;overflow:hidden}
    .tableScroll{overflow:auto;max-height:560px}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:1100px}
    thead th{position:sticky;top:0;z-index:5;background:#fbfbff;border-bottom:1px solid var(--line);font-size:12px;color:var(--muted);text-align:center;padding:10px 6px}
    thead th:first-child{left:0;z-index:7;text-align:left;padding-left:14px;min-width:280px}
    tbody td, tbody th{border-bottom:1px solid var(--line);border-right:1px solid var(--line);height:72px;vertical-align:middle;text-align:center;font-size:13px;color:var(--ink);background:#fff}
    tbody tr:last-child td, tbody tr:last-child th{border-bottom:0}
    tbody td:last-child, thead th:last-child{border-right:0}
    tbody th{position:sticky;left:0;z-index:6;background:#fff;text-align:left;padding:10px 12px;min-width:280px;border-right:1px solid var(--line)}

    .angHead{display:flex;align-items:center;gap:10px}
    .sort{color:var(--accent);font-weight:900}
    .dow{font-size:10px; color:var(--muted); margin-top:2px; font-weight:800}

    .who{display:flex;align-items:center;gap:10px}
    .idx{width:18px;text-align:right;color:#a0a6ba;font-weight:800}
    .av{width:38px;height:38px;border-radius:999px;background:#e9ecff;display:grid;place-items:center;font-weight:900;color:#3a2d71;flex:0 0 auto}
    .name{display:flex;flex-direction:column;line-height:1.1}
    .name .n{font-weight:700}
    .name .d{font-size:12px;color:var(--muted)}
    .day{background:#fff}
    .lvcell{position:relative;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;height:100%}
    .lvcell:hover{background:#fafaff}
    .c{font-weight:900; letter-spacing:.3px}
    .t{font-size:11px;color:rgba(27,27,40,.70);font-weight:800}
    .mini{font-size:10px;color:rgba(27,27,40,.55);font-weight:800}

    .bang{
      position:absolute;top:8px;left:8px;width:18px;height:18px;border-radius:999px;
      background:#ffb020;color:#1f2330;font-weight:900;font-size:12px;display:grid;place-items:center;
      border:2px solid #fff;
    }

    /* ===== Cards below calendar ===== */
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
    .cardHead{padding:16px 18px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .cardHead h2{margin:0;font-size:16px;letter-spacing:.2px}
    .cardHead .sub{color:var(--muted);font-size:12px}

    /* ===== Status list (match 3.png) ===== */
    .simpleTable{width:100%;border-collapse:separate;border-spacing:0}
    .simpleTable thead th{
      background:#fff;
      position:sticky;top:0;z-index:2;
      text-align:left;
      padding:14px 18px;
      font-size:13px;
      letter-spacing:.2px;
      color:#2a2e3f;
      border-bottom:1px solid var(--line);
    }
    .simpleTable thead th:nth-child(2),
    .simpleTable thead th:nth-child(3),
    .simpleTable thead th:nth-child(4){text-align:left}
    .simpleTable tbody td{
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      background:#fff;
      vertical-align:middle;
      font-size:14px;
    }
    .simpleTable tbody tr:last-child td{border-bottom:0}
    .simpleTable .colAng{min-width:320px}
    .rowAng{display:flex;align-items:center;gap:14px}
    .rowAng .av{width:44px;height:44px}
    .rowAng .nm{font-weight:700}
    .dim{color:#a0a6ba;font-weight:700}
    .status{font-weight:800}
    .status.pending{color:var(--wait)}
    .status.approved{color:var(--ok)}
    .status.rejected{color:var(--bad)}

    .scrollY{max-height:520px;overflow:auto}

    /* ===== Quick approvals (match 4.png) ===== */
    .actBtns{display:flex;gap:10px;justify-content:flex-end;align-items:center}
    .actApprove{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      padding:12px 18px;border-radius:10px;border:0;
      background:#79c07a;color:white;font-weight:900;cursor:pointer;min-width:150px;
      box-shadow:0 10px 20px rgba(121,192,122,.22);
    }
    .actReject{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      padding:12px 18px;border-radius:10px;border:1px solid var(--line);
      background:#f1f2f8;color:#2a2e3f;font-weight:900;cursor:pointer;min-width:140px;
    }
    .actApprove:active,.actReject:active{transform:translateY(1px)}
    .actApprove .ic, .actReject .ic{font-size:16px;font-weight:900}

    .noteBar{display:flex;align-items:center;gap:10px}
    .noteBar input{
      width:min(520px,100%);
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      outline:none;font:inherit;background:#fff;
    }

    .empty{padding:16px 18px;color:var(--muted);font-weight:700}

    /* ===== Purple approval modal (unchanged, matches your screenshot) ===== */
    .ov{position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
    .ov.show{display:flex}
    .modal{
      width:min(520px, 96vw);
      background:linear-gradient(180deg,var(--purple2),var(--purple));
      color:var(--purpleInk);
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .modal .body{padding:18px}
    .k{color:var(--purpleMuted);font-size:12px;margin-top:10px}
    .v{font-weight:800;font-size:16px;margin-top:2px}
    .avatars{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .avatars .av{background:rgba(255,255,255,.16);color:var(--purpleInk);border:1px solid var(--purpleLine)}
    .modal textarea{
      width:100%;margin-top:12px;min-height:80px;resize:vertical;
      border-radius:12px;border:1px solid var(--purpleLine);
      background:rgba(255,255,255,.10);color:var(--purpleInk);
      padding:10px;font:inherit;outline:none
    }
    .modal .foot{
      display:flex;gap:10px;padding:14px;border-top:1px solid var(--purpleLine);
      background:rgba(0,0,0,.08)
    }
    .bbtn{
      flex:1;display:flex;align-items:center;justify-content:center;gap:8px;
      border-radius:12px;padding:12px 10px;font-weight:900;cursor:pointer;border:1px solid transparent
    }
    .bbtn.secondary{background:rgba(255,255,255,.12);border-color:var(--purpleLine);color:var(--purpleInk)}
    .bbtn.approve{background:#6bc676;color:#0b2b12}
    .bbtn.reject{background:rgba(255,255,255,.12);border:1px solid var(--purpleLine);color:var(--purpleInk)}
    .bbtn.icon{flex:0 0 54px}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#1f2330;color:#fff;padding:10px 12px;border-radius:12px;font-weight:700;box-shadow:var(--shadow);display:none;z-index:99999}
    .toast.show{display:block}

    .err{margin:0 14px 14px 14px;padding:12px;border-radius:12px;background:#fff0f0;border:1px solid #ffd2d2;color:#9b1c1c;font-weight:800;display:none}
  </style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <div class="head">
      <div class="title">
        <h1>Concedii &amp; Ã®nvoiri</h1>
        <div class="sub" id="sub">AprobÄƒri</div>
      </div>
      <div class="controls">
        <button class="btn" id="prev">â€¹</button>
        <div class="pill">
          <select id="monthSel"></select>
        </div>
        <button class="btn" id="next">â€º</button>
        <div class="pill">
          <span style="opacity:.7">ðŸ”Ž</span>
          <input id="q" placeholder="CautÄƒ angajat..." />
        </div>
        <label class="toggle" title="FiltreazÄƒ doar cererile repartizate È›ie">
          <input type="checkbox" id="onlyMine" checked />
          <span>Doar ale mele</span>
        </label>
        <button class="btn primary" id="refresh">Refresh</button>
      </div>
    </div>

    <div id="errTop" class="err"></div>

    <div class="stack">

      <!-- Calendar (2.png style) -->
      <div class="tableWrap">
        <div class="tableScroll" id="calScroll">
          <table id="cal">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- ÃŽn aÈ™teptare / Status list (3.png style) -->
      <div class="card">
        <div class="cardHead">
          <div>
            <h2>ÃŽn aÈ™teptare &amp; istoric</h2>
            <div class="sub">Lista cererilor (concediu / Ã®nvoire) + statusul curent.</div>
          </div>
          <div class="noteBar">
            <div class="sub" id="dbg" style="font-weight:800"></div>
          </div>
        </div>

        <div class="scrollY">
          <table class="simpleTable" id="reqTable">
            <thead>
              <tr>
                <th class="colAng">ANGAJAT <span class="sort">â†‘â†“</span></th>
                <th>TIP DE CONCEDIU <span class="sort">â†‘â†“</span></th>
                <th>TIP ÃŽNVOIRE <span class="sort">â†‘â†“</span></th>
                <th>STATUS</th>
              </tr>
            </thead>
            <tbody id="reqTbody"></tbody>
          </table>
          <div class="empty" id="reqEmpty" style="display:none">Nu existÄƒ cereri Ã®n luna selectatÄƒ.</div>
        </div>
      </div>

      <!-- AprobÄƒri rapide (4.png style) -->
      <div class="card">
        <div class="cardHead">
          <div>
            <h2>AprobÄƒri rapide</h2>
            <div class="sub">AprobÄƒ sau respinge direct din listÄƒ (doar cereri <b>pending</b>).</div>
          </div>
          <div class="noteBar">
            <input id="quickNote" placeholder="NotÄƒ (opÈ›ional) â€” se aplicÄƒ la approve/reject" />
          </div>
        </div>

        <div class="scrollY">
          <table class="simpleTable" id="quickTable">
            <thead>
              <tr>
                <th class="colAng">ANGAJAT <span class="sort">â†‘â†“</span></th>
                <th>PERIOADÄ‚ <span class="sort">â†‘â†“</span></th>
                <th style="text-align:right;padding-right:18px">ACÈšIUNI</th>
              </tr>
            </thead>
            <tbody id="quickTbody"></tbody>
          </table>
          <div class="empty" id="quickEmpty" style="display:none">Nu existÄƒ cereri pending Ã®n luna selectatÄƒ.</div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Approval modal -->
<div class="ov" id="ov">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="body">
      <div class="k">PerioadÄƒ</div>
      <div class="v" id="mPeriod">â€”</div>

      <div class="k">NumÄƒr</div>
      <div class="v" id="mCount">â€”</div>

      <div class="k">Motiv</div>
      <div class="v" id="mReason">â€”</div>

      <div class="k">Ziua selectatÄƒ</div>
      <div class="v" id="mDay">â€”</div>

      <div class="k">ÃŽn aceeaÈ™i zi cu</div>
      <div class="avatars" id="sameDayAv"></div>

      <div class="k">ÃŽn aceeaÈ™i perioadÄƒ cu</div>
      <div class="avatars" id="samePeriodAv"></div>

      <textarea id="mNote" placeholder="NotÄƒ (opÈ›ional) â€” se aplicÄƒ la approve/reject"></textarea>
    </div>
    <div class="foot">
      <button class="bbtn secondary icon" id="mDl" title="Export (placeholder)">â¤“</button>
      <button class="bbtn reject" id="mReject">âœ• Respinge</button>
      <button class="bbtn approve" id="mApprove">âœ“ AprobÄƒ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">â€”</div>

<script>
(() => {
  const CFG_PATHS = ["./config.json","../config.json","/config.json"];
  let CFG = null;

  const LS_ADMIN = "pontaj/admin/v1";
  const LS_ADMIN_KEY = "pontaj_adminKey";

  function $(sel){ return document.querySelector(sel); }
  function showTopError(msg){
    const e = $("#errTop");
    if (!e) return;
    if (!msg){ e.style.display="none"; e.textContent=""; return; }
    e.style.display="block";
    e.textContent = msg;
  }
  function toast(msg){
    const t = $("#toast");
    if (!t) return;
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }

  async function loadCFG(){
    for (const p of CFG_PATHS){
      try{
        const r = await fetch(p, { cache:"no-store" });
        if (!r.ok) continue;
        CFG = await r.json();
        return;
      }catch(e){}
    }
    CFG = {};
  }
  function ep(){ return (CFG && (CFG.leaveEndpoint || CFG.adminEventsEndpoint || CFG.stateEndpoint)) || ""; }

  function getAdminSession(){
    const raw = (localStorage.getItem(LS_ADMIN) || "").trim();
    if (!raw) return null;
    let obj = null;
    try{ obj = JSON.parse(raw); }catch(_){ obj = null; }
    if (obj && typeof obj === "object"){
      const label = (obj.label || obj.name || obj.user || obj.email || obj.id || "").toString().trim();
      const email = (obj.email || obj.userEmail || obj.mail || "").toString().trim();
      if (!label && !email) return null;
      return { raw: obj, label: label || email, email: email || "" };
    }
    return { raw: { value: raw }, label: raw, email: "" };
  }
  function getAdminKey(){
    let k = "";
    try{ k = (localStorage.getItem(LS_ADMIN_KEY) || "").trim(); }catch(e){}
    if (!k){
      k = (prompt("Cheie admin (ADMIN_KEY) pentru aprobÄƒri:", "") || "").trim();
      if (k){ try{ localStorage.setItem(LS_ADMIN_KEY, k); }catch(e){} }
    }
    return k;
  }

  // JSONP
  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const cb = "cb_"+Math.random().toString(16).slice(2);
      const s = document.createElement("script");
      const t = setTimeout(()=>{ cleanup(); reject(new Error("JSONP timeout")); }, 20000);
      function cleanup(){
        clearTimeout(t);
        try{ delete window[cb]; }catch(_){ window[cb]=undefined; }
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }
      window[cb] = (data)=>{ cleanup(); resolve(data); };
      s.onerror = ()=>{ cleanup(); reject(new Error("JSONP error")); };
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
      document.body.appendChild(s);
    });
  }

  // helpers
  function norm(s){ return String(s||"").trim().toLowerCase(); }
  function deacc(s){ return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }
  function keyName(s){ return deacc(norm(s)).replace(/\s+/g," ").trim(); }
  function tokens(s){ return keyName(s).split(/[^a-z0-9]+/).filter(Boolean); }
  function samePerson(a,b){
    const A = keyName(a), B = keyName(b);
    if (!A || !B) return false;
    if (A === B) return true;
    if (A.includes(B) || B.includes(A)) return true;
    const ta = tokens(A), tb = tokens(B);
    const small = ta.length<=tb.length ? ta : tb;
    const big = ta.length<=tb.length ? tb : ta;
    let hits = 0;
    for (const t of small){
      if (big.includes(t)) hits++;
    }
    return hits >= Math.min(2, small.length);
  }
  function initials(name){
    const parts = String(name||"").trim().split(/\s+/).filter(Boolean);
    const a = parts[0]?.[0] || "?";
    const b = parts.length>1 ? parts[parts.length-1][0] : "";
    return (a+b).toUpperCase();
  }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtTime(v){
    if (v === null || v === undefined || v === "") return "";
    if (typeof v === "string"){
      const m = v.match(/(\d{1,2}):(\d{2})/);
      if (m) return pad2(m[1]) + ":" + m[2];
      const d = new Date(v);
      if (!isNaN(d.getTime())) return pad2(d.getHours()) + ":" + pad2(d.getMinutes());
      return v;
    }
    if (v instanceof Date){
      if (!isNaN(v.getTime())) return pad2(v.getHours()) + ":" + pad2(v.getMinutes());
      return "";
    }
    if (typeof v === "number" && isFinite(v)){
      let frac = v % 1;
      if (frac < 0) frac += 1;
      const totalMin = Math.round(frac * 24 * 60);
      const hh = Math.floor(totalMin / 60) % 24;
      const mm = totalMin % 60;
      return pad2(hh) + ":" + pad2(mm);
    }
    try{
      const d = new Date(v);
      if (!isNaN(d.getTime())) return pad2(d.getHours()) + ":" + pad2(d.getMinutes());
    }catch(e){}
    return "";
  }

  function daysInMonth(ym){
    const [y,m] = ym.split("-").map(Number);
    return new Date(y, m, 0).getDate();
  }
  function dowShort(d){
    const arr=["Du","Lu","Ma","Mi","Jo","Vi","SÃ¢"];
    return arr[d.getDay()];
  }
  function isoDate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da= String(d.getDate()).padStart(2,"0");
    return y+"-"+m+"-"+da;
  }
  function parseIsoDate(s){
    const m = String(s||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return null;
    return new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), 12,0,0,0);
  }
  function between(d, a, b){
    return d && a && b && d.getTime() >= a.getTime() && d.getTime() <= b.getTime();
  }

  function leaveLabel(code){
    const c = (code||"").toString().trim().toUpperCase();
    const map = {
      "CO":"Concediu de odihnÄƒ",
      "BO":"Concediu medical",
      "CCC":"Concediu creÈ™tere copil",
      "CFP":"Concediu fÄƒrÄƒ platÄƒ",
      "EV":"Eveniment"
    };
    return map[c] || (c ? c : "â€”");
  }
  function statusLabel(st){
    const s = norm(st);
    if (s==="approved") return { t:"Solicitare aprobatÄƒ", cls:"approved" };
    if (s==="rejected") return { t:"Solicitare respinsÄƒ", cls:"rejected" };
    return { t:"ÃŽn aÈ™teptare", cls:"pending" };
  }
  function periodText(l){
    const k = norm(l.kind);
    if (k === "invoire"){
      const t1 = fmtTime(l.startTime);
      const t2 = fmtTime(l.endTime);
      return `${l.startDate} â€¢ ${t1}â€“${t2}`;
    }
    return `${l.startDate} â€“ ${l.endDate || l.startDate}`;
  }

  // data
  let LEAVES_ALL = [];
  let LEAVES_VIEW = [];
  let MANAGERS = null;

  async function loadManagersMap(endpoint, key){
    if (MANAGERS) return MANAGERS;
    try{
      const u = endpoint + "?fn=adminManagersMap&key=" + encodeURIComponent(key) + "&ts=" + Date.now();
      const data = await jsonp(u);
      if (data && data.ok && data.map){
        MANAGERS = data.map;
        return MANAGERS;
      }
    }catch(_){}
    MANAGERS = {};
    return MANAGERS;
  }

  function enrichLeave(l){
    const emp = String(l.employeeName||"").trim();
    const k = keyName(emp);
    const m = (MANAGERS && MANAGERS[k]) ? MANAGERS[k] : null;
    const mgrName = String(l.managerName||"").trim() || (m ? String(m.managerName||"").trim() : "");
    const mgrEmail = String(l.managerEmail||"").trim() || (m ? String(m.managerEmail||"").trim() : "");
    return { ...l, _empKey:k, _mgrName:mgrName, _mgrEmail:mgrEmail };
  }

  function filterMine(list, admin){
    const onlyMine = $("#onlyMine")?.checked;
    if (!onlyMine) return list;
    if (!admin) return list;
    const adminId = admin.label || admin.email || "";
    if (!adminId) return list;
    return list.filter(l=>{
      const a = l._mgrName || "";
      const b = l._mgrEmail || "";
      if (!a && !b) return false;
      return samePerson(a, adminId) || samePerson(b, adminId) || samePerson(a, admin.email||"") || samePerson(b, admin.email||"");
    });
  }
  function filterSearch(list){
    const q = norm($("#q")?.value || "");
    if (!q) return list;
    const qq = deacc(q);
    return list.filter(l=>{
      const n = deacc(norm(l.employeeName||""));
      const c = deacc(norm(l.code||""));
      return n.includes(qq) || c.includes(qq);
    });
  }
  function buildView(admin){
    const enriched = LEAVES_ALL.map(enrichLeave);
    let list = enriched;
    list = filterMine(list, admin);
    list = filterSearch(list);
    // sort: employee then startDate
    list.sort((a,b)=>{
      const ea = keyName(a.employeeName||"");
      const eb = keyName(b.employeeName||"");
      if (ea !== eb) return ea.localeCompare(eb);
      return String(a.startDate||"").localeCompare(String(b.startDate||""));
    });
    LEAVES_VIEW = list;
  }

  // ===== render calendar + lists =====
  function renderAll(ym, admin){
    renderCalendar(ym);
    renderStatusList();
    renderQuickApprovals(admin);
    const dbg = $("#dbg");
    if (dbg){
      const a = admin ? (admin.label || admin.email || "â€”") : "â€”";
      dbg.textContent = `ÃŽncÄƒrcate: ${LEAVES_ALL.length} â€¢ AfiÈ™ate: ${LEAVES_VIEW.length} â€¢ Admin: ${a}`;
    }
  }

  function renderCalendar(ym){
    const thead = $("#thead");
    const tbody = $("#tbody");
    if (!thead || !tbody) return;

    const dim = daysInMonth(ym);

    // header row
    let h = `<tr><th><div class="angHead"><span>ANGAJAT</span><span class="sort">â†‘â†“</span></div></th>`;
    for (let d=1; d<=dim; d++){
      const dt = new Date(Number(ym.slice(0,4)), Number(ym.slice(5,7))-1, d, 12,0,0,0);
      h += `<th>${String(d).padStart(2,"0")}<div class="dow">${dowShort(dt)}</div></th>`;
    }
    h += `</tr>`;
    thead.innerHTML = h;

    // group by employee
    const byEmp = new Map();
    for (const l of LEAVES_VIEW){
      const emp = String(l.employeeName||"").trim() || "â€”";
      if (!byEmp.has(emp)) byEmp.set(emp, []);
      byEmp.get(emp).push(l);
    }
    const emps = Array.from(byEmp.keys()).sort((a,b)=>keyName(a).localeCompare(keyName(b)));

    let html = "";
    let idx = 1;
    for (const emp of emps){
      const list = byEmp.get(emp) || [];
      const cellMap = new Map();
      for (const l of list){
        const sd = parseIsoDate(l.startDate);
        const ed = parseIsoDate(l.endDate || l.startDate);
        if (!sd || !ed) continue;
        for (let d=1; d<=dim; d++){
          const day = new Date(Number(ym.slice(0,4)), Number(ym.slice(5,7))-1, d, 12,0,0,0);
          if (between(day, sd, ed)){
            if (!cellMap.has(d)) cellMap.set(d, []);
            cellMap.get(d).push(l);
          }
        }
      }

      const mgr = list[0]?._mgrName || list[0]?._mgrEmail || "";
      const mgrTxt = mgr ? `Manager: ${mgr}` : `Manager: â€”`;

      html += `<tr><th>
        <div class="who">
          <div class="idx">${idx++}</div>
          <div class="av">${initials(emp)}</div>
          <div class="name">
            <div class="n">${emp}</div>
            <div class="d">${mgrTxt}</div>
          </div>
        </div>
      </th>`;

      for (let d=1; d<=dim; d++){
        const arr = cellMap.get(d) || [];
        if (!arr.length){
          html += `<td class="day"></td>`;
          continue;
        }
        const first = arr[0];
        const code = (norm(first.kind)==="invoire") ? "INV" : (first.code || "â€”");
        const pending = arr.some(x=>norm(x.status)==="pending");
        const more = arr.length>1 ? `<div class="mini">+${arr.length-1}</div>` : "";
        const bang = pending ? `<div class="bang">!</div>` : "";
        const time = (norm(first.kind)==="invoire") ? `<div class="t">${fmtTime(first.startTime)}â€“${fmtTime(first.endTime)}</div>` : "";
        const payload = encodeURIComponent(JSON.stringify(arr));
        html += `<td class="day">
          <div class="lvcell" data-day="${String(d).padStart(2,"0")}" data-arr="${payload}">
            ${bang}
            <div class="c">${code}</div>
            ${time}
            ${more}
          </div>
        </td>`;
      }
      html += `</tr>`;
    }
    tbody.innerHTML = html;

    // click handler (single)
    tbody.onclick = (ev)=>{
      const el = ev.target && ev.target.closest ? ev.target.closest(".lvcell") : null;
      if (!el) return;
      try{
        const day = ym + "-" + el.getAttribute("data-day");
        const arr = JSON.parse(decodeURIComponent(el.getAttribute("data-arr")||"[]"));
        openModal(arr, day);
      }catch(e){
        console.warn("openModal failed", e);
      }
    };
  }

  function renderStatusList(){
    const tb = $("#reqTbody");
    const empty = $("#reqEmpty");
    if (!tb || !empty) return;

    if (!LEAVES_VIEW.length){
      tb.innerHTML = "";
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    // one row per request (as you asked)
    const rows = LEAVES_VIEW.slice().sort((a,b)=>{
      const sa = keyName(a.employeeName||"");
      const sb = keyName(b.employeeName||"");
      if (sa !== sb) return sa.localeCompare(sb);
      // pending first
      const pa = norm(a.status)==="pending" ? 0 : 1;
      const pb = norm(b.status)==="pending" ? 0 : 1;
      if (pa !== pb) return pa-pb;
      return String(a.startDate||"").localeCompare(String(b.startDate||""));
    });

    tb.innerHTML = rows.map(l=>{
      const emp = l.employeeName || "â€”";
      const isInv = norm(l.kind)==="invoire";
      const tipConcediu = isInv ? "â€”" : leaveLabel(l.code);
      const tipInv = isInv ? `${fmtTime(l.startTime)}â€“${fmtTime(l.endTime)}` : "â€”";
      const st = statusLabel(l.status);

      return `<tr data-id="${String(l.id||"")}" class="reqRow">
        <td class="colAng">
          <div class="rowAng">
            <div class="av">${initials(emp)}</div>
            <div>
              <div class="nm">${emp}</div>
              <div class="dim">${periodText(l)}</div>
            </div>
          </div>
        </td>
        <td>${tipConcediu}</td>
        <td>${tipInv}</td>
        <td><span class="status ${st.cls}">${st.t}</span></td>
      </tr>`;
    }).join("");
  }

  function renderQuickApprovals(admin){
    const tb = $("#quickTbody");
    const empty = $("#quickEmpty");
    if (!tb || !empty) return;

    const pending = LEAVES_VIEW.filter(l=>norm(l.status)==="pending");
    if (!pending.length){
      tb.innerHTML = "";
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    tb.innerHTML = pending.map(l=>{
      const emp = l.employeeName || "â€”";
      const per = periodText(l);
      return `<tr data-id="${String(l.id||"")}">
        <td class="colAng">
          <div class="rowAng">
            <div class="av">${initials(emp)}</div>
            <div>
              <div class="nm">${emp}</div>
              <div class="dim">${(norm(l.kind)==="invoire") ? "ÃŽnvoire" : leaveLabel(l.code)}</div>
            </div>
          </div>
        </td>
        <td style="font-weight:800">${per}</td>
        <td style="text-align:right;padding-right:18px">
          <div class="actBtns">
            <button class="actApprove" data-act="approve"><span class="ic">âœ“</span> AprobÄƒ</button>
            <button class="actReject" data-act="reject"><span class="ic">âœ•</span> Respinge</button>
          </div>
        </td>
      </tr>`;
    }).join("");

    // bind (delegated)
    tb.onclick = (ev)=>{
      const btn = ev.target && ev.target.closest ? ev.target.closest("button[data-act]") : null;
      if (!btn) return;
      const tr = btn.closest("tr");
      const id = tr && tr.getAttribute("data-id");
      if (!id) return;
      const rec = pending.find(x=>String(x.id)===String(id));
      if (!rec) return;
      const act = btn.getAttribute("data-act");
      const decision = act==="approve" ? "approved" : "rejected";
      const note = ($("#quickNote")?.value || "").trim();
      decideOne(rec, decision, note);
    };
  }

  // ===== modal (approval) =====
  let CURRENT = null; // {arr, day}
  function openModal(arr, day){
    if (!arr || !arr.length) return;
    CURRENT = { arr, day };
    const l = arr[0];
    const ov = $("#ov");
    if (!ov) return;
    ov.classList.add("show");

    const mPeriod = $("#mPeriod"), mCount=$("#mCount"), mReason=$("#mReason"), mDay=$("#mDay");
    const mNote=$("#mNote");
    if (mNote) mNote.value = "";

    const kind = norm(l.kind);
    if (kind === "invoire"){
      if (mPeriod) mPeriod.textContent = `${l.startDate} â€¢ ${fmtTime(l.startTime)}â€“${fmtTime(l.endTime)}`;
      if (mCount) mCount.textContent = "ÃŽnvoire (ore)";
    } else {
      if (mPeriod) mPeriod.textContent = `${l.startDate} â€“ ${l.endDate || l.startDate}`;
      if (mCount) mCount.textContent = `${countDays(l.startDate, l.endDate || l.startDate)} zile`;
    }
    if (mReason) mReason.textContent = l.reason || "â€”";
    if (mDay) mDay.textContent = day || l.startDate || "â€”";

    fillAvatars("#sameDayAv", listSameDay(arr, day));
    fillAvatars("#samePeriodAv", listSamePeriod(arr));
  }
  function closeModal(){
    $("#ov")?.classList.remove("show");
    CURRENT = null;
  }

  function fillAvatars(sel, people){
    const box = $(sel);
    if (!box) return;
    box.innerHTML = "";
    if (!people.length){
      box.innerHTML = `<div class="dim">â€”</div>`;
      return;
    }
    people.slice(0,6).forEach(p=>{
      const d = document.createElement("div");
      d.className = "av";
      d.title = p;
      d.textContent = initials(p);
      box.appendChild(d);
    });
  }

  function countDays(sd, ed){
    const a = parseIsoDate(sd), b = parseIsoDate(ed);
    if (!a || !b) return 0;
    return Math.floor((b.getTime()-a.getTime())/86400000)+1;
  }
  function listSameDay(arr, day){
    const sel = parseIsoDate(day||"");
    if (!sel) return [];
    const names = new Set();
    for (const l of LEAVES_VIEW){
      const sd = parseIsoDate(l.startDate);
      const ed = parseIsoDate(l.endDate || l.startDate);
      if (!sd || !ed) continue;
      if (between(sel, sd, ed)) names.add(String(l.employeeName||"").trim());
    }
    for (const x of arr){ names.delete(String(x.employeeName||"").trim()); }
    return Array.from(names);
  }
  function listSamePeriod(arr){
    const first = arr[0];
    const sd = parseIsoDate(first.startDate);
    const ed = parseIsoDate(first.endDate || first.startDate);
    if (!sd || !ed) return [];
    const names = new Set();
    for (const l of LEAVES_VIEW){
      const a = parseIsoDate(l.startDate);
      const b = parseIsoDate(l.endDate || l.startDate);
      if (!a || !b) continue;
      if (b < sd || a > ed) continue;
      names.add(String(l.employeeName||"").trim());
    }
    for (const x of arr){ names.delete(String(x.employeeName||"").trim()); }
    return Array.from(names);
  }

  async function decideOne(l, decision, note){
    const endpoint = ep();
    if (!endpoint){ showTopError("LipseÈ™te endpoint Ã®n config.json."); return; }
    const key = getAdminKey();
    if (!key){ showTopError("LipseÈ™te ADMIN_KEY."); return; }

    const admin = getAdminSession();
    const by = (admin && (admin.label || admin.email)) ? (admin.label || admin.email) : "admin";

    const url = endpoint + "?fn=adminLeaveDecide"
      + "&id=" + encodeURIComponent(l.id)
      + "&decision=" + encodeURIComponent(decision)
      + "&note=" + encodeURIComponent(note || "")
      + "&by=" + encodeURIComponent(by)
      + "&key=" + encodeURIComponent(key)
      + "&ts=" + Date.now();

    try{
      const res = await jsonp(url);
      if (!res || !res.ok) throw new Error(res?.error || "Eroare la salvare.");
      toast(decision === "approved" ? "Aprobat." : "Respins.");
      await loadMonth(CUR_YM);
    }catch(err){
      showTopError(String(err && err.message ? err.message : err));
    }
  }

  async function decideFromModal(decision){
    if (!CURRENT || !CURRENT.arr || !CURRENT.arr.length) return;
    const l = CURRENT.arr[0];
    const note = ($("#mNote")?.value || "").trim();
    await decideOne(l, decision, note);
    closeModal();
  }

  // load month
  let CUR_YM = "";

  async function loadMonth(ym){
    showTopError("");
    const endpoint = ep();
    if(!endpoint){ showTopError("LipseÈ™te leaveEndpoint/adminEventsEndpoint Ã®n config.json."); return; }

    const key = getAdminKey();
    if(!key){ showTopError("LipseÈ™te ADMIN_KEY."); return; }

    CUR_YM = ym;

    const admin = getAdminSession();
    const adminName = admin ? (admin.label || admin.email || "") : "";
    const adminEmail = admin ? (admin.email || "") : "";

    const url = endpoint + "?fn=adminLeavesMonth"
      + "&ym=" + encodeURIComponent(ym)
      + "&key=" + encodeURIComponent(key)
      + "&adminName=" + encodeURIComponent(adminName)
      + "&adminEmail=" + encodeURIComponent(adminEmail)
      + "&mine=0"
      + "&ts=" + Date.now();

    try{
      const [data] = await Promise.all([
        jsonp(url),
        loadManagersMap(endpoint, key)
      ]);

      if (!data || !data.ok) throw new Error(data?.error || "Eroare la Ã®ncÄƒrcare.");
      LEAVES_ALL = Array.isArray(data.list) ? data.list : [];
      buildView(admin);
      renderAll(ym, admin);
    }catch(err){
      showTopError(String(err && err.message ? err.message : err));
    }
  }

  function ymNow(){
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
  }

  function buildMonthSel(){
    const sel = $("#monthSel");
    if (!sel) return;
    const now = ymNow();
    // build +- 12 months around now
    const base = new Date(Number(now.slice(0,4)), Number(now.slice(5,7))-1, 1);
    const opts = [];
    for (let i=-12;i<=12;i++){
      const d = new Date(base.getFullYear(), base.getMonth()+i, 1);
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      opts.push(ym);
    }
    sel.innerHTML = opts.map(ym=>`<option value="${ym}">${ym.replace("-", " / ")}</option>`).join("");
    sel.value = now;
  }

  function bind(){
    buildMonthSel();

    $("#monthSel")?.addEventListener("change", ()=>loadMonth($("#monthSel").value));

    $("#prev")?.addEventListener("click", ()=>{
      const v = ($("#monthSel")?.value || ymNow()).split("-").map(Number);
      const d = new Date(v[0], v[1]-2, 1);
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      if ($("#monthSel")) $("#monthSel").value = ym;
      loadMonth(ym);
    });
    $("#next")?.addEventListener("click", ()=>{
      const v = ($("#monthSel")?.value || ymNow()).split("-").map(Number);
      const d = new Date(v[0], v[1], 1);
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      if ($("#monthSel")) $("#monthSel").value = ym;
      loadMonth(ym);
    });

    $("#refresh")?.addEventListener("click", ()=>loadMonth($("#monthSel")?.value || ymNow()));

    $("#q")?.addEventListener("input", ()=>{
      const admin = getAdminSession();
      buildView(admin);
      renderAll(CUR_YM || ($("#monthSel")?.value || ymNow()), admin);
    });
    $("#onlyMine")?.addEventListener("change", ()=>{
      const admin = getAdminSession();
      buildView(admin);
      renderAll(CUR_YM || ($("#monthSel")?.value || ymNow()), admin);
    });

    // modal
    $("#ov")?.addEventListener("click", (e)=>{
      if (e.target && e.target.id === "ov") closeModal();
    });
    $("#mApprove")?.addEventListener("click", ()=>decideFromModal("approved"));
    $("#mReject")?.addEventListener("click", ()=>decideFromModal("rejected"));
    $("#mDl")?.addEventListener("click", ()=>toast("Export: Ã®n curÃ¢nd"));
    document.addEventListener("keydown", (e)=>{
      if (e.key === "Escape") closeModal();
    });

    // click on status list row -> open modal
    $("#reqTbody")?.addEventListener("click", (e)=>{
      const tr = e.target && e.target.closest ? e.target.closest("tr[data-id]") : null;
      if (!tr) return;
      const id = tr.getAttribute("data-id");
      const l = LEAVES_VIEW.find(x=>String(x.id)===String(id));
      if (!l) return;
      openModal([l], l.startDate || (CUR_YM+"-01"));
    });
  }

  async function init(){
    await loadCFG();
    bind();
    const ym = $("#monthSel")?.value || ymNow();
    CUR_YM = ym;
    await loadMonth(ym);
  }

  document.addEventListener("DOMContentLoaded", init);
})();
</script>
</body>
</html>
