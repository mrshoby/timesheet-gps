<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin â€” Concedii (v16)</title>
  <style>
    :root{
      --bg:#f5f6ff;
      --card:#ffffff;
      --ink:#1f2330;
      --muted:#6f7890;
      --line:#e7e9f6;
      --accent:#6d5efc;
      --shadow:0 10px 30px rgba(20,18,40,.08);
      --r:18px;

      --c-pending:#fff3d6;
      --c-approved:#e3f7e8;
      --c-rejected:#ffe0e0;
      --c-neutral:#f6f7fb;

      --purple:#2f245c;
      --purple2:#3a2d71;
      --purpleInk:#f5f4ff;
      --purpleMuted: rgba(245,244,255,.72);
      --purpleLine: rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1600px;margin:18px auto;padding:0 14px}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .head{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .title{display:flex;flex-direction:column;gap:2px}
    .title h1{margin:0;font-size:18px}
    .title .sub{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:flex;align-items:center;gap:8px;background:var(--c-neutral);border:1px solid var(--line);border-radius:14px;padding:8px 10px}
    .pill input,.pill select{border:0;background:transparent;outline:none;font:inherit;color:var(--ink)}
    .btn{border:1px solid var(--line);background:var(--card);border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:600}
    .btn.primary{background:rgba(109,94,252,.12);border-color:rgba(109,94,252,.25);color:var(--accent)}
    .btn:active{transform:translateY(1px)}
    .toggle{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);border-radius:14px;background:var(--c-neutral);user-select:none}
    .toggle input{width:16px;height:16px}

    .grid{display:grid;grid-template-columns: 1fr 360px;gap:14px;padding:14px}
    @media(max-width:1100px){ .grid{grid-template-columns:1fr} }

    .tableWrap{background:var(--card);border:1px solid var(--line);border-radius:18px;overflow:hidden}
    .tableScroll{overflow:auto}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:980px}
    thead th{position:sticky;top:0;z-index:5;background:#fbfbff;border-bottom:1px solid var(--line);font-size:12px;color:var(--muted);text-align:center;padding:10px 6px}
    thead th:first-child{left:0;z-index:7;text-align:left;padding-left:14px;min-width:260px}
    tbody td, tbody th{border-bottom:1px solid var(--line);border-right:1px solid var(--line);height:64px;vertical-align:middle;text-align:center;font-size:13px;color:var(--ink);background:#fff}
    tbody tr:last-child td, tbody tr:last-child th{border-bottom:0}
    tbody td:last-child, thead th:last-child{border-right:0}
    tbody th{position:sticky;left:0;z-index:6;background:#fff;text-align:left;padding:10px 12px;min-width:260px;border-right:1px solid var(--line)}
    .who{display:flex;align-items:center;gap:10px}
    .av{width:34px;height:34px;border-radius:999px;background:#e9ecff;display:grid;place-items:center;font-weight:800;color:#3a2d71;flex:0 0 auto}
    .name{display:flex;flex-direction:column;line-height:1.1}
    .name .n{font-weight:700}
    .name .d{font-size:12px;color:var(--muted)}

    .cell{position:relative;cursor:pointer}
    .cell:hover{background:#fafaff}
    .tag{display:inline-flex;align-items:center;justify-content:center;min-width:44px;padding:6px 10px;border-radius:12px;font-weight:800}
    .tag.co{background:rgba(109,94,252,.10);color:var(--accent)}
    .tag.inv{background:rgba(47,36,92,.08);color:var(--purple)}
    .mini{display:block;margin-top:4px;font-size:11px;color:var(--muted);font-weight:600}

    .pending{background:var(--c-pending)}
    .approved{background:var(--c-approved)}
    .rejected{background:var(--c-rejected)}
    .bang{
      position:absolute;top:6px;right:6px;width:18px;height:18px;border-radius:999px;
      background:#ffb020;color:#1f2330;font-weight:900;font-size:12px;display:grid;place-items:center;
      border:2px solid #fff;
    }

    .side{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:12px}
    .side h3{margin:0 0 10px 0;font-size:14px}
    .side .muted{color:var(--muted);font-size:12px}
    .list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .item{border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff;display:flex;justify-content:space-between;gap:10px}
    .item strong{display:block}
    .item .meta{font-size:12px;color:var(--muted)}
    .item .actions{display:flex;gap:8px;align-items:center}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800;background:#f3f4ff;color:var(--accent);border:1px solid rgba(109,94,252,.25)}
    .err{margin-top:10px;padding:10px;border-radius:12px;background:#fff0f0;border:1px solid #ffd2d2;color:#9b1c1c;font-weight:700}

    /* Approval modal (purple) */
    .ov{position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
    .ov.show{display:flex}

    .ov.open{display:flex}
    .modal{
      width:min(520px, 96vw);
      background:linear-gradient(180deg,var(--purple2),var(--purple));
      color:var(--purpleInk);
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .modal .body{padding:18px}
    .k{color:var(--purpleMuted);font-size:12px;margin-top:10px}
    .v{font-weight:800;font-size:16px;margin-top:2px}
    .row{display:flex;gap:12px;align-items:center;margin-top:14px}
    .avatars{display:flex;gap:8px;margin-top:8px}
    .avatars .av{background:rgba(255,255,255,.16);color:var(--purpleInk);border:1px solid var(--purpleLine)}
    .modal textarea{
      width:100%;margin-top:12px;min-height:80px;resize:vertical;
      border-radius:12px;border:1px solid var(--purpleLine);
      background:rgba(255,255,255,.10);color:var(--purpleInk);
      padding:10px;font:inherit;outline:none
    }
    .modal .foot{
      display:flex;gap:10px;padding:14px;border-top:1px solid var(--purpleLine);
      background:rgba(0,0,0,.08)
    }
    .bbtn{
      flex:1;display:flex;align-items:center;justify-content:center;gap:8px;
      border-radius:12px;padding:12px 10px;font-weight:900;cursor:pointer;border:1px solid transparent
    }
    .bbtn.secondary{background:rgba(255,255,255,.12);border-color:var(--purpleLine);color:var(--purpleInk)}
    .bbtn.approve{background:#6bc676;color:#0b2b12}
    .bbtn.reject{background:rgba(255,255,255,.12);border:1px solid var(--purpleLine);color:var(--purpleInk)}
    .bbtn.icon{flex:0 0 54px}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#1f2330;color:#fff;padding:10px 12px;border-radius:12px;font-weight:700;box-shadow:var(--shadow);display:none;z-index:99999}
    .toast.show{display:block}
  

    .dow{font-size:10px; color:var(--muted); margin-top:2px; font-weight:800}
    .lvcell{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px; height:100%; min-height:64px}
    .lvcell .c{font-weight:900; letter-spacing:.3px}
    .lvcell .t{font-size:11px; color:rgba(27,27,40,.7); font-weight:800}
    .lvcell .mini{font-size:10px; opacity:.75}
    .lvcell .bang{position:absolute;top:6px;right:6px}
    .av2{width:40px;height:40px;border-radius:999px;background:#e9ecff;display:grid;place-items:center;font-weight:900;color:#3a2d71;border:2px solid rgba(255,255,255,.7)}

    /* ===== Submenu tabs (ca Ã®n admin) ===== */
    .subnav{display:flex;gap:26px;align-items:flex-end;padding:10px 16px;background:rgba(109,94,252,.10);border-bottom:1px solid var(--line)}
    .subnav .tab{border:0;background:transparent;padding:12px 4px;font-weight:800;font-size:20px;color:rgba(31,35,48,.45);cursor:pointer;position:relative}
    .subnav .tab::after{content:"";position:absolute;left:0;right:0;bottom:4px;height:3px;border-radius:3px;background:transparent}
    .subnav .tab.active{color:var(--accent)}
    .subnav .tab.active::after{background:var(--accent)}
    .pane{display:none;padding:14px 16px}
    .pane.active{display:block}

    /* Calendar container */
    #pane-cal .tableWrap{border-radius:22px}
    #pane-cal .tableScroll{max-height:420px;overflow:auto}

    /* Pending + Quick tables */
    .cardSection{background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);padding:16px}
    .secHead{display:flex;flex-direction:column;gap:4px;margin-bottom:12px}
    .secHead h3{margin:0;font-size:18px}
    .tableScroll2{max-height:520px;overflow:auto;border:1px solid var(--line);border-radius:18px}
    table.reqTable, table.quickTable{width:100%;min-width:0;border-collapse:separate;border-spacing:0;background:#fff}
    .reqTable thead th,.quickTable thead th{position:sticky;top:0;z-index:2;background:#fff;border-bottom:1px solid var(--line);font-size:16px;letter-spacing:.06em;color:var(--accent);padding:16px}
    .reqTable td,.quickTable td{padding:18px 16px;border-bottom:1px solid var(--line);font-size:16px}
    .reqTable tbody tr:hover,.quickTable tbody tr:hover{background:#fafbff}
    .sort{opacity:.45;font-weight:900;margin-left:6px}
    .rowWho{display:flex;align-items:center;gap:14px}
    .rowAv{width:44px;height:44px;border-radius:999px;background:rgba(109,94,252,.15);display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--accent);flex:0 0 auto}
    .rowMeta .rowName{font-weight:900}
    .rowMeta .rowSub{font-size:12px;color:var(--muted)}
    .statusTxt{font-weight:900}
    .statusTxt.pending{color:var(--accent)}
    .statusTxt.approved{color:#4da866}
    .statusTxt.rejected{color:#d16555}
    .actionBtns{display:flex;gap:12px;justify-content:flex-end}
    .aBtn{border:0;border-radius:12px;padding:12px 18px;font-weight:900;cursor:pointer}
    .aBtn.approve{background:#79c18a;color:#fff}
    .aBtn.reject{background:#eef0ff;color:#1f2330}

</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <div class="head">
      <div class="title">
        <h1>Concedii &amp; Ã®nvoiri</h1>
        <div class="sub" id="sub">AprobÄƒri</div>
      </div>
      <div class="controls">
        <button class="btn" id="prev">â€¹</button>
        <div class="pill">
          <select id="monthSel"></select>
        </div>
        <button class="btn" id="next">â€º</button>
        <div class="pill">
          <span style="opacity:.7">ðŸ”Ž</span>
          <input id="q" placeholder="CautÄƒ angajat..." />
        </div>
        <label class="toggle" title="FiltreazÄƒ doar cererile repartizate È›ie">
          <input type="checkbox" id="onlyMine" checked />
          <span>Doar ale mele</span>
        </label>
        <button class="btn primary" id="refresh">Refresh</button>
      </div>
    </div>

    
    <div class="subnav" id="subnav">
      <button class="tab active" data-tab="cal">Concedii &amp; Ã®nvoiri</button>
      <button class="tab" data-tab="pending">ÃŽn aÈ™teptare</button>
      <button class="tab" data-tab="quick">AprobÄƒri rapide</button>
    </div>

    <div class="pane active" id="pane-cal">
      <div class="tableWrap">
        <div class="tableScroll">
          <table id="cal">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
      <div class="muted" id="dbg" style="margin-top:10px"></div>
      <div id="err" class="err" style="display:none;margin-top:10px"></div>
    </div>

    <div class="pane" id="pane-pending">
      <div class="cardSection">
        <div class="secHead">
          <h3>ÃŽn aÈ™teptare <span class="badge" id="pendingCount">0</span></h3>
          <div class="muted">Cererile din luna selectatÄƒ (pending / aprobate / respinse).</div>
        </div>
        <div class="tableScroll2">
          <table class="reqTable" id="pendingTable">
            <thead>
              <tr>
                <th>ANGAJAT <span class="sort">â†‘â†“</span></th>
                <th>TIP DE CONCEDIU <span class="sort">â†‘â†“</span></th>
                <th>TIP ÃŽNVOIRE <span class="sort">â†‘â†“</span></th>
                <th>STATUS <span class="sort">â†‘â†“</span></th>
              </tr>
            </thead>
            <tbody id="pendingTbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="pane" id="pane-quick">
      <div class="cardSection">
        <div class="secHead">
          <h3>AprobÄƒri rapide</h3>
          <div class="muted">AprobÄƒ / respinge direct din tabel.</div>
        </div>
        <div class="tableScroll2">
          <table class="quickTable" id="quickTable">
            <thead>
              <tr>
                <th>ANGAJAT <span class="sort">â†‘â†“</span></th>
                <th>PERIOADÄ‚ <span class="sort">â†‘â†“</span></th>
                <th style="text-align:right">ACÈšIUNI</th>
              </tr>
            </thead>
            <tbody id="quickTbody"></tbody>
          </table>
        </div>
      </div>
    </div>



<!-- Approval modal -->
<div class="ov" id="ov">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="body">
      <div class="k">PerioadÄƒ</div>
      <div class="v" id="mPeriod">â€”</div>

      <div class="k">NumÄƒr</div>
      <div class="v" id="mCount">â€”</div>

      <div class="k">Motiv</div>
      <div class="v" id="mReason">â€”</div>

      <div class="k">Ziua selectatÄƒ</div>
      <div class="v" id="mDay">â€”</div>

      <div class="k">ÃŽn aceeaÈ™i zi cu</div>
      <div class="avatars" id="sameDayAv"></div>

      <div class="k">ÃŽn aceeaÈ™i perioadÄƒ cu</div>
      <div class="avatars" id="samePeriodAv"></div>

      <textarea id="mNote" placeholder="NotÄƒ (opÈ›ional) â€” se aplicÄƒ la approve/reject"></textarea>
    </div>
    <div class="foot">
      <button class="bbtn secondary icon" id="mDl" title="Export (placeholder)">â¤“</button>
      <button class="bbtn reject" id="mReject">âœ• Respinge</button>
      <button class="bbtn approve" id="mApprove">âœ“ AprobÄƒ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">â€”</div>

<script>
(() => {
  // ===== Config loading (same smart loader used elsewhere) =====
  const CFG_PATHS = ["./config.json","../config.json","/config.json"];
  let CFG = null;

  const LS_ADMIN = "pontaj/admin/v1";
  const LS_ADMIN_KEY = "pontaj_adminKey";

  function $(sel){ return document.querySelector(sel); }
  function toast(msg){
    const t = $("#toast");
    if (!t) return;
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }
  function setError(msg){
    const e = $("#err");
    if (!e) return;
    if(!msg){ e.style.display="none"; e.textContent=""; return; }
    e.style.display="block";
    e.textContent = msg;
  }

  async function loadCFG(){
    for (const p of CFG_PATHS){
      try{
        const r = await fetch(p, { cache:"no-store" });
        if (!r.ok) continue;
        CFG = await r.json();
        return;
      }catch(e){}
    }
    CFG = {};
  }
  function ep(){ return (CFG && (CFG.leaveEndpoint || CFG.adminEventsEndpoint || CFG.stateEndpoint)) || ""; }

  // ===== Admin session =====
  function getAdminSession(){
    const raw = (localStorage.getItem(LS_ADMIN) || "").trim();
    if (!raw) return null;
    let obj = null;
    try{ obj = JSON.parse(raw); }catch(_){ obj = null; }
    if (obj && typeof obj === "object"){
      const label = (obj.label || obj.name || obj.user || obj.email || obj.id || "").toString().trim();
      const email = (obj.email || obj.userEmail || obj.mail || "").toString().trim();
      if (!label && !email) return null;
      return { raw: obj, label: label || email, email: email || "" };
    }
    return { raw: { value: raw }, label: raw, email: "" };
  }

  function getAdminKey(){
    let k = "";
    try{ k = (localStorage.getItem(LS_ADMIN_KEY) || "").trim(); }catch(e){}
    if (!k){
      k = (prompt("Cheie admin (ADMIN_KEY) pentru aprobÄƒri:", "") || "").trim();
      if (k){ try{ localStorage.setItem(LS_ADMIN_KEY, k); }catch(e){} }
    }
    return k;
  }

  // ===== JSONP =====
  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const cb = "cb_"+Math.random().toString(16).slice(2);
      const s = document.createElement("script");
      const t = setTimeout(()=>{ cleanup(); reject(new Error("JSONP timeout")); }, 20000);
      function cleanup(){
        clearTimeout(t);
        try{ delete window[cb]; }catch(_){ window[cb]=undefined; }
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }
      window[cb] = (data)=>{ cleanup(); resolve(data); };
      s.onerror = ()=>{ cleanup(); reject(new Error("JSONP error")); };
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
      document.body.appendChild(s);
    });
  }

  // ===== helpers =====
  function norm(s){ return String(s||"").trim().toLowerCase(); }
  function deacc(s){ return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }
  function keyName(s){ return deacc(norm(s)).replace(/\s+/g," ").trim(); }

  function tokens(s){
    return keyName(s).split(/[^a-z0-9]+/).filter(Boolean);
  }
  function samePerson(a,b){
    const A = keyName(a), B = keyName(b);
    if (!A || !B) return false;
    if (A === B) return true;
    if (A.includes(B) || B.includes(A)) return true;
    // token match (useful for emails)
    const ta = tokens(A), tb = tokens(B);
    const small = ta.length<=tb.length ? ta : tb;
    const big = ta.length<=tb.length ? tb : ta;
    // require at least 1 token match, or all tokens from smaller contained
    let hits = 0;
    for (const t of small){
      if (big.includes(t)) hits++;
    }
    return hits >= Math.min(2, small.length); // usually "alin ceclan" => 2 hits
  }

  function initials(name){
    const parts = String(name||"").trim().split(/\s+/).filter(Boolean);
    const a = parts[0]?.[0] || "?";
    const b = parts.length>1 ? parts[parts.length-1][0] : "";
    return (a+b).toUpperCase();
  }

  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtTime(v){
    if (v === null || v === undefined || v === "") return "";
    // String like "09:30" or "9:30"
    if (typeof v === "string"){
      const m = v.match(/(\d{1,2}):(\d{2})/);
      if (m) return pad2(m[1]) + ":" + m[2];
      // ISO datetime or Date string
      const d = new Date(v);
      if (!isNaN(d.getTime())) return pad2(d.getHours()) + ":" + pad2(d.getMinutes());
      return v;
    }
    // Date object (Google Sheets time often comes as 1899-12-30...)
    if (v instanceof Date){
      if (!isNaN(v.getTime())) return pad2(v.getHours()) + ":" + pad2(v.getMinutes());
      return "";
    }
    // Number: Google Sheets serial date/time or fraction of day
    if (typeof v === "number" && isFinite(v)){
      let frac = v % 1;
      if (frac < 0) frac += 1;
      const totalMin = Math.round(frac * 24 * 60);
      const hh = Math.floor(totalMin / 60) % 24;
      const mm = totalMin % 60;
      return pad2(hh) + ":" + pad2(mm);
    }
    try{
      const d = new Date(v);
      if (!isNaN(d.getTime())) return pad2(d.getHours()) + ":" + pad2(d.getMinutes());
    }catch(e){}
    return "";
  }


  function daysInMonth(ym){
    const [y,m] = ym.split("-").map(Number);
    return new Date(y, m, 0).getDate();
  }
  function dowShort(d){
    const arr=["Du","Lu","Ma","Mi","Jo","Vi","SÃ¢"];
    return arr[d.getDay()];
  }
  function iso(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da= String(d.getDate()).padStart(2,"0");
    return y+"-"+m+"-"+da;
  }
  function parseIsoDate(s){
    const m = String(s||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return null;
    return new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), 12,0,0,0);
  }
  function between(d, a, b){
    return d && a && b && d.getTime() >= a.getTime() && d.getTime() <= b.getTime();
  }

  // ===== data =====
  let LEAVES_ALL = [];
  let LEAVES_VIEW = [];
  let MANAGERS = null; // { keyName(emp): {managerName, managerEmail} }

  async function loadManagersMap(endpoint, key){
    if (MANAGERS) return MANAGERS;
    try{
      const u = endpoint + "?fn=adminManagersMap&key=" + encodeURIComponent(key) + "&ts=" + Date.now();
      const data = await jsonp(u);
      if (data && data.ok && data.map){
        MANAGERS = data.map;
        return MANAGERS;
      }
    }catch(_){}
    MANAGERS = {};
    return MANAGERS;
  }

  function enrichLeave(l){
    const emp = String(l.employeeName||"").trim();
    const k = keyName(emp);
    const m = (MANAGERS && MANAGERS[k]) ? MANAGERS[k] : null;
    const mgrName = String(l.managerName||"").trim() || (m ? String(m.managerName||"").trim() : "");
    const mgrEmail = String(l.managerEmail||"").trim() || (m ? String(m.managerEmail||"").trim() : "");
    return {
      ...l,
      _empKey: k,
      _mgrName: mgrName,
      _mgrEmail: mgrEmail
    };
  }

  function filterMine(list, admin){
    const onlyMine = $("#onlyMine")?.checked;
    if (!onlyMine) return list;
    if (!admin) return list; // can't filter
    const adminId = admin.label || admin.email || "";
    if (!adminId) return list;

    return list.filter(l=>{
      const a = l._mgrName || "";
      const b = l._mgrEmail || "";
      // if request has no manager assigned, hide it in "mine"
      if (!a && !b) return false;
      return samePerson(a, adminId) || samePerson(b, adminId) || samePerson(a, admin.email||"") || samePerson(b, admin.email||"");
    });
  }

  function filterSearch(list){
    const q = norm($("#q")?.value || "");
    if (!q) return list;
    const qq = deacc(q);
    return list.filter(l=>{
      const n = deacc(norm(l.employeeName||""));
      const c = deacc(norm(l.code||""));
      return n.includes(qq) || c.includes(qq);
    });
  }

  function buildView(admin){
    const enriched = LEAVES_ALL.map(enrichLeave);
    let list = enriched;
    list = filterMine(list, admin);
    list = filterSearch(list);
    LEAVES_VIEW = list;
  }


  // ===== Submenu (tab) state =====
  let ACTIVE_TAB = "cal";
  function setTab(k){
    ACTIVE_TAB = k || "cal";
    document.querySelectorAll("#subnav .tab").forEach(b=>{
      b.classList.toggle("active", b.getAttribute("data-tab")===ACTIVE_TAB);
    });
    $("#pane-cal")?.classList.toggle("active", ACTIVE_TAB==="cal");
    $("#pane-pending")?.classList.toggle("active", ACTIVE_TAB==="pending");
    $("#pane-quick")?.classList.toggle("active", ACTIVE_TAB==="quick");
  }


  // ===== UI render =====
  function render(ym, admin){
    const thead = $("#thead");
    const tbody = $("#tbody");
    if (!thead || !tbody) return;

    // header
    const dim = daysInMonth(ym);
    let h = `<tr><th class="stickyL">Angajat</th>`;
    for (let d=1; d<=dim; d++){
      const dt = new Date(Number(ym.slice(0,4)), Number(ym.slice(5,7))-1, d, 12,0,0,0);
      h += `<th>${String(d).padStart(2,"0")}<div class="dow">${dowShort(dt)}</div></th>`;
    }
    h += `</tr>`;
    thead.innerHTML = h;

    // group leaves by employee
    const byEmp = new Map();
    for (const l of LEAVES_VIEW){
      const emp = String(l.employeeName||"").trim() || "â€”";
      if (!byEmp.has(emp)) byEmp.set(emp, []);
      byEmp.get(emp).push(l);
    }
    const emps = Array.from(byEmp.keys()).sort((a,b)=>keyName(a).localeCompare(keyName(b)));

    // rows
    let html = "";
    for (const emp of emps){
      const list = byEmp.get(emp) || [];
      // map day -> leaves
      const cellMap = new Map(); // d => [leaves]
      for (const l of list){
        const sd = parseIsoDate(l.startDate);
        const ed = parseIsoDate(l.endDate || l.startDate);
        if (!sd || !ed) continue;
        for (let d=1; d<=dim; d++){
          const day = new Date(Number(ym.slice(0,4)), Number(ym.slice(5,7))-1, d, 12,0,0,0);
          if (between(day, sd, ed)){
            if (!cellMap.has(d)) cellMap.set(d, []);
            cellMap.get(d).push(l);
          }
        }
      }

      const mgr = list[0]?._mgrName || list[0]?._mgrEmail || "";
      const mgrTxt = mgr ? `Manager: ${mgr}` : `Manager: â€”`;
      html += `<tr><th class="stickyL">
        <div class="who">
          <div class="av">${initials(emp)}</div>
          <div class="name">
            <div class="n">${emp}</div>
            <div class="d">${mgrTxt}</div>
          </div>
        </div>
      </th>`;

      for (let d=1; d<=dim; d++){
        const arr = cellMap.get(d) || [];
        if (!arr.length){
          html += `<td class="day"></td>`;
          continue;
        }
        // show first request + badge for more
        const first = arr[0];
        const code = (norm(first.kind)==="invoire") ? "INV" : (first.code || "â€”");
        const pending = arr.some(x=>norm(x.status)==="pending");
        const more = arr.length>1 ? `<div class="mini">+${arr.length-1}</div>` : "";
        const bang = pending ? `<div class="bang">!</div>` : "";
        const time = (norm(first.kind)==="invoire") ? `<div class="t">${fmtTime(first.startTime)}-${fmtTime(first.endTime)}</div>` : "";
        const dataPayload = encodeURIComponent(JSON.stringify(arr));
        html += `<td class="day">
          <div class="lvcell cell" data-ym="${ym}" data-day="${String(d).padStart(2,"0")}" data-arr="${dataPayload}">
            ${bang}
            <div class="c">${code}</div>
            ${time}
            ${more}
          </div>
        </td>`;
      }
      html += `</tr>`;
    }
    tbody.innerHTML = html;

    // pending + tables
    const all = LEAVES_VIEW.slice();
    const pending = all.filter(l=>norm(l.status)==="pending");

    const pc = $("#pendingCount"); if (pc) pc.textContent = String(pending.length);

    renderPendingTable(all, admin);
    renderQuickTable(pending, admin);

// debug
    const dbg = $("#dbg");
    if (dbg){
      const a = admin ? (admin.label || admin.email || "â€”") : "â€”";
      dbg.textContent = `ÃŽncÄƒrcate: ${LEAVES_ALL.length} â€¢ AfiÈ™ate: ${LEAVES_VIEW.length} â€¢ Admin: ${a}`;
    }
  }

  // ===== Tables (ÃŽn aÈ™teptare / AprobÄƒri rapide) =====
  function codeName(code){
    const c = String(code||"").trim().toUpperCase();
    const map = {
      "CO":"Concediu de odihnÄƒ",
      "BO":"Concediu medical",
      "CCC":"Concediu pentru creÈ™terea copilului",
      "CFP":"Concediu fÄƒrÄƒ platÄƒ",
      "EV":"Eveniment"
    };
    return map[c] || (c ? c : "â€”");
  }
  function roDate(iso){
    const d = parseIsoDate(iso);
    if (!d) return String(iso||"â€”");
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    return `${dd}.${mm}.${yy}`;
  }
  function statusInfo(st){
    const s = norm(st);
    if (s==="approved") return { cls:"approved", txt:"Solicitare aprobatÄƒ" };
    if (s==="rejected") return { cls:"rejected", txt:"Solicitare respinsÄƒ" };
    return { cls:"pending", txt:"Solicitare Ã®n aÈ™teptare" };
  }

  function renderPendingTable(list, admin){
    const tb = $("#pendingTbody");
    if (!tb) return;
    // sort: pending first, then approved, then rejected; newest first
    const rank = (l)=>{
      const s = norm(l.status);
      if (s==="pending") return 0;
      if (s==="approved") return 1;
      return 2;
    };
    const sorted = list.slice().sort((a,b)=>{
      const ra = rank(a), rb = rank(b);
      if (ra!==rb) return ra-rb;
      // createdAt desc (fallback by timestamp string)
      return String(b.createdAt||b.ts||"").localeCompare(String(a.createdAt||a.ts||""));
    });

    tb.innerHTML = sorted.map(l=>{
      const emp = String(l.employeeName||"â€”");
      const mgr = (l._mgrName || l._mgrEmail) ? `Manager: ${l._mgrName||l._mgrEmail}` : "";
      const leaveCol = (norm(l.kind)==="invoire") ? "â€”" : codeName(l.code);
      const invCol = (norm(l.kind)==="invoire") ? `ÃŽnvoire (${fmtTime(l.startTime)}â€“${fmtTime(l.endTime)})` : "â€”";
      const st = statusInfo(l.status);
      const payload = encodeURIComponent(JSON.stringify([l]));
      const day = String(l.startDate || "").slice(0,10) || (CUR_YM + "-01");
      return `
        <tr class="pendRow" data-arr="${payload}" data-day="${day}">
          <td>
            <div class="rowWho">
              <div class="rowAv">${initials(emp)}</div>
              <div class="rowMeta">
                <div class="rowName">${emp}</div>
                <div class="rowSub">${mgr}</div>
              </div>
            </div>
          </td>
          <td>${leaveCol}</td>
          <td>${invCol}</td>
          <td class="statusTxt ${st.cls}">${st.txt}</td>
        </tr>
      `;
    }).join("");

    // click row -> modal
    tb.querySelectorAll(".pendRow").forEach(tr=>{
      tr.addEventListener("click", ()=>{
        try{
          const arr = JSON.parse(decodeURIComponent(tr.getAttribute("data-arr")||"[]"));
          const day = tr.getAttribute("data-day") || (CUR_YM+"-01");
          openModal(arr, day, admin);
        }catch(e){ console.warn("openModal row failed", e); }
      });
    });
  }

  function renderQuickTable(pending, admin){
    const tb = $("#quickTbody");
    if (!tb) return;

    // show only pending
    const sorted = pending.slice().sort((a,b)=> String(a.employeeName||"").localeCompare(String(b.employeeName||"")));

    tb.innerHTML = sorted.map(l=>{
      const emp = String(l.employeeName||"â€”");
      const isInv = norm(l.kind)==="invoire";
      const period = isInv
        ? `${roDate(l.startDate)} (${fmtTime(l.startTime)}â€“${fmtTime(l.endTime)})`
        : `${roDate(l.startDate)} â€“ ${roDate(l.endDate||l.startDate)}`;
      return `
        <tr>
          <td>
            <div class="rowWho">
              <div class="rowAv">${initials(emp)}</div>
              <div class="rowMeta">
                <div class="rowName">${emp}</div>
                <div class="rowSub">${isInv ? "ÃŽnvoire" : codeName(l.code)}</div>
              </div>
            </div>
          </td>
          <td style="font-weight:800;color:#2b2f44">${period}</td>
          <td>
            <div class="actionBtns">
              <button class="aBtn approve" data-id="${l.id}" data-decision="approved">âœ“ AprobÄƒ</button>
              <button class="aBtn reject" data-id="${l.id}" data-decision="rejected">âœ•</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");

    tb.querySelectorAll(".aBtn").forEach(btn=>{
      btn.addEventListener("click", async (e)=>{
        e.stopPropagation();
        const id = btn.getAttribute("data-id");
        const decision = btn.getAttribute("data-decision");
        await decideId(id, decision);
      });
    });
  }

  async function decideId(id, decision){
    const endpoint = ep();
    if(!endpoint){ setError("LipseÈ™te endpoint Ã®n config.json."); return; }
    const key = getAdminKey();
    if(!key){ setError("LipseÈ™te ADMIN_KEY."); return; }

    const admin = getAdminSession();
    const by = (admin && (admin.label || admin.email)) ? (admin.label || admin.email) : "admin";

    const url = endpoint + "?fn=adminLeaveDecide"
      + "&id=" + encodeURIComponent(id)
      + "&decision=" + encodeURIComponent(decision)
      + "&note=" + encodeURIComponent("")
      + "&by=" + encodeURIComponent(by)
      + "&key=" + encodeURIComponent(key)
      + "&ts=" + Date.now();

    try{
      const res = await jsonp(url);
      if (!res || !res.ok) throw new Error(res?.error || "Eroare la salvare.");
      toast(decision === "approved" ? "Aprobat." : "Respins.");
      await loadMonth(CUR_YM);
      // dupÄƒ refresh, rÄƒmÃ¢i pe tab-ul curent
    }catch(err){
      setError(String(err && err.message ? err.message : err));
    }
  }



  // ===== Modal (approval) =====
  let CURRENT = null; // {arr, day}
  function openModal(arr, day, admin){
    if (!arr || !arr.length) return;
    CURRENT = { arr, day };
    const l = arr[0];

    const ov = $("#ov");
    if (!ov) return;
    ov.classList.add("show");

    // fill
    const mPeriod = $("#mPeriod"), mCount=$("#mCount"), mReason=$("#mReason"), mDay=$("#mDay");
    const mNote=$("#mNote");
    if (mNote) mNote.value = "";

    const kind = norm(l.kind);
    if (kind === "invoire"){
      if (mPeriod) mPeriod.textContent = `${l.startDate} â€¢ ${fmtTime(l.startTime)}â€“${fmtTime(l.endTime)}`;
      if (mCount) mCount.textContent = "ÃŽnvoire (ore)";
    } else {
      if (mPeriod) mPeriod.textContent = `${l.startDate} - ${l.endDate}`;
      if (mCount) mCount.textContent = `${countDays(l.startDate, l.endDate)} zile`;
    }
    if (mReason) mReason.textContent = l.reason || "â€”";
    if (mDay) mDay.textContent = day || l.startDate || "â€”";

    // same day / period avatars
    fillAvatars("#sameDayAv", listSameDay(arr, day));
    fillAvatars("#samePeriodAv", listSamePeriod(arr));

    // buttons
    const mApprove = $("#mApprove"), mReject=$("#mReject");
    if (mApprove) mApprove.disabled = false;
    if (mReject) mReject.disabled = false;
  }

  function closeModal(){
    const ov = $("#ov");
    if (!ov) return;
    ov.classList.remove("show");
    CURRENT = null;
  }

  function fillAvatars(sel, people){
    const box = $(sel);
    if (!box) return;
    box.innerHTML = "";
    if (!people.length){
      box.innerHTML = `<div class="muted">â€”</div>`;
      return;
    }
    people.slice(0,6).forEach(p=>{
      const d = document.createElement("div");
      d.className = "av2";
      d.title = p;
      d.textContent = initials(p);
      box.appendChild(d);
    });
  }

  function countDays(sd, ed){
    const a = parseIsoDate(sd), b = parseIsoDate(ed);
    if (!a || !b) return 0;
    const ms = b.getTime() - a.getTime();
    return Math.floor(ms / 86400000) + 1;
  }

  function listSameDay(arr, day){
    // within current view, show others in same day
    const d = day || "";
    const names = new Set();
    for (const l of LEAVES_VIEW){
      if (!l.startDate) continue;
      const sd = parseIsoDate(l.startDate);
      const ed = parseIsoDate(l.endDate || l.startDate);
      const sel = parseIsoDate(d);
      if (!sd || !ed || !sel) continue;
      if (between(sel, sd, ed)) names.add(String(l.employeeName||"").trim());
    }
    // remove current employee
    for (const x of arr){
      names.delete(String(x.employeeName||"").trim());
    }
    return Array.from(names);
  }

  function listSamePeriod(arr){
    const first = arr[0];
    const sd = parseIsoDate(first.startDate);
    const ed = parseIsoDate(first.endDate || first.startDate);
    if (!sd || !ed) return [];
    const names = new Set();
    for (const l of LEAVES_VIEW){
      const a = parseIsoDate(l.startDate);
      const b = parseIsoDate(l.endDate || l.startDate);
      if (!a || !b) continue;
      // overlap
      if (b < sd || a > ed) continue;
      names.add(String(l.employeeName||"").trim());
    }
    for (const x of arr){ names.delete(String(x.employeeName||"").trim()); }
    return Array.from(names);
  }

  async function decide(decision){
    if (!CURRENT || !CURRENT.arr || !CURRENT.arr.length) return;
    const endpoint = ep();
    if (!endpoint){ setError("LipseÈ™te endpoint Ã®n config.json."); return; }
    const key = getAdminKey();
    if (!key){ setError("LipseÈ™te ADMIN_KEY."); return; }

    const admin = getAdminSession();
    const by = (admin && (admin.label || admin.email)) ? (admin.label || admin.email) : "admin";

    // decide only first request for now (if multiple in same cell, admin can click each from pending list)
    const l = CURRENT.arr[0];
    const note = ($("#mNote")?.value || "").trim();

    const url = endpoint + "?fn=adminLeaveDecide"
      + "&id=" + encodeURIComponent(l.id)
      + "&decision=" + encodeURIComponent(decision)
      + "&note=" + encodeURIComponent(note)
      + "&by=" + encodeURIComponent(by)
      + "&key=" + encodeURIComponent(key)
      + "&ts=" + Date.now();

    try{
      const res = await jsonp(url);
      if (!res || !res.ok) throw new Error(res?.error || "Eroare la salvare.");
      toast(decision === "approved" ? "Aprobat." : "Respins.");
      closeModal();
      await loadMonth(CUR_YM);
    }catch(err){
      setError(String(err && err.message ? err.message : err));
    }
  }

  // ===== load month =====
  let CUR_YM = "";

  async function loadMonth(ym){
    setError("");
    const endpoint = ep();
    if(!endpoint){ setError("LipseÈ™te leaveEndpoint/adminEventsEndpoint Ã®n config.json."); return; }

    const key = getAdminKey();
    if(!key){ setError("LipseÈ™te ADMIN_KEY."); return; }

    CUR_YM = ym;

    const admin = getAdminSession();
    const adminName = admin ? (admin.label || admin.email || "") : "";
    const adminEmail = admin ? (admin.email || "") : "";

    const url = endpoint + "?fn=adminLeavesMonth"
      + "&ym=" + encodeURIComponent(ym)
      + "&key=" + encodeURIComponent(key)
      + "&adminName=" + encodeURIComponent(adminName)
      + "&adminEmail=" + encodeURIComponent(adminEmail)
      + "&mine=0"
      + "&ts=" + Date.now();

    try{
      const [data] = await Promise.all([
        jsonp(url),
        loadManagersMap(endpoint, key)
      ]);

      if (!data || !data.ok) throw new Error(data?.error || "Eroare la Ã®ncÄƒrcare.");
      LEAVES_ALL = Array.isArray(data.list) ? data.list : [];
      buildView(admin);
      render(ym, admin);
    }catch(err){
      setError(String(err && err.message ? err.message : err));
    }
  }

  // ===== init =====
  function ymNow(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    return `${y}-${m}`;
  }

  function bind(){
    // month selector
    const monthSel = $("#monthSel");
    if (monthSel){
      const now = ymNow();
      monthSel.value = now;
      monthSel.addEventListener("change", ()=>loadMonth(monthSel.value));
    }

    // submenus (tabs)
    document.querySelectorAll("#subnav .tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const k = btn.getAttribute("data-tab");
        setTab(k);
      });
    });


    $("#prev")?.addEventListener("click", ()=>{
      const m = ($("#monthSel")?.value || ymNow()).split("-").map(Number);
      const d = new Date(m[0], m[1]-2, 1);
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      if ($("#monthSel")) $("#monthSel").value = ym;
      loadMonth(ym);
    });

    $("#next")?.addEventListener("click", ()=>{
      const m = ($("#monthSel")?.value || ymNow()).split("-").map(Number);
      const d = new Date(m[0], m[1], 1);
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      if ($("#monthSel")) $("#monthSel").value = ym;
      loadMonth(ym);
    });

    $("#refresh")?.addEventListener("click", ()=>loadMonth($("#monthSel")?.value || ymNow()));
    $("#q")?.addEventListener("input", ()=>{
      const admin = getAdminSession();
      buildView(admin);
      render(CUR_YM || ($("#monthSel")?.value || ymNow()), admin);
    });
    $("#onlyMine")?.addEventListener("change", ()=>{
      const admin = getAdminSession();
      buildView(admin);
      render(CUR_YM || ($("#monthSel")?.value || ymNow()), admin);
    });


    // calendar cell click (delegare)
    const tbody = $("#tbody");
    if (tbody && !tbody.__bound){
      tbody.__bound = true;
      tbody.addEventListener("click", (ev)=>{
        const el = ev.target && ev.target.closest ? ev.target.closest(".lvcell") : null;
        if (!el) return;
        try{
          const admin = getAdminSession();
          const ym = CUR_YM || ($("#monthSel")?.value || ymNow());
          const day = ym + "-" + el.getAttribute("data-day");
          const arr = JSON.parse(decodeURIComponent(el.getAttribute("data-arr")||"[]"));
          openModal(arr, day, admin);
        }catch(e){ console.warn("openModal failed", e); }
      });
    }

    // modal
    $("#ov")?.addEventListener("click", (e)=>{
      if (e.target && e.target.id === "ov") closeModal();
    });
    $("#mApprove")?.addEventListener("click", ()=>decide("approved"));
    $("#mReject")?.addEventListener("click", ()=>decide("rejected"));
    $("#mDl")?.addEventListener("click", ()=>toast("Export: Ã®n curÃ¢nd"));
    document.addEventListener("keydown", (e)=>{
      if (e.key === "Escape") closeModal();
    });
  }

  async function init(){
    await loadCFG();
    bind();
    setTab(ACTIVE_TAB);
    const ym = $("#monthSel")?.value || ymNow();
    CUR_YM = ym;
    await loadMonth(ym);
  }

  document.addEventListener("DOMContentLoaded", init);
})();
</script>
</body>
</html>
