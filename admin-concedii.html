<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin â€” Concedii</title>
  <style>
    :root{
      --bg:#f5f6ff;
      --card:#ffffff;
      --ink:#1f2330;
      --muted:#6f7890;
      --line:#e7e9f6;
      --accent:#6d5efc;
      --shadow:0 10px 30px rgba(20,18,40,.08);
      --r:18px;

      --c-inactive:#f1f3f9;
      --c-under:#ffe9c7;
      --c-complete:#dff7e4;
      --c-over:#d9ecff;
      --c-leave:#efe6ff;

      --c-pending:#fff3d6;
      --c-approved:#e3f7e8;
      --c-rejected:#ffe0e0;
      --c-neutral:#f6f7fb;

      --purple:#2f245c;
      --purple2:#3a2d71;
      --purpleInk:#f5f4ff;
      --purpleMuted: rgba(245,244,255,.72);
      --purpleLine: rgba(255,255,255,.12);
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1600px;margin:18px auto;padding:0 14px}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .head{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .title{display:flex;flex-direction:column;gap:2px}
    .title h1{margin:0;font-size:18px}
    .title .sub{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{border:1px solid var(--line);background:#fff;border-radius:14px;padding:9px 12px;cursor:pointer;font-weight:750}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.primary{background:rgba(109,94,252,.12);border-color:rgba(109,94,252,.25);color:#2b2472}
    .pill{display:flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;border-radius:14px;padding:8px 10px}
    .pill input{border:0;outline:none;font-size:14px;width:220px}
    select{border:0;outline:none;font-weight:800;background:transparent;font-size:14px}
    .toggle{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);border-radius:14px;background:#fff;font-weight:750;color:#2b2472}
    .toggle input{width:16px;height:16px}

    /* === Calendar table (same look as PrezenÈ›Äƒ) === */
    .tableWrap{overflow:auto; max-height: calc(100vh - 220px); border-top:1px solid var(--line); background:#fff}
    table{border-collapse:separate;border-spacing:0; width:max(1100px, 100%); font-size:13px}
    thead th{
      position:sticky; top:0; z-index:6;
      background:#fff; border-bottom:1px solid var(--line);
      padding:12px 10px; text-align:center; color:#3b3f55;
      font-weight:900;
    }
    tbody td{
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      background:#fff;
      vertical-align:middle;
    }
    tbody tr:hover td{background:#fbfbff}
    th, td{white-space:nowrap}

    thead th.stickyL, tbody td.stickyL{position:sticky; left:0; z-index:7; text-align:left; box-shadow: 10px 0 20px rgba(20,18,40,.04);}
    thead th.stickyL2, tbody td.stickyL2{position:sticky; left:56px; z-index:7; text-align:left; box-shadow: 10px 0 20px rgba(20,18,40,.04);}
    thead th.stickyL3, tbody td.stickyL3{position:sticky; left:320px; z-index:7; text-align:left; box-shadow: 10px 0 20px rgba(20,18,40,.04);}

    tbody td.stickyL, tbody td.stickyL2, tbody td.stickyL3{background:#fff}
    thead th.stickyL, thead th.stickyL2, thead th.stickyL3{background:#fff}

    .empCell{display:flex;align-items:center;gap:10px}
    .empBubble{
      width:28px;height:28px;border-radius:10px;background:var(--bg);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;color:#3b3f55;border:1px solid var(--line)
    }
    .empName{font-weight:850}
    .empDept{font-size:12px;color:var(--muted);margin-top:2px}

    .dayCell{border-left:1px solid var(--line)}
    .cell{
      border-radius:12px;
      padding:8px 8px;
      border:1px solid rgba(0,0,0,0.03);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      min-height:52px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:2px;
      position:relative;
    }
    .cell:hover{transform:translateY(-1px)}
    .cell small{display:block; font-size:10px; font-weight:800; opacity:.85; margin-top:1px}

    .inactive{background:transparent; border-color:transparent; cursor:default}
    .leave{background:var(--c-leave)}
    .inv{background:var(--c-under)}
    .approvedTag{background:var(--c-approved)}
    .rejectedTag{background:var(--c-rejected)}
    .pendingTag{background:var(--c-pending)}

    .bang{
      position:absolute; top:6px; left:6px;
      width:18px;height:18px;border-radius:9px;
      background:#ffcc67; color:#3b2d00;
      display:flex;align-items:center;justify-content:center;
      font-size:12px;font-weight:1000;
      border:1px solid rgba(0,0,0,.06);
    }
    .more{
      position:absolute; bottom:6px; left:6px;
      font-size:10px; font-weight:1000; opacity:.75;
    }

    .legend{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding:12px 16px; border-top:1px solid var(--line); background:#fff;
      color:var(--muted); font-size:12px;
    }
    .lg{display:flex;gap:8px;align-items:center}
    .dot{width:10px;height:10px;border-radius:4px;border:1px solid rgba(0,0,0,.06)}

    /* === Below sections === */
    .below{padding:16px; display:flex; flex-direction:column; gap:14px; background:linear-gradient(180deg, rgba(245,246,255,.0), rgba(245,246,255,.55));}
    .card{background:#fff;border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .cardHead{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:12px}
    .cardHead h3{margin:0;font-size:14px}
    .badge{display:inline-flex;min-width:22px;height:22px;padding:0 8px;border-radius:999px;background:rgba(109,94,252,.12);border:1px solid rgba(109,94,252,.25);color:#2b2472;font-weight:900;align-items:center;justify-content:center;font-size:12px}
    .muted{color:var(--muted);font-size:12px}
    .tableMiniWrap{overflow:auto; max-height:340px}
    .miniTable{width:100%; border-collapse:separate; border-spacing:0}
    .miniTable th{position:sticky; top:0; background:#fff; border-bottom:1px solid var(--line); padding:12px 14px; text-align:left; font-size:12px; letter-spacing:.02em}
    .miniTable td{border-bottom:1px solid var(--line); padding:14px 14px; vertical-align:middle}
    .miniTable tr:hover td{background:#fbfbff}
    .empRow{display:flex;align-items:center;gap:12px}
    .av{width:36px;height:36px;border-radius:50%;background:#eee;border:1px solid rgba(0,0,0,.06);display:flex;align-items:center;justify-content:center;font-weight:1000;color:#3b3f55}
    .status{font-weight:900}
    .st-approved{color:#2f8a43}
    .st-rejected{color:#d34848}
    .st-pending{color:#7b6dfb}
    .dash{opacity:.55}

    .actions{display:flex;gap:10px;align-items:center}
    .actBtn{border:1px solid var(--line);background:#f2f3fb;border-radius:14px;padding:10px 14px;font-weight:900;cursor:pointer;display:inline-flex;gap:10px;align-items:center}
    .actBtn.approve{background:#7cc67a;border-color:#68b866;color:#fff}
    .actBtn.reject{background:#f2f3fb}
    .actBtn:hover{transform:translateY(-1px)}
    .actBtn:active{transform:translateY(0)}
    .rightBtns{display:flex;gap:10px;justify-content:flex-end}

    /* === Modal (approval) === */
    .ov{position:fixed;inset:0;background:rgba(18,16,32,.35);display:none;align-items:flex-end;justify-content:center;padding:18px;z-index:99}
    .ov.show{display:flex}
    .modal{width:min(560px,100%);background:var(--purple);color:var(--purpleInk);border-radius:18px;box-shadow:0 18px 60px rgba(0,0,0,.35);overflow:hidden}
    .modal .body{padding:16px 16px 10px;display:grid;grid-template-columns:1fr;gap:10px}
    .k{font-size:12px;color:var(--purpleMuted)}
    .v{font-size:16px;font-weight:900}
    .avatars{display:flex;gap:8px;flex-wrap:wrap}
    .ava{width:42px;height:42px;border-radius:50%;background:rgba(255,255,255,.12);border:1px solid var(--purpleLine)}
    .ava span{display:flex;width:100%;height:100%;align-items:center;justify-content:center;font-weight:1000}
    #mNote{margin-top:6px;width:100%;min-height:86px;resize:vertical;border:1px solid var(--purpleLine);background:rgba(255,255,255,.08);border-radius:12px;color:var(--purpleInk);padding:10px;outline:none}
    .modal .foot{display:flex;gap:10px;padding:12px 12px 14px;background:rgba(0,0,0,.06)}
    .bbtn{flex:1;border:1px solid var(--purpleLine);background:rgba(255,255,255,.08);border-radius:14px;padding:12px 14px;font-weight:1000;color:var(--purpleInk);cursor:pointer}
    .bbtn.approve{background:#78c774;border-color:#78c774;color:#fff}
    .bbtn.reject{background:rgba(255,255,255,.12)}
    .bbtn.icon{flex:0 0 46px}
    .bbtn:hover{transform:translateY(-1px)}
    .bbtn:active{transform:translateY(0)}

    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111; color:#fff;padding:10px 12px;border-radius:12px;opacity:0;pointer-events:none;transition:opacity .2s, transform .2s;z-index:120}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}
    .err{background:#ffe0e0;border:1px solid rgba(210,70,70,.25);color:#7e1f1f;padding:10px 12px;border-radius:14px;margin-top:10px;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="head">
        <div class="title">
          <h1>Concedii &amp; Ã®nvoiri</h1>
          <div class="sub" id="sub">AprobÄƒri</div>
        </div>
        <div class="controls">
          <button class="btn" id="prev">â€¹</button>
          <div class="pill">
            <select id="monthSel"></select>
          </div>
          <button class="btn" id="next">â€º</button>
          <div class="pill">
            <span style="opacity:.7">ðŸ”Ž</span>
            <input id="q" placeholder="CautÄƒ angajat..." />
          </div>
          <label class="toggle" title="FiltreazÄƒ doar cererile repartizate È›ie">
            <input type="checkbox" id="onlyMine" checked />
            <span>Doar ale mele</span>
          </label>
          <button class="btn primary" id="refresh">Refresh</button>
        </div>
      </div>

      <div class="tableWrap">
        <table id="cal">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="legend">
        <div class="lg"><span class="dot" style="background:var(--c-leave)"></span> Concediu</div>
        <div class="lg"><span class="dot" style="background:var(--c-under)"></span> ÃŽnvoire</div>
        <div class="lg"><span class="dot" style="background:var(--c-pending)"></span> Pending</div>
        <div class="lg"><span class="dot" style="background:var(--c-approved)"></span> Aprobat</div>
        <div class="lg"><span class="dot" style="background:var(--c-rejected)"></span> Respins</div>
      </div>

      <div class="below">
        <div class="card">
          <div class="cardHead">
            <div style="display:flex;align-items:center;gap:10px">
              <h3>ÃŽn aÈ™teptare &amp; istoric</h3>
              <span class="badge" id="pendingCount">0</span>
            </div>
            <div class="muted" id="dbg"></div>
          </div>
          <div style="padding:0 16px 12px">
            <div id="err" class="err"></div>
            <div class="muted" style="padding:10px 0 0">Angajat â€¢ Tip concediu â€¢ Tip Ã®nvoire â€¢ Status</div>
          </div>
          <div class="tableMiniWrap">
            <table class="miniTable" id="reqTable">
              <thead>
                <tr>
                  <th style="min-width:260px">ANGAJAT</th>
                  <th style="min-width:260px">TIP DE CONCEDIU</th>
                  <th style="min-width:260px">TIP ÃŽNVOIRE</th>
                  <th style="min-width:220px">STATUS</th>
                </tr>
              </thead>
              <tbody id="reqTbody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="cardHead">
            <h3>AprobÄƒri rapide</h3>
            <div class="muted">AprobÄƒ/respinge direct din listÄƒ</div>
          </div>
          <div class="tableMiniWrap">
            <table class="miniTable" id="actTable">
              <thead>
                <tr>
                  <th style="min-width:260px">ANGAJAT</th>
                  <th style="min-width:340px">PERIOADA</th>
                  <th style="min-width:260px">ACÈšIUNI</th>
                </tr>
              </thead>
              <tbody id="actTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Approval modal -->
  <div class="ov" id="ov">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="body">
        <div class="k">PerioadÄƒ</div>
        <div class="v" id="mPeriod">â€”</div>

        <div class="k">Tip</div>
        <div class="v" id="mReason">â€”</div>

        <div class="k">Status</div>
        <div class="v" id="mCount">â€”</div>

        <div class="k">Ziua selectatÄƒ</div>
        <div class="v" id="mDay">â€”</div>

        <textarea id="mNote" placeholder="NotÄƒ (opÈ›ional) â€” se aplicÄƒ la approve/reject"></textarea>
      </div>
      <div class="foot">
        <button class="bbtn reject" id="mReject">âœ• Respinge</button>
        <button class="bbtn approve" id="mApprove">âœ“ AprobÄƒ</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">â€”</div>

<script>
(() => {
  const CFG_PATHS = ["./config.json","../config.json","/config.json"];
  let CFG = null;
  const LS_ADMIN = "pontaj/admin/v1";
  const LS_ADMIN_KEY = "pontaj_adminKey";

  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));

  let YM = null;
  let ALL = [];
  let VIEW = [];
  let CURRENT = null; // current request (modal)

  function escapeHtml(s){ return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;", '"':"&quot;","'":"&#39;" }[m])) };
  function toast(msg){
    const el = $("#toast");
    el.textContent = msg;
    el.classList.add("show");
    clearTimeout(el._t);
    el._t = setTimeout(()=>el.classList.remove("show"), 2200);
  }

  async function loadCfg(){
    for (const p of CFG_PATHS){
      try{
        const r = await fetch(p, {cache:"no-store"});
        if (r.ok){ CFG = await r.json(); return CFG; }
      }catch(e){}
    }
    return null;
  }
  function endpoint(){
    return (CFG && (CFG.leaveEndpoint || CFG.adminEventsEndpoint)) || "";
  }

  function jsonp(url, params){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const qs = new URLSearchParams({...params, callback: cb}).toString();
      const s = document.createElement("script");
      const cleanup = ()=>{
        try{ delete window[cb]; }catch(e){ window[cb] = undefined; }
        s.remove();
      };
      window[cb] = (data)=>{ cleanup(); resolve(data); };
      s.onerror = ()=>{ cleanup(); reject(new Error("JSONP error")); };
      s.src = url + (url.includes("?")?"&":"?") + qs;
      document.head.appendChild(s);
    });
  }

  function getAdmin(){
    try{ return JSON.parse(localStorage.getItem(LS_ADMIN) || "null"); }catch(e){ return null; }
  }
  function getAdminName(admin){
    if (!admin) return "";
    return admin.label || admin.name || admin.fullName || admin.email || admin.user || "";
  }
  function getAdminEmail(admin){
    if (!admin) return "";
    return admin.email || admin.userEmail || admin.personalEmail || "";
  }
  function norm(s){ return String(s||"").trim().toLowerCase().replace(/\s+/g," "); }
  function same(a,b){ a=norm(a); b=norm(b); if (!a||!b) return false; return a===b || a.replace(/[^a-z0-9@.]+/g,"")===b.replace(/[^a-z0-9@.]+/g,""); }

  function pad2(n){ return String(n).padStart(2,"0"); }
  function daysInMonth(ym){
    const y = Number(ym.slice(0,4)), m = Number(ym.slice(5,7));
    return new Date(y, m, 0).getDate();
  }
  function toISODate(d){
    return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
  }
  function parseISO(iso){
    if (!iso) return null;
    if (iso instanceof Date) return new Date(iso.getTime());
    const s = String(iso);
    // accept YYYY-MM-DD or DD.MM.YYYY
    let m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (m) return new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), 12,0,0,0);
    m = s.match(/^(\d{2})\.(\d{2})\.(\d{4})/);
    if (m) return new Date(Number(m[3]), Number(m[2])-1, Number(m[1]), 12,0,0,0);
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }
  function fmtRO(iso){
    const d = parseISO(iso);
    if (!d) return "â€”";
    return pad2(d.getDate())+"."+pad2(d.getMonth()+1)+"."+d.getFullYear();
  }
  function getWeekdayShort(iso){
    const d = parseISO(iso);
    const map = ["Du","Lu","Ma","Mi","Jo","Vi","SÃ¢"];
    return map[d.getDay()];
  }
  function initials(name){
    const p = String(name||"").trim().split(/\s+/).filter(Boolean);
    if (!p.length) return "â€”";
    return (p[0][0] + (p[1]?p[1][0]:"")).toUpperCase();
  }

  function fmtTime(v){
    if (v==null || v==="") return "";
    // Date object (often 1899-12-30)
    if (v instanceof Date){
      const h = v.getHours(), m = v.getMinutes();
      return pad2(h)+":"+pad2(m);
    }
    // numeric serial (fraction of day)
    if (typeof v === "number" && isFinite(v)){
      const totalMin = Math.round(v * 24 * 60);
      const h = Math.floor(totalMin/60)%24;
      const m = totalMin%60;
      return pad2(h)+":"+pad2(m);
    }
    const s = String(v).trim();
    // "09:30" or "09:30:00"
    const m = s.match(/^(\d{1,2}):(\d{2})/);
    if (m) return pad2(Number(m[1]))+":"+m[2];
    // try Date parse
    const d = new Date(s);
    if (!isNaN(d)) return pad2(d.getHours())+":"+pad2(d.getMinutes());
    return s;
  }

  const LEAVE_MAP = {
    "CO":"Concediu de odihnÄƒ",
    "BO":"Concediu medical",
    "CCC":"Concediu pentru creÈ™terea copilului",
    "CFP":"Concediu fÄƒrÄƒ platÄƒ",
    "EV":"Eveniment"
  };

  function tipConcediu(req){
    if (req.kind !== "concediu") return "â€”";
    const code = (req.code||"").toUpperCase();
    return LEAVE_MAP[code] || (code ? ("Concediu ("+code+")") : "Concediu");
  }
  function tipInvoire(req){
    if (req.kind !== "invoire") return "â€”";
    const st = fmtTime(req.startTime||req.start||req.from);
    const en = fmtTime(req.endTime||req.end||req.to);
    const hh = (st && en) ? (st+"â€“"+en) : (st||en||"");
    return hh ? ("ÃŽnvoire "+hh) : "ÃŽnvoire";
  }
  function statusText(req){
    const s = (req.status||"pending").toLowerCase();
    if (s==="approved") return "Solicitare aprobatÄƒ";
    if (s==="rejected") return "Solicitare respinsÄƒ";
    return "ÃŽn aÈ™teptare";
  }
  function statusClass(req){
    const s = (req.status||"pending").toLowerCase();
    if (s==="approved") return "st-approved";
    if (s==="rejected") return "st-rejected";
    return "st-pending";
  }

  function fillMonthSelect(){
    const sel = $("#monthSel");
    sel.innerHTML = "";
    const now = new Date();
    for (let i=-12;i<=12;i++){
      const d = new Date(now.getFullYear(), now.getMonth()+i, 1);
      const ym = d.getFullYear()+"-"+pad2(d.getMonth()+1);
      const opt = document.createElement("option");
      opt.value = ym;
      opt.textContent = d.getFullYear()+" / "+pad2(d.getMonth()+1);
      sel.appendChild(opt);
    }
  }

  function applyFilters(){
    const q = norm($("#q").value);
    const onlyMine = $("#onlyMine").checked;
    const admin = getAdmin();
    const an = getAdminName(admin);
    const ae = getAdminEmail(admin);

    VIEW = ALL.filter(r=>{
      if (q){
        const hay = norm(r.employeeName) + " " + norm(r.dept) + " " + norm(r.code) + " " + norm(r.kind);
        if (!hay.includes(q)) return false;
      }
      if (onlyMine){
        const mn = r.managerName || r.manager || "";
        const me = r.managerEmail || "";
        // match by name OR email OR if request has empty manager then show (so you can see & fix)
        if (mn || me){
          return same(mn, an) || same(me, ae) || same(mn, ae) || same(me, an);
        }
      }
      return true;
    });
  }

  function buildByEmpDay(list){
    const by = new Map(); // emp -> {dept, days: Map(iso->array)}
    for (const r of list){
      const emp = String(r.employeeName||"").trim() || "â€”";
      if (!by.has(emp)) by.set(emp, {dept: r.dept||"", days: new Map()});
      const info = by.get(emp);
      if (!info.dept && r.dept) info.dept = r.dept;

      const s = parseISO(r.startDate || r.date || r.day);
      const e = parseISO(r.endDate || r.startDate || r.date || r.day);
      if (!s) continue;
      const end = e || s;
      const cur = new Date(s.getTime());
      while (cur <= end){
        const dk = toISODate(cur);
        if (dk.startsWith(YM)){
          if (!info.days.has(dk)) info.days.set(dk, []);
          info.days.get(dk).push(r);
        }
        cur.setDate(cur.getDate()+1);
      }
    }
    // sort arrays by createdAt
    for (const [k,v] of by){
      for (const [d,arr] of v.days){
        arr.sort((a,b)=> String(a.createdAt||"").localeCompare(String(b.createdAt||"")));
      }
    }
    return by;
  }

  function renderCalendar(){
    const dim = daysInMonth(YM);
    const thead = $("#thead");
    const tbody = $("#tbody");
    const cols = Array.from({length:dim}, (_,i)=>{
      const dk = YM+"-"+pad2(i+1);
      return `<th title="${dk}">${pad2(i+1)}<br><span style="font-weight:900">${getWeekdayShort(dk)}</span></th>`;
    }).join("");

    thead.innerHTML = `<tr>
      <th class="stickyL" style="min-width:56px">#</th>
      <th class="stickyL2" style="min-width:264px">Angajat</th>
      <th class="stickyL3" style="min-width:160px">Departament</th>
      ${cols}
    </tr>`;

    const by = buildByEmpDay(VIEW);
    const emps = Array.from(by.keys()).sort((a,b)=>a.localeCompare(b, "ro"));
    let html = "";
    emps.forEach((emp, idx)=>{
      const info = by.get(emp);
      const daysMap = info.days;

      const cells = Array.from({length:dim}, (_,i)=>{
        const dk = YM+"-"+pad2(i+1);
        const arr = daysMap.get(dk) || [];
        if (!arr.length){
          return `<td class="dayCell"><div class="cell inactive" data-ids="" data-day="${dk}" data-name="${escapeHtml(emp)}"></div></td>`;
        }
        const first = arr[0];
        const kind = (first.kind||"concediu").toLowerCase();
        const isInv = kind==="invoire";
        const label = isInv ? "INV" : (String(first.code||"").toUpperCase() || "CO");
        const sub = isInv ? (fmtTime(first.startTime||first.start||first.from)+"â€“"+fmtTime(first.endTime||first.end||first.to)) : "";
        const pendingAny = arr.some(x=>String(x.status||"pending").toLowerCase()==="pending");
        const clsBase = isInv ? "inv" : "leave";
        const ids = arr.map(x=>x.id).filter(Boolean).join(",");
        const more = arr.length>1 ? `<span class="more">+${arr.length-1}</span>` : "";
        const bang = pendingAny ? `<span class="bang">!</span>` : "";
        const subHtml = sub ? `<small>${escapeHtml(sub)}</small>` : "";
        const title = `${emp} â€¢ ${dk}\n${arr.map(x=>{
          const k = (x.kind||"").toLowerCase();
          const t = k==="invoire" ? ("ÃŽnvoire "+(fmtTime(x.startTime||x.start||x.from)||"")+"â€“"+(fmtTime(x.endTime||x.end||x.to)||"")) : (String(x.code||"").toUpperCase());
          return `${t} (${x.status||"pending"})`;
        }).join("\n")}`;
        return `<td class="dayCell">
          <div class="cell ${clsBase} ${pendingAny?'pending':''}" data-ids="${escapeHtml(ids)}" data-day="${dk}" data-name="${escapeHtml(emp)}" title="${escapeHtml(title)}">
            ${bang}${escapeHtml(label)}${subHtml}${more}
          </div>
        </td>`;
      }).join("");

      html += `<tr>
        <td class="stickyL">${idx+1}</td>
        <td class="stickyL2">
          <div class="empCell">
            <div class="empBubble">${escapeHtml(initials(emp))}</div>
            <div>
              <div class="empName">${escapeHtml(emp)}</div>
              <div class="empDept">Manager: ${escapeHtml((info.managerName||"") || (VIEW.find(r=>r.employeeName===emp)?.managerName) || "â€”")}</div>
            </div>
          </div>
        </td>
        <td class="stickyL3">${escapeHtml(info.dept || "â€”")}</td>
        ${cells}
      </tr>`;
    });

    tbody.innerHTML = html || `<tr><td class="stickyL" colspan="${3+dim}" style="padding:16px;color:var(--muted)">Nu existÄƒ cereri Ã®n luna selectatÄƒ.</td></tr>`;
  }

  function renderReqTables(){
    const reqTbody = $("#reqTbody");
    const actTbody = $("#actTbody");

    const pending = VIEW.filter(r=>String(r.status||"pending").toLowerCase()==="pending");
    $("#pendingCount").textContent = String(pending.length);

    // debug label
    const admin = getAdmin();
    const dbg = `ÃŽncÄƒrcate: ${ALL.length} â€¢ AfiÈ™ate: ${VIEW.length} â€¢ Admin: ${getAdminName(admin) || "â€”"}`;
    $("#dbg").textContent = dbg;

    // table 3 (all)
    const rows = VIEW.slice().sort((a,b)=>String(b.createdAt||"").localeCompare(String(a.createdAt||"")));
    reqTbody.innerHTML = rows.map(r=>{
      const emp = r.employeeName || "â€”";
      const av = initials(emp);
      const tc = (r.kind==="concediu") ? tipConcediu(r) : "<span class='dash'>â€”</span>";
      const ti = (r.kind==="invoire") ? (tipInvoire(r)) : "<span class='dash'>â€”</span>";
      const st = statusText(r);
      const stc = statusClass(r);
      return `<tr>
        <td>
          <div class="empRow">
            <div class="av">${escapeHtml(av)}</div>
            <div>
              <div style="font-weight:900">${escapeHtml(emp)}</div>
              <div class="muted">${escapeHtml(r.dept || "â€”")}</div>
            </div>
          </div>
        </td>
        <td>${tc}</td>
        <td>${ti}</td>
        <td class="status ${stc}">${escapeHtml(st)}</td>
      </tr>`;
    }).join("") || `<tr><td colspan="4" class="muted" style="padding:16px">Nu existÄƒ cereri pentru luna selectatÄƒ.</td></tr>`;

    // table 4 (pending with actions)
    actTbody.innerHTML = pending.map(r=>{
      const emp = r.employeeName || "â€”";
      const av = initials(emp);
      const per = (r.kind==="invoire")
        ? (fmtRO(r.startDate)+" â€¢ "+(fmtTime(r.startTime||r.start||r.from)||"")+"â€“"+(fmtTime(r.endTime||r.end||r.to)||""))
        : (fmtRO(r.startDate) + " â€“ " + fmtRO(r.endDate || r.startDate));
      return `<tr data-id="${escapeHtml(r.id)}">
        <td>
          <div class="empRow">
            <div class="av">${escapeHtml(av)}</div>
            <div>
              <div style="font-weight:900">${escapeHtml(emp)}</div>
              <div class="muted">${escapeHtml(r.kind==="invoire" ? "ÃŽnvoire" : "Concediu")}</div>
            </div>
          </div>
        </td>
        <td style="font-weight:900">${escapeHtml(per)}</td>
        <td>
          <div class="actions">
            <button class="actBtn approve" data-act="approve">âœ“ AprobÄƒ</button>
            <button class="actBtn reject" data-act="reject">âœ•</button>
          </div>
        </td>
      </tr>`;
    }).join("") || `<tr><td colspan="3" class="muted" style="padding:16px">Nu existÄƒ cereri pending Ã®n luna selectatÄƒ.</td></tr>`;
  }

  function openModalById(id, day){
    const r = VIEW.find(x=>x.id===id) || ALL.find(x=>x.id===id);
    if (!r) return;
    CURRENT = r;
    const isInv = (r.kind||"").toLowerCase()==="invoire";
    const per = isInv
      ? (fmtRO(r.startDate)+" â€¢ "+(fmtTime(r.startTime||r.start||r.from)||"")+"â€“"+(fmtTime(r.endTime||r.end||r.to)||""))
      : (fmtRO(r.startDate) + " â€“ " + fmtRO(r.endDate || r.startDate));
    $("#mPeriod").textContent = per;
    $("#mReason").textContent = isInv ? tipInvoire(r) : tipConcediu(r);
    $("#mCount").textContent = statusText(r);
    $("#mDay").textContent = day || (r.startDate || "â€”");
    $("#mNote").value = "";
    $("#ov").classList.add("show");
  }

  async function decide(id, decision){
    if (!id) return;
    const key = localStorage.getItem(LS_ADMIN_KEY) || "";
    if (!key){
      toast("LipseÈ™te ADMIN_KEY (pontaj_adminKey).");
      return;
    }
    const note = $("#mNote").value.trim();
    const ep = endpoint();
    const resp = await jsonp(ep, {fn:"adminLeaveDecide", id, decision, note, key});
    if (!resp || resp.ok !== true){
      throw new Error((resp && (resp.error || resp.message)) || "Decizie eÈ™uatÄƒ");
    }
    // update local
    const allIdx = ALL.findIndex(x=>x.id===id);
    if (allIdx>=0) ALL[allIdx].status = decision;
    const viewIdx = VIEW.findIndex(x=>x.id===id);
    if (viewIdx>=0) VIEW[viewIdx].status = decision;
    toast(decision==="approved" ? "Aprobat" : "Respins");
    $("#ov").classList.remove("show");
    applyFilters();
    renderCalendar();
    renderReqTables();
  }

  async function loadMonth(){
    $("#err").style.display = "none";
    const ep = endpoint();
    if (!ep){ $("#err").style.display="block"; $("#err").textContent = "Nu gÄƒsesc endpoint (config.json)."; return; }
    const key = localStorage.getItem(LS_ADMIN_KEY) || "";
    const admin = getAdmin();
    const adminName = getAdminName(admin);
    const adminEmail = getAdminEmail(admin);
    const resp = await jsonp(ep, {fn:"adminLeavesMonth", ym:YM, key, adminName, adminEmail});
    if (!resp || resp.ok !== true){
      throw new Error((resp && (resp.error || resp.message)) || "Eroare adminLeavesMonth");
    }
    ALL = Array.isArray(resp.leaves) ? resp.leaves : (resp.items || []);
    // normalize fields
    ALL.forEach(r=>{
      r.kind = (r.kind||r.type||"concediu").toLowerCase();
      r.code = r.code || r.leaveCode || r.leaveType || (r.kind==="invoire" ? "INV" : "");
      r.startDate = r.startDate || r.date || r.day;
      r.endDate = r.endDate || r.end;
      r.status = (r.status||"pending").toLowerCase();
    });
    applyFilters();
    renderCalendar();
    renderReqTables();
  }

  function bind(){
    $("#refresh").addEventListener("click", ()=>loadMonth().catch(showErr));
    $("#q").addEventListener("input", ()=>{ applyFilters(); renderCalendar(); renderReqTables(); });
    $("#onlyMine").addEventListener("change", ()=>{ applyFilters(); renderCalendar(); renderReqTables(); });

    $("#monthSel").addEventListener("change", (e)=>{
      YM = e.target.value;
      loadMonth().catch(showErr);
    });
    $("#prev").addEventListener("click", ()=>{
      const y = Number(YM.slice(0,4)), m = Number(YM.slice(5,7));
      const d = new Date(y, m-2, 1);
      YM = d.getFullYear()+"-"+pad2(d.getMonth()+1);
      $("#monthSel").value = YM;
      loadMonth().catch(showErr);
    });
    $("#next").addEventListener("click", ()=>{
      const y = Number(YM.slice(0,4)), m = Number(YM.slice(5,7));
      const d = new Date(y, m, 1);
      YM = d.getFullYear()+"-"+pad2(d.getMonth()+1);
      $("#monthSel").value = YM;
      loadMonth().catch(showErr);
    });

    // calendar click
    $("#tbody").addEventListener("click", (e)=>{
      const cell = e.target.closest(".cell");
      if (!cell) return;
      const ids = (cell.getAttribute("data-ids")||"").split(",").filter(Boolean);
      if (!ids.length) return;
      const day = cell.getAttribute("data-day") || "";
      // prefer first pending
      const pending = ids.map(id=>VIEW.find(x=>x.id===id)).filter(Boolean).find(x=>String(x.status||"pending")==="pending");
      const id = pending ? pending.id : ids[0];
      openModalById(id, day);
    });

    // actions table
    $("#actTbody").addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-act]");
      if (!btn) return;
      const tr = e.target.closest("tr[data-id]");
      if (!tr) return;
      const id = tr.getAttribute("data-id");
      const act = btn.getAttribute("data-act");
      $("#mNote").value = "";
      if (act==="approve") decide(id, "approved").catch(showErr);
      if (act==="reject") decide(id, "rejected").catch(showErr);
    });

    // modal
    $("#ov").addEventListener("click", (e)=>{
      if (e.target.id==="ov") $("#ov").classList.remove("show");
    });
    $("#mApprove").addEventListener("click", ()=>{ if(CURRENT) decide(CURRENT.id, "approved").catch(showErr); });
    $("#mReject").addEventListener("click", ()=>{ if(CURRENT) decide(CURRENT.id, "rejected").catch(showErr); });
  }

  function showErr(err){
    console.error(err);
    const el = $("#err");
    el.style.display = "block";
    el.textContent = (err && (err.message||err.error)) ? (err.message||err.error) : String(err);
  }

  async function init(){
    fillMonthSelect();
    const now = new Date();
    YM = now.getFullYear()+"-"+pad2(now.getMonth()+1);
    $("#monthSel").value = YM;
    await loadCfg();
    bind();
    await loadMonth();
  }

  init().catch(showErr);
})();
</script>
</body>
</html>
