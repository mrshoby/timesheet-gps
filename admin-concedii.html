<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin â€” Concedii</title>
  <style>
    :root{
      --bg:#f5f6ff;
      --card:#ffffff;
      --ink:#1f2330;
      --muted:#6f7890;
      --line:#e7e9f6;
      --accent:#6d5efc;
      --shadow:0 10px 30px rgba(20,18,40,.08);
      --r:18px;

      --c-pending:#fff3d6;
      --c-approved:#e3f7e8;
      --c-rejected:#ffe0e0;
      --c-neutral:#f6f7fb;

      --purple:#2f245c;
      --purple2:#3a2d71;
      --purpleInk:#f5f4ff;
      --purpleMuted: rgba(245,244,255,.72);
      --purpleLine: rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1600px;margin:18px auto;padding:0 14px}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .head{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .title{display:flex;flex-direction:column;gap:2px}
    .title h1{margin:0;font-size:18px}
    .title .sub{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:flex;align-items:center;gap:8px;background:var(--c-neutral);border:1px solid var(--line);border-radius:14px;padding:8px 10px}
    .pill input,.pill select{border:0;background:transparent;outline:none;font:inherit;color:var(--ink)}
    .btn{border:1px solid var(--line);background:var(--card);border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:600}
    .btn.primary{background:rgba(109,94,252,.12);border-color:rgba(109,94,252,.25);color:var(--accent)}
    .btn:active{transform:translateY(1px)}
    .toggle{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);border-radius:14px;background:var(--c-neutral);user-select:none}
    .toggle input{width:16px;height:16px}

    .grid{display:grid;grid-template-columns: 1fr 360px;gap:14px;padding:14px}
    @media(max-width:1100px){ .grid{grid-template-columns:1fr} }

    .tableWrap{background:var(--card);border:1px solid var(--line);border-radius:18px;overflow:hidden}
    .tableScroll{overflow:auto}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:980px}
    thead th{position:sticky;top:0;z-index:5;background:#fbfbff;border-bottom:1px solid var(--line);font-size:12px;color:var(--muted);text-align:center;padding:10px 6px}
    thead th:first-child{left:0;z-index:7;text-align:left;padding-left:14px;min-width:260px}
    tbody td, tbody th{border-bottom:1px solid var(--line);border-right:1px solid var(--line);height:64px;vertical-align:middle;text-align:center;font-size:13px;color:var(--ink);background:#fff}
    tbody tr:last-child td, tbody tr:last-child th{border-bottom:0}
    tbody td:last-child, thead th:last-child{border-right:0}
    tbody th{position:sticky;left:0;z-index:6;background:#fff;text-align:left;padding:10px 12px;min-width:260px;border-right:1px solid var(--line)}
    .who{display:flex;align-items:center;gap:10px}
    .av{width:34px;height:34px;border-radius:999px;background:#e9ecff;display:grid;place-items:center;font-weight:800;color:#3a2d71;flex:0 0 auto}
    .name{display:flex;flex-direction:column;line-height:1.1}
    .name .n{font-weight:700}
    .name .d{font-size:12px;color:var(--muted)}

    .cell{position:relative;cursor:pointer}
    .cell:hover{background:#fafaff}
    .tag{display:inline-flex;align-items:center;justify-content:center;min-width:44px;padding:6px 10px;border-radius:12px;font-weight:800}
    .tag.co{background:rgba(109,94,252,.10);color:var(--accent)}
    .tag.inv{background:rgba(47,36,92,.08);color:var(--purple)}
    .mini{display:block;margin-top:4px;font-size:11px;color:var(--muted);font-weight:600}

    .pending{background:var(--c-pending)}
    .approved{background:var(--c-approved)}
    .rejected{background:var(--c-rejected)}
    .bang{
      position:absolute;top:6px;right:6px;width:18px;height:18px;border-radius:999px;
      background:#ffb020;color:#1f2330;font-weight:900;font-size:12px;display:grid;place-items:center;
      border:2px solid #fff;
    }

    .side{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:12px}
    .side h3{margin:0 0 10px 0;font-size:14px}
    .side .muted{color:var(--muted);font-size:12px}
    .list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .item{border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff;display:flex;justify-content:space-between;gap:10px}
    .item strong{display:block}
    .item .meta{font-size:12px;color:var(--muted)}
    .item .actions{display:flex;gap:8px;align-items:center}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800;background:#f3f4ff;color:var(--accent);border:1px solid rgba(109,94,252,.25)}
    .err{margin-top:10px;padding:10px;border-radius:12px;background:#fff0f0;border:1px solid #ffd2d2;color:#9b1c1c;font-weight:700}

    /* Approval modal (purple) */
    .ov{position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
    .ov.open{display:flex}
    .modal{
      width:min(520px, 96vw);
      background:linear-gradient(180deg,var(--purple2),var(--purple));
      color:var(--purpleInk);
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .modal .body{padding:18px}
    .k{color:var(--purpleMuted);font-size:12px;margin-top:10px}
    .v{font-weight:800;font-size:16px;margin-top:2px}
    .row{display:flex;gap:12px;align-items:center;margin-top:14px}
    .avatars{display:flex;gap:8px;margin-top:8px}
    .avatars .av{background:rgba(255,255,255,.16);color:var(--purpleInk);border:1px solid var(--purpleLine)}
    .modal textarea{
      width:100%;margin-top:12px;min-height:80px;resize:vertical;
      border-radius:12px;border:1px solid var(--purpleLine);
      background:rgba(255,255,255,.10);color:var(--purpleInk);
      padding:10px;font:inherit;outline:none
    }
    .modal .foot{
      display:flex;gap:10px;padding:14px;border-top:1px solid var(--purpleLine);
      background:rgba(0,0,0,.08)
    }
    .bbtn{
      flex:1;display:flex;align-items:center;justify-content:center;gap:8px;
      border-radius:12px;padding:12px 10px;font-weight:900;cursor:pointer;border:1px solid transparent
    }
    .bbtn.secondary{background:rgba(255,255,255,.12);border-color:var(--purpleLine);color:var(--purpleInk)}
    .bbtn.approve{background:#6bc676;color:#0b2b12}
    .bbtn.reject{background:rgba(255,255,255,.12);border:1px solid var(--purpleLine);color:var(--purpleInk)}
    .bbtn.icon{flex:0 0 54px}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#1f2330;color:#fff;padding:10px 12px;border-radius:12px;font-weight:700;box-shadow:var(--shadow);display:none;z-index:99999}
    .toast.show{display:block}
  </style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <div class="head">
      <div class="title">
        <h1>Concedii &amp; Ã®nvoiri</h1>
        <div class="sub" id="sub">AprobÄƒri</div>
      </div>
      <div class="controls">
        <button class="btn" id="prev">â€¹</button>
        <div class="pill">
          <select id="monthSel"></select>
        </div>
        <button class="btn" id="next">â€º</button>
        <div class="pill">
          <span style="opacity:.7">ðŸ”Ž</span>
          <input id="q" placeholder="CautÄƒ angajat..." />
        </div>
        <label class="toggle" title="FiltreazÄƒ doar cererile repartizate È›ie">
          <input type="checkbox" id="onlyMine" checked />
          <span>Doar ale mele</span>
        </label>
        <button class="btn primary" id="refresh">Refresh</button>
      </div>
    </div>

    <div class="grid">
      <div class="tableWrap">
        <div class="tableScroll">
          <table id="cal">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="side">
        <h3>ÃŽn aÈ™teptare <span class="badge" id="pendingCount">0</span></h3>
        <div class="muted">Click pe o zi cu cerere pentru aprobare / respingere.</div>
        <div id="err" class="err" style="display:none"></div>
        <div class="list" id="pendingList"></List>
        <div class="muted" id="emptyMsg" style="margin-top:10px;display:none">Nu existÄƒ cereri pending Ã®n luna selectatÄƒ.</div>
      </div>
    </div>
  </div>
</div>

<!-- Approval modal -->
<div class="ov" id="ov">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="body">
      <div class="k">PerioadÄƒ</div>
      <div class="v" id="mPeriod">â€”</div>

      <div class="k">NumÄƒr</div>
      <div class="v" id="mCount">â€”</div>

      <div class="k">Motiv</div>
      <div class="v" id="mReason">â€”</div>

      <div class="k">Ziua selectatÄƒ</div>
      <div class="v" id="mDay">â€”</div>

      <div class="k">ÃŽn aceeaÈ™i zi cu</div>
      <div class="avatars" id="sameDayAv"></div>

      <div class="k">ÃŽn aceeaÈ™i perioadÄƒ cu</div>
      <div class="avatars" id="samePeriodAv"></div>

      <textarea id="mNote" placeholder="NotÄƒ (opÈ›ional) â€” se aplicÄƒ la approve/reject"></textarea>
    </div>
    <div class="foot">
      <button class="bbtn secondary icon" id="mDl" title="Export (placeholder)">â¤“</button>
      <button class="bbtn reject" id="mReject">âœ• Respinge</button>
      <button class="bbtn approve" id="mApprove">âœ“ AprobÄƒ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">â€”</div>

<script>
(() => {
  // ===== Config loading (same smart loader used elsewhere) =====
  const CFG_PATHS = ["./config.json","../config.json","/config.json"];
  let CFG = null;

  function $(sel){ return document.querySelector(sel); }
  function toast(msg){
    const t = $("#toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }

  async function loadCFG(){
    for (const p of CFG_PATHS){
      try{
        const r = await fetch(p, { cache:"no-store" });
        if (!r.ok) continue;
        CFG = await r.json();
        return;
      }catch(e){}
    }
    CFG = {};
  }
  function ep(){ return CFG?.leaveEndpoint || CFG?.adminEventsEndpoint || CFG?.stateEndpoint || ""; }

  // ===== Admin session (from admin shell) =====
  const LS_ADMIN = "pontaj/admin/v1";
  const LS_ADMIN_KEY = "pontaj_adminKey";

  function getAdminSession(){
      const raw = (localStorage.getItem(LS_ADMIN) || "").trim();
      if (!raw) return null;
  
      // raw can be JSON or a plain string (email/name)
      let obj = null;
      try{ obj = JSON.parse(raw); }catch(_){ obj = null; }
  
      if (obj && typeof obj === 'object'){
        // many builds store {email,name,user,label,ts,...} â€“ do NOT require obj.ok
        const adminName = (obj.label || obj.name || obj.user || obj.email || obj.id || "").toString().trim();
        const adminEmail = (obj.email || obj.userEmail || obj.mail || "").toString().trim();
        if (!adminName && !adminEmail) return null;
        return { raw: obj, name: adminName || adminEmail, email: adminEmail || adminName };
      }
  
      // fallback: treat raw as identifier
      return { raw: { value: raw }, name: raw, email: raw };
    }
  
    function requireAdmin(){
      const s = getAdminSession();
      if (!s) throw new Error("Nu eÈ™ti logat ca admin.");
      return s;
    }

  function getAdminKey(){
    let k = "";
    try{ k = (localStorage.getItem(LS_ADMIN_KEY) || "").trim(); }catch(e){}
    if (!k){
      k = (prompt("Cheie admin (ADMIN_KEY) pentru aprobÄƒri:", "") || "").trim();
      if (k){ try{ localStorage.setItem(LS_ADMIN_KEY, k); }catch(e){} }
    }
    return k;
  }

  // ===== JSONP =====
  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const cb = "cb_"+Math.random().toString(16).slice(2);
      window[cb] = (data)=>{ try{ delete window[cb]; }catch(e){} s.remove(); resolve(data); };
      const s = document.createElement("script");
      s.src = url + (url.includes("?")?"&":"?") + "callback=" + cb;
      s.onerror = ()=>{ try{ delete window[cb]; }catch(e){} s.remove(); reject(new Error("JSONP error")); };
      document.body.appendChild(s);
    });
  }

  // ===== State =====
  let LEAVES = [];
  let INDEX = new Map(); // name -> list
  let DAYINDEX = new Map(); // yyyy-mm-dd -> list
  let YM = "";
  let ACTIVE = null; // active leave object
  let ACTIVE_DAY = "";

  function norm(s){ return String(s||"").trim().toLowerCase(); }
  function deacc(s){ return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }
  function initials(name){
    const parts = String(name||"").trim().split(/\s+/).filter(Boolean);
    const a = parts[0]?.[0] || "?";
    const b = parts.length>1 ? parts[parts.length-1][0] : "";
    return (a+b).toUpperCase();
  }
  function daysInMonth(ym){
    const [y,m] = ym.split("-").map(Number);
    return new Date(y, m, 0).getDate();
  }
  function dowShort(d){
    const arr=["Du","Lu","Ma","Mi","Jo","Vi","SÃ¢"];
    return arr[d.getDay()];
  }
  function iso(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da= String(d.getDate()).padStart(2,"0");
    return y+"-"+m+"-"+da;
  }
  function parseIsoDate(s){
    const m = String(s||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return null;
    const d = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
    d.setHours(0,0,0,0);
    return d;
  }
  function overlaps(aStart,aEnd,bStart,bEnd){
    return !(aEnd < bStart || aStart > bEnd);
  }
  function inRange(day, start, end){
    return day >= start && day <= end;
  }

  function indexLeaves(list){
    LEAVES = Array.isArray(list) ? list.slice() : [];
    INDEX = new Map();
    DAYINDEX = new Map();
    for (const l of LEAVES){
      const name = String(l.employeeName||"").trim();
      if(!name) continue;
      if(!INDEX.has(name)) INDEX.set(name, []);
      INDEX.get(name).push(l);

      const sd = String(l.startDate||"");
      const ed = String(l.endDate||"");
      const sdd = parseIsoDate(sd);
      const edd = parseIsoDate(ed);
      if(!sdd || !edd) continue;
      for(let d=new Date(sdd); d<=edd; d.setDate(d.getDate()+1)){
        const day = iso(d);
        if(!DAYINDEX.has(day)) DAYINDEX.set(day, []);
        DAYINDEX.get(day).push(l);
      }
    }
    // sort leaves per employee by startDate
    for (const [k,arr] of INDEX.entries()){
      arr.sort((a,b)=>String(a.startDate||"").localeCompare(String(b.startDate||"")));
    }
  }

  function bestForCell(list){
    if(!list || !list.length) return null;
    const pending = list.find(x=>norm(x.status)==="pending");
    return pending || list[0];
  }

  function render(ym){
    const q = norm($("#q").value);
    const onlyMine = $("#onlyMine").checked;
    const days = daysInMonth(ym);
    const thead = $("#thead");
    const tbody = $("#tbody");

    // build roster from leaves (names)
    let names = Array.from(INDEX.keys());
    if(q) names = names.filter(n=>deacc(n.toLowerCase()).includes(deacc(q)));
    names.sort((a,b)=>a.localeCompare(b,"ro"));

    // header
    let h = "<tr>";
    h += "<th>ANGAJAT</th>";
    for(let i=1;i<=days;i++){
      const d = new Date(ym+"-"+String(i).padStart(2,"0")+"T00:00:00");
      h += `<th><div style="font-weight:800;color:#1f2330">${String(i).padStart(2,"0")}</div><div>${dowShort(d)}</div></th>`;
    }
    h += "</tr>";
    thead.innerHTML = h;

    // body rows
    let html = "";
    for (const name of names){
      html += "<tr>";
      html += `<th><div class="who"><div class="av">${initials(name)}</div><div class="name"><span class="n">${name}</span><span class="d">â€”</span></div></div></th>`;
      for(let i=1;i<=days;i++){
        const day = ym+"-"+String(i).padStart(2,"0");
        const all = (INDEX.get(name)||[]).filter(l=>inRange(day, String(l.startDate||""), String(l.endDate||"")));
        if(!all.length){
          html += `<td class="cell" data-day="${day}" data-name="${encodeURIComponent(name)}"></td>`;
          continue;
        }
        const pick = bestForCell(all);
        const st = norm(pick.status);
        const cls = st==="pending" ? "pending" : (st==="approved" ? "approved" : (st==="rejected" ? "rejected" : ""));
        const isInv = norm(pick.kind)==="invoire";
        const tagCls = isInv ? "tag inv" : "tag co";
        const tagTxt = isInv ? "INV" : (pick.code||"â€”");
        const mini = isInv ? (`<span class="mini">${pick.startTime||""}-${pick.endTime||""}</span>`) : "";
        const bang = st==="pending" ? `<div class="bang">!</div>` : "";
        const ids = all.map(x=>x.id).filter(Boolean).join(",");
        html += `<td class="cell ${cls}" data-day="${day}" data-name="${encodeURIComponent(name)}" data-ids="${ids}">
                  ${bang}
                  <span class="${tagCls}">${tagTxt}</span>
                  ${mini}
                 </td>`;
      }
      html += "</tr>";
    }
    tbody.innerHTML = html;

    // pending list right
    const pending = LEAVES.filter(l=>norm(l.status)==="pending");
    $("#pendingCount").textContent = String(pending.length);
    const pl = $("#pendingList");
    const emptyMsg = $("#emptyMsg");
    pl.innerHTML = "";
    if(!pending.length){
      emptyMsg.style.display = "block";
    }else{
      emptyMsg.style.display = "none";
      pending.slice(0,30).forEach(l=>{
        const txt = (norm(l.kind)==="invoire") ? `ÃŽnvoire ${l.startDate} ${l.startTime||""}-${l.endTime||""}` : `${l.code||"â€”"} ${l.startDate}â€“${l.endDate}`;
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `<div>
            <strong>${l.employeeName||"â€”"}</strong>
            <div class="meta">${txt}</div>
          </div>
          <div class="actions"><span class="badge">pending</span></div>`;
        div.addEventListener("click", ()=>{
          const day = l.startDate || ym+"-01";
          openModal(l, day);
        });
        pl.appendChild(div);
      });
    }
  }

  function setError(msg){
    const e = $("#err");
    if(!msg){ e.style.display="none"; e.textContent=""; return; }
    e.style.display="block";
    e.textContent = msg;
  }

  async function loadMonth(ym){
    setError("");
    const endpoint = ep();
    if(!endpoint){ setError("LipseÈ™te endpoint Ã®n config.json (leaveEndpoint/adminEventsEndpoint)."); return; }

    let admin = null;
    try{ admin = requireAdmin(); }catch(err){ admin = null; }

    const key = getAdminKey();
    if(!key){ setError("LipseÈ™te ADMIN_KEY."); return; }

    const adminName = (admin && (admin.name||admin.email)) || '';
    const adminEmail = (admin && admin.email) || '';

    const onlyMine = $("#onlyMine").checked;
    const url = endpoint + "?fn=adminLeavesMonth"
      + "&ym=" + encodeURIComponent(ym)
      + "&key=" + encodeURIComponent(key)
      + "&adminName=" + encodeURIComponent(adminName)
      + "&adminEmail=" + encodeURIComponent(adminEmail)
      + "&mine=" + (onlyMine ? "1" : "0")
      + "&ts=" + Date.now();

    try{
      const res = await jsonp(url);
      if(!res || !res.ok) throw new Error(res?.error || "Nu pot Ã®ncÄƒrca cererile.");
      indexLeaves(res.list||[]);
      $("#sub").textContent = onlyMine ? "AprobÄƒri â€” doar ale mele" : "AprobÄƒri â€” toate";
      render(ym);
    }catch(err){
      setError(String(err?.message||err||"Eroare"));
      indexLeaves([]);
      render(ym);
    }
  }

  // ===== Modal =====
  function openModal(leave, day){
    ACTIVE = leave;
    ACTIVE_DAY = day;
    $("#mDay").textContent = day;
    const isInv = norm(leave.kind)==="invoire";
    $("#mPeriod").textContent = isInv ? `${leave.startDate} (${leave.startTime||""}-${leave.endTime||""})` : `${leave.startDate} - ${leave.endDate}`;
    $("#mCount").textContent = isInv ? "ÃŽnvoire" : (calcDays(leave.startDate, leave.endDate) + " zile");
    $("#mReason").textContent = (leave.reason && String(leave.reason).trim()) ? leave.reason : "â€”";
    $("#mNote").value = "";

    // same day avatars
    $("#sameDayAv").innerHTML = "";
    const sameDay = (DAYINDEX.get(day)||[]).filter(x=>x.id!==leave.id && norm(x.status)==="pending");
    sameDay.slice(0,6).forEach(x=>{
      const d = document.createElement("div");
      d.className="av";
      d.textContent = initials(x.employeeName);
      d.title = x.employeeName;
      $("#sameDayAv").appendChild(d);
    });
    if(!sameDay.length) $("#sameDayAv").innerHTML = '<span class="k" style="margin-top:0">â€”</span>';

    // same period avatars
    $("#samePeriodAv").innerHTML = "";
    const sd = parseIsoDate(leave.startDate), ed = parseIsoDate(leave.endDate);
    const samePer = LEAVES.filter(x=>{
      if(x.id===leave.id) return false;
      if(norm(x.status)!=="pending") return false;
      const a = parseIsoDate(x.startDate), b = parseIsoDate(x.endDate);
      if(!a||!b||!sd||!ed) return false;
      return overlaps(sd,ed,a,b);
    });
    samePer.slice(0,6).forEach(x=>{
      const d = document.createElement("div");
      d.className="av";
      d.textContent = initials(x.employeeName);
      d.title = x.employeeName;
      $("#samePeriodAv").appendChild(d);
    });
    if(!samePer.length) $("#samePeriodAv").innerHTML = '<span class="k" style="margin-top:0">â€”</span>';

    $("#ov").classList.add("open");
  }
  function closeModal(){ $("#ov").classList.remove("open"); ACTIVE=null; ACTIVE_DAY=""; }
  $("#ov").addEventListener("click", (e)=>{ if(e.target.id==="ov") closeModal(); });

  function calcDays(s,e){
    const sd = parseIsoDate(s), ed = parseIsoDate(e);
    if(!sd||!ed) return 0;
    return Math.round((ed - sd)/86400000) + 1;
  }

  async function decide(decision){
    if(!ACTIVE) return;
    const endpoint = ep();
    const key = getAdminKey();
    const admin = getAdminSession();
    const adminName = (admin && (admin.name||admin.email)) || ''
    const url = endpoint + "?fn=adminLeaveDecide"
      + "&id=" + encodeURIComponent(ACTIVE.id)
      + "&decision=" + encodeURIComponent(decision)
      + "&note=" + encodeURIComponent($("#mNote").value||"")
      + "&decidedBy=" + encodeURIComponent(adminName)
      + "&key=" + encodeURIComponent(key)
      + "&ts=" + Date.now();
    try{
      const res = await jsonp(url);
      if(!res || !res.ok) throw new Error(res?.error || "Nu pot salva decizia.");
      toast(decision==="approved" ? "Aprobat âœ…" : "Respins âœ•");
      closeModal();
      await loadMonth(YM);
    }catch(err){
      toast("Eroare: " + (err?.message||String(err)));
    }
  }

  $("#mApprove").addEventListener("click", ()=>decide("approved"));
  $("#mReject").addEventListener("click", ()=>decide("rejected"));
  $("#mDl").addEventListener("click", ()=>toast("Export â€” Ã®n curÃ¢nd"));

  // cell click
  document.addEventListener("click", (e)=>{
    const td = e.target.closest("td.cell");
    if(!td) return;
    const ids = String(td.getAttribute("data-ids")||"").split(",").filter(Boolean);
    if(!ids.length) return;
    const day = td.getAttribute("data-day")||"";
    const name = decodeURIComponent(td.getAttribute("data-name")||"");
    const list = (INDEX.get(name)||[]).filter(x=>ids.includes(String(x.id)));
    const pick = bestForCell(list);
    if(pick) openModal(pick, day);
  });

  function fillMonths(){
    const sel = $("#monthSel");
    sel.innerHTML = "";
    const now = new Date();
    const months = [];
    for(let i=-6;i<=6;i++){
      const d = new Date(now.getFullYear(), now.getMonth()+i, 1);
      const ym = d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
      months.push({ ym, label: d.toLocaleDateString("ro-RO",{month:"long",year:"numeric"}) });
    }
    months.forEach(m=>{
      const o = document.createElement("option");
      o.value=m.ym; o.textContent=m.label;
      sel.appendChild(o);
    });
  }

  function shiftMonth(delta){
    const [y,m] = YM.split("-").map(Number);
    const d = new Date(y, m-1+delta, 1);
    YM = d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
    $("#monthSel").value = YM;
    loadMonth(YM);
  }

  async function init(){
    await loadCFG();
    fillMonths();
    const now = new Date();
    YM = now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0");
    $("#monthSel").value = YM;

    $("#refresh").addEventListener("click", ()=>loadMonth($("#monthSel").value));
    $("#monthSel").addEventListener("change", ()=>{ YM=$("#monthSel").value; loadMonth(YM); });
    $("#q").addEventListener("input", ()=>render(YM));
    $("#onlyMine").addEventListener("change", ()=>loadMonth(YM));
    $("#prev").addEventListener("click", ()=>shiftMonth(-1));
    $("#next").addEventListener("click", ()=>shiftMonth(1));

    await loadMonth(YM);
  }

  document.addEventListener("DOMContentLoaded", init);
})();
</script>
</body>
</html>
